const sessions = new Map();

module.exports = function(){
  return function(req, res, next){
    const cookie = req.headers['cookie'] || '';
    let sid = cookie.match(/sid=([^;]+)/)?.[1];
    if (!sid) {
      sid = Math.random().toString(36).slice(2);
      res.setHeader('Set-Cookie', `sid=${sid}; Path=/`);
    }
    let sess = sessions.get(sid);
    if (!sess) { sess = {}; sessions.set(sid, sess); }
    sess.destroy = () => sessions.delete(sid);
    req.session = sess;
    next && next();
  };
};
