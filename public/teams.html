<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pro Club ‚Äî League Hub</title>
<style>
:root{
  --accent:#e00;
  --muted:#bb4444;
  --card-h:400px;
  --sp:12px;                 /* base spacing for mobile */
  --radius:12px;
}
/* Reset-ish */
*{box-sizing:border-box}
html,body{margin:0;padding:0}
button{cursor:pointer}

/* Base */
body{
  background:#000;
  color:#fff;
  font-family:Arial,system-ui,Segoe UI,Helvetica,sans-serif;
  line-height:1.35;
  -webkit-font-smoothing:antialiased;
}

header{
  background:linear-gradient(90deg,#a00000,#d50000);
  color:#fff;
  padding:14px var(--sp);
  display:flex;align-items:center;gap:10px;flex-wrap:wrap
}
header h1{margin:0;font-size:20px;letter-spacing:.2px}

/* Top nav */
.navbar{display:flex;gap:8px;align-items:center;margin-left:auto;flex-wrap:wrap}
.navbar button{
  background:#330000;
  color:#fff;
  border:1px solid #551111;
  border-radius:10px;
  padding:8px 10px;
  font-weight:600;
}
.navbar button[aria-pressed="true"]{background:#550000;border-color:#aa1111}

/* Layout */
main{padding:20px var(--sp);max-width:1200px;margin:0 auto}

/* Utilities */
.muted{color:var(--muted)}
.center{text-align:center}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

/* Cards + grids */
.m-card{
  background:#110000;
  border:1px solid #2a0000;
  border-radius:var(--radius);
  box-shadow:0 6px 18px rgba(255,0,0,.15);
  padding:12px;
}

/* Teams grid */
#teams-view{display:block}
.teams-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:16px;
  margin-top:18px;
}
.team-card{
  background:#110000;
  border-radius:12px;
  box-shadow:0 6px 18px rgba(255,0,0,.3);
  overflow:hidden;
  transition:transform .14s ease, box-shadow .14s ease;
  display:flex;flex-direction:column;align-items:center;
  padding:14px;color:#fff
}
.team-card:hover{transform:translateY(-6px);box-shadow:0 12px 28px rgba(255,0,0,.5)}
.team-logo{
  width:100%;
  height:160px;                 /* ‚Üë increased */
  object-fit:cover;
  border-radius:8px;
  background:#330000;
  display:block;
}
.team-meta{width:100%;display:flex;align-items:center;justify-content:space-between;margin-top:10px;gap:8px}
.team-meta .name{font-weight:700;font-size:16px}
.trophy-badge{
  background:#e00;color:#fff;font-weight:700;
  padding:6px 10px;border-radius:999px;
  display:inline-flex;align-items:center;gap:8px;
  box-shadow:0 2px 6px rgba(255,0,0,.6)
}

/* Team detail */
#detail-view{display:none}
#detail-header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
#backBtn{
  background:#330000;color:#fff;border:1px solid #551111;
  padding:8px 12px;border-radius:8px;font-weight:600
}
#detail-title{font-size:20px;font-weight:700}

.grid-panels{display:grid;grid-template-columns:1fr;gap:12px}

/* Squad slots */
.slots{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:10px;
}
.slot{
  background:#0e0000;border:1px solid #300; border-radius:10px; padding:10px;
  display:flex;justify-content:space-between;align-items:center;gap:8px
}
.slot .lbl{font-weight:700}
.slot .meta{font-size:12px;color:var(--muted)}
.slot .act{display:flex;gap:6px;flex-wrap:wrap}

/* Fixtures ‚Äî public scoreboard */
.fx-list{display:flex;flex-direction:column;gap:12px}
.fx-card{
  background:#110000;border:1px solid #300; border-radius:12px; padding:10px;
  display:grid; grid-template-columns:120px 1fr 120px; gap:10px; align-items:center
}
.fx-card .crest{
  width:80px;height:80px;border-radius:10px;background:#1b0000;object-fit:cover;display:block;margin:0 auto
}
.fx-card .mid{
  text-align:center
}
.fx-card .mid .league{font-size:12px;color:var(--muted)}
.fx-card .mid .score{font-size:26px;font-weight:800;letter-spacing:.5px}
.fx-card .mid .pens{font-size:12px}
.fx-card .side{display:flex;flex-direction:column;gap:6px;align-items:center}
.fx-card .name{font-weight:700;text-align:center}
.fx-card .scorers{font-size:12px;color:#ddd}

/* Fixtures scheduling list (manager/admin) */
.fx{background:#110000;border:1px solid #300;border-radius:10px;padding:10px;display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center}
.fx .meta{font-size:12px;color:var(--muted)}
.fx .vs{font-weight:700}
.fx .act{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end}
.fx button{background:#330000;border:1px solid #551111;color:#fff;border-radius:8px;padding:6px 8px}

/* Inputs */
input,select,textarea{
  background:#0d0000;color:#fff;border:1px solid #3a0000;border-radius:8px;padding:8px
}
label{font-size:12px;color:var(--muted)}
hr{border:none;border-top:1px solid #220000;margin:14px 0}

/* Tables: make them scroll on mobile */
.table-wrap{overflow:auto;border:1px solid #220000;border-radius:10px}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #220000}
th{text-align:left}

/* Mobile tweaks */
@media (max-width: 900px){
  .teams-grid{grid-template-columns:repeat(auto-fill,minmax(180px,1fr))}
}
@media (max-width: 720px){
  :root{ --sp:10px }
  .team-logo{height:140px}          /* ‚Üë taller than before on phones */
  .fx-card{grid-template-columns:1fr; text-align:center}
  .fx-card .crest{width:70px;height:70px}
  .fx{grid-template-columns:1fr;gap:6px}
  .fx .act{justify-content:flex-start}
  .navbar{gap:6px}
  .navbar button{padding:8px 10px}
}
</style>
</head>
<body>
<header>
  <h1>Pro Club ‚Äî League Hub</h1>
  <div class="navbar">
    <button id="navTeams"    aria-pressed="true">Teams</button>
    <button id="navMarket"   aria-pressed="false">Market</button>
    <button id="navFixturesPublic" aria-pressed="false">Fixtures</button>
    <button id="navFixturesSched"  aria-pressed="false" style="display:none">Fixtures Scheduling</button>
    <button id="navRankings" aria-pressed="false" style="display:none">Rankings</button>
    <button id="btnSetRole">Set Role</button>
    <button id="btnAdminLogin">Admin sign in</button>
    <button id="btnAdminLogout" style="display:none">Admin sign out</button>
  </div>
</header>

<main>
  <!-- TEAMS OVERVIEW -->
  <section id="teams-view" aria-live="polite">
    <div class="row" style="justify-content:space-between;">
      <h2 style="margin:0">Teams</h2>
      <div class="muted">Total teams: <span id="teams-count">0</span></div>
    </div>
    <div class="teams-grid" id="teamsGrid" role="list"></div>
  </section>

  <!-- TEAM DETAIL -->
  <section id="detail-view" aria-live="polite">
    <div id="detail-header">
      <button id="backBtn">‚Üê Back</button>
      <div>
        <div id="detail-title">Team name</div>
        <div class="muted" id="detail-sub">overview</div>
      </div>
      <div style="margin-left:auto">
        <span class="trophy-badge" id="detail-trophies">0 üèÜ</span>
      </div>
    </div>

    <div id="teamPanels" class="grid-panels">
      <div class="m-card">
        <strong>Club Wallet</strong>
        <div id="walletBody" class="muted" style="margin-top:6px">Loading‚Ä¶</div>
        <div class="row" style="margin-top:8px">
          <button id="btnCollect" style="display:none">Collect daily payout</button>
          <small class="muted" id="walletHint"></small>
        </div>
      </div>

      <div class="m-card">
        <strong>Next UPCL Match</strong>
        <div id="nextMatchBody" class="muted" style="margin-top:6px">No scheduled match yet.</div>
      </div>

      <div id="teamResultsPanel" class="m-card">
        <strong>Recent Results</strong>
        <div id="teamResultsBody" class="muted" style="margin-top:6px">No finals yet.</div>
      </div>

      <!-- Squad Slots panel (manager/admin can edit) -->
      <div class="m-card" id="slotsPanel">
        <div class="row" style="justify-content:space-between">
          <strong>Squad Slots</strong>
          <div class="row">
            <button id="btnSlotsRefresh">Refresh</button>
            <button id="btnSlotsBootstrap" title="Create S01..S15 slots">Bootstrap</button>
          </div>
        </div>
        <div id="slotsBody" class="slots" style="margin-top:8px"></div>
        <small class="muted">Managers can assign EA usernames to slots. No jersey numbers used.</small>
      </div>
    </div>
  </section>

  <!-- MARKET -->
  <section id="market-view" style="display:none">
    <h2>Transfer Market</h2>
    <div class="m-card">
      <div class="row" style="justify-content:space-between">
        <strong>Free Agents</strong>
        <div class="row">
          <button id="btnListFA">List me</button>
          <button id="btnUnlistFA">Unlist</button>
        </div>
      </div>
      <div id="faList" style="margin-top:8px" class="muted">Loading‚Ä¶</div>
    </div>
  </section>

  <!-- FIXTURES (PUBLIC) -->
  <section id="fixtures-public" style="display:none">
    <h2>Fixtures</h2>
    <div id="fixturesPublicList" class="fx-list" style="margin-top:10px"></div>
  </section>

  <!-- FIXTURES SCHEDULING (MANAGERS/Admins) -->
  <section id="fixtures-sched" style="display:none">
    <div class="row" style="justify-content:space-between">
      <h2>Fixtures Scheduling</h2>
      <div class="row">
        <button data-fxf="upcoming" aria-pressed="true">Upcoming</button>
        <button data-fxf="final" aria-pressed="false">Final</button>
        <button data-fxf="all" aria-pressed="false">All</button>
        <button data-fxf="mine" aria-pressed="false">My club</button>
        <button id="btnCreateFx" style="display:none">Create fixture</button>
      </div>
    </div>
    <div id="fixturesList" class="fx-list" style="margin-top:10px"></div>
  </section>

  <!-- RANKINGS (ADMIN ONLY) -->
  <section id="rankings-view" style="display:none">
    <div class="row" style="justify-content:space-between">
      <h2>Rankings & Payouts</h2>
      <div id="adminControls" style="display:none;gap:8px" class="row">
        <button id="btnSaveRankings">Save</button>
        <button id="btnRecalc">Recalc tiers</button>
        <button id="btnCupDry">Cup bonuses (dry run)</button>
        <button id="btnCupPay">Cup bonuses (pay)</button>
      </div>
    </div>
    <div class="m-card" style="margin-top:10px">
      <div class="muted" style="margin-bottom:8px">Only admins can view/edit this section.</div>
      <div class="table-wrap"><div id="rankingsTable">Loading‚Ä¶</div></div>
    </div>
  </section>
</main>

<script>
// =======================
//   CONFIG / CONSTANTS
// =======================
const API_BASE = '';

const TEAM_TITLES = {
  '3638105': [
    { count: 1, name: 'United Pro Clubs League Title' },
    { count: 1, name: 'Leagues Cup' }
  ]
};

// Teams (+ manual clubs)
const teams = [
  { id: '2491998', name: 'Royal Republic', logo: '/assets/logos/royal-republic-logo.png' },
  { id: '1527486', name: 'Gungan FC',       logo: '/assets/logos/gungan-fc.png' },
  { id: '1969494', name: 'Club Frijol',     logo: '/assets/logos/club-frijol.png' },
  { id: '2086022', name: 'Brehemen',        logo: '/assets/logos/brehemen.png' },
  { id: '2462194', name: 'Costa Chica FC',  logo: '/assets/logos/costa-chica-fc.png' },
  { id: '5098824', name: 'Sporting de la ma', logo: '/assets/logos/sporting-de-la-ma.png' },
  { id: '4869810', name: 'Afc Tekki',       logo: '/assets/logos/afc-tekki.png' },
  { id: '576007',  name: 'Ethabella FC',    logo: '/assets/logos/ethabella-fc.png' },
  { id: '4933507', name: 'Loss Toyz',       logo: '/assets/logos/loss-toyz.png' },
  { id: '4824736', name: 'GoldenGoals FC',  logo: '/assets/logos/goldengoals-fc.png' },
  { id: '481847',  name: 'Rooney tunes',    logo: '/assets/logos/rooney-tunes.png' },
  { id: '3050467', name: 'invincible afc',  logo: '/assets/logos/invincible-afc.png' },
  { id: '4154835', name: 'khalch Fc',       logo: '/assets/logos/khalch-fc.png' },
  { id: '3638105', name: 'Real mvc',        logo: '/assets/logos/real-mvc.png' },
  { id: '55408',   name: 'Elite VT',        logo: '/assets/logos/elite-vt.png' },
  { id: '4819681', name: 'EVERYTHING DEAD', logo: '/assets/logos/everything-dead.png' },
  { id: '35642',   name: 'EBK FC',          logo: '/assets/logos/ebk-fc.png' },
  { id: 'afc-warriors',  name: 'AFC Warriors',  logo: '/assets/logos/afc-warriors.png' },
  { id: 'jids-trivela',  name: 'Jids Trivela',  logo: '/assets/logos/jids-trivela.png' },
  { id: 'razorblack-fc', name: 'Razorblack FC', logo: '/assets/logos/razorblack-fc.png' }
];

const byId = id => teams.find(t=>String(t.id)===String(id));
function teamLogoUrl(team){ return team.logo || `https://via.placeholder.com/800x400.png?text=${encodeURIComponent(team.name)}`; }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
function fmtMoney(n){ return '‚Çµ' + Number(n||0).toLocaleString(); }
function fmtDate(ms){ try{ return new Date(ms).toLocaleString(); } catch{ return ''; } }

// State
let isAdmin=false, meUser=null, isMgr=false;
let rankings = {};
let payouts  = { elite:0, mid:0, bottom:0 };
let fixturesPublicCache=[], fixturesSchedCache=[];

// Generic API
async function apiGet(p){ const r=await fetch(API_BASE+p); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
async function apiPost(p,body){ const r=await fetch(API_BASE+p,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
async function apiPut(p,body){ const r=await fetch(API_BASE+p,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }

// Nav
const navTeams    = document.getElementById('navTeams');
const navMarket   = document.getElementById('navMarket');
const navFxPublic = document.getElementById('navFixturesPublic');
const navFxSched  = document.getElementById('navFixturesSched');
const navRankings = document.getElementById('navRankings');

const teamsViewEl = document.getElementById('teams-view');
const marketView  = document.getElementById('market-view');
const fxPublic    = document.getElementById('fixtures-public');
const fxSched     = document.getElementById('fixtures-sched');
const rankingsView= document.getElementById('rankings-view');

function setNav(active){
  if (active==='rankings' && !isAdmin){ alert('Admin only'); active='teams'; }
  if (active==='fixturesSched' && !(isMgr||isAdmin)){ alert('Managers only'); active='fixturesPublic'; }
  const map = {
    teams:[teamsViewEl,navTeams],
    market:[marketView,navMarket],
    fixturesPublic:[fxPublic,navFxPublic],
    fixturesSched:[fxSched,navFxSched],
    rankings:[rankingsView,navRankings]
  };
  for (const k of Object.keys(map)){
    const [view,btn]=map[k];
    const on = (k===active);
    view.style.display = on ? 'block':'none';
    btn.setAttribute('aria-pressed', String(on));
  }
}
navTeams.onclick = ()=>setNav('teams');
navMarket.onclick= ()=>setNav('market');
navFxPublic.onclick=()=>setNav('fixturesPublic');
navFxSched.onclick =()=>setNav('fixturesSched');
navRankings.onclick=()=>setNav('rankings');

// Auth/admin
const btnAdminLogin=document.getElementById('btnAdminLogin');
const btnAdminLogout=document.getElementById('btnAdminLogout');
btnAdminLogin.onclick = async ()=>{
  const pw = prompt('Admin password');
  if(!pw) return;
  try{ await apiPost('/api/admin/login',{password:pw}); await checkAdmin(); await checkMe(); alert('Admin signed in'); }
  catch(e){ alert('Login failed: '+e.message); }
};
btnAdminLogout.onclick = async ()=>{ try{ await apiPost('/api/admin/logout',{});}catch{} await checkAdmin(); await checkMe(); alert('Signed out'); };
async function checkAdmin(){
  try{ isAdmin = !!(await apiGet('/api/admin/me')).admin; }catch{ isAdmin=false; }
  navRankings.style.display = isAdmin ? 'inline-block':'none';
  btnAdminLogout.style.display = isAdmin ? 'inline-block':'none';
  document.getElementById('btnCreateFx').style.display = isAdmin ? 'inline-block':'none';
  navFxSched.style.display = (isMgr||isAdmin) ? 'inline-block':'none';
  if (isAdmin){ await loadRankings(); renderRankings(); }
}
async function checkMe(){
  try{ meUser = (await apiGet('/api/auth/me')).user || null; }catch{ meUser=null; }
  isMgr = !!(meUser && meUser.role==='Manager');
  navFxSched.style.display = (isMgr||isAdmin) ? 'inline-block':'none';
}

// =======================
//   TEAMS LIST / DETAIL
// =======================
const teamsGrid=document.getElementById('teamsGrid');
const teamsCount=document.getElementById('teams-count');
const detailView=document.getElementById('detail-view');
const detailTitle=document.getElementById('detail-title');
const detailSub=document.getElementById('detail-sub');
const detailTrophies=document.getElementById('detail-trophies');
const backBtn=document.getElementById('backBtn');

function renderTeams(){
  teamsGrid.innerHTML='';
  teamsCount.textContent = teams.length;
  teams.forEach(team=>{
    const card=document.createElement('div');
    card.className='team-card';
    card.setAttribute('role','listitem');
    card.innerHTML=`
      <img class="team-logo" src="${teamLogoUrl(team)}" alt="${escapeHtml(team.name)} logo" />
      <div class="team-meta">
        <div class="name">${escapeHtml(team.name)}</div>
        <div class="trophy-badge">
          ${Array.isArray(TEAM_TITLES[team.id]) ? TEAM_TITLES[team.id].map(t=>`${t.count}x ${t.name}`).join(', ') : ''}
        </div>
      </div>
    `;
    card.addEventListener('click',()=>showTeam(team));
    teamsGrid.appendChild(card);
  });
}

backBtn.addEventListener('click', ()=>{
  detailView.style.display='none';
  document.getElementById('teams-view').style.display='block';
  window.scrollTo({top:0,behavior:'smooth'});
});

async function showTeam(team){
  window.scrollTo({top:0,behavior:'smooth'});
  document.getElementById('teams-view').style.display='none';
  detailView.style.display='block';
  detailTitle.textContent = team.name;
  detailSub.textContent   = 'Loading club info‚Ä¶';
  if (Array.isArray(TEAM_TITLES[team.id])){
    detailTrophies.innerHTML = TEAM_TITLES[team.id].map(t=>`<div>${t.count}x ${t.name}</div>`).join('');
  }else detailTrophies.textContent = 'No trophies';

  await renderWallet(team.id);
  await refreshFixturesPublic();
  renderNextFor(team.id);
  renderTeamResults(team.id);
  await loadSlots(team.id);        // squad slots pane

  detailSub.textContent = 'Club overview';
}

// Wallet panel
async function renderWallet(clubId){
  const body=document.getElementById('walletBody');
  const hint=document.getElementById('walletHint');
  const btn=document.getElementById('btnCollect');
  try{
    const d=await apiGet(`/api/wallets/${encodeURIComponent(clubId)}`);
    const w=d.wallet||{}, prev=d.preview||{}, per=d.perDay||0;
    body.innerHTML = `Balance: <strong>${fmtMoney(w.balance||0)}</strong><br>
                      Tier payout: <strong>${fmtMoney(per)}</strong> / day<br>
                      Pending payout: <strong>${fmtMoney(prev.amount||0)}</strong> (${prev.days||0} days)`;
    const canCollect = meUser && meUser.role==='Manager' && String(meUser.teamId)===String(clubId);
    btn.style.display = canCollect ? 'inline-block':'none';
    btn.onclick = async ()=>{
      try{ const r=await apiPost(`/api/wallets/${encodeURIComponent(clubId)}/collect`,{}); alert(r.ok?'Payout collected!':(r.message||'No payout')); await renderWallet(clubId); }
      catch(e){ alert('Collect failed: '+e.message); }
    };
    hint.textContent = canCollect ? 'Only the club manager can collect.' : 'Sign in as manager to collect.';
  }catch(e){ body.textContent='Wallet unavailable'; hint.textContent=''; document.getElementById('btnCollect').style.display='none'; }
}

// Squad Slots UI
const slotsBody = document.getElementById('slotsBody');
document.getElementById('btnSlotsRefresh').onclick = async ()=>{
  const id = detailTitle.textContent && (teams.find(t=>t.name===detailTitle.textContent)||{}).id;
  if (id) await loadSlots(id);
};
document.getElementById('btnSlotsBootstrap').onclick = async ()=>{
  const team = teams.find(t=>t.name===detailTitle.textContent);
  if (!team) return;
  if (!confirm('Create S01..S15 slots for this club?')) return;
  try{ await apiPost(`/api/clubs/${encodeURIComponent(team.id)}/squad/bootstrap`,{size:15}); await loadSlots(team.id); }
  catch(e){ alert('Bootstrap failed: '+e.message); }
};
async function loadSlots(clubId){
  try{
    const d = await apiGet(`/api/clubs/${encodeURIComponent(clubId)}/squad`);
    const slots = d.slots || [];
    if (!slots.length){
      slotsBody.innerHTML = `<div class="muted">No slots yet. Admin/Manager can click ‚ÄúBootstrap‚Äù.</div>`;
      return;
    }
    slotsBody.innerHTML = slots.map(s=>{
      const who = s.player ? escapeHtml(s.player.eaName) : '<span class="muted">Vacant</span>';
      return `<div class="slot" data-slot="${s.slotId}">
        <div>
          <div class="lbl">${escapeHtml(s.label||s.slotId)}</div>
          <div class="meta">${s.player ? 'EA: '+escapeHtml(s.player.eaName) : '‚Äî'}</div>
        </div>
        <div class="act">
          <button class="slot-assign">Assign</button>
          <button class="slot-unassign">Clear</button>
          <button class="slot-rename">Rename</button>
        </div>
      </div>`;
    }).join('');
    // attach handlers
    slots.forEach(s=>{
      const root=document.querySelector(`.slot[data-slot="${s.slotId}"]`);
      if (!root) return;
      root.querySelector('.slot-assign').onclick = async ()=>{
        const eaName = prompt('EA username to assign (or leave blank if you have an existing playerId)');
        let playerId = '';
        if (!eaName){
          playerId = prompt('Existing playerId to assign');
          if (!playerId) return;
        }
        const aliases = prompt('Any aliases? (comma separated)')||'';
        try{
          await apiPost(`/api/clubs/${encodeURIComponent(clubId)}/squad/slots/${encodeURIComponent(s.slotId)}/assign`, { playerId, eaName, aliases });
          await loadSlots(clubId);
        }catch(e){ alert('Assign failed: '+e.message); }
      };
      root.querySelector('.slot-unassign').onclick = async ()=>{
        try{ await apiPost(`/api/clubs/${encodeURIComponent(clubId)}/squad/slots/${encodeURIComponent(s.slotId)}/unassign`,{}); await loadSlots(clubId); }
        catch(e){ alert('Clear failed: '+e.message); }
      };
      root.querySelector('.slot-rename').onclick = async ()=>{
        const label = prompt('New label', s.label||s.slotId);
        if (!label) return;
        try{ await fetch(`/api/clubs/${encodeURIComponent(clubId)}/squad/slots/${encodeURIComponent(s.slotId)}`, { method:'PATCH', headers:{'Content-Type':'application/json'}, body:JSON.stringify({label}) }); await loadSlots(clubId); }
        catch(e){ alert('Rename failed: '+e.message); }
      };
    });
  }catch(e){
    slotsBody.innerHTML = `<div class="muted">Failed to load slots.</div>`;
  }
}

// =======================
//   FREE AGENTS
// =======================
async function loadFA(){
  try{
    const d = await apiGet('/api/free-agents');
    const arr = d.agents || [];
    document.getElementById('faList').innerHTML = arr.length ? arr.map(a=>{
      const pos=(a.positions||[]).join(', ');
      return `<div class="m-card" style="margin:8px 0;padding:8px">
        <strong>${escapeHtml(a.name)}</strong> <span class="muted">(${escapeHtml(a.region||'')})</span><br>
        <span class="muted">${escapeHtml(pos)}</span>
        ${a.discord?`<div>Discord: ${escapeHtml(a.discord)}</div>`:''}
        ${a.bio?`<div class="muted">${escapeHtml(a.bio)}</div>`:''}
      </div>`;
    }).join('') : 'No free agents listed.';
  }catch{ document.getElementById('faList').textContent='Failed to load.'; }
}
document.getElementById('btnListFA').onclick = async ()=>{
  const name = meUser?.name || prompt('Your display name');
  if (!name) return;
  const positions = prompt('Positions (comma separated, e.g., ST, CAM, CB)')||'';
  const region = prompt('Region/Timezone (e.g., EST, EU)')||'';
  const foot = prompt('Strong foot (L/R)')||'';
  const availability = prompt('Availability (e.g., Mon-Thu 7-10pm)')||'';
  const discord = prompt('Discord tag (optional)')||'';
  const bio = prompt('Short bio (optional)')||'';
  try{
    await apiPost('/api/free-agents/me',{ name, positions, region, foot, availability, discord, bio });
    alert('Listed!'); await loadFA();
  }catch(e){ alert('List failed: '+e.message); }
};
document.getElementById('btnUnlistFA').onclick=async()=>{
  try{ await fetch('/api/free-agents/me',{method:'DELETE'}); alert('Unlisted'); await loadFA(); }
  catch(e){ alert('Unlist failed: '+e.message); }
};

// =======================
//   FIXTURES ‚Äî PUBLIC (scoreboard w/ logos)
// =======================
const fixturesPublicList=document.getElementById('fixturesPublicList');
async function refreshFixturesPublic(){
  try{ fixturesPublicCache = (await apiGet('/api/cup/fixtures/public?cup=UPCL')).fixtures || []; }
  catch{ fixturesPublicCache = []; }
}
function crestSrc(id){ return byId(id)?.logo || 'https://via.placeholder.com/120x120.png?text=%20'; }
function renderFixturesPublic(){
  const list = fixturesPublicCache.slice().sort((a,b)=>(a.when||a.createdAt)-(b.when||b.createdAt));
  fixturesPublicList.innerHTML = list.length ? list.map(f=>{
    const home = byId(f.home)||{name:f.home}, away = byId(f.away)||{name:f.away};
    const whenTxt = f.when ? fmtDate(f.when) : 'TBD';
    const scoreTxt = f.status==='final' ? `${f.score.hs}‚Äì${f.score.as}` : '‚Äî';
    const pensTxt = f.report?.pens ? `Penalties: ${f.report.pens}` : (f.pens?`Penalties: ${f.pens}`:'');
    const homeSc = (f.details?.home||[]).map(p=>`${escapeHtml(p.player||'')}${p.goals?` (${p.goals})`:''}`).filter(Boolean).join(', ');
    const awaySc = (f.details?.away||[]).map(p=>`${escapeHtml(p.player||'')}${p.goals?` (${p.goals})`:''}`).filter(Boolean).join(', ');

    return `
      <div class="fx-card">
        <div class="side">
          <img class="crest" src="${crestSrc(f.home)}" alt="${escapeHtml(home.name)} crest"/>
          <div class="name">${escapeHtml(home.name)}</div>
          <div class="scorers">${homeSc||''}</div>
        </div>
        <div class="mid">
          <div class="league muted">UPCL ‚Ä¢ ${escapeHtml(f.round||'')}</div>
          <div class="score">${scoreTxt}</div>
          ${pensTxt?`<div class="pens muted">${escapeHtml(pensTxt)}</div>`:''}
          <div class="muted" style="margin-top:4px">${whenTxt}</div>
        </div>
        <div class="side">
          <img class="crest" src="${crestSrc(f.away)}" alt="${escapeHtml(away.name)} crest"/>
          <div class="name">${escapeHtml(away.name)}</div>
          <div class="scorers">${awaySc||''}</div>
        </div>
      </div>`;
  }).join('') : `<div class="muted">No fixtures yet.</div>`;
}

// =======================
//   FIXTURES ‚Äî SCHEDULING
// =======================
const fixturesList=document.getElementById('fixturesList');
const btnCreateFx=document.getElementById('btnCreateFx');

btnCreateFx.onclick=async()=>{
  const home=prompt('Home club ID (exact from Teams list)');
  const away=prompt('Away club ID');
  const round=prompt('Round (e.g., Quarterfinal)');
  if(!home||!away) return;
  try{ await apiPost('/api/cup/fixtures',{home,away,round,cup:'UPCL'}); alert('Created fixture'); await refreshFixturesSched(); renderFixturesSched(); }
  catch(e){ alert('Create failed: '+e.message); }
};

document.querySelectorAll('[data-fxf]').forEach(btn=>{
  btn.onclick=()=>{ document.querySelectorAll('[data-fxf]').forEach(b=>b.setAttribute('aria-pressed','false')); btn.setAttribute('aria-pressed','true'); renderFixturesSched(); };
});
async function refreshFixturesSched(){
  if (!(isMgr||isAdmin)){ fixturesSchedCache=[]; return; }
  try{ fixturesSchedCache=(await apiGet('/api/cup/fixtures/scheduling?cup=UPCL')).fixtures||[]; }
  catch{ fixturesSchedCache=[]; }
}
function filterKey(){ const a=[...document.querySelectorAll('[data-fxf]')].find(b=>b.getAttribute('aria-pressed')==='true'); return a?a.getAttribute('data-fxf'):'upcoming'; }
function renderFxSchedRow(f){
  const hn=byId(f.home)?.name||f.home, an=byId(f.away)?.name||f.away;
  const whenTxt=f.when?fmtDate(f.when):'TBD';
  const props=(f.proposals||[]).map(p=>`<option value="${p.at}">${fmtDate(p.at)} ${p.by?`‚Ä¢ ${escapeHtml(byId(p.by)?.name||p.by)}`:''}</option>`).join('');
  const status=f.status||'pending';
  const adminBtns = isAdmin ? `<button class="ingest">Admin paste</button><button class="json">Upload JSON</button>` : '';
  return `
  <div class="fx" id="fx_${f.id}">
    <div>
      <div class="vs">${escapeHtml(hn)} <span class="muted">vs</span> ${escapeHtml(an)}</div>
      <div class="meta">Round: ${escapeHtml(f.round||'')} ‚Ä¢ When: ${escapeHtml(whenTxt)} ‚Ä¢ Status: <span class="muted">${escapeHtml(status)}</span></div>
    </div>
    <div class="center">
      ${(f.proposals||[]).length ? `<label>Proposals</label><br><select name="slot">${props}</select>` : `<span class="muted">No proposals</span>`}
    </div>
    <div class="act">
      <button class="prop">Propose</button>
      <button class="agree">Agree</button>
      <button class="decl">Decline</button>
      <button class="line">Set Lineup</button>
      <button class="rep">Submit Result</button>
      ${adminBtns}
    </div>
  </div>`;
}
function renderFixturesSched(){
  const key=filterKey();
  let list=fixturesSchedCache.slice();
  const now=Date.now();
  if (key==='upcoming'){ list=list.filter(f=>f.status!=='final'&&(!f.when||f.when>=now)); }
  else if(key==='final'){ list=list.filter(f=>f.status==='final'); }
  else if(key==='mine'&&meUser){ list=list.filter(f=>f.home===meUser.teamId||f.away===meUser.teamId); }
  list.sort((a,b)=>(a.when||a.createdAt)-(b.when||b.createdAt));
  fixturesList.innerHTML = list.length ? list.map(renderFxSchedRow).join('') : `<div class="muted">No fixtures.</div>`;
  // attach handlers
  list.forEach(f=>{
    const root=document.getElementById('fx_'+f.id); if(!root) return;
    const isManagerOf = meUser && meUser.role==='Manager' && [f.home,f.away].includes(meUser.teamId);

    const btnProp=root.querySelector('.act .prop');
    if (btnProp) btnProp.onclick = async ()=>{
      if (!isManagerOf && !isAdmin) return alert('Managers only');
      const atStr=prompt('Propose time (e.g., 2025-08-20 20:30)'); if(!atStr) return;
      const at=Date.parse(atStr); if(!at) return alert('Could not parse date');
      try{ await apiPost(`/api/cup/fixtures/${f.id}/propose`,{at}); await refreshFixturesSched(); renderFixturesSched(); }
      catch(e){ alert('Propose failed: '+e.message); }
    };

    const btnAgree=root.querySelector('.act .agree');
    if (btnAgree) btnAgree.onclick = async ()=>{
      if (!isManagerOf && !isAdmin) return alert('Managers only');
      const at=root.querySelector('select[name="slot"]')?.value; if(!at) return alert('Pick a proposed slot first');
      try{ await apiPost(`/api/cup/fixtures/${f.id}/vote`,{at,agree:true}); await refreshFixturesSched(); renderFixturesSched(); await refreshFixturesPublic(); renderFixturesPublic(); }
      catch(e){ alert('Vote failed: '+e.message); }
    };

    const btnDecl=root.querySelector('.act .decl');
    if (btnDecl) btnDecl.onclick = async ()=>{
      if (!isManagerOf && !isAdmin) return alert('Managers only');
      const at=root.querySelector('select[name="slot"]')?.value; if(!at) return alert('Pick a proposed slot first');
      try{ await apiPost(`/api/cup/fixtures/${f.id}/vote`,{at,agree:false}); await refreshFixturesSched(); renderFixturesSched(); }
      catch(e){ alert('Vote failed: '+e.message); }
    };

    const btnLine=root.querySelector('.act .line');
    if (btnLine) btnLine.onclick = async ()=>{
      if (!isManagerOf && !isAdmin) return alert('Managers only');
      const formation=prompt('Formation (e.g., 4-3-3)')||'';
      const starters = prompt('Comma-separated starters (names)')||'';
      const lineup={}; starters.split(',').map(s=>s.trim()).filter(Boolean).forEach((name,i)=> lineup['P'+(i+1)]=name);
      try{ await apiPut(`/api/cup/fixtures/${f.id}/lineup`,{formation,lineup}); await refreshFixturesSched(); renderFixturesSched(); }
      catch(e){ alert('Lineup failed: '+e.message); }
    };

    const btnReport=root.querySelector('.act .rep');
    if (btnReport) btnReport.onclick = async ()=>{
      if (!isManagerOf && !isAdmin) return alert('Managers only');
      const hs=Number(prompt('Home score?')||0);
      const as=Number(prompt('Away score?')||0);
      const text=prompt('Notes (optional)')||'';
      try{
        await apiPost(`/api/cup/fixtures/${f.id}/report`,{hs,as,text});
        document.querySelectorAll('[data-fxf]').forEach(x=>x.setAttribute('aria-pressed','false'));
        document.querySelector('[data-fxf="final"]').setAttribute('aria-pressed','true');
        await refreshFixturesSched(); renderFixturesSched();
        await refreshFixturesPublic(); renderFixturesPublic();
      }catch(e){ alert('Report failed: '+e.message); }
    };

    const btnIngest=root.querySelector('.act .ingest');
    if (btnIngest) btnIngest.onclick = async ()=>{
      if (!isAdmin) return alert('Admin only');
      const text=prompt('Paste quick result (score & player lines)'); if(!text) return;
      try{
        await apiPost(`/api/cup/fixtures/${f.id}/ingest-text`,{text});
        document.querySelectorAll('[data-fxf]').forEach(x=>x.setAttribute('aria-pressed','false'));
        document.querySelector('[data-fxf="final"]').setAttribute('aria-pressed','true');
        await refreshFixturesSched(); renderFixturesSched();
        await refreshFixturesPublic(); renderFixturesPublic();
      }catch(e){ alert('Ingest failed: '+e.message); }
    };

    const btnJson=root.querySelector('.act .json');
    if (btnJson) btnJson.onclick = async ()=>{
      if (!isAdmin) return alert('Admin only');
      const hs=Number(prompt('Home score (hs)')||0);
      const as=Number(prompt('Away score (as)')||0);
      const template=JSON.stringify({details:{home:[{player:"Player A",goals:1,assists:0,rating:9.5}],away:[{player:"Player B",goals:2,assists:0,rating:8.7}] }},null,2);
      const raw=prompt('Paste JSON (or edit the template):', template); if(!raw) return;
      try{
        const obj=JSON.parse(raw);
        await apiPost(`/api/cup/fixtures/${f.id}/report`,{hs,as,details:obj.details||obj});
        document.querySelectorAll('[data-fxf]').forEach(x=>x.setAttribute('aria-pressed','false'));
        document.querySelector('[data-fxf="final"]').setAttribute('aria-pressed','true');
        await refreshFixturesSched(); renderFixturesSched();
        await refreshFixturesPublic(); renderFixturesPublic();
      }catch(e){ alert('JSON upload failed: '+e.message); }
    };
  });
}

// Next & recent (from public)
function nextFor(teamId){
  const now=Date.now();
  return fixturesPublicCache
    .filter(f=>(f.home===teamId||f.away===teamId)&&f.status!=='final'&&f.when&&f.when>=now)
    .sort((a,b)=>a.when-b.when)[0];
}
function finalsFor(teamId,n=5){
  return fixturesPublicCache
    .filter(f=>f.status==='final'&&(f.home===teamId||f.away===teamId))
    .sort((a,b)=>(b.when||b.createdAt)-(a.when||a.createdAt))
    .slice(0,n);
}
function renderNextFor(teamId){
  const el=document.getElementById('nextMatchBody');
  const f=nextFor(teamId);
  if (!f){ el.textContent='No scheduled match yet.'; return; }
  const hn=byId(f.home)?.name||f.home, an=byId(f.away)?.name||f.away;
  el.innerHTML = `<div><strong>${escapeHtml(hn)}</strong> vs <strong>${escapeHtml(an)}</strong></div><div class="muted">${fmtDate(f.when)}</div>`;
}
function renderTeamResults(teamId){
  const el=document.getElementById('teamResultsBody');
  const list=finalsFor(teamId);
  el.innerHTML = list.length ? list.map(f=>{
    const hn=byId(f.home)?.name||f.home, an=byId(f.away)?.name||f.away;
    return `<div>FT ${f.score.hs}-${f.score.as}: <strong>${escapeHtml(hn)}</strong> vs <strong>${escapeHtml(an)}</strong> ‚Ä¢ ${fmtDate(f.when||f.createdAt)}</div>`;
  }).join('') : 'No finals yet.';
}

// =======================
//   RANKINGS (ADMIN)
// =======================
async function loadRankings(){
  try{
    const d=await apiGet('/api/rankings');
    rankings=d.rankings||{};
    payouts=d.payouts||payouts;
  }catch{ rankings={}; }
}
function perDayFor(clubId){ const r=rankings[clubId]||{tier:'mid'}; return payouts[r.tier||'mid']||0; }
function renderRankings(){
  const rows = teams.map(t=>{
    const r=rankings[t.id]||{leaguePos:'',cup:'none',points:0,tier:'mid'};
    const cupOpts=['none','round_of_16','quarterfinal','semifinal','runner_up','winner'].map(v=>`<option value="${v}" ${r.cup===v?'selected':''}>${v.replace(/_/g,' ')}</option>`).join('');
    return `<tr>
      <td>${escapeHtml(t.name)}</td>
      <td><input type="number" min="0" style="width:80px" value="${r.leaguePos||''}" data-k="leaguePos" data-id="${t.id}"></td>
      <td><select data-k="cup" data-id="${t.id}">${cupOpts}</select></td>
      <td>${escapeHtml(r.tier||'mid')}</td>
      <td>${fmtMoney(perDayFor(t.id))}</td>
    </tr>`;
  }).join('');
  document.getElementById('rankingsTable').innerHTML = `
    <table>
      <thead><tr><th>Club</th><th>League pos</th><th>Cup</th><th>Tier</th><th>Payout/day</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
  const adminControls=document.getElementById('adminControls');
  adminControls.style.display = isAdmin ? 'flex':'none';

  document.getElementById('btnSaveRankings').onclick=async()=>{
    const payload={rankings:{}};
    document.querySelectorAll('#rankingsTable [data-id]').forEach(el=>{
      const id=el.getAttribute('data-id'), k=el.getAttribute('data-k');
      payload.rankings[id]=payload.rankings[id]||{};
      payload.rankings[id][k]= k==='leaguePos'?Number(el.value||0):el.value;
    });
    try{ await apiPost('/api/rankings/bulk',payload); alert('Saved'); await loadRankings(); renderRankings(); }
    catch(e){ alert('Save failed: '+e.message); }
  };
  document.getElementById('btnRecalc').onclick=async()=>{
    try{ await apiPost('/api/rankings/recalc',{}); await loadRankings(); renderRankings(); alert('Recalculated'); }
    catch(e){ alert('Recalc failed: '+e.message); }
  };
  document.getElementById('btnCupDry').onclick=async()=>{
    try{ const r=await apiPost('/api/bonuses/cup',{dryRun:true}); alert('Would award: '+fmtMoney(r.totalAwarded)); }
    catch(e){ alert('Dry run failed: '+e.message); }
  };
  document.getElementById('btnCupPay').onclick=async()=>{
    if (!confirm('Pay cup bonuses now?')) return;
    try{ const r=await apiPost('/api/bonuses/cup',{dryRun:false}); alert('Awarded: '+fmtMoney(r.totalAwarded)); }
    catch(e){ alert('Pay failed: '+e.message); }
  };
}

// =======================
//   ROLE CLAIM
// =======================
document.getElementById('btnSetRole').onclick = async ()=>{
  const role=(prompt('Role (Manager or Player)')||'').trim().toLowerCase();
  if (!role) return;

  if (role==='manager'){
    const clubId=prompt('Enter your Club ID exactly as shown in Teams (e.g., 2491998 or afc-warriors)');
    const name=prompt('Your display name');
    const code=prompt('Manager code (ask admin)');
    if(!clubId||!name||!code) return;
    try{ await apiPost(`/api/clubs/${encodeURIComponent(clubId)}/claim-manager`,{name,code}); alert('Manager role claimed'); await checkMe(); await refreshFixturesSched(); renderFixturesSched(); }
    catch(e){ alert('Claim failed: '+e.message); }
    return;
  }

  if (role==='player'){
    const name=prompt('Your display name');
    const clubId=prompt('Optional: Club ID to associate with (or leave blank)');
    if (!name) return;
    try{ await apiPost('/api/players/claim',{name,teamId:clubId||''}); alert('Player role set'); await checkMe(); }
    catch(e){ alert('Player claim failed: '+e.message); }
    return;
  }

  alert('Unsupported role. Use Manager or Player.');
};

// =======================
//   INIT
// =======================
async function init(){
  renderTeams();
  await checkAdmin();
  await checkMe();
  setNav('teams');
  await refreshFixturesPublic(); renderFixturesPublic();
  if (isMgr||isAdmin){ await refreshFixturesSched(); renderFixturesSched(); }
  await loadFA();

  // If #team=<id> present, open it
  try{
    const m=location.hash.match(/team=([^&]+)/);
    if (m){ const team=byId(decodeURIComponent(m[1])); if (team) setTimeout(()=>showTeam(team),150); }
  }catch{}
}
init();
</script>
</body>
</html>
