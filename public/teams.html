<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>UPCL</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          crimson: '#0f172a',
          midnight: '#02060d',
          gold: '#d4af37',
          silver: '#aeb7c2',
          teal: '#1ec9c3'
        },
        fontFamily: {
          montserrat: ['Montserrat', 'sans-serif']
        },
        boxShadow: {
          'crimson-glow': '0 18px 45px rgba(139, 0, 0, 0.45)'
        }
      }
    }
  };
</script>
<style>
/* === Core palette === */
:root{
  --accent:#1ec9c3;
  --accent-rgb:30,201,195;
  --accent-dark:#041017;
  --accent-soft:#0a1b23;
  --muted:#8b97ab;
  --gold:#d4af37;
  --silver:#aeb7c2;
  --emerald:#34d399;
  --pad:16px;
  --radius:18px;
}
html{scroll-behavior:smooth;}
*{box-sizing:border-box}
html,body{
  margin:0;
  padding:0;
  min-height:100%;
  background:
    radial-gradient(circle at center, #0a0f1c, #000000);
  background-size:cover;
  background-attachment:fixed;
  background-color:#000;
  overflow-x:hidden;
}
body{
  position:relative;
  color:#f6f9ff;
  font-family:'Montserrat',Arial,system-ui,-apple-system,'Segoe UI',sans-serif;
  -webkit-text-size-adjust:100%;
  min-height:100vh;
  background:
    radial-gradient(120% 90% at 50% -15%, rgba(30,201,195,0.25), transparent 65%),
    radial-gradient(85% 70% at 0% 0%, rgba(212,175,55,0.12), transparent 70%),
    linear-gradient(165deg, #020308 0%, #02060d 40%, #010208 100%);
  background-attachment:fixed;
  letter-spacing:0.02em;
  line-height:1.55;
  padding-top:env(safe-area-inset-top);
  padding-bottom:env(safe-area-inset-bottom);
}
a{color:#fdfcfc; text-decoration:none}
img{max-width:100%; display:block}
button{
  font-family:inherit;
  font-weight:600;
  letter-spacing:0.08em;
  text-transform:uppercase;
  background:linear-gradient(135deg, rgba(45,212,191,0.2), rgba(14,23,32,0.92));
  color:#fdfcfc;
  border:1px solid rgba(212,175,55,0.3);
  border-radius:14px;
  padding:10px 16px;
  cursor:pointer;
  transition:transform .25s ease, box-shadow .25s ease, border-color .25s ease, background .25s ease;
  backdrop-filter:blur(6px);
}
button:hover,
button:focus-visible{
  outline:none;
  transform:translateY(-1px);
  border-color:rgba(45,212,191,0.45);
  box-shadow:0 12px 24px rgba(45,212,191,0.22);
}
button:disabled{
  opacity:0.6;
  cursor:not-allowed;
  transform:none;
  box-shadow:none;
}

.glow-card{
  position:relative;
  background:linear-gradient(145deg, rgba(9,13,20,0.94), rgba(4,7,12,0.92));
  border-radius:22px;
  padding:22px;
  border:1px solid rgba(148,163,184,0.24);
  box-shadow:0 22px 45px rgba(0,0,0,0.65);
  overflow:hidden;
  transition:transform .32s cubic-bezier(.21,.72,.35,1), box-shadow .32s ease, border-color .32s ease;
  --glow-rgb:148,163,184;
}
.glow-card::before{
  content:"";
  position:absolute;
  inset:-2px;
  border-radius:inherit;
  background:
    radial-gradient(circle at 18% 12%, rgba(var(--glow-rgb),0.35), transparent 58%),
    radial-gradient(circle at 82% 20%, rgba(94,234,212,0.16), transparent 70%);
  opacity:0.85;
  pointer-events:none;
  transition:opacity .32s ease;
}
.glow-card::after{
  content:"";
  position:absolute;
  inset:1px;
  border-radius:inherit;
  border:1px solid rgba(var(--glow-rgb),0.28);
  mix-blend-mode:screen;
  opacity:0.55;
  pointer-events:none;
  transition:border-color .32s ease, opacity .32s ease;
}
.glow-card > *{position:relative;z-index:1;}
.glow-card:hover,
.glow-card:focus-visible{
  outline:none;
  transform:translateY(-8px) scale(1.02);
  border-color:rgba(var(--glow-rgb),0.55);
  box-shadow:0 28px 65px rgba(0,0,0,0.72), 0 0 32px rgba(var(--glow-rgb),0.45);
}
.glow-card:hover::after,
.glow-card:focus-visible::after{opacity:0.85;border-color:rgba(var(--glow-rgb),0.55);}
.glow-card:hover::before,
.glow-card:focus-visible::before{opacity:1;}

.glow-gold{--glow-rgb:212,175,55;}
.glow-green{--glow-rgb:45,212,191;}
.glow-silver{--glow-rgb:148,163,184;}
body::before{
  content:"";
  position:fixed;
  inset:0;
  z-index:-1;
  background-image:
    linear-gradient(135deg, rgba(30,201,195,0.2) 0%, rgba(6,8,12,0.92) 60%),
    radial-gradient(65% 55% at 15% 10%, rgba(212,175,55,0.18) 0%, transparent 70%),
    radial-gradient(45% 45% at 85% 0%, rgba(65,120,255,0.15) 0%, transparent 65%),
    url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"%3E%3Cdefs%3E%3ClinearGradient id="g" x1="0" y1="0" x2="1" y2="1"%3E%3Cstop offset="0" stop-color="%23ffffff" stop-opacity="0.08"/%3E%3Cstop offset="1" stop-color="%23ffffff" stop-opacity="0"/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width="200" height="200" fill="url(%23g)"/%3E%3C/svg%3E');
  background-size:120% 120%, 120% 120%, 120% 120%, 280px;
  mix-blend-mode:screen;
  opacity:0.32;
  animation: shimmer 18s ease-in-out infinite alternate;
  pointer-events:none;
}
@keyframes shimmer{
  0%{transform:translate3d(-3%, -3%, 0) scale(1.02);}
  100%{transform:translate3d(3%, 4%, 0) scale(1.05);}
}

/* Header / Nav */
header{
  position:sticky;
  top:0;
  z-index:50;
  background:linear-gradient(120deg, rgba(21,0,0,0.82), rgba(0,0,0,0.82));
  backdrop-filter:blur(16px);
  padding:18px clamp(16px,3vw,32px);
  border-bottom:1px solid rgba(212,175,55,0.18);
  box-shadow:0 12px 24px rgba(0,0,0,0.55);
  display:flex;
  align-items:center;
  gap:18px;
}
h1{
  margin:0;
  font-size:24px;
  letter-spacing:0.28em;
  text-transform:uppercase;
  font-weight:700;
}
.site-brand{
  display:flex;
  align-items:center;
  gap:12px;
}
.brand-copy{display:flex;flex-direction:column;gap:4px;}
.site-brand::after{
  content:"";
  width:42px;
  height:2px;
  background:linear-gradient(90deg, rgba(212,175,55,0.6), rgba(45,212,191,0));
  border-radius:999px;
}
.brand-mark{
  width:44px;
  height:44px;
  border-radius:14px;
  background:radial-gradient(circle at 25% 25%, rgba(212,175,55,0.55), rgba(30,201,195,0.6) 58%, rgba(5,8,12,0.9));
  box-shadow:0 0 25px rgba(212,175,55,0.25);
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  color:rgba(255,255,255,0.9);
}
.brand-tagline{
  font-size:12px;
  text-transform:uppercase;
  letter-spacing:0.38em;
  color:rgba(255,255,255,0.58);
}
.navbar{
  margin-left:auto;
  display:flex;
  gap:24px;
  align-items:stretch;
  flex-wrap:nowrap;
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
  scrollbar-width:none;
  padding-bottom:6px;
}
.navbar::-webkit-scrollbar{display:none}
.nav-group{
  display:flex;
  flex-direction:column;
  gap:10px;
  min-width:max-content;
}
.nav-group-label{
  font-size:10px;
  font-weight:700;
  letter-spacing:0.28em;
  text-transform:uppercase;
  color:rgba(255,255,255,0.42);
}
.nav-group-items{
  display:flex;
  gap:8px;
}
.navbar button{
  position:relative;
  display:flex;
  align-items:center;
  gap:8px;
  padding:10px 16px;
  background:linear-gradient(135deg, rgba(14,23,32,0.82), rgba(6,10,16,0.9));
  border:1px solid rgba(94,234,212,0.2);
  border-radius:999px;
  color:#f6f9ff;
  font-weight:600;
  cursor:pointer;
  transition:transform .3s ease, box-shadow .3s ease, border-color .3s ease;
  white-space:nowrap;
  box-shadow:0 8px 22px rgba(15,23,42,0.45);
}
.navbar button::after{
  content:"";
  position:absolute;
  left:16px;
  right:16px;
  bottom:6px;
  height:3px;
  border-radius:999px;
  background:linear-gradient(90deg, rgba(45,212,191,0.65), rgba(212,175,55,0.85));
  transform-origin:left;
  transform:scaleX(0);
  transition:transform .28s ease;
  opacity:0.7;
}
.navbar button:hover::after,
.navbar button:focus-visible::after{transform:scaleX(1);}
.navbar button:hover,
.navbar button:focus-visible{
  outline:none;
  border-color:rgba(45,212,191,0.48);
  box-shadow:0 18px 36px rgba(45,212,191,0.22);
  transform:translateY(-2px);
}
.navbar button[aria-pressed="true"]{
  border-color:rgba(212,175,55,0.65);
  box-shadow:0 18px 36px rgba(212,175,55,0.24);
}
.nav-icon{
  width:18px;
  height:18px;
  color:rgba(212,175,55,0.9);
  display:flex;
}
.nav-icon svg{width:18px;height:18px;}

/* Layout */
main{
  position:relative;
  padding:0;
  max-width:1280px;
  margin:0 auto;
  z-index:1;
  overflow-x:hidden;
}
main::before{
  content:"";
  position:absolute;
  inset:0;
  left:50%;
  right:auto;
  width:calc(100% + min(20vw, 120px));
  transform:translateX(-50%);
  background:
    radial-gradient(75% 45% at 50% 0%, rgba(30,201,195,0.18) 0%, transparent 65%),
    linear-gradient(0deg, rgba(255,255,255,0.02), rgba(255,255,255,0));
  opacity:0.7;
  filter:blur(42px);
  z-index:-1;
  pointer-events:none;
}
h2{margin:0 0 12px;font-size:28px;letter-spacing:0.08em;text-transform:uppercase}
.muted{color:var(--muted)}
.center{text-align:center}
.chip{
  background:linear-gradient(135deg, rgba(45,212,191,0.22), rgba(14,23,32,0.82));
  border:1px solid rgba(45,212,191,0.35);
  color:#f6f9ff;
  border-radius:999px;
  padding:4px 10px;
  font-size:12px;
  letter-spacing:0.1em;
  text-transform:uppercase;
}

/* Home section */
.home-grid{display:grid;gap:16px;margin-top:18px}
.home-card-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  flex-wrap:wrap;
}
.home-card-action{
  font-size:11px;
  padding:6px 12px;
  letter-spacing:0.16em;
  text-transform:uppercase;
  border-radius:999px;
  background:linear-gradient(135deg, rgba(30,201,195,0.18), rgba(8,14,24,0.88));
  border:1px solid rgba(30,201,195,0.38);
  color:#f6f9ff;
  white-space:nowrap;
}
.home-card-action:hover,
.home-card-action:focus-visible{
  border-color:rgba(30,201,195,0.6);
  box-shadow:0 12px 24px rgba(30,201,195,0.18);
}
.home-card-body{margin-top:10px;}

/* Teams grid/cards */
.teams-grid{
  position:relative;
  display:grid;
  gap:24px;
  margin-top:28px;
  padding:8px 4px 28px;
  grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
}
.teams-grid::before{
  content:"";
  position:absolute;
  inset:0;
  background:
    radial-gradient(90% 65% at 50% 0%, rgba(30,201,195,0.2) 0%, transparent 70%),
    radial-gradient(45% 35% at 50% 12%, rgba(148,163,184,0.18) 0%, transparent 70%);
  opacity:0.65;
  filter:blur(40px);
  transform:translateY(-12%);
  pointer-events:none;
  z-index:-1;
}
.team-card{
  padding:22px 22px 20px;
  display:flex;
  flex-direction:column;
  gap:16px;
  color:#f6f9ff;
  cursor:pointer;
  transform-style:preserve-3d;
  border:1px solid rgba(212,175,55,0.18);
  background:linear-gradient(150deg, rgba(10,15,24,0.92), rgba(3,6,12,0.94));
}
.team-card.glow-card:hover,
.team-card.glow-card:focus-visible{
  transform:perspective(800px) rotateX(2deg) translateY(-10px) scale(1.03);
}
.team-card:hover .team-extra,
.team-card:focus-visible .team-extra{
  opacity:1;
  transform:translateY(0);
  max-height:160px;
}

/* Crest & primary metadata */
.team-crest{
  position:relative;
  border-radius:18px;
  background:linear-gradient(135deg, rgba(17,24,39,0.8), rgba(6,11,17,0.92));
  padding:16px;
  box-shadow:inset 0 0 0 1px rgba(148,163,184,0.25), 0 0 24px rgba(30,201,195,0.18);
  flex-shrink:0;
}
.team-logo{
  width:100%;
  aspect-ratio:5/3;
  object-fit:contain;
  border-radius:12px;
  background:linear-gradient(135deg, rgba(20,28,38,0.85), rgba(9,13,20,0.92));
  padding:12px;
}
.team-card-header{
  display:flex;
  flex-direction:column;
  gap:14px;
}
.team-meta{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:12px;
  flex-wrap:wrap;
}
.team-meta .name{
  font-weight:800;
  font-size:19px;
  text-transform:uppercase;
  letter-spacing:0.06em;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.team-meta .record{
  font-size:12px;
  font-weight:700;
  padding:6px 10px;
  border-radius:999px;
  background:linear-gradient(135deg, rgba(45,212,191,0.2), rgba(12,18,28,0.85));
  border:1px solid rgba(45,212,191,0.45);
  letter-spacing:0.14em;
  text-transform:uppercase;
  color:#f6f9ff;
}
.team-country{
  display:flex;
  align-items:center;
  gap:8px;
  margin-top:6px;
  font-size:13px;
  color:rgba(255,255,255,0.76);
  letter-spacing:0.04em;
}
.team-country img{
  width:22px;
  height:22px;
  border-radius:50%;
  box-shadow:0 0 0 2px rgba(0,0,0,0.35);
}
.jersey-swatches{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:12px;
}
.jersey-swatch{
  display:inline-flex;
  align-items:center;
  gap:6px;
  font-size:12px;
  letter-spacing:0.08em;
  text-transform:uppercase;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,0.3);
  background:linear-gradient(135deg, rgba(13,19,28,0.8), rgba(8,12,20,0.9));
  color:var(--silver);
}
.jersey-dot{
  width:12px;
  height:12px;
  border-radius:50%;
  background:var(--gold);
  box-shadow:0 0 10px rgba(212,175,55,0.6);
}
.team-manager{
  display:flex;
  align-items:center;
  gap:8px;
  font-size:13px;
  color:rgba(255,255,255,0.78);
  letter-spacing:0.05em;
}
.team-manager svg{width:16px;height:16px;color:rgba(212,175,55,0.85);}
.team-extra{
  border-top:1px solid rgba(148,163,184,0.22);
  padding-top:12px;
  display:grid;
  gap:6px;
  opacity:0;
  transform:translateY(12px);
  max-height:0;
  transition:opacity .3s ease, transform .3s ease, max-height .3s ease;
  color:rgba(235,242,255,0.72);
  font-size:12px;
  letter-spacing:0.04em;
}
.team-extra strong{color:var(--gold);font-weight:700;}

.teams-empty{
  margin-top:32px;
  padding:28px;
  border-radius:22px;
  border:1px dashed rgba(148,163,184,0.35);
  background:linear-gradient(145deg, rgba(11,15,22,0.9), rgba(5,8,13,0.92));
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:12px;
  color:rgba(235,242,255,0.72);
  text-align:center;
  box-shadow:0 18px 35px rgba(0,0,0,0.55);
}
.teams-empty .empty-icon{
  width:48px;
  height:48px;
  border-radius:16px;
  display:flex;
  align-items:center;
  justify-content:center;
  background:rgba(45,212,191,0.16);
  border:1px solid rgba(45,212,191,0.45);
  color:var(--accent);
  font-size:22px;
}

.leaderboard-table tbody tr{
  border-radius:22px;
  border:1px solid rgba(212,175,55,0.2);
  background:linear-gradient(155deg, rgba(12,18,30,0.92), rgba(4,7,14,0.94));
  box-shadow:0 22px 44px rgba(2,6,12,0.55);
  transition:transform .25s ease, box-shadow .25s ease, border-color .25s ease, background .25s ease;
}
.leaderboard-table tbody tr:hover,
.leaderboard-table tbody tr:focus-within{
  transform:translateY(-2px);
  border-color:rgba(250,204,21,0.45);
  box-shadow:0 26px 52px rgba(2,6,12,0.6);
  background:linear-gradient(155deg, rgba(16,24,38,0.95), rgba(6,10,18,0.97));
}
.leaderboard-table tbody tr td{
  background:transparent;
  border:none;
}
.leaderboard-row{ /* utility hook for JS-generated rows */
  border-radius:22px;
}
@media (max-width:1023px){
  header{flex-direction:column;align-items:flex-start;gap:16px;}
  .site-brand::after{display:none;}
  .navbar{width:100%;gap:18px;}
  .nav-group{min-width:0;}
  .nav-group-items{flex-wrap:wrap;gap:6px;}
  .teams-grid{grid-template-columns:repeat(2,minmax(220px,1fr));gap:20px;}
  .team-card{padding:20px;}
  .team-card-header{flex-direction:row;align-items:center;gap:18px;}
  .team-meta{flex:1;}
  .team-meta .record{margin-top:0;}
  .team-crest{padding:14px;}
}
@media (max-width:768px){
  .navbar{padding-bottom:2px;}
  .navbar button{padding:8px 14px;font-size:12px;}
  .teams-grid{grid-template-columns:1fr;gap:16px;}
  .team-card{padding:16px 18px;gap:14px;}
  .team-card-header{flex-direction:row;align-items:center;gap:16px;}
  .team-crest{width:92px;padding:12px;}
  .team-logo{max-width:80px;margin:0 auto;}
  .team-meta .name{font-size:16px;}
  .team-meta{gap:6px;}
  .team-meta .record{font-size:11px;padding:5px 9px;letter-spacing:0.12em;}
  .team-meta .record{align-self:flex-start;}
  .team-country{margin-top:4px;font-size:12px;}
  .jersey-swatches{margin-top:8px;gap:6px;}
  .jersey-swatch{padding:5px 8px;font-size:10px;}
  .team-manager{font-size:11px;margin-top:4px;}
  #rankingsTableWrap{padding-left:1.25rem;padding-right:1.25rem;overflow-x:visible;}
  .leaderboard-table{border-spacing:0;}
  .leaderboard-table thead{display:none;}
  .leaderboard-table tbody{display:flex;flex-direction:column;gap:16px;}
  .leaderboard-table tbody tr{display:flex;flex-direction:column;padding:18px 16px;gap:8px;}
  .leaderboard-table tbody tr td{display:flex;align-items:center;justify-content:space-between;gap:12px;width:100%;padding:6px 0;font-size:13px;}
  .leaderboard-table tbody tr td::before{content:attr(data-label) ': ';font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.18em;color:rgba(250,204,21,0.75);margin-right:12px;flex:0 0 auto;}
  .leaderboard-table tbody tr td:first-child{padding-top:0;}
  .leaderboard-table tbody tr td:last-child{padding-bottom:0;}
  .leaderboard-table tbody tr td > .pointer-events-none{display:none !important;}
  .brand-tagline{letter-spacing:0.24em;font-size:10px;}
  .players-grid{gap:14px;}
  .player-card{min-height:260px;padding:18px;}
  .player-stat-grid{gap:10px;}
  .player-stat .stat-value{font-size:18px;}
  .player-name{font-size:16px;}
}
@media (max-width:480px){
  .team-card{padding:14px 16px;gap:12px;}
  .team-card-header{gap:14px;}
  .team-crest{width:78px;padding:10px;}
  .team-logo{max-width:72px;}
  .team-meta .name{font-size:15px;}
  .team-meta .record{font-size:10px;padding:4px 8px;letter-spacing:0.1em;}
  .team-country{font-size:11px;}
  .jersey-swatch{padding:4px 7px;font-size:9px;letter-spacing:0.06em;}
  .leaderboard-table tbody tr{padding:16px 14px;}
  .leaderboard-table tbody tr td{font-size:12px;gap:10px;}
  .leaderboard-table tbody tr td::before{font-size:10px;letter-spacing:0.16em;}
  .player-card{padding:16px;min-height:240px;}
  .player-avatar{width:72px;height:72px;}
  .player-stat-grid{grid-template-columns:1fr;}
}
.players-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 18px;
  justify-items: stretch;
  margin-top: 12px;
  width: 100%;
}
.players-grid.compact{grid-template-columns:repeat(auto-fit,minmax(220px,1fr));}
@media (min-width:640px){
  .players-grid{grid-template-columns:repeat(2,minmax(0,1fr));}
}
@media (min-width:1024px){
  .players-grid{grid-template-columns:repeat(3,minmax(0,1fr));}
}
.team-card > .players-grid{display:none}
.player-card{
  --card-primary:#0f172a;
  --card-secondary:#1f2937;
  --card-accent:#38bdf8;
  --card-glow:var(--card-accent);
  --card-glow-shadow:rgba(56,189,248,0.45);
  position:relative;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:16px;
  padding:20px;
  border-radius:20px;
  background:linear-gradient(160deg,var(--card-primary),var(--card-secondary));
  color:#f8fafc;
  box-shadow:0 18px 45px rgba(2,6,23,0.55);
  border:1px solid rgba(255,255,255,0.08);
  min-height:280px;
  overflow:hidden;
  transition:transform .3s ease, box-shadow .3s ease, border-color .3s ease;
  text-align:center;
}
.player-card::before{
  content:"";
  position:absolute;
  inset:0;
  border-radius:inherit;
  background-image:var(--player-card-photo);
  background-size:cover;
  background-position:center;
  background-repeat:no-repeat;
  opacity:0;
  transition:opacity .4s ease;
  pointer-events:none;
  z-index:0;
}
.player-card::after{
  content:"";
  position:absolute;
  inset:0;
  border-radius:inherit;
  background:linear-gradient(180deg,rgba(255,255,255,0.08),rgba(15,23,42,0.05));
  mix-blend-mode:screen;
  border:1px solid rgba(255,255,255,0.06);
  pointer-events:none;
  transition:opacity .3s ease, box-shadow .3s ease, border-color .3s ease;
  opacity:0.7;
  z-index:1;
}
.player-card > *{position:relative;z-index:2;}
.player-card[data-has-photo="true"]::before{opacity:1;}
.player-card:hover,
.player-card:focus-visible{
  outline:none;
  transform:translateY(-8px) scale(1.02);
  box-shadow:0 26px 60px rgba(2,6,23,0.65),0 0 40px var(--card-glow-shadow, rgba(56,189,248,0.18));
  border-color:var(--card-glow);
}
.player-card:hover::after,
.player-card:focus-visible::after{
  border-color:var(--card-glow);
  box-shadow:0 0 0 2px var(--card-glow-shadow, rgba(56,189,248,0.45));
  opacity:1;
}
.player-card[data-is-captain="false"] .player-card-badge{display:none;}
.player-card-badge{
  position:absolute;
  top:14px;
  right:14px;
  font-size:20px;
  filter:drop-shadow(0 4px 10px rgba(0,0,0,0.55));
  z-index:2;
}
.player-card-top,
.player-card-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  width:100%;
  gap:12px;
}
.player-card-header{padding-inline:4px;}
.player-form-indicator{
  display:flex;
  align-items:center;
  gap:6px;
  min-height:16px;
}
.player-form-indicator .player-form-dot{
  width:10px;
  height:10px;
  border-radius:999px;
  background:rgba(148,163,184,0.35);
  box-shadow:0 0 12px rgba(15,23,42,0.65);
  transition:transform .3s ease, box-shadow .3s ease, opacity .3s ease;
}
.player-form-indicator .player-form-dot.W{background:rgba(34,197,94,0.85);box-shadow:0 0 14px rgba(34,197,94,0.55);}
.player-form-indicator .player-form-dot.D{background:rgba(148,163,184,0.85);box-shadow:0 0 12px rgba(148,163,184,0.55);}
.player-form-indicator .player-form-dot.L{background:rgba(239,68,68,0.85);box-shadow:0 0 14px rgba(239,68,68,0.55);}
.player-form-indicator .player-form-dot.empty{opacity:0.35;}
.player-card:hover .player-form-indicator .player-form-dot,
.player-card:focus-visible .player-form-indicator .player-form-dot{transform:translateY(-1px);}
.player-card-info{
  text-align:center;
  display:flex;
  flex-direction:column;
  gap:6px;
}
.player-club{
  font-size:12px;
  letter-spacing:0.22em;
  text-transform:uppercase;
  color:rgba(226,232,240,0.6);
}
.player-position-chip{
  font-size:11px;
  font-weight:700;
  letter-spacing:0.28em;
  text-transform:uppercase;
  padding:6px 14px;
  border-radius:999px;
  background:rgba(15,23,42,0.75);
  border:1px solid rgba(255,255,255,0.12);
  color:rgba(226,232,240,0.9);
  box-shadow:0 8px 20px rgba(2,6,23,0.4);
}
.player-ovr-pill{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  align-self:center;
  padding:8px 20px;
  border-radius:999px;
  background:rgba(15,23,42,0.72);
  border:1px solid rgba(255,255,255,0.12);
  box-shadow:0 12px 28px rgba(2,6,23,0.45);
}
.player-ovr-pill .ovr-label{
  font-size:11px;
  letter-spacing:0.34em;
  text-transform:uppercase;
  color:rgba(226,232,240,0.6);
}
.player-ovr-pill .ovr-value{
  font-size:24px;
  font-weight:800;
  color:#f8fafc;
}
.player-avatar{
  --avatar-primary:rgba(15,23,42,0.92);
  --avatar-secondary:rgba(30,64,175,0.68);
  position:relative;
  width:84px;
  height:84px;
  margin:0 auto;
  border-radius:999px;
  display:flex;
  align-items:center;
  justify-content:center;
  background:linear-gradient(135deg,var(--avatar-primary),var(--avatar-secondary));
  border:3px solid var(--avatar-ring, rgba(255,255,255,0.12));
  box-shadow:0 16px 36px rgba(2,6,23,0.55);
  transition:transform .3s ease, box-shadow .3s ease;
  overflow:hidden;
}
.player-card:hover .player-avatar,
.player-card:focus-visible .player-avatar{
  transform:translateY(-2px);
  box-shadow:0 22px 44px rgba(2,6,23,0.6);
}
.player-avatar::after{
  content:"";
  position:absolute;
  inset:0;
  border-radius:inherit;
  background:radial-gradient(circle at 30% 30%,rgba(255,255,255,0.22),transparent 65%);
  mix-blend-mode:screen;
  pointer-events:none;
}
.player-avatar-img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:none;
}
.player-avatar.has-image{
  background:#020617;
}
.player-avatar.has-image::after{opacity:0;}
.player-avatar.has-image .player-avatar-img{display:block;}
.player-avatar-initial{
  font-size:28px;
  font-weight:800;
  letter-spacing:0.08em;
  text-transform:uppercase;
  z-index:1;
}
.player-avatar.has-image .player-avatar-initial{opacity:0;}
.player-meta{
  text-align:center;
  display:flex;
  flex-direction:column;
  gap:6px;
}
.player-name-row{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  flex-wrap:wrap;
}
.player-name{font-size:18px;font-weight:800;letter-spacing:0.04em;}
.player-flag{width:22px;height:22px;border-radius:50%;object-fit:cover;box-shadow:0 0 0 2px rgba(255,255,255,0.18);}
.player-position{
  font-size:12px;
  font-weight:700;
  letter-spacing:0.24em;
  text-transform:uppercase;
  color:rgba(226,232,240,0.7);
}
.player-stat-grid{
  display:grid;
  grid-template-columns:repeat(2,minmax(0,1fr));
  gap:12px;
  margin-top:auto;
}
.player-stat{
  background:rgba(15,23,42,0.58);
  border:1px solid rgba(255,255,255,0.08);
  border-radius:16px;
  padding:10px 12px;
  display:flex;
  flex-direction:column;
  gap:4px;
  min-height:72px;
  transition:border-color .3s ease, transform .3s ease;
}
.player-card:hover .player-stat,
.player-card:focus-visible .player-stat{border-color:rgba(255,255,255,0.14);}
.player-stat .stat-label{
  font-size:11px;
  letter-spacing:0.16em;
  text-transform:uppercase;
  color:rgba(226,232,240,0.6);
}
.player-stat .stat-value{
  font-size:20px;
  font-weight:800;
  color:#f8fafc;
}
.player-stat.top-scorer .stat-value{color:var(--gold);}
.player-card-actions{
  width:100%;
  display:none;
  justify-content:center;
  margin-top:4px;
}
.is-admin .player-card-actions{display:flex;}
.upload-btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:6px;
  padding:6px 14px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,0.18);
  background:rgba(15,23,42,0.55);
  font-size:11px;
  letter-spacing:0.26em;
  text-transform:uppercase;
  color:rgba(226,232,240,0.85);
  cursor:pointer;
  transition:transform .25s ease, box-shadow .25s ease, border-color .25s ease, background .25s ease;
}
.upload-btn:hover,
.upload-btn:focus-visible{
  outline:none;
  transform:translateY(-1px);
  border-color:var(--card-glow);
  box-shadow:0 16px 30px rgba(2,6,23,0.45),0 0 20px var(--card-glow-shadow, rgba(56,189,248,0.25));
  background:rgba(15,23,42,0.75);
}
.upload-btn.is-uploading{
  pointer-events:none;
  opacity:0.65;
}
.upload-btn:focus-visible{box-shadow:0 0 0 2px rgba(255,255,255,0.28),0 0 20px var(--card-glow-shadow, rgba(56,189,248,0.28));}
.player-upload-input{display:none;}

/* Generic card wrappers */
.m-card{padding:0;}
.m-card.glow-card{padding:24px;}
.m-card strong{font-weight:700;letter-spacing:0.08em;text-transform:uppercase;}
.mini-card{padding:0;}
.mini-card.glow-card{padding:18px;}

/* Squad editor */
.squad-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:18px;margin-top:14px}

/* Fixtures list */
.fx-list{display:flex;flex-direction:column;gap:16px}
.fx{
  display:grid;
  grid-template-columns:1fr auto 1fr;
  gap:12px;
  align-items:center;
  padding:0;
}
.fx.glow-card{padding:20px;}
.fx .meta{font-size:12px;color:var(--muted)}
.fx .act{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end}
.fx button{
  background:linear-gradient(135deg, rgba(45,212,191,0.2), rgba(15,23,42,0.92));
  border:1px solid rgba(45,212,191,0.45);
  color:#f6f9ff;
  border-radius:10px;
  padding:8px 12px;
  cursor:pointer;
  transition:transform .25s ease, box-shadow .25s ease, border-color .25s ease;
}
.fx button:hover,
.fx button:focus-visible{
  outline:none;
  transform:translateY(-2px);
  border-color:rgba(212,175,55,0.55);
  box-shadow:0 12px 24px rgba(212,175,55,0.2);
}
.fx-banner{width:100%;max-height:120px;object-fit:cover;border-radius:8px;margin:6px 0}
.fx-vs{display:flex;align-items:center;gap:10px;font-weight:800}
.fx-team{display:inline-flex;align-items:center;gap:8px;min-width:0}
.fx-team img{width:32px;height:32px;border-radius:50%;object-fit:cover;background:rgba(15,23,42,0.8);box-shadow:0 0 0 2px rgba(45,212,191,0.25)}
.fx-team span{display:inline-block;max-width:160px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

.score-pill{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:4px 12px;
  border-radius:999px;
  font-weight:700;
  letter-spacing:0.08em;
  text-transform:uppercase;
  background:rgba(15,23,42,0.78);
  border:1px solid rgba(148,163,184,0.28);
  color:var(--silver);
}
.score-pill.score-final{color:var(--gold);border-color:rgba(212,175,55,0.45);}
.score-pill.score-upcoming{color:rgba(45,212,191,0.95);border-color:rgba(45,212,191,0.35);}

.match-card{display:flex;flex-direction:column;gap:6px;font-size:16px;padding:0;}
.match-card.glow-card{padding:18px;}
.match-card small{color:var(--muted);}
.match-card .match-line{display:flex;align-items:center;flex-wrap:wrap;gap:6px;justify-content:center;font-weight:600;letter-spacing:0.04em;text-transform:uppercase;}
.match-card .club{color:#f6f9ff;}
.match-card .score{font-weight:800;color:rgba(45,212,191,0.95);font-size:20px;}
.match-card .score.score-gold{color:var(--gold);}
.match-card .score.score-silver{color:var(--silver);}
.match-card .score-pill{margin:0 8px;}

/* Results modal (sheet editor) */
.modal{position:fixed;inset:0;background:rgba(3,6,12,0.85);display:none;align-items:center;justify-content:center;z-index:1000}
.modal.show{display:flex}
.dialog{background:linear-gradient(145deg, rgba(11,15,22,0.94), rgba(5,8,13,0.95));border:1px solid rgba(94,234,212,0.28);border-radius:20px;padding:22px;width:min(960px,96vw);max-height:96vh;overflow:auto;box-shadow:0 28px 60px rgba(0,0,0,0.65)}
.dialog h3{margin:0 0 8px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.sheet{border:1px solid rgba(148,163,184,0.24);border-radius:14px;padding:12px;background:linear-gradient(145deg, rgba(13,19,28,0.85), rgba(8,12,20,0.92));box-shadow:inset 0 0 0 1px rgba(45,212,191,0.08)}
.sheet table{width:100%;border-collapse:collapse}
.sheet th,.sheet td{border-bottom:1px solid rgba(148,163,184,0.15);padding:6px}
.sheet th{font-size:12px;color:var(--muted);text-align:left}
.sheet select,.sheet input, .dialog textarea{width:100%;background:rgba(6,10,16,0.85);color:#f6f9ff;border:1px solid rgba(94,234,212,0.28);border-radius:10px;padding:10px}
/* Ensure numeric inputs in result sheet are wide enough to show values */
.sheet td input[type=number]{
  padding:4px;
  min-width:36px;
  text-align:center;
}
.sheet .row-btns{display:flex;gap:6px}
.dialog .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

/* News feed (social style) */
.news-wrap{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:20px;width:100%;margin:0 auto}
.news-post{display:flex;flex-direction:column;gap:12px;width:100%;padding:22px;position:relative}
.news-post.glow-card{padding:22px}
.news-post.news-manual{grid-column:1/-1;padding:28px;gap:18px}
.news-avatar{width:52px;height:52px;border-radius:14px;object-fit:cover;background:rgba(15,23,42,0.8);flex:0 0 auto;box-shadow:0 0 0 2px rgba(45,212,191,0.25)}
.news-body{flex:1;text-align:left;font-size:16px;line-height:1.6;color:#f8fafc}
.news-title{font-weight:800;margin-bottom:4px;font-size:22px}
.news-meta{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:0.18em;margin-top:4px}
.news-badge{font-size:11px;letter-spacing:0.22em;text-transform:uppercase;color:rgba(148,163,184,0.75)}
.news-stats{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:12px}
.news-stat-row{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-radius:14px;background:rgba(15,23,42,0.55);border:1px solid rgba(148,163,184,0.15)}
.news-stat-row .rank{font-size:18px;font-weight:800;color:var(--gold);margin-right:12px}
.news-stat-row .stat-club{flex:1;font-weight:600}
.news-stat-row .stat-meta{font-size:13px;color:var(--muted)}
.news-chart{width:100%;height:220px}
.news-highlight{display:flex;align-items:center;justify-content:space-between;gap:20px;padding:14px 18px;border-radius:18px;background:rgba(148,163,184,0.08);border:1px solid rgba(148,163,184,0.18)}
.news-highlight .club{display:flex;align-items:center;gap:12px;font-weight:700;font-size:16px}
.news-highlight .club img{width:46px;height:46px;border-radius:50%;object-fit:cover;background:rgba(15,23,42,0.9);box-shadow:0 0 0 2px rgba(148,163,184,0.2)}
.news-highlight .score{font-size:34px;font-weight:800;color:var(--gold);text-shadow:0 0 18px rgba(250,204,21,0.25)}
.news-media{border-radius:18px;overflow:hidden;box-shadow:0 26px 50px rgba(0,0,0,0.45)}
.news-media img,.news-media iframe,.news-media video{display:block;width:100%}
.news-manual .news-body{font-size:17px}
.news-admin-actions{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap;margin-top:4px}
.news-admin-actions button{min-width:0;padding:8px 12px;font-size:11px;letter-spacing:0.16em;text-transform:uppercase}
.news-admin-actions button.danger{color:#fca5a5;border-color:rgba(248,113,113,0.55)}
.news-admin-actions button.danger:hover,
.news-admin-actions button.danger:focus-visible{color:#fecaca;border-color:rgba(248,113,113,0.85);box-shadow:0 12px 24px rgba(248,113,113,0.25)}
.news-hidden-gem{gap:16px;background:linear-gradient(160deg, rgba(40,30,5,0.92), rgba(15,15,20,0.94));border:1px solid rgba(250,204,21,0.35)}
.news-hidden-gem .news-badge{color:rgba(250,204,21,0.85)}
.hidden-gem-header{display:flex;flex-wrap:wrap;align-items:flex-start;justify-content:space-between;gap:18px}
.hidden-gem-player{display:flex;flex-direction:column;gap:4px}
.hidden-gem-name{font-size:24px;font-weight:800;letter-spacing:0.04em}
.hidden-gem-meta{font-size:13px;letter-spacing:0.18em;text-transform:uppercase;color:rgba(250,240,197,0.75)}
.hidden-gem-overall{display:flex;align-items:center;gap:10px;padding:8px 14px;border-radius:999px;background:rgba(0,0,0,0.35);border:1px solid rgba(250,204,21,0.45);box-shadow:0 12px 32px rgba(250,204,21,0.18)}
.hidden-gem-overall .label{font-size:12px;letter-spacing:0.28em;text-transform:uppercase;color:rgba(250,240,197,0.8)}
.hidden-gem-overall .value{font-size:26px;font-weight:800;color:#fdf6b2}
.hidden-gem-overall .potential{font-size:12px;letter-spacing:0.16em;text-transform:uppercase;color:rgba(252,211,77,0.8)}
.hidden-gem-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px}
.hidden-gem-stat{display:flex;flex-direction:column;gap:6px;padding:12px 14px;border-radius:16px;background:rgba(12,8,0,0.6);border:1px solid rgba(250,204,21,0.25)}
.hidden-gem-stat .stat-label{font-size:11px;letter-spacing:0.18em;text-transform:uppercase;color:rgba(250,240,197,0.7)}
.hidden-gem-stat .stat-value{font-size:20px;font-weight:800;color:#fdf6b2}
.hidden-gem-traits{display:flex;flex-wrap:wrap;gap:10px;padding:6px 0}
.hidden-gem-traits span{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:999px;background:rgba(250,204,21,0.16);border:1px solid rgba(250,204,21,0.32);font-size:11px;letter-spacing:0.16em;text-transform:uppercase;color:rgba(250,240,197,0.85)}

.competitions-admin-controls{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:12px}
.competitions-admin-intro{color:var(--muted);font-size:13px;letter-spacing:0.08em;text-transform:uppercase}
.competition-defaults{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-top:10px}
.competition-defaults label{display:flex;flex-direction:column;gap:4px;font-size:11px;letter-spacing:0.18em;text-transform:uppercase;color:rgba(226,232,240,0.7)}
.competition-defaults input{background:rgba(15,23,42,0.75);border:1px solid rgba(148,163,184,0.3);border-radius:12px;padding:10px 12px;color:#f8fafc;font-size:14px}
.competition-defaults input:focus{outline:none;border-color:rgba(94,234,212,0.45);box-shadow:0 0 0 2px rgba(94,234,212,0.2)}
.competition-defaults small{font-size:10px;letter-spacing:0.12em;text-transform:uppercase;color:rgba(148,163,184,0.8)}
.pending-matches-list{display:grid;gap:18px;margin-top:16px}
.pending-match-card{position:relative;display:flex;flex-direction:column;gap:14px;padding:22px;border-radius:20px;background:linear-gradient(150deg, rgba(9,13,20,0.9), rgba(3,6,12,0.92));border:1px solid rgba(94,234,212,0.25)}
.pending-match-card .pending-match-header{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:12px}
.pending-match-card .pending-match-score{display:flex;align-items:center;gap:10px;font-size:20px;font-weight:800;letter-spacing:0.08em;text-transform:uppercase;color:#f8fafc}
.pending-match-card .pending-match-score span{display:flex;align-items:center;gap:8px}
.pending-match-card .pending-match-score .score{font-size:26px;color:var(--gold);text-shadow:0 0 16px rgba(250,204,21,0.28)}
.pending-match-card .pending-match-meta{font-size:11px;letter-spacing:0.22em;text-transform:uppercase;color:rgba(148,163,184,0.7)}
.pending-player-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
.pending-player{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 12px;border-radius:14px;background:rgba(15,23,42,0.65);border:1px solid rgba(148,163,184,0.25)}
.pending-player .info{display:flex;flex-direction:column;gap:2px;font-size:13px}
.pending-player .info .club{font-size:11px;letter-spacing:0.12em;text-transform:uppercase;color:rgba(148,163,184,0.75)}
.pending-player .stat{display:flex;align-items:center;gap:10px;font-weight:700;color:#f8fafc}
.pending-match-form{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
.pending-match-form label{display:flex;flex-direction:column;gap:4px;font-size:11px;letter-spacing:0.16em;text-transform:uppercase;color:rgba(226,232,240,0.75)}
.pending-match-form input{background:rgba(15,23,42,0.78);border:1px solid rgba(148,163,184,0.28);border-radius:12px;padding:10px 12px;color:#f8fafc;font-size:14px}
.pending-match-form input:focus{outline:none;border-color:rgba(94,234,212,0.45);box-shadow:0 0 0 2px rgba(94,234,212,0.2)}
.pending-match-actions{display:flex;flex-wrap:wrap;justify-content:flex-end;gap:10px}
.pending-match-actions button{min-width:0;padding:10px 16px;font-size:11px;letter-spacing:0.16em;text-transform:uppercase}
.pending-match-actions button.approve{background:linear-gradient(135deg, rgba(45,212,191,0.25), rgba(15,23,42,0.95));border:1px solid rgba(45,212,191,0.5)}
.pending-match-actions button.reject{color:#fecaca;border-color:rgba(248,113,113,0.55);background:linear-gradient(135deg, rgba(46,12,12,0.65), rgba(15,23,42,0.92))}
.pending-match-actions button.reject:hover,
.pending-match-actions button.reject:focus-visible{border-color:rgba(248,113,113,0.85);box-shadow:0 12px 24px rgba(248,113,113,0.25);color:#fee2e2}

/* Champions Cup groups — compact standings only */
.group-grid{display:grid;gap:16px}
.group-card{padding:0;overflow:hidden}
.group-card.glow-card{padding:18px;}
.group-title{font-weight:800;margin:0 0 10px;letter-spacing:0.08em;text-transform:uppercase}
.group-table{width:100%;border-collapse:collapse;background:linear-gradient(145deg, rgba(9,13,20,0.8), rgba(4,6,12,0.85));border-radius:16px;overflow:hidden}
.group-table th,.group-table td{padding:8px 10px;border-bottom:1px solid rgba(148,163,184,0.16);text-align:right;font-variant-numeric:tabular-nums}
.group-table th{color:rgba(226,232,240,0.9);text-transform:uppercase;font-size:12px;letter-spacing:0.1em;background:rgba(15,23,42,0.75)}
.group-table th:first-child,.group-table td:first-child{text-align:left}
.group-table tbody tr{transition:background .25s ease;}
.group-table tbody tr:hover{background:rgba(45,212,191,0.12)}
.group-table tbody tr td:last-child{font-weight:700;color:rgba(226,232,240,0.9);}
.group-table tbody tr:first-child td:last-child{color:var(--gold);}
.group-table tbody tr:nth-child(2) td:last-child{color:rgba(45,212,191,0.95);}
.group-table tbody tr:nth-child(3) td:last-child{color:var(--silver);}
.standings-table{padding:0;overflow:hidden;border-radius:22px;}
.standings-table.glow-card{padding:0;}
.league-table{width:100%;border-collapse:collapse;background:linear-gradient(145deg, rgba(9,13,20,0.85), rgba(4,6,12,0.88));}
.league-table th,.league-table td{padding:10px 12px;border-bottom:1px solid rgba(148,163,184,0.16);text-align:right;font-variant-numeric:tabular-nums}
.league-table th{color:rgba(226,232,240,0.88);font-size:12px;letter-spacing:0.12em;text-transform:uppercase;background:rgba(15,23,42,0.78)}
.league-table th:first-child,.league-table td:first-child{text-align:center}
.league-table th:nth-child(2),.league-table td:nth-child(2){text-align:left}
.league-table tbody tr{transition:background .25s ease;}
.league-table tbody tr:hover{background:rgba(45,212,191,0.1)}
.league-table .club-name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:160px}
.league-grid{display:grid;grid-template-columns:2fr 1fr;gap:20px;align-items:start}
.podium-list{display:flex;flex-direction:column;gap:12px}
.podium-row{display:flex;align-items:center;gap:8px}
.podium-row .player-card{width:100px;height:140px;flex:0 0 100px}
.podium-info{font-size:14px}
.form-cell{display:flex;gap:4px;justify-content:flex-start}
.form-cell span{width:12px;height:12px;border-radius:50%;box-shadow:0 0 8px rgba(15,23,42,0.45)}
.form-cell span.W{background:var(--emerald)}
.form-cell span.D{background:rgba(148,163,184,0.85)}
.form-cell span.L{background:rgba(239,68,68,0.85)}
.league-table tr.top4{box-shadow:inset 3px 0 0 rgba(45,212,191,0.6)}
.league-table tbody tr td:nth-child(8){font-weight:700;color:rgba(226,232,240,0.9);}
.league-table tbody tr.rank-1 td:nth-child(8){color:var(--gold);}
.league-table tbody tr.rank-2 td:nth-child(8){color:rgba(45,212,191,0.95);}
.league-table tbody tr.rank-3 td:nth-child(8){color:var(--silver);}
.stats-row{display:flex;align-items:center;gap:12px;padding:10px 12px;border-bottom:1px solid rgba(148,163,184,0.12)}
.stats-row .rank-badge{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:50%;background:rgba(148,163,184,0.16);font-weight:700;font-size:13px;color:#f6f9ff;box-shadow:0 0 12px rgba(148,163,184,0.12);}
.stats-row .rank-badge+img{margin-left:4px;}
.stats-row .player-kit,.stats-row .player-silhouette{position:static;transform:none;width:60px;height:auto;flex-shrink:0}
.stats-row .player-kit-box{position:static;transform:none;width:60px;height:60px;border-radius:6px;flex-shrink:0}
.stats-row .info{flex:1;min-width:0;line-height:1.2}
.stats-row .info div:first-child{font-weight:600;font-size:14px}
.stats-row .value{margin-left:auto;font-size:16px;font-weight:700;color:#f6f9ff;text-align:right}
.stats-row[data-rank="1"] .value{color:var(--gold);}
.stats-row[data-rank="2"] .value{color:rgba(45,212,191,0.95);}
.stats-row[data-rank="3"] .value{color:var(--silver);}
.group-team{display:inline-flex;align-items:center;gap:8px}
.group-team img{width:18px;height:18px;border-radius:3px;object-fit:cover}

/* Leaderboards layout */
.leaderboards{display:grid;gap:16px;margin-top:12px}
.leaderboards .m-card strong{display:block;font-size:18px;font-weight:700;margin-bottom:8px;text-align:center}

@media (max-width:768px){
  .standings-table{font-size:14px;overflow-x:auto}
  .standings-table table{min-width:480px}
  .league-grid{display:block}
  .stats-section{display:block}
  .player-card{transform:scale(0.85);margin:8px auto}
  .player-name{font-size:14px}
}

/* Champions Cup bracket */
.bracket-grid{display:grid;gap:16px}
.bracket-card{padding:0;text-align:center}
.bracket-card.glow-card{padding:18px;}
.bracket-match{display:flex;flex-direction:column;gap:4px}
.bracket-vs{font-size:12px;color:var(--muted)}

/* Mobile & small tablets */
@media (max-width: 900px){
  .teams-grid{gap:20px;}
  .fx-team span{max-width:120px}
  .league-grid{grid-template-columns:1fr}
}
@media (max-width: 640px){
  main{padding:14px}
  .team-logo{aspect-ratio:16/9}       /* slightly shorter on phones */
  .teams-grid{gap:14px}
  .news-wrap{grid-template-columns:1fr}
  .news-post{padding:18px}
  .news-post.news-manual{padding:22px}
  .news-highlight{flex-direction:column;align-items:flex-start}
  .news-highlight .score{font-size:28px}
  .news-avatar{width:44px;height:44px}
  .grid2{grid-template-columns:1fr}   /* modals stack */
  .fx{grid-template-columns:1fr;gap:8px}
  .fx .act{justify-content:flex-start}
}
/* Motion-safe */
@media (prefers-reduced-motion: reduce){
  .team-card,.navbar button{transition:none}
}

/* Intro splash */
#intro{
  position:fixed;
  inset:0;
  background:#000;
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:9999;
  transition:opacity 1s ease;
}
#intro.hidden{opacity:0;pointer-events:none;}
#intro img{max-width:80vw;max-height:80vh;}
</style>
</head>
<body>
<div id="intro">
    <img src="/assets/logos/UPCL.png" alt="League logo">
  <audio id="introAudio" src="/intro.mp3"></audio>
</div>
<header class="flex flex-wrap items-center gap-4 md:gap-6">
  <div class="site-brand">
    <div class="brand-mark">UP</div>
    <div class="brand-copy">
      <h1>UPCL</h1>
      <div class="brand-tagline">United Pro Clubs League</div>
    </div>
  </div>
  <button
    type="button"
    id="navToggle"
    class="ml-auto inline-flex h-10 w-10 items-center justify-center rounded-xl border border-yellow-400/40 bg-black/30 p-2 text-yellow-100 shadow-[0_8px_20px_rgba(15,23,42,0.5)] transition hover:border-yellow-300/70 hover:bg-black/50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-yellow-200/60 md:hidden"
    aria-expanded="false"
    aria-controls="primaryNav"
  >
    <span class="sr-only">Toggle navigation</span>
    <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <line x1="3" y1="6" x2="21" y2="6" />
      <line x1="3" y1="12" x2="21" y2="12" />
      <line x1="3" y1="18" x2="21" y2="18" />
    </svg>
  </button>
  <nav id="primaryNav" class="navbar hidden w-full flex-col gap-6 md:ml-auto md:flex md:w-auto md:flex-row md:items-stretch" aria-label="Primary navigation">
    <div class="nav-group" aria-label="Main">
      <span class="nav-group-label">Main</span>
      <div class="nav-group-items">
        <button type="button" id="navHome" data-view="home" aria-pressed="false">
          <span class="nav-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 10.5 12 3l9 7.5" />
              <path d="M5 11v9h5v-5h4v5h5v-9" />
            </svg>
          </span>
          <span>Home</span>
        </button>
        <button type="button" id="navTeams" aria-pressed="true">
          <span class="nav-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <path d="M7 20v-4a3 3 0 0 1 3-3h4a3 3 0 0 1 3 3v4" />
              <circle cx="12" cy="7" r="3.5" />
            </svg>
          </span>
          <span>Teams</span>
        </button>
        <button type="button" id="navRankings" aria-pressed="false">
          <span class="nav-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 18V5" />
              <path d="M15 18v-8" />
              <path d="M21 18v-4" />
              <path d="M3 18v-2" />
              <path d="M21 20H3" />
            </svg>
          </span>
          <span>Rankings</span>
        </button>
        <button type="button" id="navNews" aria-pressed="false">
          <span class="nav-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4 5h16v14H5.5A1.5 1.5 0 0 1 4 17.5V5z" />
              <path d="M8 9h8" />
              <path d="M8 13h5" />
            </svg>
          </span>
          <span>News</span>
        </button>
        <button type="button" id="navFixturesPublic" aria-pressed="false">
          <span class="nav-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="5" width="18" height="16" rx="2" />
              <path d="M16 3v4" />
              <path d="M8 3v4" />
              <path d="M3 11h18" />
            </svg>
          </span>
          <span>Fixtures</span>
        </button>
        <button type="button" id="navFixturesSched" aria-pressed="false" style="display:none">
          <span class="nav-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 8v5l3 1.5" />
              <circle cx="12" cy="12" r="9" />
            </svg>
          </span>
          <span>Scheduling</span>
        </button>
        <button type="button" id="navLeague" aria-pressed="false">
          <span class="nav-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4 4h16l-1 12-7 4-7-4-1-12z" />
              <path d="m8 11 4 2 4-2" />
            </svg>
          </span>
          <span>League</span>
        </button>
      </div>
    </div>
    <div class="nav-group" aria-label="Tournaments">
      <span class="nav-group-label">Tournaments</span>
      <div class="nav-group-items">
        <button type="button" id="navChampions" aria-pressed="false">
          <span class="nav-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <path d="M5 4h14a2 2 0 0 1 2 2v1a5 5 0 0 1-5 5h-1" />
              <path d="M19 4a5 5 0 0 1-10 0" />
              <path d="M7 4h-.5A1.5 1.5 0 0 0 5 5.5V7a5 5 0 0 0 5 5h1" />
              <path d="M8 15h8" />
              <path d="M9 21h6" />
              <path d="M10 15v6" />
              <path d="M14 15v6" />
            </svg>
          </span>
          <span>Champions Cup</span>
        </button>
        <button type="button" id="navFriendlies" aria-pressed="false">
          <span class="nav-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <path d="M7 11a5 5 0 1 1 5-5" />
              <path d="m12 6.5 3.5 3.5" />
              <path d="M17 11a5 5 0 1 0-5-5" />
              <path d="m12 17-2.5 2.5a2 2 0 0 1-2.83 0L4 16" />
              <path d="m12 17 2.5 2.5a2 2 0 0 0 2.83 0L20 16" />
            </svg>
          </span>
          <span>Friendlies</span>
        </button>
      </div>
    </div>
    <div class="nav-group" aria-label="Admin">
      <span class="nav-group-label">Admin</span>
      <div class="nav-group-items">
        <button type="button" id="btnAdminLogin">
          <span class="nav-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 22a10 10 0 0 0 10-10V7l-10-4L2 7v5a10 10 0 0 0 10 10z" />
              <path d="M8.5 12.5 11 15l4.5-4.5" />
            </svg>
          </span>
          <span>Admin Sign In</span>
        </button>
        <button type="button" id="navAdminCompetitions" aria-pressed="false" style="display:none">
          <span class="nav-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4 4h16l-1 12-7 4-7-4-1-12z" />
              <path d="M9 13h6" />
              <path d="M9 9h6" />
              <path d="M10 5v4" />
              <path d="M14 5v4" />
              <path d="M8 17h8" />
            </svg>
          </span>
          <span>Competition Queue</span>
        </button>
        <button type="button" id="btnAdminLogout" style="display:none">
          <span class="nav-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4" />
              <path d="M10 17 15 12 10 7" />
              <path d="M15 12H3" />
            </svg>
          </span>
          <span>Admin Sign Out</span>
        </button>
      </div>
    </div>
  </nav>
</header>

<main class="relative mx-auto max-w-6xl px-3 pt-6 pb-16 text-xs sm:px-6 sm:pt-8 sm:pb-20 sm:text-sm md:px-10 md:pt-12 md:pb-24 md:text-base">
  <section id="home" class="tab-content space-y-6 p-2 sm:p-4 md:p-8" style="display:none">
    <div class="home-grid grid grid-cols-1 gap-4 sm:grid-cols-2 xl:grid-cols-3">
      <div class="m-card glow-card glow-green">
        <strong>Match of the Day</strong>
        <div id="homeMotd" class="muted" style="margin-top:6px">Loading…</div>
      </div>
      <div class="m-card glow-card glow-silver">
        <strong>Latest News</strong>
        <div id="homeNews" class="news-wrap" style="margin-top:6px"><div class="muted">Loading…</div></div>
      </div>
      <div class="m-card glow-card glow-silver">
        <strong>Featured Clubs</strong>
        <div id="homeClubs" class="teams-grid grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4" style="margin-top:6px"></div>
      </div>
      <div class="m-card glow-card glow-gold home-card">
        <div class="home-card-header">
          <strong>League Standings</strong>
          <button type="button" id="btnViewFullStandings" class="home-card-action">View Full Standings</button>
        </div>
        <div id="homepage-standings" class="muted home-card-body">Loading…</div>
      </div>
      <div class="m-card glow-card glow-gold home-card">
        <div class="home-card-header">
          <strong>Top Scorers</strong>
          <button type="button" id="btnViewFullTopScorers" class="home-card-action">View Full Top Scorers</button>
        </div>
        <div id="homepage-topscorers" class="muted home-card-body">Loading…</div>
      </div>
    </div>
  </section>
  <!-- TEAMS -->
  <section id="teams-view" aria-live="polite" class="tab-content space-y-6 p-2 sm:p-4 md:p-8">
    <div class="flex flex-wrap items-center justify-between gap-3 sm:gap-4">
      <h2 style="margin:0">Teams</h2>
      <div class="muted">Total teams: <span id="teams-count">0</span></div>
    </div>
    <div class="teams-grid grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4" id="teamsGrid" role="list">
        <div class="team-card glow-card glow-silver" data-club-id="585548" role="listitem">
          <div class="team-card-header">
            <div class="team-crest">
              <img class="team-logo" src="/assets/logos/club-frijol.png" alt="Club Frijol logo" onerror="this.onerror=null;this.src='https://via.placeholder.com/800x480.png?text=Club%20Frijol';" />
            </div>
            <div>
              <div class="team-meta">
                <div>
                  <div class="name">Club Frijol</div>
                  <div class="team-country">
                    <img src="/assets/flags/mx.png" alt="Mexico flag" onerror="this.style.display='none'">
                    <span class="team-country-name">Mexico</span>
                  </div>
                </div>
                <div class="record">0-0-0</div>
              </div>
              <div class="jersey-swatches" aria-label="Jersey colors">
                <span class="jersey-swatch"><span class="jersey-dot" style="background:#8b0000"></span>Home</span>
                <span class="jersey-swatch"><span class="jersey-dot" style="background:#ffffff"></span>Away</span>
              </div>
              <div class="team-manager">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4z" />
                  <path d="M6 21v-2a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v2" />
                </svg>
                <span class="team-manager-name">Manager TBD</span>
              </div>
            </div>
          </div>
          <div class="team-extra">
            <div><strong>Founded:</strong> <span class="team-founded">2020</span></div>
            <div><strong>Record:</strong> <span class="team-extra-record">Updating soon</span></div>
          </div>
          <div class="players-grid"></div>
        </div>
      </div>
      <div id="teamsEmpty" class="teams-empty p-4 sm:p-6 md:p-7" role="status" aria-live="polite" style="display:none">
        <div class="empty-icon">🏟️</div>
        <div>No teams registered yet.</div>
        <small class="muted">Check back after clubs join the competition.</small>
      </div>
    </section>

  <section id="rankings-section" class="tab-content mt-24 space-y-6 p-2 sm:p-4 md:p-8" style="display:none">
    <div class="relative overflow-hidden rounded-3xl border border-yellow-400/40 bg-slate-900/80 shadow-[0_30px_60px_rgba(12,10,5,0.75)]">
      <div class="flex flex-wrap items-center justify-between gap-4 sm:gap-6 border-b border-yellow-300/20 bg-gradient-to-r from-yellow-500/10 via-amber-400/5 to-transparent px-6 py-5">
        <div class="flex flex-col gap-2">
          <p class="text-xl font-semibold tracking-wide text-yellow-50">Rankings Leaderboard</p>
          <p id="rankingsMeta" class="text-xs uppercase tracking-[0.32em] text-yellow-200/70">Generating universal rankings…</p>
        </div>
        <div class="flex items-center gap-4">
          <span id="rankingsCount" class="rounded-full border border-yellow-300/50 bg-yellow-500/20 px-3 py-1 text-xs font-semibold uppercase tracking-[0.24em] text-yellow-50 shadow-[0_0_18px_rgba(250,204,21,0.4)]">0</span>
          <button
            id="rankingsRefresh"
            type="button"
            class="rounded-full border border-yellow-300/40 bg-yellow-500/20 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-yellow-50 shadow-[0_0_25px_rgba(250,204,21,0.35)] transition hover:border-yellow-200/60 hover:bg-yellow-500/30 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-yellow-200/70"
          >
            Refresh
          </button>
        </div>
      </div>
      <div id="rankingsLoading" class="hidden items-center gap-3 px-6 py-10 text-sm font-semibold text-yellow-100">
        <span class="h-4 w-4 animate-spin rounded-full border-2 border-yellow-200/70 border-t-transparent"></span>
        <span>Compiling live rankings across all clubs…</span>
      </div>
      <div id="rankingsEmpty" class="hidden px-6 py-8 text-sm text-yellow-100/80">
        Unable to load player data. Try refreshing in a moment.
      </div>
      <div id="rankingsTableWrap" class="hidden overflow-x-auto px-4 pb-8">
        <table class="leaderboard-table min-w-full border-separate border-spacing-y-3 text-xs text-slate-100 sm:text-sm md:text-base">
          <thead>
            <tr class="text-xs uppercase tracking-[0.32em] text-yellow-200/70">
              <th scope="col" class="px-4 py-3 text-left">Rank</th>
              <th scope="col" class="px-4 py-3 text-left">Player</th>
              <th scope="col" class="px-4 py-3 text-left">Club</th>
              <th scope="col" class="px-4 py-3 text-left">Position</th>
              <th scope="col" class="px-4 py-3 text-left">Points</th>
              <th scope="col" class="px-4 py-3 text-left">Value (USD)</th>
            </tr>
          </thead>
          <tbody id="rankingsTableBody"></tbody>
        </table>
      </div>
    </div>
  </section>
  <div id="teamView" style="display:none"></div>

  <!-- NEWS -->
  <section id="news-view" class="tab-content space-y-6 p-2 sm:p-4 md:p-8" style="display:none">
    <h2>League News</h2>
    <div class="space-y-10">
      <div id="newsAdminPanel" class="space-y-4" style="display:none">
        <div class="glow-card glow-silver space-y-2" style="padding:20px">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div>
              <h3 class="text-xl font-semibold">Admin newsroom</h3>
              <p class="muted text-sm">Publish official bulletins that appear alongside the community feed.</p>
            </div>
            <button id="adminNewsRefresh" type="button" class="rounded-full border border-emerald-300/60 bg-emerald-400/20 px-4 py-2 text-xs font-semibold uppercase tracking-[0.28em] text-emerald-100 shadow-[0_0_20px_rgba(34,197,94,0.28)] transition hover:border-emerald-200/80 hover:bg-emerald-400/30">Refresh feed</button>
          </div>
          <form id="adminNewsForm" class="space-y-4" enctype="multipart/form-data">
            <div class="grid gap-3 sm:grid-cols-2">
              <label class="space-y-1">
                <span class="text-sm font-semibold uppercase tracking-[0.2em] text-emerald-200/80">Headline *</span>
                <input name="title" type="text" required class="w-full rounded-xl border border-emerald-300/30 bg-slate-950/60 px-3 py-2 text-sm text-slate-100" maxlength="180" placeholder="UPCL Media delivers breaking news">
              </label>
              <label class="space-y-1">
                <span class="text-sm font-semibold uppercase tracking-[0.2em] text-emerald-200/80">Author</span>
                <input name="author" type="text" class="w-full rounded-xl border border-emerald-300/30 bg-slate-950/60 px-3 py-2 text-sm text-slate-100" maxlength="120" placeholder="UPCL Media">
              </label>
            </div>
            <label class="space-y-1">
              <span class="text-sm font-semibold uppercase tracking-[0.2em] text-emerald-200/80">Story *</span>
              <textarea name="body" rows="5" required class="w-full rounded-xl border border-emerald-300/30 bg-slate-950/60 px-3 py-2 text-sm leading-relaxed text-slate-100" maxlength="2000" placeholder="Share the full bulletin here…"></textarea>
            </label>
            <div class="grid gap-3 sm:grid-cols-2">
              <label class="space-y-1">
                <span class="text-sm font-semibold uppercase tracking-[0.2em] text-emerald-200/80">Feature image</span>
                <input name="image" type="file" accept="image/*" class="w-full rounded-xl border border-emerald-300/30 bg-slate-950/60 px-3 py-2 text-sm text-slate-100">
                <small class="muted block text-[0.65rem] tracking-[0.2em]">PNG, JPG, GIF up to 3MB.</small>
              </label>
              <label class="space-y-1">
                <span class="text-sm font-semibold uppercase tracking-[0.2em] text-emerald-200/80">Video embed URL</span>
                <input name="video" type="url" placeholder="https://www.youtube.com/embed/..." class="w-full rounded-xl border border-emerald-300/30 bg-slate-950/60 px-3 py-2 text-sm text-slate-100">
              </label>
            </div>
            <div class="flex flex-wrap items-center justify-between gap-3">
              <small class="muted">Stories publish instantly for all viewers. Double-check embeds before posting.</small>
              <button type="submit" class="rounded-full border border-emerald-300/70 bg-emerald-400/30 px-5 py-2 text-xs font-semibold uppercase tracking-[0.32em] text-emerald-100 shadow-[0_0_22px_rgba(16,185,129,0.32)] transition hover:border-emerald-200/80 hover:bg-emerald-400/40">Publish story</button>
            </div>
            <div id="adminNewsStatus" class="text-xs uppercase tracking-[0.3em] text-emerald-200/70"></div>
          </form>
        </div>
        <div class="glow-card glow-gold" style="padding:20px">
          <h4 class="text-lg font-semibold">Manual stories</h4>
          <div id="adminNewsList" class="news-wrap" style="margin-top:12px">
            <div class="muted">Administrator tools appear here after signing in.</div>
          </div>
        </div>
      </div>
      <div class="space-y-3">
        <div>
          <h3 class="text-xl font-semibold">Main</h3>
          <p class="muted text-sm">Automatic highlights, standings cards, and other league-generated updates.</p>
        </div>
        <div id="newsMainFeed" class="news-wrap" style="margin-top:8px">
          <div class="muted">Loading main news…</div>
        </div>
      </div>
      <div class="space-y-4">
        <div>
          <h3 class="text-xl font-semibold">General</h3>
          <p class="muted text-sm">Share your club stories, scrim results, and updates with the rest of the league.</p>
        </div>
        <form id="generalNewsForm" class="glow-card glow-gold space-y-4" style="padding:18px">
          <div class="grid gap-3 sm:grid-cols-2">
            <label class="space-y-1">
              <span class="text-sm font-semibold uppercase tracking-[0.2em] text-amber-200/80">Display name</span>
              <input name="author" type="text" placeholder="Optional" class="w-full rounded-xl border border-amber-300/30 bg-slate-950/60 px-3 py-2 text-sm text-slate-100" maxlength="80">
            </label>
            <label class="space-y-1">
              <span class="text-sm font-semibold uppercase tracking-[0.2em] text-amber-200/80">Headline *</span>
              <input name="title" type="text" required class="w-full rounded-xl border border-amber-300/30 bg-slate-950/60 px-3 py-2 text-sm text-slate-100" maxlength="140" placeholder="Big win for the Falcons tonight!">
            </label>
          </div>
          <label class="space-y-1">
            <span class="text-sm font-semibold uppercase tracking-[0.2em] text-amber-200/80">Story *</span>
            <textarea name="body" rows="4" required class="w-full rounded-xl border border-amber-300/30 bg-slate-950/60 px-3 py-2 text-sm leading-relaxed text-slate-100" maxlength="1200" placeholder="Give everyone the context: opponent, scoreline, standout players, upcoming plans…"></textarea>
          </label>
          <div class="grid gap-3 sm:grid-cols-2">
            <label class="space-y-1">
              <span class="text-sm font-semibold uppercase tracking-[0.2em] text-amber-200/80">Image URL</span>
              <input name="imageUrl" type="url" placeholder="https://" class="w-full rounded-xl border border-amber-300/30 bg-slate-950/60 px-3 py-2 text-sm text-slate-100">
            </label>
            <label class="space-y-1">
              <span class="text-sm font-semibold uppercase tracking-[0.2em] text-amber-200/80">Video URL</span>
              <input name="videoUrl" type="url" placeholder="https://" class="w-full rounded-xl border border-amber-300/30 bg-slate-950/60 px-3 py-2 text-sm text-slate-100">
            </label>
          </div>
          <div class="flex flex-wrap items-center justify-between gap-3">
            <small class="muted">Posts go live immediately. Keep it respectful—admins can moderate if needed.</small>
            <button type="submit" class="rounded-full border border-amber-300/60 bg-amber-400/30 px-5 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-amber-100 shadow-[0_0_20px_rgba(251,191,36,0.35)] transition hover:border-amber-200/80 hover:bg-amber-400/40">Publish</button>
          </div>
          <div id="generalNewsStatus" class="text-xs uppercase tracking-[0.28em] text-amber-200/70"></div>
        </form>
        <div id="newsGeneralFeed" class="news-wrap" style="margin-top:8px">
          <div class="muted">Loading community posts…</div>
        </div>
      </div>
    </div>
  </section>

  <!-- TEAM DETAIL -->
  <section id="detail-view" aria-live="polite" style="display:none">
    <div id="detail-header" style="display:flex;align-items:center;gap:12px;margin-bottom:14px">
      <button id="backBtn">← Back</button>
      <div>
        <div id="detail-title" style="font-size:20px;font-weight:800">Team name</div>
        <div class="muted" id="detail-sub">squad & trophies</div>
      </div>
    </div>

    <div id="teamPanels" class="grid-panels" style="display:grid;grid-template-columns:1fr;gap:12px">
      <div class="m-card glow-card glow-silver">
        <strong>Club Wallet</strong>
        <div id="walletBody" class="muted" style="margin-top:6px">Loading…</div>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button id="btnCollect" style="display:none">Collect daily payout</button>
          <small class="muted" id="walletHint"></small>
        </div>
      </div>

      <div class="m-card glow-card glow-green">
        <strong>Next UPCL Match</strong>
        <div id="nextMatchBody" class="muted" style="margin-top:6px">No scheduled match yet.</div>
      </div>

      <div id="teamResultsPanel" class="m-card glow-card glow-green">
        <strong>Recent Results</strong>
        <div id="teamResultsBody" class="muted" style="margin-top:6px">No finals yet.</div>
      </div>

      <!-- Manual squad editor -->
      <div class="m-card glow-card glow-silver" id="squadPanel">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
          <strong>Squad</strong>
          <div id="squadTools" style="display:none;gap:8px"><button id="btnBootstrapSlots" title="Create S01..S15">Bootstrap slots</button></div>
        </div>
        <div id="squadBody" class="players-grid" style="margin-top:6px"></div>
      </div>
    </div>

    <div id="detail-footer" style="margin-top:18px" class="muted center">
      <small>Manual squads (EA API disabled).</small>
    </div>
  </section>

  <!-- FIXTURES (PUBLIC) -->
  <section id="fixtures-public" class="tab-content space-y-6 p-2 sm:p-4 md:p-8" style="display:none">
    <h2>Fixtures</h2>
    <div id="fixtures" class="fx-list" style="margin-top:10px"></div>
    <div id="fixturesPublicList" class="fx-list" style="margin-top:10px"></div>
  </section>

  <!-- FIXTURES SCHEDULING (MANAGERS/Admins) -->
  <section id="fixtures-sched" class="tab-content space-y-6 p-2 sm:p-4 md:p-8" style="display:none">
    <div class="flex flex-wrap items-center justify-between gap-3 sm:gap-4">
      <h2>Fixtures Scheduling</h2>
      <div class="flex flex-wrap items-center gap-2 sm:gap-3">
        <button data-fxf="upcoming" aria-pressed="true">Upcoming</button>
        <button data-fxf="final" aria-pressed="false">Final</button>
        <button data-fxf="all" aria-pressed="false">All</button>
        <button data-fxf="mine" aria-pressed="false">My club</button>
        <button id="btnCreateFx" style="display:none">Create fixture</button>
      </div>
    </div>
    <div id="fixturesList" class="fx-list" style="margin-top:10px"></div>
  </section>

  <!-- CHAMPIONS CUP -->
  <section id="champions-view" class="tab-content space-y-6 p-2 sm:p-4 md:p-8" style="display:none">
    <div class="flex flex-wrap items-center justify-between gap-3 sm:gap-4">
      <h2>UPCL Champions Cup</h2>
      <div class="chip">Cup ID: <span id="ccCupId"></span></div>
    </div>

    <!-- Groups + tables (names once, standings only) -->
    <div class="m-card glow-card glow-gold" style="margin-top:10px">
      <strong>Groups</strong>
      <div id="ccGroups" class="group-grid grid grid-cols-1 gap-4 sm:grid-cols-2 xl:grid-cols-4" style="margin-top:8px"></div>
    </div>

    <!-- Bracket -->
    <div class="m-card glow-card glow-gold" style="margin-top:10px">
      <strong>Bracket</strong>
      <div id="ccBracket" class="bracket-grid grid grid-cols-1 gap-4 sm:grid-cols-2 xl:grid-cols-3" style="margin-top:8px"></div>
    </div>

    <!-- Leaders -->
    <div class="m-card glow-card glow-green" style="margin-top:10px">
      <strong>Leaders</strong>
      <div id="ccLeaders" class="mt-2 grid grid-cols-1 gap-4 sm:grid-cols-2 xl:grid-cols-3"></div>
    </div>

    <!-- Admin tools (group editor + easy create fixture) -->
    <div class="m-card glow-card glow-silver" id="ccAdmin" style="display:none;margin-top:10px">
      <strong>Admin tools</strong>
      <div class="muted">Assign teams to groups, save groups, and create fixtures.</div>

      <div id="ccManualGroups" style="display:grid;grid-template-columns:repeat(4,minmax(220px,1fr));gap:10px;margin-top:10px"></div>
      <div class="flex flex-wrap gap-3" style="margin-top:8px">
        <button id="ccBtnSaveGroups">Save groups</button>
      </div>

      <hr style="border:none;border-top:1px solid rgba(148,163,184,0.2);margin:12px 0">

      <div>
        <strong>Create Champions Cup fixture</strong>
        <div class="grid2" style="margin-top:8px">
          <div>
            <label class="muted">Home</label>
            <select id="ccHomeSel"></select>
          </div>
          <div>
            <label class="muted">Away</label>
            <select id="ccAwaySel"></select>
          </div>
          <div>
            <label class="muted">Group (optional)</label>
            <select id="ccGroupSel">
              <option value="">— none —</option>
              <option value="A">Group A</option>
              <option value="B">Group B</option>
              <option value="C">Group C</option>
              <option value="D">Group D</option>
            </select>
          </div>
          <div>
            <label class="muted">Stage / Round</label>
            <input id="ccRoundInput" placeholder="e.g., Group A MD1 or Semifinal">
          </div>
          <div>
            <label class="muted">Date & time (optional)</label>
            <input id="ccWhenInput" type="datetime-local">
          </div>
          <div style="align-self:end">
            <button id="ccFormCreate">Create fixture</button>
          </div>
        </div>
      </div>
    </div>

    <!-- CC Fixtures -->
    <div class="m-card glow-card glow-green" style="margin-top:10px">
      <strong>Champions Cup Fixtures</strong>
      <div id="ccFixtures" class="fx-list" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- LEAGUE STANDINGS -->
  <section id="leagueView" class="tab-content space-y-6 p-2 sm:p-4 md:p-8" style="display:none">
    <div class="flex flex-wrap items-center justify-between gap-3 sm:gap-4">
      <h2>League Standings</h2>
      <div id="statsBtnHolderLeague">
        <button id="statsToggleBtn" class="chip">Stats</button>
      </div>
    </div>
    <div class="league-grid">
      <div class="standings-table glow-card glow-gold">
        <div class="overflow-x-auto">
          <table class="league-table min-w-[560px] text-left text-xs sm:text-sm md:text-base">
            <thead>
              <tr><th>#</th><th>Team</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GF</th><th>GA</th><th>GD</th><th>Pts</th></tr>
            </thead>
            <tbody id="league-standings"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <section id="statsView" class="tab-content space-y-6 p-2 sm:p-4 md:p-8" style="display:none">
    <div class="flex flex-wrap items-center justify-between gap-3 sm:gap-4">
      <h2>League Stats</h2>
      <div id="statsBtnHolderStats"></div>
    </div>
    <div class="m-card glow-card glow-green" id="league-topscorers-card">
      <strong>Top Scorers</strong>
      <div id="league-topscorers" class="mt-2 space-y-2">
        <div class="muted">Loading…</div>
      </div>
    </div>
    <div class="leaderboards stats-section grid grid-cols-1 gap-4 sm:grid-cols-2 xl:grid-cols-3"></div>
  </section>

  <!-- FRIENDLIES -->
  <section id="friendlies-view" class="tab-content space-y-6 p-2 sm:p-4 md:p-8" style="display:none">
    <div class="flex flex-wrap items-center justify-between gap-3 sm:gap-4">
      <h2>Friendlies</h2>
      <div class="chip">Cup ID: <span id="frCupId"></span></div>
    </div>

    <div class="m-card glow-card glow-green" style="margin-top:10px">
      <strong>Fixtures</strong>
      <div id="friendliesFixtures" class="fx-list" style="margin-top:8px"></div>
    </div>

    <div class="m-card glow-card glow-silver" id="friendliesAdmin" style="display:none;margin-top:10px">
      <strong>Admin tools</strong>
      <div class="muted">Manage friendly teams and generate fixtures.</div>
      <div id="frTeamList" style="margin-top:8px"></div>
      <div class="flex flex-wrap gap-3" style="margin-top:8px">
        <select id="frAddSel"></select>
        <button id="frAddBtn">Add team</button>
      </div>
      <div style="margin-top:8px">
        <button id="frGenBtn">Generate fixtures</button>
      </div>
    </div>
  </section>

  <section id="competitions-admin-view" class="tab-content space-y-6 p-2 sm:p-4 md:p-8" style="display:none">
    <div class="flex flex-wrap items-center justify-between gap-3 sm:gap-4">
      <h2>Competition Approval</h2>
      <button type="button" id="competitionsAdminRefresh" class="chip" style="border-color:rgba(45,212,191,0.45);background:linear-gradient(135deg, rgba(45,212,191,0.18), rgba(14,23,32,0.88));display:none">Refresh queue</button>
    </div>
    <div class="glow-card glow-silver" style="padding:20px">
      <div class="competitions-admin-controls">
        <div>
          <p class="text-lg font-semibold">Pending friendly results</p>
          <p class="competitions-admin-intro">Approve friendly matches to apply them to official competitions.</p>
        </div>
      </div>
      <form id="competitionDefaultsForm" class="competition-defaults" autocomplete="off">
        <label>
          Competition ID
          <input id="competitionDefaultId" name="competitionId" type="text" placeholder="UPCL_CC_2025_08" maxlength="80">
          <small>Used when approving, can be overridden per match.</small>
        </label>
        <label>
          Group (optional)
          <input id="competitionDefaultGroup" name="groupName" type="text" placeholder="Group A" maxlength="40">
        </label>
        <label>
          Round / Stage
          <input id="competitionDefaultRound" name="roundName" type="text" placeholder="Group MD1" maxlength="60">
        </label>
      </form>
      <div id="competitionsAdminStatus" class="muted" style="margin-top:12px"></div>
    </div>
    <div id="competitionsPendingList" class="pending-matches-list">
      <div class="muted">Sign in as an admin to review pending competition matches.</div>
    </div>
  </section>

</main>

<!-- Result Sheet Modal -->
<div class="modal" id="resultModal" aria-hidden="true">
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="resTitle">
    <h3 id="resTitle">Submit Result</h3>

    <div id="resMeta" class="muted"></div>

    <div class="grid2" style="margin-top:10px">
      <div class="sheet">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
          <strong id="homeTitle">Home</strong>
          <div class="row-btns"><button id="addHomeRow">+ Add row</button></div>
        </div>
        <div class="overflow-x-auto">
          <table id="homeTable" class="min-w-[520px] text-left text-xs sm:text-sm md:text-base" style="margin-top:6px">
            <thead>
              <tr><th style="width:40%">Player</th><th>G</th><th>A</th><th>Rating</th><th>Pos</th><th></th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="sheet">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
          <strong id="awayTitle">Away</strong>
          <div class="row-btns"><button id="addAwayRow">+ Add row</button></div>
        </div>
        <div class="overflow-x-auto">
          <table id="awayTable" class="min-w-[520px] text-left text-xs sm:text-sm md:text-base" style="margin-top:6px">
            <thead>
              <tr><th style="width:40%">Player</th><th>G</th><th>A</th><th>Rating</th><th>Pos</th><th></th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="grid2" style="margin-top:10px">
      <div>
        <label class="muted">Home Score</label>
        <input id="homeScore" type="number" min="0" value="0">
      </div>
      <div>
        <label class="muted">Away Score</label>
        <input id="awayScore" type="number" min="0" value="0">
      </div>
    </div>

    <div style="margin-top:8px">
      <label class="muted">Notes (optional)</label>
      <textarea id="resNotes" rows="3" placeholder="Short match notes or MVPs"></textarea>
    </div>

    <div class="actions">
      <button id="resCancel">Cancel</button>
      <button id="resPasteJson">Admin paste JSON</button>
      <button id="resSubmit">Submit Result</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
<script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
<script src="js/home.js"></script>
<script>
// =======================
//   CONFIG / CONSTANTS
// =======================
const API_BASE = '';
const CC_ID = 'UPCL_CC_2025_08'; // current Champions Cup id
const FRIENDLIES_ID = 'UPCL_FRIENDLIES_2025'; // current Friendlies id

let leagueDataCache = null;
let leagueDataPromise = null;
let latestManualNews = [];
let adminNewsSetup = false;
let adminNewsFetched = false;

async function fetchLeagueData(force = false){
  if (!force && leagueDataCache) return leagueDataCache;
  if (!leagueDataPromise || force){
    leagueDataPromise = (async () => {
      const [standingsRes, matchesRes, playersRes] = await Promise.all([
        apiGet('/api/league').catch(()=>({ standings: [] })),
        apiGet('/api/matches').catch(()=>({ matches: [] })),
        apiGet('/api/players').catch(()=>({ players: [] }))
      ]);
      const players = Array.isArray(playersRes.players) ? playersRes.players : [];
      const playerStandings = deriveStandingsFromPlayers(players);
      const topScorers = deriveTopScorersFromPlayers(players);
      leagueDataCache = {
        standings: standingsRes.standings || [],
        matches: matchesRes.matches || [],
        players,
        scorers: topScorers,
        playerStandings
      };
      return leagueDataCache;
    })();
  }
  return leagueDataPromise;
}

function deriveStandingsFromPlayers(players){
  const byClub = new Map();
  const toNumber = value => {
    const num = Number(value);
    return Number.isFinite(num) ? num : 0;
  };
  (Array.isArray(players) ? players : []).forEach(player => {
    const rawId = player?.club_id ?? player?.clubId ?? player?.team_id ?? player?.teamId ?? player?.club;
    if (!rawId) return;
    const clubId = String(rawId);
    const entry = byClub.get(clubId) || {
      clubId,
      name: '',
      played: 0,
      wins: 0,
      draws: 0,
      losses: 0,
      goalsFor: 0,
      goalsAgainst: 0,
      points: 0
    };
    if (!entry.name){
      entry.name = player?.club_name || player?.club || player?.team || player?.team_name || '';
    }
    const wins = toNumber(player?.club_wins ?? player?.wins ?? player?.team_wins ?? player?.record_wins);
    const draws = toNumber(player?.club_draws ?? player?.draws ?? player?.team_draws ?? player?.record_draws);
    const losses = toNumber(player?.club_losses ?? player?.losses ?? player?.team_losses ?? player?.record_losses);
    const playedCandidates = [
      player?.club_played,
      player?.club_games_played,
      player?.games_played,
      player?.gamesPlayed,
      player?.matches,
      wins + draws + losses
    ];
    const goalsFor = toNumber(player?.club_goals_for ?? player?.goals_for ?? player?.team_goals_for);
    const goalsAgainst = toNumber(player?.club_goals_against ?? player?.goals_against ?? player?.team_goals_against);
    const points = toNumber(player?.club_points ?? player?.points ?? player?.team_points ?? player?.clubpts);

    if (wins > entry.wins) entry.wins = wins;
    if (draws > entry.draws) entry.draws = draws;
    if (losses > entry.losses) entry.losses = losses;
    const played = playedCandidates
      .map(toNumber)
      .reduce((acc, val) => (val > acc ? val : acc), entry.played);
    if (played > entry.played) entry.played = played;
    if (goalsFor > entry.goalsFor) entry.goalsFor = goalsFor;
    if (goalsAgainst > entry.goalsAgainst) entry.goalsAgainst = goalsAgainst;
    if (points > entry.points) entry.points = points;

    byClub.set(clubId, entry);
  });

  return Array.from(byClub.values()).map(entry => {
    if (!entry.played){
      entry.played = entry.wins + entry.draws + entry.losses;
    }
    return entry;
  });
}

function deriveTopScorersFromPlayers(players){
  const toNumber = value => {
    const num = Number(value);
    return Number.isFinite(num) ? num : 0;
  };
  const normalized = (Array.isArray(players) ? players : []).map(player => {
    const clubId = player?.club_id ?? player?.clubId ?? player?.team_id ?? player?.teamId ?? player?.club;
    const goals = toNumber(player?.goals ?? player?.goal ?? player?.total_goals ?? player?.totalGoals ?? player?.count);
    const name = player?.name || player?.player || player?.player_name || player?.personaName || player?.persona_name || player?.gamertag || player?.displayName || '';
    if (!name) return null;
    return {
      clubId: clubId ? String(clubId) : '',
      name,
      goals
    };
  }).filter(Boolean);

  normalized.sort((a, b) => {
    if (b.goals !== a.goals) return b.goals - a.goals;
    return a.name.localeCompare(b.name);
  });

  return normalized;
}

// Teams
let teams = [];
let staticTeams = [];

function buildStaticTeams(){
  staticTeams = Array.from(document.querySelectorAll('.team-card')).map(card => {
    const id = card.getAttribute('data-club-id');
    const name = card.querySelector('.name').textContent.trim();
    const logo = card.querySelector('.team-logo').getAttribute('src');
    const team = { id, name, logo };
    card.addEventListener('click', () => openTeamView(id));
    return team;
  });
  teams = [...staticTeams];
  leaderboardState.loaded = false;
  leaderboardState.loading = false;
  leaderboardState.players = [];
  leaderboardState.lastUpdated = null;
  if(leaderboardEls.count) leaderboardEls.count.textContent = '0';
  if(leaderboardEls.meta) leaderboardEls.meta.textContent = 'Generating universal rankings…';
  if(leaderboardEls.body) leaderboardEls.body.innerHTML = '';
  leaderboardEls.tableWrap?.classList.add('hidden');
  leaderboardEls.loading?.classList.add('hidden');
  if(leaderboardEls.empty){
    leaderboardEls.empty.classList.add('hidden');
    leaderboardEls.empty.textContent = 'Unable to load player data. Try refreshing in a moment.';
  }
  document.getElementById('teams-count').textContent = teams.length;
  const emptyState = document.getElementById('teamsEmpty');
  if(emptyState){ emptyState.style.display = teams.length ? 'none' : 'flex'; }
}

// helpers
function normalizeId(id){
  return String(id||'').toLowerCase().replace(/[^a-z0-9]+/g,'-');
}
const byId = id => {
  const norm = normalizeId(id);
  return teams.find(t => normalizeId(t.id) === norm);
};
function replaceClubIds(str){
  if(!str) return str;
  return String(str).replace(/[A-Za-z0-9_-]+/g, token => {
    const club = byId(token);
    return club ? club.name : token;
  });
}
function teamLogoUrl(team){ return team?.logo || `https://via.placeholder.com/800x480.png?text=${encodeURIComponent(team?.name||'Club')}`; }
function escapeHtml(s){
  const map = { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' };
  return String(s).replace(/[&<>"']/g, c => map[c]);
}
function escapeAttr(s){
  if (s === undefined || s === null) return '';
  const map = { '&':'&amp;', '<':'&lt;', '"':'&quot;' };
  return String(s).replace(/[&<"]/g, c => map[c]);
}

function stripDiacritics(value){
  if(value === undefined || value === null) return '';
  try{
    return String(value).normalize('NFKD').replace(/[\u0300-\u036f]/g, '');
  }catch{
    return String(value);
  }
}

function hashForSlug(value){
  const str = String(value ?? '');
  let hash = 0;
  for(let i = 0; i < str.length; i += 1){
    hash = (hash * 31 + str.charCodeAt(i)) | 0;
  }
  return (hash >>> 0).toString(36);
}

function createPlayerSlug(name, clubId){
  const normalizedName = stripDiacritics(name).toLowerCase();
  const clubPartRaw = clubId !== undefined && clubId !== null
    ? String(clubId).trim().toLowerCase()
    : '';
  const clubPart = clubPartRaw.replace(/[^a-z0-9]+/g, '');
  let base = normalizedName.replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
  if(!base){
    const seed = `${normalizedName || 'player'}-${clubPart || 'club'}`;
    base = `player-${hashForSlug(seed)}`;
  }
  const combined = clubPart ? `${base}-${clubPart}` : base;
  const sanitized = combined.replace(/-+/g, '-').replace(/^-+|-+$/g, '');
  return sanitized.slice(0, 64) || `player-${hashForSlug('fallback')}`;
}

function getPlayerUploadKey(meta, fallbackId, existingKey){
  if(fallbackId !== undefined && fallbackId !== null && fallbackId !== ''){
    return String(fallbackId);
  }
  if(existingKey){
    return String(existingKey);
  }
  const source = meta || {};
  const candidate = source.playerId ?? source.playerid;
  if(candidate !== undefined && candidate !== null && candidate !== ''){
    return String(candidate);
  }
  const clubId = source.clubId ?? source.clubid ?? '';
  return createPlayerSlug(source.name || 'Player', clubId);
}
function fmtMoney(n){ return '₵' + Number(n||0).toLocaleString(); }
function fmtDate(value){
  try{
    if (!value && value !== 0) return '';
    const date = value instanceof Date ? value : new Date(value);
    if (Number.isNaN(date.getTime())) return '';
    return date.toLocaleString();
  }catch{
    return '';
  }
}
function getFixtureBanner(){ return '/assets/ui/fixture-banner.png'; }

const PRO_POSITION_MAP = {
  0:'GK',
  1:'RWB',
  2:'RB',
  3:'CB',
  4:'LB',
  5:'LWB',
  6:'CDM',
  7:'RM',
  8:'CM',
  9:'LM',
  10:'CAM',
  11:'CF',
  12:'RF',
  13:'LF',
  14:'ST',
  15:'LW',
  16:'RW',
  17:'LM',
  18:'RM',
  19:'CB',
  20:'CDM',
  21:'CM',
  22:'CAM',
  23:'ST',
  24:'GK',
  25:'CB',
  26:'LB',
  27:'RB',
  28:'LM',
  29:'RM',
  30:'CDM',
  31:'CAM'
};

const FAVORITE_POSITION_MAP = {
  'forward':'ST',
  'midfielder':'CM',
  'defender':'CB',
  'goalkeeper':'GK'
};

const usdFormatter = new Intl.NumberFormat('en-US', {
  style: 'currency',
  currency: 'USD',
  maximumFractionDigits: 0
});

function numberFrom(value){
  const n = Number(value);
  return Number.isFinite(n) ? n : 0;
}

function resolvePlayerPosition(player){
  const fav = player?.favoritePosition ?? player?.favoriteposition;
  if(fav != null){
    const favKey = String(fav).trim().toLowerCase();
    if(FAVORITE_POSITION_MAP[favKey]){
      return FAVORITE_POSITION_MAP[favKey];
    }
    if(favKey){
      return favKey.toUpperCase();
    }
  }
  const raw = player.position || player.pos || player.proPos || player.proPosition;
  if(raw == null) return '—';
  const str = String(raw).trim();
  if(!str) return '—';
  const lower = str.toLowerCase();
  if(FAVORITE_POSITION_MAP[lower]) return FAVORITE_POSITION_MAP[lower];
  const num = Number(str);
  if(!Number.isNaN(num) && PRO_POSITION_MAP[num]) return PRO_POSITION_MAP[num];
  return str.toUpperCase();
}

function calculatePlayerPoints(player){
  const goals = numberFrom(player.goals);
  const assists = numberFrom(player.assists);
  const matches = numberFrom(player.gamesPlayed ?? player.matches);
  const winRate = numberFrom(player.winRate);
  const rating = numberFrom(player.ratingAve ?? player.rating);
  const tackles = numberFrom(player.tacklesMade ?? player.tackles);
  const cleanSheetsDef = numberFrom(player.cleanSheetsDef ?? player.cleanSheetsAny ?? player.cleanSheets);
  const cleanSheetsGK = numberFrom(player.cleanSheetsGK ?? player.cleanSheetsKeeper ?? player.cleanSheetsGoalie);
  const motm = numberFrom(player.manOfTheMatch ?? player.mom ?? player.motm);
  const redCards = numberFrom(player.redCards ?? player.redCard ?? player.rc);

  const total =
    goals * 5 +
    assists * 4 +
    matches * 2 +
    winRate * 0.5 +
    rating * 10 +
    tackles * 2 +
    cleanSheetsDef * 10 +
    cleanSheetsGK * 20 +
    motm * 10 +
    redCards * -15;

  const precise = Number.isFinite(total) ? Number(total.toFixed(2)) : 0;
  return precise;
}

function prepareLeaderboardPlayer(member){
  const name = member.name || member.playername || member.proName || member.personaName || `Player ${member.playerId || member.playerid || ''}`.trim();
  const clubName = member.clubName || member.club || member.teamName || member.clubname || 'Unknown Club';
  const matches = numberFrom(member.gamesPlayed ?? member.matches);
  const rating = numberFrom(member.ratingAve ?? member.rating);
  const winRate = numberFrom(member.winRate);
  const goals = numberFrom(member.goals);
  const assists = numberFrom(member.assists);
  const tackles = numberFrom(member.tacklesMade ?? member.tackles);
  const cleanSheetsDef = numberFrom(member.cleanSheetsDef ?? member.cleanSheetsAny ?? member.cleanSheets);
  const cleanSheetsGK = numberFrom(member.cleanSheetsGK ?? member.cleanSheetsKeeper ?? member.cleanSheetsGoalie);
  const motm = numberFrom(member.manOfTheMatch ?? member.mom ?? member.motm);
  const redCards = numberFrom(member.redCards ?? member.redCard ?? member.rc);
  const shotSuccess = numberFrom(member.shotSuccessRate ?? member.shotsSuccessRate);
  const passSuccess = numberFrom(member.passSuccessRate ?? member.passsuccessrate);
  const passesMade = numberFrom(member.passesMade ?? member.passesmade);
  const totalPoints = calculatePlayerPoints(member);
  const valueUsd = Math.round(totalPoints * 10000);

  return {
    name,
    clubName,
    position: resolvePlayerPosition(member),
    points: totalPoints,
    value: valueUsd,
    matches,
    rating,
    winRate,
    goals,
    assists,
    tackles,
    cleanSheetsDef,
    cleanSheetsGK,
    motm,
    redCards,
    shotSuccess,
    passSuccess,
    passesMade
  };
}

function formatPoints(points){
  return Number(points || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function formatUsd(value){
  return usdFormatter.format(Math.round(value || 0));
}

async function fetchLeaderboardPlayers(){
  if(!teams.length){
    buildStaticTeams();
  }
  const clubIds = Array.from(new Set(teams.map(t => t && t.id).filter(Boolean)));
  const players = [];
  for (const clubId of clubIds){
    const club = teams.find(t => String(t.id) === String(clubId));
    try{
      const res = await fetch(`/api/ea/clubs/${encodeURIComponent(clubId)}/members`);
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      const list = Array.isArray(data?.members) ? data.members : [];
      list.forEach(member => {
        players.push({ ...member, clubId, clubName: club?.name || `Club ${clubId}` });
      });
    }catch(err){
      console.error('Failed to load members for club', clubId, err);
    }
  }
  return players;
}

function renderLeaderboard(players){
  if(!leaderboardEls.body) return;
  leaderboardEls.body.innerHTML = '';

  if(!players.length){
    leaderboardEls.tableWrap?.classList.add('hidden');
    if(leaderboardEls.empty){
      leaderboardEls.empty.textContent = 'No player data available yet.';
      leaderboardEls.empty.classList.remove('hidden');
    }
    return;
  }

  leaderboardEls.tableWrap?.classList.remove('hidden');
  leaderboardEls.empty?.classList.add('hidden');

  players.forEach((player, index) => {
    const row = document.createElement('tr');
    const baseClass = 'group leaderboard-row relative overflow-hidden rounded-2xl border bg-slate-950/70 backdrop-blur-sm transition-all duration-300 hover:-translate-y-1 hover:border-yellow-300/60 hover:shadow-[0_18px_35px_rgba(250,204,21,0.25)]';
    let topClass = 'border-slate-700/60 shadow-[0_10px_25px_rgba(5,6,12,0.65)]';
    if(index === 0){
      topClass = 'border-yellow-300/90 shadow-[0_0_55px_rgba(250,204,21,0.55)]';
    }else if(index === 1){
      topClass = 'border-slate-200/80 shadow-[0_0_45px_rgba(226,232,240,0.4)]';
    }else if(index === 2){
      topClass = 'border-amber-500/80 shadow-[0_0_45px_rgba(248,166,70,0.4)]';
    }
    row.className = `${baseClass} ${topClass}`;
    row.dataset.rank = String(index + 1);

    const tooltip = `
      <div class="grid grid-cols-2 gap-x-5 gap-y-1">
        <span class="text-yellow-200/70">Matches</span><span class="font-semibold text-yellow-50">${player.matches}</span>
        <span class="text-yellow-200/70">Win Rate</span><span class="font-semibold text-yellow-50">${player.winRate.toFixed(1)}%</span>
        <span class="text-yellow-200/70">Goals</span><span class="font-semibold text-yellow-50">${player.goals}</span>
        <span class="text-yellow-200/70">Assists</span><span class="font-semibold text-yellow-50">${player.assists}</span>
        <span class="text-yellow-200/70">Tackles</span><span class="font-semibold text-yellow-50">${player.tackles}</span>
        <span class="text-yellow-200/70">Clean Sheets DEF</span><span class="font-semibold text-yellow-50">${player.cleanSheetsDef}</span>
        <span class="text-yellow-200/70">Clean Sheets GK</span><span class="font-semibold text-yellow-50">${player.cleanSheetsGK}</span>
        <span class="text-yellow-200/70">MOTM</span><span class="font-semibold text-yellow-50">${player.motm}</span>
        <span class="text-yellow-200/70">Red Cards</span><span class="font-semibold text-yellow-50">${player.redCards}</span>
        <span class="text-yellow-200/70">Pass Success</span><span class="font-semibold text-yellow-50">${player.passSuccess.toFixed(1)}%</span>
        <span class="text-yellow-200/70">Shot Success</span><span class="font-semibold text-yellow-50">${player.shotSuccess.toFixed(1)}%</span>
        <span class="text-yellow-200/70">Passes Made</span><span class="font-semibold text-yellow-50">${player.passesMade}</span>
      </div>
    `;

    row.innerHTML = `
      <td data-label="Rank" class="px-4 py-3 text-sm font-extrabold tracking-wide text-yellow-200/90">${index + 1}</td>
      <td data-label="Player" class="relative px-4 py-3 text-sm font-semibold text-slate-100">
        <div class="flex flex-col gap-1">
          <span>${escapeHtml(player.name)}</span>
          <span class="text-xs font-medium uppercase tracking-[0.24em] text-yellow-200/70">Rating ${player.rating.toFixed(2)} • Win ${player.winRate.toFixed(1)}%</span>
        </div>
        <div aria-hidden="true" class="pointer-events-none absolute left-1/2 top-full z-30 w-[min(320px,80vw)] -translate-x-1/2 -translate-y-3 rounded-2xl border border-yellow-300/30 bg-slate-950/95 px-4 py-3 text-xs text-yellow-50 shadow-[0_28px_55px_rgba(8,8,3,0.9)] opacity-0 transition-all duration-200 group-hover:opacity-100 group-hover:-translate-y-1 group-focus-within:opacity-100 group-focus-within:-translate-y-1">
          ${tooltip}
        </div>
      </td>
      <td data-label="Club" class="px-4 py-3 text-sm font-medium text-slate-200">${escapeHtml(player.clubName)}</td>
      <td data-label="Position" class="px-4 py-3 text-sm font-semibold uppercase tracking-[0.24em] text-yellow-100">${escapeHtml(player.position)}</td>
      <td data-label="Points" class="px-4 py-3 text-sm font-bold text-yellow-200">${formatPoints(player.points)}</td>
      <td data-label="Value (USD)" class="px-4 py-3 text-sm font-bold text-yellow-100">${formatUsd(player.value)}</td>
    `;

    leaderboardEls.body.appendChild(row);
  });
}

async function ensureRankingsLoaded(force){
  if(!leaderboardEls.section) return;
  if(leaderboardState.loading) return;
  if(leaderboardState.loaded && !force){
    renderLeaderboard(leaderboardState.players);
    if(leaderboardEls.meta && leaderboardState.lastUpdated){
      leaderboardEls.meta.textContent = `Updated ${new Date(leaderboardState.lastUpdated).toLocaleString()} • ${leaderboardState.players.length} players ranked`;
    }
    return;
  }

  leaderboardState.loading = true;
  leaderboardEls.loading?.classList.remove('hidden');
  leaderboardEls.empty?.classList.add('hidden');
  leaderboardEls.tableWrap?.classList.add('hidden');

  try{
    const rawPlayers = await fetchLeaderboardPlayers();
    const prepared = rawPlayers.map(prepareLeaderboardPlayer)
      .filter(p => Number.isFinite(p.points))
      .sort((a, b) => b.points - a.points || b.goals - a.goals || b.assists - a.assists || b.rating - a.rating);

    leaderboardState.players = prepared;
    leaderboardState.loaded = true;
    leaderboardState.lastUpdated = Date.now();

    renderLeaderboard(prepared);

    if(leaderboardEls.meta){
      leaderboardEls.meta.textContent = `Updated ${new Date(leaderboardState.lastUpdated).toLocaleString()} • ${prepared.length} players ranked`;
    }
    if(leaderboardEls.count){
      leaderboardEls.count.textContent = prepared.length.toString();
    }
  }catch(err){
    console.error('Failed to compile rankings', err);
    if(leaderboardEls.empty){
      leaderboardEls.empty.textContent = 'Unable to compile the rankings right now. Please try again.';
      leaderboardEls.empty.classList.remove('hidden');
    }
  }finally{
    leaderboardEls.loading?.classList.add('hidden');
    leaderboardState.loading = false;
  }
}

function setupRankings(){
  leaderboardEls = {
    section: document.getElementById('rankings-section'),
    count: document.getElementById('rankingsCount'),
    meta: document.getElementById('rankingsMeta'),
    loading: document.getElementById('rankingsLoading'),
    empty: document.getElementById('rankingsEmpty'),
    tableWrap: document.getElementById('rankingsTableWrap'),
    body: document.getElementById('rankingsTableBody'),
    refresh: document.getElementById('rankingsRefresh')
  };

  if(!leaderboardEls.section) return;

  if(leaderboardEls.refresh){
    leaderboardEls.refresh.addEventListener('click', async ()=>{
      if(leaderboardState.loading) return;
      leaderboardEls.refresh.disabled = true;
      leaderboardEls.refresh.setAttribute('aria-busy','true');
      try{
        await ensureRankingsLoaded(true);
      }finally{
        leaderboardEls.refresh.removeAttribute('aria-busy');
        leaderboardEls.refresh.disabled = false;
      }
    });
  }

  ensureRankingsLoaded(false);
}

let isAdmin = false;
let meUser  = null;
let isMgr   = false;
let rankings = {};
let payouts  = { elite:0, mid:0, bottom:0 };
let fixturesPublicCache = [];
let fixturesSchedCache  = [];
let friendliesFxCache  = [];
let friendliesTeams    = [];
const leaderboardState = { loaded:false, loading:false, players:[], lastUpdated:null };
let leaderboardEls = {};
const competitionsAdminState = {
  loaded:false,
  loading:false,
  items:[],
  defaults:{ competitionId:'', groupName:'', roundName:'' },
  formValues:{},
  errorMessage:''
};
let competitionDefaultsSetup = false;

function normalizeFixtures(list){
  return (Array.isArray(list)?list:[]).map(f=>({
    ...f,
    when: f.when?Number(f.when):f.when,
    createdAt: f.createdAt?Number(f.createdAt):f.createdAt,
    score: f.score || { hs: f.hs, as: f.as }
  }));
}

// api
async function apiGet(p){ const r = await fetch(API_BASE+p,{credentials:'include'}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
async function apiPost(p, body){ const r = await fetch(API_BASE+p,{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(body||{})}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
async function apiPut(p, body){ const r = await fetch(API_BASE+p,{method:'PUT',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(body||{})}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
async function apiDelete(p){ const r = await fetch(API_BASE+p,{method:'DELETE',credentials:'include'}); if(!r.ok) throw new Error('HTTP '+r.status); const text = await r.text(); return text ? JSON.parse(text) : {}; }

// players cache
let playersByClub = {};

const playerNameCache = new Map();
async function resolvePlayerName(id){
  if(!id) return '';
  if(playerNameCache.has(id)) return playerNameCache.get(id);
  for (const arr of Object.values(playersByClub)) {
    const p = arr.find(m => String(m.personaId||m.playerId||m.id) === String(id));
    if (p) {
      const name = p.name || p.playername || p.personaName || '';
      playerNameCache.set(id, name || id);
      return name || id;
    }
  }
  playerNameCache.set(id, id);
  return id;
}

// nav elements
const navHome              = document.getElementById('navHome');
const navTeams             = document.getElementById('navTeams');
const navRankings          = document.getElementById('navRankings');
const navNews              = document.getElementById('navNews');
const navFxPublic          = document.getElementById('navFixturesPublic');
const navFxSched           = document.getElementById('navFixturesSched');
const navChampions         = document.getElementById('navChampions');
const navLeague            = document.getElementById('navLeague');
const navFriendlies        = document.getElementById('navFriendlies');
const navAdminCompetitions = document.getElementById('navAdminCompetitions');
const navToggle     = document.getElementById('navToggle');
const primaryNav    = document.getElementById('primaryNav');

if(navToggle && primaryNav){
  const syncNavForViewport = ()=>{
    if(window.innerWidth >= 768){
      primaryNav.classList.remove('hidden');
      navToggle.setAttribute('aria-expanded','true');
    }else{
      primaryNav.classList.add('hidden');
      navToggle.setAttribute('aria-expanded','false');
    }
  };
  syncNavForViewport();
  window.addEventListener('resize', syncNavForViewport);
  navToggle.addEventListener('click', ()=>{
    if(window.innerWidth >= 768) return;
    const expanded = navToggle.getAttribute('aria-expanded') === 'true';
    navToggle.setAttribute('aria-expanded', String(!expanded));
    primaryNav.classList.toggle('hidden', expanded);
  });
  primaryNav.querySelectorAll('button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(window.innerWidth < 768){
        primaryNav.classList.add('hidden');
        navToggle.setAttribute('aria-expanded','false');
      }
    });
  });
}

const homeView    = document.getElementById('home');
const teamsViewEl = document.getElementById('teams-view');
const rankingsSection = document.getElementById('rankings-section');
const newsView    = document.getElementById('news-view');
const adminNewsPanel  = document.getElementById('newsAdminPanel');
const adminNewsForm   = document.getElementById('adminNewsForm');
const adminNewsStatus = document.getElementById('adminNewsStatus');
const adminNewsList   = document.getElementById('adminNewsList');
const adminNewsRefresh= document.getElementById('adminNewsRefresh');
const generalNewsForm = document.getElementById('generalNewsForm');
const generalNewsStatus = document.getElementById('generalNewsStatus');
const fxPublic    = document.getElementById('fixtures-public');
const fxSched     = document.getElementById('fixtures-sched');
const cupView     = document.getElementById('champions-view');
const leagueView  = document.getElementById('leagueView');
const friendliesView = document.getElementById('friendlies-view');
const competitionsAdminView = document.getElementById('competitions-admin-view');
const competitionsAdminRefresh = document.getElementById('competitionsAdminRefresh');
const competitionsPendingList = document.getElementById('competitionsPendingList');
const competitionsAdminStatus = document.getElementById('competitionsAdminStatus');
const competitionDefaultsForm = document.getElementById('competitionDefaultsForm');
const competitionDefaultId = document.getElementById('competitionDefaultId');
const competitionDefaultGroup = document.getElementById('competitionDefaultGroup');
const competitionDefaultRound = document.getElementById('competitionDefaultRound');

function normalizeInitialView(raw){
  if (!raw) return null;
  const value = String(raw).toLowerCase();
  switch(value){
    case 'home':
    case 'teams':
    case 'news':
    case 'champions':
    case 'league':
    case 'friendlies':
    case 'rankings':
      return value;
    case 'fixtures':
    case 'fixturespublic':
    case 'fixtures-public':
      return 'fixturesPublic';
    case 'fixturessched':
    case 'fixtures-sched':
    case 'schedule':
    case 'scheduling':
      return 'fixturesSched';
    default:
      return null;
  }
}

function resolveInitialNav(){
  const search = new URLSearchParams(window.location.search || '');
  const queryView = normalizeInitialView(search.get('view'));
  const hashView = normalizeInitialView(window.location.hash ? window.location.hash.replace(/^#/, '') : '');
  const path = window.location.pathname.replace(/\/+$/, '') || '/';
  const pathView = path === '/admin/news'
    ? 'news'
    : (path === '/admin/competitions' ? 'competitionsAdmin' : null);
  return queryView || hashView || pathView || 'teams';
}

function setupCommunityNewsForm(){
  if (!generalNewsForm) return;
  const submitBtn = generalNewsForm.querySelector('button[type="submit"]');
  generalNewsForm.addEventListener('submit', async (event)=>{
    event.preventDefault();
    const formData = new FormData(generalNewsForm);
    const title = String(formData.get('title') || '').trim();
    const body = String(formData.get('body') || '').trim();
    const author = String(formData.get('author') || '').trim();
    const imageUrl = String(formData.get('imageUrl') || '').trim();
    const videoUrl = String(formData.get('videoUrl') || '').trim();
    if (generalNewsStatus){
      generalNewsStatus.textContent = 'Posting…';
    }
    if (submitBtn){
      submitBtn.disabled = true;
      submitBtn.setAttribute('aria-busy','true');
    }
    if (!title || !body){
      if (generalNewsStatus){
        generalNewsStatus.textContent = 'Headline and story are required.';
      }
      if (submitBtn){
        submitBtn.disabled = false;
        submitBtn.removeAttribute('aria-busy');
      }
      return;
    }
    const payload = { title, body };
    if (author) payload.author = author;
    if (imageUrl) payload.imageUrl = imageUrl;
    if (videoUrl) payload.videoUrl = videoUrl;
    try{
      const res = await fetch(`${API_BASE}/api/news`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(payload)
      });
      let data = null;
      try{ data = await res.json(); }
      catch{ data = null; }
      if (!res.ok){
        throw new Error(data?.error || `HTTP ${res.status}`);
      }
      if (generalNewsStatus){
        generalNewsStatus.textContent = 'Thanks for sharing! Your post is live.';
      }
      generalNewsForm.reset();
      await loadNews();
    }catch(err){
      if (generalNewsStatus){
        generalNewsStatus.textContent = err?.message || 'Failed to publish your update.';
      }
    }finally{
      if (submitBtn){
        submitBtn.disabled = false;
        submitBtn.removeAttribute('aria-busy');
      }
    }
  });
}

function setNav(active){
  if (active==='fixturesSched' && !isAdmin) { alert('Admins only'); active='fixturesPublic'; }
  document.querySelectorAll('.tab-content').forEach(el=>el.style.display='none');
  const s = {
    home:[homeView, navHome],
    teams:[teamsViewEl, navTeams],
    news:[newsView, navNews],
    fixturesPublic:[fxPublic, navFxPublic],
    fixturesSched:[fxSched, navFxSched],
    champions:[cupView, navChampions],
    league:[leagueView, navLeague],
    friendlies:[friendliesView, navFriendlies],
    competitionsAdmin:[competitionsAdminView, navAdminCompetitions]
  };
  if(rankingsSection){
    s.rankings = [rankingsSection, navRankings];
  }
  for (const key of Object.keys(s)){
    const [view,btn] = s[key];
    const is = key===active;
    if(view && is) view.style.display = 'block';
    if(btn) btn.setAttribute('aria-pressed', String(is));
  }
  if(active==='rankings'){
    ensureRankingsLoaded(false);
  }
}
navHome.onclick        = async ()=>{ setNav('home'); await loadHome(); };
navTeams.onclick       = ()=> { setNav('teams'); ensureRankingsLoaded(false); };
navNews.onclick        = async ()=>{ setNav('news'); await loadNews(); };
navFxPublic.onclick    = ()=> setNav('fixturesPublic');
navFxSched.onclick     = ()=> setNav('fixturesSched');
navChampions.onclick   = async ()=> { setNav('champions'); await loadChampions(); };
navLeague.onclick      = ()=> { setNav('league'); loadLeague(); };
navFriendlies.onclick  = async ()=> { setNav('friendlies'); await loadFriendlies(); };
if(navAdminCompetitions){
  navAdminCompetitions.onclick = async ()=>{
    setNav('competitionsAdmin');
    if(isAdmin){
      await loadCompetitionsAdmin();
    }else{
      updateCompetitionsAdminPanel();
    }
  };
}
if(navRankings){
  navRankings.onclick = ()=>{
    setNav('rankings');
  };
}

const btnViewFullStandings = document.getElementById('btnViewFullStandings');
const btnViewFullTopScorers = document.getElementById('btnViewFullTopScorers');
const goToLeagueView = () => {
  if (navLeague) {
    navLeague.click();
  } else {
    setNav('league');
    loadLeague();
  }
};
if (btnViewFullStandings) {
  btnViewFullStandings.addEventListener('click', goToLeagueView);
}
if (btnViewFullTopScorers) {
  btnViewFullTopScorers.addEventListener('click', goToLeagueView);
}

// auth / admin / manager
const btnAdminLogin = document.getElementById('btnAdminLogin');
const btnAdminLogout= document.getElementById('btnAdminLogout');

btnAdminLogin.onclick = async ()=>{
  const pw = prompt('Admin password');
  if (!pw) return;
  try{
    await apiPost('/api/admin/login',{ password: pw });
    await checkAdmin(); await checkMe();
    alert('Admin signed in');
  }catch(e){ alert('Login failed: '+e.message); }
};
btnAdminLogout.onclick = async ()=>{
  try{ await apiPost('/api/admin/logout',{}); }catch{}
  await checkAdmin(); await checkMe();
  alert('Signed out');
};

async function checkAdmin(){
  try{ const d = await apiGet('/api/admin/me'); isAdmin = !!d.admin; }catch{ isAdmin=false; }
  btnAdminLogout.style.display = isAdmin ? 'inline-block' : 'none';
  navFxSched.style.display = isAdmin ? 'inline-block' : 'none';
  if(navAdminCompetitions){
    navAdminCompetitions.style.display = isAdmin ? 'inline-flex' : 'none';
    if(!isAdmin && navAdminCompetitions.getAttribute('aria-pressed') === 'true'){
      setNav('teams');
    }
  }
  if(competitionsAdminRefresh){
    competitionsAdminRefresh.style.display = isAdmin ? 'inline-flex' : 'none';
  }
  updateAdminNewsPanel();
  updateCompetitionsAdminPanel();
  updatePlayerUploadState();
}
async function checkMe(){
  try { meUser = (await apiGet('/api/auth/me')).user || null; } catch { meUser = null; }
  isMgr = !!(meUser && meUser.role==='Manager');
  navFxSched.style.display = isAdmin ? 'inline-block' : 'none';
}

// =======================
//   TEAMS LIST / DETAIL
// =======================
const teamsGrid = document.getElementById('teamsGrid');
const teamsCount = document.getElementById('teams-count');
const detailView = document.getElementById('detail-view');
const detailTitle = document.getElementById('detail-title');
const detailSub   = document.getElementById('detail-sub');
const backBtn = document.getElementById('backBtn');

function parseVpro(vproattr){
  const parts=String(vproattr||'').split('|').map(n=>parseInt(n,10));
  if(parts.length<27||parts.some(n=>isNaN(n))) return null;
  const avg=a=>Math.round(a.reduce((x,y)=>x+y,0)/a.length);
  const pac=avg([parts[0],parts[1]]);
  const sho=avg([parts[4],parts[5],parts[8],parts[16],parts[17]]);
  const pas=avg([parts[9],parts[19],parts[12],parts[15],parts[13]]);
  const dri=avg([parts[2],parts[3],parts[7],parts[11]]);
  const def=avg([parts[18],parts[10],parts[20],parts[21]]);
  const phy=avg([parts[22],parts[23],parts[24],parts[25],parts[26]]);
  const ovr=Math.round(pac*0.2+sho*0.2+pas*0.2+dri*0.2+def*0.1+phy*0.1);
  return {pac,sho,pas,dri,def,phy,ovr};
}

function tierFromOvr(ovr){
  if(ovr==null) return {frame:'iron_rookie.png',className:'tier-iron'};
  const n=Number(ovr)||0;
  if(n<70) return {frame:'iron_rookie.png',className:'tier-iron'};
  if(n<=84) return {frame:'steel_card.png',className:'tier-steel'};
  if(n<=94) return {frame:'crimson_card.png',className:'tier-crimson'};
  return {frame:'obsidian_elite.png',className:'tier-obsidian'};
}

async function getClubInfo(clubId){
  const res = await fetch(`/api/club-info/${encodeURIComponent(clubId)}`);
  const data = await res.json();
  return data && data[clubId];
}

async function getTeamId(clubId){
  const info = await getClubInfo(clubId);
  return info?.teamId;
}

function getKitUrl(teamId){
  return `https://proclubsdatabase.s3.us-east-2.amazonaws.com/minikits/j0_${teamId}_0.png`;
}

function toHexColor(value){
  if(value === null || value === undefined) return null;
  if(typeof value === 'number' && Number.isFinite(value)){
    let hex = value.toString(16);
    if(hex.length < 6) hex = hex.padStart(6, '0');
    if(hex.length > 6) hex = hex.slice(-6);
    return `#${hex.toLowerCase()}`;
  }
  let str = String(value).trim();
  if(!str) return null;
  str = str.replace(/^#/, '');
  if(/^[0-9a-f]{6}$/i.test(str)) return `#${str.toLowerCase()}`;
  if(/^[0-9a-f]{3}$/i.test(str)){
    str = str.split('').map(ch => ch + ch).join('');
    return `#${str.toLowerCase()}`;
  }
  return null;
}

function parseHexColor(value){
  const hex = toHexColor(value);
  if(!hex) return null;
  return [
    parseInt(hex.slice(1,3), 16),
    parseInt(hex.slice(3,5), 16),
    parseInt(hex.slice(5,7), 16)
  ];
}

function mixColors(colorA, colorB, weight){
  const a = parseHexColor(colorA);
  const b = parseHexColor(colorB);
  if(!a && !b) return null;
  if(!a) return toHexColor(colorB);
  if(!b) return toHexColor(colorA);
  const w = Math.min(1, Math.max(0, weight ?? 0.5));
  const mix = a.map((chan, idx) => Math.round(chan * (1 - w) + b[idx] * w));
  return `#${mix.map(v => v.toString(16).padStart(2, '0')).join('')}`;
}

function hexToRgba(hex, alpha){
  const rgb = parseHexColor(hex);
  if(!rgb) return null;
  const a = Math.min(1, Math.max(0, alpha ?? 1));
  return `rgba(${rgb[0]},${rgb[1]},${rgb[2]},${a})`;
}

function extractKitColors(customKit){
  if(!customKit) return [];
  const keys = ['kitColor1','kitColor2','kitColor3','kitColor4'];
  return keys.map(k => toHexColor(customKit[k])).filter(Boolean);
}

function applyGradient(img, customKit){
  const box = document.createElement('div');
  box.className = 'player-kit-box';
  const colors = extractKitColors(customKit);
  if(colors.length){
    box.style.background = `linear-gradient(45deg, ${colors.join(',')})`;
  }else{
    box.style.background = 'linear-gradient(45deg, #1f2937, #0f172a)';
  }
  img.replaceWith(box);
}

function applyCardTheme(card, customKit){
  if(!card) return;
  const colors = extractKitColors(customKit);
  const primary = colors[0] || '#0f172a';
  const secondary = colors[1] || mixColors(primary, '#1f2937', 0.35) || '#1f2937';
  const accent = colors[2] || colors[0] || '#38bdf8';
  const glowShadow = hexToRgba(accent, 0.45);
  card.style.setProperty('--card-primary', primary);
  card.style.setProperty('--card-secondary', secondary);
  card.style.setProperty('--card-accent', accent);
  card.style.setProperty('--card-glow', accent);
  if(glowShadow) card.style.setProperty('--card-glow-shadow', glowShadow);
  const avatar = card.querySelector('.player-avatar');
  if(avatar){
    const avatarPrimary = mixColors(primary, '#020617', 0.45) || primary;
    const avatarSecondary = mixColors(accent, '#0f172a', 0.25) || accent;
    avatar.style.setProperty('--avatar-primary', avatarPrimary);
    avatar.style.setProperty('--avatar-secondary', avatarSecondary);
    avatar.style.setProperty('--avatar-ring', accent);
    if(!avatar.classList.contains('has-image')){
      avatar.style.background = `linear-gradient(135deg, ${avatarPrimary}, ${avatarSecondary})`;
      avatar.style.backgroundSize = 'cover';
      avatar.style.backgroundPosition = 'center';
    }
  }
}

const clubInfoCache = new Map();
const kitUrlCache = new Map();
const PLAYER_IMAGE_ALLOWED_TYPES = new Set(['image/png','image/jpeg','image/webp','image/jpg']);
const PLAYER_IMAGE_MAX_SIZE = 5 * 1024 * 1024;

function getPlayerInitials(name){
  if(!name) return '?';
  const parts = String(name).trim().split(/\s+/).filter(Boolean);
  if(!parts.length) return '?';
  const initials = parts.slice(0,2).map(part => part[0]).join('');
  return initials.toUpperCase();
}

function readNumeric(source, keys){
  if(!source) return null;
  for(const key of keys){
    if(Object.prototype.hasOwnProperty.call(source, key)){
      const raw = source[key];
      if(raw === null || raw === undefined || raw === '') continue;
      const num = Number(raw);
      if(Number.isFinite(num)) return num;
    }
  }
  return null;
}

function resolvePlayerRating(source, stats){
  const candidates = [
    source?.rating,
    source?.averageRating,
    source?.avgMatchRating,
    source?.averageMatchRating,
    source?.matchRating,
    source?.overallRating,
    source?.ovr,
    source?.proOverall,
    source?.prooverall,
    stats?.rating,
    stats?.ovr
  ];
  for(const value of candidates){
    if(value === null || value === undefined || value === '') continue;
    const num = Number(value);
    if(Number.isFinite(num)) return num;
  }
  return null;
}

function formatRatingValue(num){
  if(num === null || num === undefined || Number.isNaN(num)) return '–';
  if(num >= 10) return String(Math.round(num));
  return (Math.round(num * 10) / 10).toFixed(1);
}

function formatStatValue(value){
  if(value === null || value === undefined || value === '') return '–';
  if(typeof value === 'number'){
    return Number.isFinite(value) ? value.toLocaleString() : '–';
  }
  const str = String(value).trim();
  return str ? str : '–';
}

function formatOverallValue(num){
  if(num === null || num === undefined || Number.isNaN(num)) return 'N/A';
  return Math.round(num);
}

function normalizeFormArray(value){
  if(value === null || value === undefined) return [];
  const source = Array.isArray(value) ? value : String(value).split('');
  const normalized = [];
  for(const entry of source){
    if(entry === null || entry === undefined) continue;
    const char = String(entry).trim().toUpperCase();
    if(!char) continue;
    const code = char[0];
    if(code === 'W' || code === 'D' || code === 'L'){
      normalized.push(code);
      if(normalized.length >= 5) break;
    }
  }
  return normalized;
}

function renderPlayerFormDots(formCodes){
  const dots = Array.isArray(formCodes) ? formCodes.slice(0,5) : [];
  while(dots.length < 5) dots.push(null);
  return dots.map(code => {
    if(code === 'W'){
      return '<span class="player-form-dot W" aria-label="Win" title="Win"></span>';
    }
    if(code === 'D'){
      return '<span class="player-form-dot D" aria-label="Draw" title="Draw"></span>';
    }
    if(code === 'L'){
      return '<span class="player-form-dot L" aria-label="Loss" title="Loss"></span>';
    }
    return '<span class="player-form-dot empty" aria-hidden="true"></span>';
  }).join('');
}

function formatFormAria(formCodes){
  if(!Array.isArray(formCodes) || formCodes.length === 0){
    return 'Recent form: no data available';
  }
  const words = formCodes.map(code => {
    if(code === 'W') return 'Win';
    if(code === 'D') return 'Draw';
    if(code === 'L') return 'Loss';
    return null;
  }).filter(Boolean);
  if(!words.length) return 'Recent form: no data available';
  return `Recent form: ${words.join(', ')}`;
}

function composePlayerMeta(player, stats, overrides = {}){
  const base = player || {};
  const matches = readNumeric(overrides, ['matches','gamesPlayed','appearances']) ?? readNumeric(base, ['matches','gamesPlayed','appearances']);
  const goals = readNumeric(overrides, ['goals','totalGoals']) ?? readNumeric(base, ['goals','totalGoals']);
  const assists = readNumeric(overrides, ['assists','totalAssists']) ?? readNumeric(base, ['assists','totalAssists']);
  const ratingNum = resolvePlayerRating(overrides, stats) ?? resolvePlayerRating(base, stats);
  const rating = formatRatingValue(ratingNum);
  const name = overrides.name ?? base.name ?? 'Unknown';
  const position = overrides.position ?? base.position ?? '';
  const clubId = overrides.clubId ?? base.clubId ?? null;
  const overallCandidates = [
    overrides.overallRating,
    overrides.ovr,
    base.overallRating,
    base.ovr,
    stats?.ovr,
  ];
  let overallRating = null;
  for(const value of overallCandidates){
    if(value === null || value === undefined || value === '') continue;
    const num = Number(value);
    if(Number.isFinite(num) && num > 0){ overallRating = num; break; }
  }
  const clubName = overrides.clubName
    ?? base.clubName
    ?? (clubId ? (byId(clubId)?.name || '') : '');
  const flag = overrides.countryFlag ?? overrides.flag ?? base.countryFlag ?? base.flag ?? base.flagUrl ?? null;
  const isCaptain = Boolean(overrides.isCaptain ?? base.isCaptain);
  const isTopScorer = Boolean(overrides.isTopScorer);
  const hasOverrideForm = Object.prototype.hasOwnProperty.call(overrides, 'form');
  const form = hasOverrideForm ? normalizeFormArray(overrides.form) : normalizeFormArray(base.form);
  const imageUrl = overrides.imageUrl ?? overrides.imageurl ?? base.imageUrl ?? base.imageurl ?? null;
  return {
    matches,
    goals,
    assists,
    rating,
    ratingNum,
    name,
    position,
    clubId,
    clubName,
    overallRating,
    flag,
    isCaptain,
    isTopScorer,
    form,
    imageUrl,
  };
}

function renderPlayerStat(key, label, value, highlight){
  const classes = ['player-stat'];
  if(highlight) classes.push('top-scorer');
  return `<div class="${classes.join(' ')}" data-stat="${key}"><span class="stat-label">${label}</span><span class="stat-value">${escapeHtml(formatStatValue(value))}</span></div>`;
}

function applyPlayerImage(card, imageUrl, playerName){
  if(!card) return;
  const avatar = card.querySelector('.player-avatar');
  if(!avatar) return;
  const img = avatar.querySelector('.player-avatar-img');
  const initialsEl = avatar.querySelector('.player-avatar-initial');
  if(initialsEl) initialsEl.textContent = getPlayerInitials(playerName);
  const trimmed = typeof imageUrl === 'string' ? imageUrl.trim() : '';
  const normalizedUrl = trimmed || '';
  card.dataset.imageUrl = normalizedUrl;
  if(!img){
    if(!normalizedUrl){
      avatar.classList.remove('has-image');
      avatar.dataset.hasPhoto = 'false';
      card.style.removeProperty('--player-card-photo');
      card.dataset.hasPhoto = 'false';
    }
    return;
  }
  if(normalizedUrl){
    const version = card.dataset.imageVersion;
    const finalUrl = version ? `${normalizedUrl}${normalizedUrl.includes('?') ? '&' : '?'}v=${version}` : normalizedUrl;
    if(img.src !== finalUrl) img.src = finalUrl;
    img.alt = playerName ? `${playerName} portrait` : 'Player portrait';
    avatar.classList.add('has-image');
    avatar.dataset.hasPhoto = 'true';
    card.style.setProperty('--player-card-photo', `url("${finalUrl}")`);
    card.dataset.hasPhoto = 'true';
  }else{
    img.removeAttribute('src');
    img.alt = '';
    avatar.classList.remove('has-image');
    avatar.dataset.hasPhoto = 'false';
    card.style.removeProperty('--player-card-photo');
    card.dataset.hasPhoto = 'false';
  }
}

function applyPlayerForm(card, formCodes){
  if(!card) return;
  const indicator = card.querySelector('.player-form-indicator');
  if(!indicator) return;
  const normalized = normalizeFormArray(formCodes);
  indicator.innerHTML = renderPlayerFormDots(normalized);
  const ariaText = formatFormAria(normalized);
  indicator.setAttribute('aria-label', ariaText);
  indicator.setAttribute('title', ariaText.replace('Recent form: ', '') || 'Recent form: N/A');
  indicator.dataset.hasData = normalized.length ? 'true' : 'false';
  card.dataset.form = normalized.join('');
}

function applyAdminStateToPlayerCard(card){
  if(!card) return;
  const input = card.querySelector('.player-upload-input');
  if(input){
    if(card.dataset.playerUploadKey){
      input.dataset.playerUploadKey = card.dataset.playerUploadKey;
    }
    if(card.dataset.playerId){
      input.dataset.playerId = card.dataset.playerId;
    }else{
      delete input.dataset.playerId;
    }
    if(card.dataset.clubId){
      input.dataset.clubId = card.dataset.clubId;
    }else{
      delete input.dataset.clubId;
    }
    input.disabled = !isAdmin;
  }
}

function updatePlayerUploadState(){
  document.body.classList.toggle('is-admin', isAdmin);
  document.querySelectorAll('.player-card').forEach(applyAdminStateToPlayerCard);
}

async function renderClubKits(clubId, container){
  if(!clubId) return;
  let info = clubInfoCache.get(clubId);
  if(!info){
    try{ info = await getClubInfo(clubId); clubInfoCache.set(clubId, info); }
    catch(e){ info=null; }
  }
  const teamId = info?.teamId;
  const customKit = info?.customKit || {};
  let kitUrl = teamId ? kitUrlCache.get(teamId) : null;
  if(teamId && !kitUrl){
    kitUrl = getKitUrl(teamId);
    kitUrlCache.set(teamId, kitUrl);
  }
  let imgs;
  if(container){
    imgs = container.querySelectorAll(`[data-club-id="${clubId}"] .player-kit`);
    if(!imgs.length) imgs = container.querySelectorAll('.player-kit');
  }else{
    imgs = document.querySelectorAll(`.team-card[data-club-id="${clubId}"] .player-kit, [data-club-id="${clubId}"] .player-kit`);
  }
  imgs.forEach(img=>{
    if(kitUrl){
      img.src = kitUrl;
      img.onerror = () => applyGradient(img, customKit);
    }else{
      applyGradient(img, customKit);
    }
  });
  const scope = container || document;
  const cards = scope.querySelectorAll(`.player-card[data-club-id="${clubId}"]`);
  cards.forEach(card => applyCardTheme(card, customKit));
}

function buildPlayerCard(p, stats, tier, overrides){
  const t = tier || tierFromOvr(stats?.ovr);
  const meta = composePlayerMeta(p, stats, overrides);
  const card = document.createElement('div');
  const classes = ['player-card'];
  if(t?.className) classes.push(t.className);
  card.className = classes.join(' ');
  const rawPlayerId = p.player_id ?? p.playerId;
  const playerId = rawPlayerId !== undefined && rawPlayerId !== null ? String(rawPlayerId) : '';
  if(playerId){
    card.dataset.playerId = playerId;
  }
  if(meta.clubId !== undefined && meta.clubId !== null){
    card.dataset.clubId = String(meta.clubId);
  }
  const uploadKey = getPlayerUploadKey(meta, playerId, card.dataset.playerUploadKey);
  card.dataset.playerUploadKey = uploadKey;
  if(meta.name) card.dataset.playerName = meta.name;
  if(meta.position !== undefined) card.dataset.playerPosition = meta.position;
  if(meta.clubName) card.dataset.clubName = meta.clubName;
  card.dataset.overallRating = meta.overallRating !== null && meta.overallRating !== undefined
    ? String(meta.overallRating)
    : '';
  card.dataset.isCaptain = meta.isCaptain ? 'true' : 'false';
  card.dataset.topScorer = meta.isTopScorer ? 'true' : 'false';
  card.dataset.imageVersion = card.dataset.imageVersion || '';
  const badgeTitle = 'Team Captain';
  const flagHtml = meta.flag ? `<img src="${escapeHtml(meta.flag)}" class="player-flag" alt="">` : '';
  const overallText = formatOverallValue(meta.overallRating);
  const formAria = escapeHtml(formatFormAria(meta.form));
  const formDots = renderPlayerFormDots(meta.form);
  const uploadId = `upload-${uploadKey}`;
  const playerIdAttr = playerId ? ` data-player-id="${escapeAttr(playerId)}"` : '';
  const clubIdAttr = meta.clubId !== undefined && meta.clubId !== null
    ? ` data-club-id="${escapeAttr(meta.clubId)}"`
    : '';
  const uploadControls = `
      <div class="player-card-actions">
        <label class="upload-btn" for="${escapeAttr(uploadId)}">Upload Image</label>
        <input type="file" class="player-upload-input" id="${escapeAttr(uploadId)}" data-player-upload-key="${escapeAttr(uploadKey)}"${playerIdAttr}${clubIdAttr} accept="image/png,image/jpeg,image/webp" hidden>
      </div>
    `;
  card.innerHTML = `
    <div class="player-card-badge" title="${badgeTitle}" aria-label="${badgeTitle}">🏅</div>
    <div class="player-card-header player-card-top">
      <div class="player-form-indicator" aria-label="${formAria}" title="${formAria}">
        ${formDots}
      </div>
      <div class="player-position-chip">${escapeHtml(meta.position || 'UNK')}</div>
    </div>
    <div class="player-avatar" data-has-photo="false">
      <img class="player-avatar-img" alt="" loading="lazy">
      <span class="player-avatar-initial">${escapeHtml(getPlayerInitials(meta.name))}</span>
    </div>
    <div class="player-card-info">
      <div class="player-name-row">
        <span class="player-name">${escapeHtml(meta.name)}</span>
        ${flagHtml}
      </div>
      <div class="player-club">${escapeHtml(meta.clubName || '')}</div>
    </div>
    <div class="player-ovr-pill">
      <span class="ovr-label">OVR</span>
      <span class="ovr-value">${escapeHtml(String(overallText))}</span>
    </div>
    <div class="player-stat-grid">
      ${renderPlayerStat('matches','Matches',meta.matches,false)}
      ${renderPlayerStat('goals','Goals',meta.goals,meta.isTopScorer)}
      ${renderPlayerStat('assists','Assists',meta.assists,false)}
      ${renderPlayerStat('rating','Rating',meta.rating,false)}
    </div>
    ${uploadControls}
  `;
  const badge = card.querySelector('.player-card-badge');
  if(badge){
    if(meta.isCaptain){
      badge.hidden = false;
      badge.setAttribute('title', badgeTitle);
      badge.setAttribute('aria-label', badgeTitle);
    }else{
      badge.hidden = true;
      badge.removeAttribute('title');
      badge.removeAttribute('aria-label');
    }
  }
  applyPlayerImage(card, meta.imageUrl, meta.name);
  applyPlayerForm(card, meta.form);
  applyAdminStateToPlayerCard(card);
  return card;
}

function updatePlayerCard(card, stats, overrides={}){
  if(!card) return;
  const tier = tierFromOvr(stats?.ovr);
  const classes = ['player-card'];
  if(tier?.className) classes.push(tier.className);
  card.className = classes.join(' ');
  const existing = {
    name: card.dataset.playerName,
    position: card.dataset.playerPosition,
    clubId: card.dataset.clubId,
    clubName: card.dataset.clubName,
    overallRating: card.dataset.overallRating ? Number(card.dataset.overallRating) : null,
    isCaptain: card.dataset.isCaptain === 'true'
  };
  const meta = composePlayerMeta(existing, stats, overrides);
  const overridePlayerId = overrides.playerId ?? overrides.playerid;
  if(overridePlayerId !== undefined && overridePlayerId !== null && overridePlayerId !== ''){
    card.dataset.playerId = String(overridePlayerId);
  }
  const currentPlayerId = card.dataset.playerId || '';
  const uploadKey = getPlayerUploadKey(meta, currentPlayerId, card.dataset.playerUploadKey);
  card.dataset.playerUploadKey = uploadKey;
  card.dataset.playerName = meta.name;
  card.dataset.playerPosition = meta.position || '';
  if(meta.clubId !== null && meta.clubId !== undefined) card.dataset.clubId = String(meta.clubId);
  else delete card.dataset.clubId;
  if(meta.clubName !== undefined && meta.clubName !== null) card.dataset.clubName = String(meta.clubName);
  card.dataset.overallRating = meta.overallRating !== null && meta.overallRating !== undefined
    ? String(meta.overallRating)
    : '';
  card.dataset.isCaptain = meta.isCaptain ? 'true' : 'false';
  card.dataset.topScorer = meta.isTopScorer ? 'true' : 'false';
  card.dataset.imageVersion = card.dataset.imageVersion || '';
  const badge = card.querySelector('.player-card-badge');
  if(badge){
    badge.hidden = !meta.isCaptain;
    if(meta.isCaptain){
      badge.setAttribute('title', 'Team Captain');
      badge.setAttribute('aria-label', 'Team Captain');
    }else{
      badge.removeAttribute('title');
      badge.removeAttribute('aria-label');
    }
  }
  const nameEl = card.querySelector('.player-name');
  if(nameEl) nameEl.textContent = meta.name;
  const initialsEl = card.querySelector('.player-avatar-initial');
  if(initialsEl) initialsEl.textContent = getPlayerInitials(meta.name);
  const positionEl = card.querySelector('.player-position-chip');
  if(positionEl) positionEl.textContent = meta.position || 'UNK';
  const clubEl = card.querySelector('.player-club');
  if(clubEl) clubEl.textContent = meta.clubName || '';
  const ovrEl = card.querySelector('.player-ovr-pill .ovr-value');
  if(ovrEl) ovrEl.textContent = formatOverallValue(meta.overallRating);
  const uploadId = `upload-${uploadKey}`;
  const input = card.querySelector('.player-upload-input');
  if(input){
    input.dataset.playerUploadKey = uploadKey;
    input.id = uploadId;
    if(card.dataset.playerId){
      input.dataset.playerId = card.dataset.playerId;
    }else{
      delete input.dataset.playerId;
    }
    if(meta.clubId !== null && meta.clubId !== undefined){
      input.dataset.clubId = String(meta.clubId);
    }else{
      delete input.dataset.clubId;
    }
    const label = card.querySelector('.player-card-actions label.upload-btn');
    if(label){
      label.setAttribute('for', uploadId);
    }
  }
  applyPlayerImage(card, meta.imageUrl, meta.name);
  applyPlayerForm(card, meta.form);
  const nameRow = card.querySelector('.player-name-row');
  let flagEl = card.querySelector('.player-flag');
  if(meta.flag){
    if(!flagEl){
      flagEl = document.createElement('img');
      flagEl.className = 'player-flag';
      flagEl.alt = '';
      if(nameRow) nameRow.appendChild(flagEl);
    }
    flagEl.src = meta.flag;
    flagEl.style.display = '';
  }else if(flagEl){
    flagEl.remove();
    flagEl = null;
  }
  const statMap = {
    matches: meta.matches,
    goals: meta.goals,
    assists: meta.assists,
    rating: meta.rating
  };
  Object.entries(statMap).forEach(([key,value])=>{
    const statEl = card.querySelector(`.player-stat[data-stat="${key}"] .stat-value`);
    if(statEl) statEl.textContent = formatStatValue(value);
  });
  const goalsStat = card.querySelector('.player-stat[data-stat="goals"]');
  if(goalsStat){
    if(meta.isTopScorer) goalsStat.classList.add('top-scorer');
    else goalsStat.classList.remove('top-scorer');
  }
  applyAdminStateToPlayerCard(card);
}

async function upgradeClubPlayers(clubId, container){
  try{
    const d = await fetch(`/api/clubs/${encodeURIComponent(clubId)}/player-cards`).then(r=>r.json());
    const grid = container || document.querySelector(`.team-card[data-club-id="${clubId}"] .players-grid`);
    if(!grid) return;
    const members = Array.isArray(d.members) ? d.members : [];
    const topGoals = members.reduce((max, m) => {
      const goals = readNumeric(m, ['goals','totalGoals']);
      return Math.max(max, goals ?? 0);
    }, 0);
    members.forEach(m=>{
      const id = m.playerId || m.playerid;
      let card = grid.querySelector(`.player-card[data-player-id="${id}"]`);
      if(!card){
        card = Array.from(grid.querySelectorAll('.player-card')).find(el=>el.dataset.playerName === m.name);
      }
      const stats = m.stats || (m.vproattr ? parseVpro(m.vproattr) : null);
      if(card && stats){
        const goals = readNumeric(m, ['goals','totalGoals']);
        const overall = readNumeric(m, ['overallRating','ovr','proOverall']);
        const clubMeta = byId(clubId);
        const overrides = {
          matches: readNumeric(m, ['matches','gamesPlayed','appearances']),
          goals,
          assists: readNumeric(m, ['assists','totalAssists']),
          rating: resolvePlayerRating(m, stats),
          isCaptain: m.isCaptain,
          isTopScorer: topGoals > 0 && goals === topGoals,
          name: m.name,
          position: typeof resolvePlayerPosition === 'function' ? resolvePlayerPosition(m) : (m.position || ''),
          clubId: clubId,
          clubName: clubMeta?.name || '',
          overallRating: overall ?? stats?.ovr ?? null,
          imageUrl: m.imageUrl,
          form: m.form,
        };
        updatePlayerCard(card, stats, overrides);
      }
    });
    renderClubKits(clubId, grid);
  }catch(e){
    console.error('upgrade failed', e);
  }
}

async function uploadPlayerImage(uploadKey, input){
  if(!uploadKey || !input) return;
  if(!isAdmin){
    alert('Admin access required.');
    input.value = '';
    return;
  }
  const file = input.files && input.files[0];
  if(!file){
    return;
  }
  if(!PLAYER_IMAGE_ALLOWED_TYPES.has(file.type)){
    alert('Please select a JPG, PNG, or WEBP image.');
    input.value = '';
    return;
  }
  if(file.size > PLAYER_IMAGE_MAX_SIZE){
    alert('Image is too large. Maximum size is 5MB.');
    input.value = '';
    return;
  }
  const card = input.closest('.player-card');
  const label = card ? card.querySelector(`label[for="${input.id}"]`) : null;
  if(label){
    label.dataset.originalText = label.dataset.originalText || label.textContent;
    label.textContent = 'Uploading…';
    label.classList.add('is-uploading');
  }
  const formData = new FormData();
  formData.append('image', file);
  const cardClubId = input.dataset.clubId || card?.dataset.clubId || '';
  const playerName = card?.dataset.playerName || '';
  const playerPosition = card?.dataset.playerPosition || '';
  if(cardClubId){
    formData.append('clubId', cardClubId);
  }
  if(playerName){
    formData.append('playerName', playerName);
  }
  if(playerPosition){
    formData.append('position', playerPosition);
  }
  try{
    const res = await fetch(`/api/players/${encodeURIComponent(uploadKey)}/uploadImage`, {
      method: 'POST',
      body: formData,
      credentials: 'include',
    });
    const payload = await res.json().catch(()=>({}));
    if(!res.ok || !payload?.success){
      throw new Error(payload?.error || 'Upload failed');
    }
    if(card){
      card.dataset.imageVersion = String(Date.now());
      applyPlayerImage(card, payload.imageUrl || '', card.dataset.playerName || '');
    }
  }catch(err){
    console.error('upload failed', err);
    alert(err?.message || 'Failed to upload image');
  }finally{
    if(label){
      label.textContent = label.dataset.originalText || 'Upload Image';
      label.classList.remove('is-uploading');
    }
    input.value = '';
  }
}

document.addEventListener('change', event => {
  const target = event.target;
  if(!target || !(target instanceof HTMLInputElement)) return;
  if(!target.classList.contains('player-upload-input')) return;
  const uploadKey = target.dataset.playerUploadKey || target.closest('.player-card')?.dataset.playerUploadKey;
  if(!uploadKey){
    target.value = '';
    return;
  }
  uploadPlayerImage(uploadKey, target);
});
async function openTeamView(clubId){
  teamsGrid.style.display = 'none';
  const teamView = document.getElementById('teamView');
  teamView.style.display = 'block';
  const team = byId(clubId);
  const name = team ? team.name : ((typeof CLUB_NAMES !== 'undefined' && CLUB_NAMES[clubId]) || 'Unknown Club');
  teamView.innerHTML = `<button id="teamBackBtn">← Back</button>
    <h2>${escapeHtml(name)}</h2>
    <div class="team-wallet">Wallet: TBD</div>
    <div class="players-grid"></div>`;
  document.getElementById('teamBackBtn').addEventListener('click', closeTeamView);
  const grid = teamView.querySelector('.players-grid');
  let members = [];
  try{
    const res = await fetch(`/api/teams/${clubId}/players`);
    const data = await res.json();
    members = data.members || [];
  }catch(e){console.error(e);} 
  const topGoals = members.reduce((max, m) => {
    const goals = readNumeric(m, ['goals','totalGoals']);
    return Math.max(max, goals ?? 0);
  }, 0);
  members.forEach(m => {
    const stats = m.stats || (m.vproattr
      ? parseVpro(m.vproattr)
      : { pac:'??', sho:'??', pas:'??', dri:'??', def:'??', phy:'??', ovr: m.proOverall || '??' });
    const tier = tierFromOvr(stats.ovr);
    const position = typeof resolvePlayerPosition === 'function' ? resolvePlayerPosition(m) : (m.position || '');
    const goals = readNumeric(m, ['goals','totalGoals']);
    const overall = readNumeric(m, ['overallRating','ovr','proOverall']);
    const clubMeta = byId(clubId);
    const overrides = {
      matches: readNumeric(m, ['matches','gamesPlayed','appearances']),
      goals,
      assists: readNumeric(m, ['assists','totalAssists']),
      rating: resolvePlayerRating(m, stats),
      isCaptain: m.isCaptain,
      isTopScorer: topGoals > 0 && goals === topGoals,
      position,
      clubId,
      clubName: clubMeta?.name || '',
      overallRating: overall ?? stats?.ovr ?? null,
    };
    const card = buildPlayerCard({ ...m, clubId, position }, stats, tier, overrides);
    grid.appendChild(card);
  });
  renderClubKits(clubId, teamView);
  upgradeClubPlayers(clubId, grid);
}

function closeTeamView(){
  document.getElementById('teamView').style.display = 'none';
  teamsGrid.style.display = 'grid';
}


async function loadPlayers(){
  try{
    const d = await apiGet('/api/players');
    playersByClub = {};
    (d.players||[]).forEach(p=>{
      const cid = String(p.club_id);
      (playersByClub[cid] ||= []).push(p);
    });
    document.querySelectorAll('.team-card .players-grid').forEach(grid=>{
      grid.innerHTML = '';
    });
  }catch(e){
    console.error('Failed to load players', e);
  }
}

async function showTeam(team){
  window.scrollTo({top:0,behavior:'smooth'});
  document.getElementById('teams-view').style.display='none';
  detailView.style.display='block';
  detailTitle.textContent = team.name;
  detailSub.textContent = 'Loading club info…';

  await renderWallet(team.id);
  await refreshFixturesPublic(); renderNextFor(team.id); renderTeamResults(team.id);
  await loadSquad(team.id);

  detailSub.textContent = 'Club overview';
}

backBtn.addEventListener('click', ()=>{
  detailView.style.display='none';
  teamsViewEl.style.display='block';
  window.scrollTo({top:0,behavior:'smooth'});
});

// Wallet
async function renderWallet(clubId){
  const body = document.getElementById('walletBody');
  const hint = document.getElementById('walletHint');
  const btn = document.getElementById('btnCollect');
  try{
    const d = await apiGet(`/api/wallets/${encodeURIComponent(clubId)}`);
    const w = d.wallet||{}, prev = d.preview||{};
    const per = d.perDay||0;
    body.innerHTML = `
      Balance: <strong>${fmtMoney(w.balance||0)}</strong><br>
      Tier payout: <strong>${fmtMoney(per)}</strong> / day<br>
      Pending payout: <strong>${fmtMoney(prev.amount||0)}</strong> (${prev.days||0} days)
    `;
    const canCollect = meUser && meUser.role==='Manager' && String(meUser.teamId)===String(clubId);
    btn.style.display = canCollect ? 'inline-block' : 'none';
    btn.onclick = async ()=>{
      try{
        const r = await apiPost(`/api/wallets/${encodeURIComponent(clubId)}/collect`,{});
        alert(r.ok ? `Collected ${fmtMoney(r.collected||0)}` : (r.message||'No payout'));
        await renderWallet(clubId);
      }catch(e){ alert('Collect failed: '+e.message); }
    };
    hint.textContent = canCollect ? 'Only the club manager can collect.' : 'Contact an administrator to collect payouts.';
  }catch(e){
    body.textContent = 'Wallet unavailable';
    hint.textContent = '';
    btn.style.display='none';
  }
}

async function loadSquad(clubId){
  const panel = document.getElementById('squadPanel');
  const body  = document.getElementById('squadBody');
  panel.style.display = 'block';
  body.innerHTML = 'Loading…';
  document.getElementById('squadTools').style.display = 'none';
  try{
    let members = playersByClub[clubId] || [];
    if (!members.length){
      const r = await fetch(`/api/clubs/${encodeURIComponent(clubId)}/squad`, {credentials:'include'})
        .then(res => res.ok ? res.json() : { slots: [] })
        .catch(() => ({ slots: [] }));
      members = r.slots
        .filter(s => s.player && (s.player.eaName || s.player.name))
        .map(s => ({ name: s.player.eaName || s.player.name || s.label }));
    }
    if (!members.length){
      body.innerHTML = '<div class="muted">No players registered.</div>';
      return;
    }
    body.innerHTML = '';
    members.forEach(p=>{
      const nameRaw = p.name || p.playername || p.proName || p.personaName;
      const name = nameRaw ? nameRaw : `Unknown_${p.playerId||p.playerid||''}`;
      const pos = p.position || p.pos || '';
      const stats = parseVpro(p.vproattr);
      const t = tierFromOvr(stats?.ovr);
      const baseStats = stats || { pac:'??', sho:'??', pas:'??', dri:'??', def:'??', phy:'??', ovr: stats?.ovr || '??' };
      const overrides = { position: pos, clubId };
      const card = buildPlayerCard({ name, position: pos, playerId: p.playerId||p.playerid, clubId }, baseStats, t, overrides);
      body.appendChild(card);
    });
    renderClubKits(clubId, body);
  }catch(e){
    if (e.status === 504) {
      body.innerHTML = 'EA API timed out. Try again.';
    } else if (e.status === 502) {
      body.innerHTML = 'EA API request failed.';
    } else {
      body.innerHTML = 'Failed to load squad.';
    }
  }
}

// =======================
//   FIXTURES — PUBLIC
// =======================
const fixturesPublicList = document.getElementById('fixturesPublicList');

async function refreshMatches() {
  try {
    const res = await fetch('/api/matches');
    const { matches } = await res.json();
    renderMatches(matches);
  } catch (err) {
    console.error('Failed to load matches', err);
  }
}

function renderMatches(matches) {
  const container = document.querySelector('#fixtures');
  container.innerHTML = '';
  if (!Array.isArray(matches) || !matches.length) {
    container.innerHTML = '<p>No matches yet.</p>';
    return;
  }
  matches.forEach(m => {
    const teams = Object.values(m.clubs || {}).map(c => ({
      name: c.details?.name || '',
      score: Number(c.goals ?? c.score ?? 0)
    }));
    if (teams.length < 2) return;
    const card = document.createElement('div');
    card.className = 'match-card glow-card glow-green';
    const status = String(m.status || '').toLowerCase();
    const isFinal = status === 'final';
    const homeClass = !isFinal ? 'score score-silver' : (teams[0].score === teams[1].score ? 'score score-silver' : (teams[0].score > teams[1].score ? 'score score-gold' : 'score'));
    const awayClass = !isFinal ? 'score score-silver' : (teams[1].score === teams[0].score ? 'score score-silver' : (teams[1].score > teams[0].score ? 'score score-gold' : 'score'));
    const scoreMarkup = isFinal
      ? `<span class="${homeClass}">${teams[0].score}</span><span class="muted">-</span><span class="${awayClass}">${teams[1].score}</span>`
      : `<span class="score-pill score-upcoming">vs</span>`;
    card.innerHTML = `
      <div class="match-line"><span class="club">${escapeHtml(teams[0].name)}</span>${scoreMarkup}<span class="club">${escapeHtml(teams[1].name)}</span></div>
      <small>${fmtDate(m.timestamp)}</small>
    `;
    container.appendChild(card);
  });
}

async function refreshFixturesPublic(){
  try {
    const d = await apiGet('/api/cup/fixtures?cup=UPCL');
    fixturesPublicCache = normalizeFixtures(d.fixtures);
  } catch { fixturesPublicCache = []; }
}
function renderFixturesPublic(){
  const list = fixturesPublicCache.slice().sort((a,b)=>(a.when||a.createdAt)-(b.when||b.createdAt));
  fixturesPublicList.innerHTML = list.length ? list.map(f=>{
    const banner = getFixtureBanner();
    const H = byId(f.home), A = byId(f.away);
    const hn = H?.name || f.home;
    const an = A?.name || f.away;
    const whenTxt = f.when ? fmtDate(f.when) : 'TBD';
    const isFinal = String(f.status||'').toLowerCase()==='final';
    const scoreTxt = isFinal ? `${f.score.hs}–${f.score.as}` : 'vs';
    const scoreClass = isFinal ? 'score-final' : 'score-upcoming';
    const ccBadge = (f.cup===CC_ID) ? ' • <span class="chip">Champions Cup</span>' : '';
    return `
      <div class="fx glow-card glow-silver">
        <div>
          ${banner ? `<img class="fx-banner" src="${banner}" alt="">` : ''}
          <div class="fx-vs">
            <span class="fx-team"><img src="${teamLogoUrl(H)}" alt=""><span>${escapeHtml(hn)}</span></span>
            <span class="score-pill ${scoreClass}">${scoreTxt}</span>
            <span class="fx-team"><img src="${teamLogoUrl(A)}" alt=""><span>${escapeHtml(an)}</span></span>
          </div>
          <div class="meta">${escapeHtml(f.round||'')}${ccBadge} • ${escapeHtml(whenTxt)} • ${escapeHtml(f.status||'')}</div>
        </div>
      </div>`;
  }).join('') : `<div class="muted">No fixtures yet.</div>`;
}

// Next & recent for team (from public cache)
function nextFor(teamId){
  const now = Date.now();
  return fixturesPublicCache
    .filter(f => (f.home===teamId||f.away===teamId) && f.status!=='final' && f.when && f.when>=now)
    .sort((a,b)=>a.when-b.when)[0];
}
function finalsFor(teamId, n=5){
  return fixturesPublicCache
    .filter(f => String(f.status||'').toLowerCase()==='final' && (f.home===teamId||f.away===teamId))
    .sort((a,b)=>(b.when||b.createdAt)-(a.when||a.createdAt))
    .slice(0,n);
}
function renderNextFor(teamId){
  const el = document.getElementById('nextMatchBody');
  const f = nextFor(teamId);
  if (!f){ el.textContent='No scheduled match yet.'; return; }
  const hn = byId(f.home)?.name || f.home;
  const an = byId(f.away)?.name || f.away;
  el.innerHTML = `<div class="fx-vs"><span class="fx-team"><img src="${teamLogoUrl(byId(f.home))}" alt=""><span>${escapeHtml(hn)}</span></span>
                  <span class="score-pill score-upcoming">vs</span>
                  <span class="fx-team"><img src="${teamLogoUrl(byId(f.away))}" alt=""><span>${escapeHtml(an)}</span></span></div>
                  <div class="muted">${fmtDate(f.when)}</div>`;
}
function renderTeamResults(teamId){
  const el = document.getElementById('teamResultsBody');
  const list = finalsFor(teamId);
  el.innerHTML = list.length ? list.map(f=>{
    const hn = byId(f.home)?.name || f.home;
    const an = byId(f.away)?.name || f.away;
    return `<div><span class="muted">FT</span> <span class="score-pill score-final">${f.score.hs}–${f.score.as}</span> <strong>${escapeHtml(hn)}</strong> vs <strong>${escapeHtml(an)}</strong> • ${fmtDate(f.when||f.createdAt)}</div>`;
  }).join('') : 'No finals yet.';
}

// =======================
//   FIXTURES — SCHEDULING
// =======================
const fixturesList = document.getElementById('fixturesList');
const btnCreateFx  = document.getElementById('btnCreateFx');

btnCreateFx.onclick = async ()=>{
  const home = prompt('Home club ID');
  const away = prompt('Away club ID');
  const round= prompt('Round (e.g., League MD1 or Cup QF)');
  if (!home || !away) return;
  try{
    const d = await apiPost('/api/cup/fixtures', { home, away, round, cup:'UPCL' });
    alert('Created fixture'); await refreshFixturesSched(); renderFixturesSched();
  }catch(e){ alert('Create failed: '+e.message); }
};

document.querySelectorAll('[data-fxf]').forEach(btn=>{
  btn.onclick = ()=>{
    document.querySelectorAll('[data-fxf]').forEach(b=>b.setAttribute('aria-pressed','false'));
    btn.setAttribute('aria-pressed','true');
    renderFixturesSched();
  };
});

async function refreshFixturesSched(){
  if (!isAdmin) { fixturesSchedCache=[]; return; }
  try {
    const d = await apiGet('/api/cup/fixtures/scheduling?cup=UPCL');
    fixturesSchedCache = d.fixtures || [];
  } catch {
    fixturesSchedCache = [];
  }
}
function filterKey(){
  const active = [...document.querySelectorAll('[data-fxf]')].find(b=>b.getAttribute('aria-pressed')==='true');
  return active ? active.getAttribute('data-fxf') : 'upcoming';
}
function renderFixturesSched(){
  const key = filterKey();
  let list = fixturesSchedCache.slice();
  const now = Date.now();

  if (key==='upcoming'){
    list = list.filter(f => f.status!=='final' && (!f.when || f.when>=now));
  } else if (key==='final'){
    list = list.filter(f => String(f.status||'').toLowerCase()==='final');
  } else if (key==='mine' && meUser){
    list = list.filter(f => f.home===meUser.teamId || f.away===meUser.teamId);
  }

  list.sort((a,b)=>(a.when||a.createdAt)-(b.when||b.createdAt));
  fixturesList.innerHTML = list.length ? list.map(renderFxSchedRow).join('') : `<div class="muted">No fixtures.</div>`;

  // wire buttons
  list.forEach(f=>{
    const root = document.getElementById('fx_'+f.id);
    if (!root) return;
    const btnProp = root.querySelector('.act .prop');
    if (btnProp) btnProp.onclick = async ()=>{
      if (!isAdmin) return alert('Admins only');
      const atStr = prompt('Propose time (e.g., 2025-08-20 20:30)');
      if (!atStr) return;
      const at = Date.parse(atStr);
      if (!at) return alert('Could not parse date');
      try{ await apiPost(`/api/cup/fixtures/${f.id}/propose`, { at }); await refreshFixturesSched(); renderFixturesSched(); }
      catch(e){ alert('Propose failed: '+e.message); }
    };

    const btnAgree = root.querySelector('.act .agree');
    if (btnAgree) btnAgree.onclick = async ()=>{
      if (!isAdmin) return alert('Admins only');
      const at = root.querySelector('select[name="slot"]').value;
      if (!at) return alert('Pick a proposed slot first');
      try{ await apiPost(`/api/cup/fixtures/${f.id}/vote`, { at, agree:true }); await refreshFixturesSched(); renderFixturesSched(); await refreshFixturesPublic(); renderFixturesPublic(); }
      catch(e){ alert('Vote failed: '+e.message); }
    };

    const btnDecl = root.querySelector('.act .decl');
    if (btnDecl) btnDecl.onclick = async ()=>{
      if (!isAdmin) return alert('Admins only');
      const at = root.querySelector('select[name="slot"]').value;
      if (!at) return alert('Pick a proposed slot first');
      try{ await apiPost(`/api/cup/fixtures/${f.id}/vote`, { at, agree:false }); await refreshFixturesSched(); renderFixturesSched(); }
      catch(e){ alert('Vote failed: '+e.message); }
    };

    const btnQuick = root.querySelector('.act .quick');
    if (btnQuick) btnQuick.onclick = ()=> openResultEditor(f);

    const btnJson = root.querySelector('.act .json');
    if (btnJson) btnJson.onclick = async ()=>{
      if (!isAdmin) return alert('Admin only');
      const hs = Number(prompt('Home score (hs)')||0);
      const as = Number(prompt('Away score (as)')||0);
      const template = JSON.stringify({
        details:{
          home:[{ player:"Player A", goals:1, assists:0, rating:9.5, position:"ST" }],
          away:[{ player:"Player B", goals:2, assists:0, rating:8.7, position:"CB" }]
        }
      }, null, 2);
      const raw = prompt('Paste JSON (or edit the template):', template);
      if (!raw) return;
      try{
        const obj = JSON.parse(raw);
        await apiPost(`/api/cup/fixtures/${f.id}/report`, { hs, as, details: obj.details || obj });
        document.querySelectorAll('[data-fxf]').forEach(x=>x.setAttribute('aria-pressed','false'));
        document.querySelector('[data-fxf="final"]').setAttribute('aria-pressed','true');
        await refreshFixturesSched(); renderFixturesSched();
        await refreshFixturesPublic(); renderFixturesPublic();
      }catch(e){ alert('JSON upload failed: '+e.message); }
    };
  });
}

function renderFxSchedRow(f){
  const H = byId(f.home), A = byId(f.away);
  const hn = H?.name || f.home;
  const an = A?.name || f.away;
  const whenTxt = f.when ? fmtDate(f.when) : 'TBD';
  const props = (f.proposals||[]).map(p=>{
    const who = (teams.find(t=>String(t.id)===String(p.by))?.name) || p.by || 'unknown';
    return `<option value="${p.at}">${fmtDate(p.at)} — proposed by ${escapeHtml(who)}</option>`;
  }).join('');
  const status = f.status || 'pending';
  const hs = Number(f.score?.hs ?? f.hs ?? 0);
  const as = Number(f.score?.as ?? f.as ?? 0);
  const isFinal = status === 'final';
  const scoreTxt = isFinal ? `${hs}–${as}` : 'vs';
  const scoreClass = isFinal ? 'score-final' : 'score-upcoming';
  const adminBtns = isAdmin ? `<button class="json">Admin JSON</button>` : '';
  const banner = getFixtureBanner();
  return `
  <div class="fx glow-card glow-silver" id="fx_${f.id}">
    <div>
      ${banner ? `<img class="fx-banner" src="${banner}" alt="">` : ''}
      <div class="fx-vs">
        <span class="fx-team"><img src="${teamLogoUrl(H)}" alt=""><span>${escapeHtml(hn)}</span></span>
        <span class="score-pill ${scoreClass}">${scoreTxt}</span>
        <span class="fx-team"><img src="${teamLogoUrl(A)}" alt=""><span>${escapeHtml(an)}</span></span>
      </div>
      <div class="meta">Round: ${escapeHtml(f.round||'')} • When: ${escapeHtml(whenTxt)} • Status: <span class="chip">${escapeHtml(status)}</span></div>
    </div>
    <div class="center">
      ${(f.proposals||[]).length ? `<label>Proposals</label><br><select name="slot">${props}</select>` : `<span class="muted">No proposals</span>`}
    </div>
    <div class="act">
      <button class="prop">Propose</button>
      <button class="agree">Agree</button>
      <button class="decl">Decline</button>
      <button class="quick">Quick Edit</button>
      ${adminBtns}
    </div>
  </div>`;
}

// =======================
//   RESULT SHEET MODAL
// =======================
const resultModal = document.getElementById('resultModal');
const resCancel = document.getElementById('resCancel');
const resSubmit = document.getElementById('resSubmit');
const resPasteJson = document.getElementById('resPasteJson');
let activeFixture = null;

resCancel.onclick = ()=>{ resultModal.classList.remove('show'); resultModal.setAttribute('aria-hidden','true'); };

function rowHtml(playersOptions){
  return `<tr>
    <td>
      <select class="playerSel">
        <option value="">— select player —</option>
        ${playersOptions}
      </select>
      <input class="playerCustom" placeholder="or type a name" style="margin-top:6px">
    </td>
    <td><input class="g" type="number" min="0" value="0"></td>
    <td><input class="a" type="number" min="0" value="0"></td>
    <td><input class="r" type="number" min="0" step="0.1" value="0"></td>
    <td><input class="pos" placeholder="e.g., ST"></td>
    <td><button class="rm">✕</button></td>
  </tr>`;
}

function toOptions(slots){
  const pts = (slots||[]).map(s=>{
    const p = s.player;
    const label = p?.eaName || '';
    const id = s.playerId || '';
    if (!id && !label) return '';
    return `<option value="${escapeHtml(id)}">${escapeHtml(label)}${id?` (#${id.slice(0,6)})`:''}</option>`;
  }).join('');
  return pts;
}

async function openResultEditor(f){
  activeFixture = f;
  document.getElementById('resTitle').textContent = `Submit Result — ${byId(f.home)?.name || f.home} vs ${byId(f.away)?.name || f.away}`;
  document.getElementById('resMeta').textContent = `${fmtDate(f.when||Date.now())} • ${f.round||''}`;

  const homeSlots = await fetch(`/api/clubs/${encodeURIComponent(f.home)}/squad`, {credentials:'include'}).then(r=>r.ok?r.json():{slots:[]}).catch(()=>({slots:[]}));
  const awaySlots = await fetch(`/api/clubs/${encodeURIComponent(f.away)}/squad`, {credentials:'include'}).then(r=>r.ok?r.json():{slots:[]}).catch(()=>({slots:[]}));

  const homeOpts = toOptions(homeSlots.slots);
  const awayOpts = toOptions(awaySlots.slots);

  const HT = document.querySelector('#homeTable tbody');
  const AT = document.querySelector('#awayTable tbody');
  HT.innerHTML=''; AT.innerHTML='';
  // start with 3 rows each
  for (let i=0;i<3;i++){ HT.insertAdjacentHTML('beforeend', rowHtml(homeOpts)); }
  for (let i=0;i<3;i++){ AT.insertAdjacentHTML('beforeend', rowHtml(awayOpts)); }

  document.getElementById('homeTitle').textContent = `Home — ${byId(f.home)?.name || f.home}`;
  document.getElementById('awayTitle').textContent = `Away — ${byId(f.away)?.name || f.away}`;

  document.getElementById('homeScore').value = f.score?.hs ?? 0;
  document.getElementById('awayScore').value = f.score?.as ?? 0;
  document.getElementById('resNotes').value = f.report?.text || '';

  const wireTable = (tbody)=> tbody.querySelectorAll('.rm').forEach(btn=> btn.onclick = ()=> btn.closest('tr')?.remove());
  wireTable(HT); wireTable(AT);

  document.getElementById('addHomeRow').onclick = ()=>{ HT.insertAdjacentHTML('beforeend', rowHtml(homeOpts)); wireTable(HT); };
  document.getElementById('addAwayRow').onclick = ()=>{ AT.insertAdjacentHTML('beforeend', rowHtml(awayOpts)); wireTable(AT); };

  resPasteJson.onclick = async ()=>{
    if (!isAdmin) return alert('Admin only');
    const hs = Number(prompt('Home score (hs)')||0);
    const as = Number(prompt('Away score (as)')||0);
    const template = JSON.stringify({
      details:{
        home:[{ player:"Player A", goals:1, assists:0, rating:9.5, position:"ST" }],
        away:[{ player:"Player B", goals:2, assists:0, rating:8.7, position:"CB" }]
      }
    }, null, 2);
    const raw = prompt('Paste JSON (or edit the template):', template);
    if (!raw) return;
    try{
      const obj = JSON.parse(raw);
      await apiPost(`/api/cup/fixtures/${f.id}/report`, { hs, as, details: obj.details || obj });
      alert('Saved');
      resultModal.classList.remove('show'); resultModal.setAttribute('aria-hidden','true');
      await refreshFixturesSched(); renderFixturesSched();
      await refreshFixturesPublic(); renderFixturesPublic();
      await loadChampions();
    }catch(e){ alert('JSON upload failed: '+e.message); }
  };

  resSubmit.onclick = async ()=>{
    const rowsToDetails = (tbody)=> {
      const out = [];
      tbody.querySelectorAll('tr').forEach(tr=>{
        const playerId = (tr.querySelector('.playerSel')?.value||'').trim();
        const custom   = (tr.querySelector('.playerCustom')?.value||'').trim();
        const goals = Number(tr.querySelector('.g')?.value||0);
        const assists = Number(tr.querySelector('.a')?.value||0);
        const rating = Number(tr.querySelector('.r')?.value||0);
        const pos = (tr.querySelector('.pos')?.value||'').trim();
        if (!playerId && !custom && !goals && !assists && !rating) return; // empty row
        out.push({ playerId, player: custom, goals, assists, rating, position: pos });
      });
      return out;
    };
    const details = {
      home: rowsToDetails(document.querySelector('#homeTable tbody')),
      away: rowsToDetails(document.querySelector('#awayTable tbody')),
    };
    const hs = Number(document.getElementById('homeScore').value||0);
    const as = Number(document.getElementById('awayScore').value||0);
    const text = document.getElementById('resNotes').value||'';
    try{
      await apiPost(`/api/cup/fixtures/${activeFixture.id}/report`, { hs, as, text, details });
      alert('Result submitted');
      resultModal.classList.remove('show'); resultModal.setAttribute('aria-hidden','true');
      await refreshFixturesSched(); renderFixturesSched();
      await refreshFixturesPublic(); renderFixturesPublic();
      await loadChampions();
    }catch(e){ alert('Submit failed: '+e.message); }
  };

  resultModal.classList.add('show'); resultModal.setAttribute('aria-hidden','false');
}

// =======================
//   CHAMPIONS CUP
// =======================
async function loadChampions(){
  document.getElementById('ccCupId').textContent = CC_ID;

  // groups
  let cupData = { cup:{ groups:{A:[],B:[],C:[],D:[]} } };
  try {
    cupData = await apiGet(`/api/champions/${encodeURIComponent(CC_ID)}`);
  } catch(e) {
    console.warn('Champions fetch failed:', e.message);
  }

  // cc fixtures
  let ccList = [];
  try {
    const fx = await apiGet(`/api/cup/fixtures?cup=${encodeURIComponent(CC_ID)}`);
    ccList = normalizeFixtures(fx.fixtures || []);
  } catch {}

  renderCcGroups(cupData.cup.groups, ccList);
  renderCcFixtures(ccList);

  // leaders
  try {
    const leaders = await apiGet(`/api/champions/${encodeURIComponent(CC_ID)}/leaders`);
    renderCcLeaders(leaders);
  } catch {}

  // bracket
  renderCcBracket(cupData.cup.groups, ccList);

  // admin panel
  document.getElementById('ccAdmin').style.display = isAdmin ? 'block' : 'none';
  if (isAdmin) buildManualGroupsEditor(cupData.cup.groups);
}
function renderCcGroups(groups, fixtures){
  const el = document.getElementById('ccGroups');
  const tables = computeGroupTablesClient(groups, fixtures); // client fallback for standings
  el.innerHTML = ['A','B','C','D'].map(g=>{
    const rows = (tables[g]||[]).map(r=>{
      const T = byId(r.clubId);
      return `<tr>
        <td><span class="group-team"><img src="${teamLogoUrl(T)}" alt=""><span>${escapeHtml(T?.name||r.clubId)}</span></span></td>
        <td>${r.P}</td><td>${r.W}</td><td>${r.D}</td><td>${r.L}</td><td>${r.GD}</td><td>${r.Pts}</td>
      </tr>`;
    }).join('');
    return `
      <div class="group-card glow-card glow-gold mini-card">
        <div class="group-title">Group ${g}</div>
        <div class="overflow-x-auto">
          <table class="group-table w-full min-w-[420px] text-xs sm:text-sm md:text-base">
            <thead><tr><th>Club</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GD</th><th>Pts</th></tr></thead>
            <tbody>${rows||''}</tbody>
          </table>
        </div>
      </div>`;
    }).join('');
  }
function computeGroupTablesClient(groups, fixtures){
  // derive from provided fixtures + public cache
  const table = { A:{}, B:{}, C:{}, D:{} };
  const touch = (g,id)=> table[g][id] = table[g][id] || { clubId:id, P:0, W:0, D:0, L:0, GF:0, GA:0, GD:0, Pts:0 };
  ['A','B','C','D'].forEach(g=> (groups[g]||[]).forEach(id=> touch(g,id)));

  const merged = []
    .concat(Array.isArray(fixtures) ? fixtures : [])
    .concat(fixturesPublicCache || [])
    .filter(f=>f.cup===CC_ID && String(f.status||'').toLowerCase()==='final');

  merged.forEach(f=>{
    const g = f.group || null; if(!g || !table[g]) return;
    touch(g, f.home); touch(g, f.away);
    const H = table[g][f.home], A = table[g][f.away];
    const hs = Number(f.score?.hs||0), as = Number(f.score?.as||0);
    H.P++; A.P++;
    H.GF+=hs; H.GA+=as; H.GD=H.GF-H.GA;
    A.GF+=as; A.GA+=hs; A.GD=A.GF-A.GA;
    if(hs>as){ H.W++; H.Pts+=3; A.L++; }
    else if(hs<as){ A.W++; A.Pts+=3; H.L++; }
    else { H.D++; A.D++; H.Pts++; A.Pts++; }
  });
  const sorted = {};
  ['A','B','C','D'].forEach(g=>{
    sorted[g] = Object.values(table[g]).sort((x,y)=>(y.Pts-x.Pts)||(y.GD-x.GD)||(y.GF-x.GF));
  });
  return sorted;
  }

  function renderCcBracket(groups, fixtures){
    const el = document.getElementById('ccBracket');
    if (!el) return;
    const tables = computeGroupTablesClient(groups, fixtures);
    const top = g => (tables[g] && tables[g][0]) ? tables[g][0].clubId : '';
    const winners = { A: top('A'), B: top('B'), C: top('C'), D: top('D') };

    const semiList = fixtures.filter(f => String(f.round || '').toLowerCase().includes('semi'));
    const finalFx = fixtures.find(f => {
      const r = String(f.round || '').toLowerCase();
      return r === 'final' || (r.includes('final') && !r.includes('semi'));
    }) || null;

    const makeSemi = (home, away) => ({ home, away, status:'pending', score:{ hs:0, as:0 } });
    const semi1 = semiList[0] || makeSemi(winners.A, winners.B);
    const semi2 = semiList[1] || makeSemi(winners.C, winners.D);
    const finalMatch = finalFx || { home:'Winner SF1', away:'Winner SF2', status:'pending', score:{ hs:0, as:0 } };

    const teamHtml = id => {
      const T = byId(id);
      const name = T?.name || id;
      const logo = T ? `<img src="${teamLogoUrl(T)}" alt="">` : '';
      return `<span class="group-team">${logo}<span>${escapeHtml(name)}</span></span>`;
    };
    const matchHtml = f => {
      const scoreTxt = (f.status === 'final') ? `${f.score.hs}-${f.score.as}` : 'vs';
      return `<div class="bracket-match">${teamHtml(f.home)}<span class="bracket-vs">${scoreTxt}</span>${teamHtml(f.away)}</div>`;
    };

    el.innerHTML = `
      <div class="bracket-card glow-card glow-gold mini-card"><strong>Semifinal 1</strong>${matchHtml(semi1)}</div>
      <div class="bracket-card glow-card glow-gold mini-card"><strong>Final</strong>${matchHtml(finalMatch)}</div>
      <div class="bracket-card glow-card glow-gold mini-card"><strong>Semifinal 2</strong>${matchHtml(semi2)}</div>
    `;
  }

  function renderCcLeaders(data){
    const wrap = document.getElementById('ccLeaders');
    const scorers = (data?.scorers||[]).map((r,i)=>{
      const T = byId(r.clubId);
      const club = T?.shortName || T?.name || r.clubId;
      return `<li>${escapeHtml(r.name)} <span class="muted">(${r.count}) - ${escapeHtml(club)}</span></li>`;
    }).join('');
    const assisters = (data?.assisters||[]).map((r,i)=>{
      const T = byId(r.clubId);
      const club = T?.shortName || T?.name || r.clubId;
      return `<li>${escapeHtml(r.name)} <span class="muted">(${r.count}) - ${escapeHtml(club)}</span></li>`;
    }).join('');
    if (!scorers && !assisters){
      wrap.innerHTML = '<div class="muted">No stats yet.</div>';
      return;
    }
    wrap.innerHTML = `
      <div class="mini-card glow-card glow-gold">
        <div class="muted">Top Scorers</div>
        <ol style="margin-top:6px;padding-left:18px">${scorers||''}</ol>
      </div>
      <div class="mini-card glow-card glow-green">
        <div class="muted">Top Assisters</div>
        <ol style="margin-top:6px;padding-left:18px">${assisters||''}</ol>
      </div>`;
  }
function renderCcFixtures(list){
  const el = document.getElementById('ccFixtures');
  list.sort((a,b)=>(a.when||a.createdAt)-(b.when||b.createdAt));
  el.innerHTML = list.length ? list.map(f=>{
    const H = byId(f.home), A = byId(f.away);
    const hn = H?.name || f.home;
    const an = A?.name || f.away;
    const whenTxt = f.when ? fmtDate(f.when) : 'TBD';
    const isFinal = String(f.status||'').toLowerCase()==='final';
    const scoreTxt = isFinal ? `${f.score.hs}–${f.score.as}` : 'vs';
    const scoreClass = isFinal ? 'score-final' : 'score-upcoming';
    const banner = getFixtureBanner();
    const editBtn = isAdmin ? `<div class="act"><button data-ccq="${f.id}">Quick Edit</button><button data-ccj="${f.id}">Admin JSON</button></div>` : '';
    return `<div class="fx glow-card glow-gold" id="ccfx_${f.id}">
      <div>
        ${banner ? `<img class="fx-banner" src="${banner}" alt="">` : ''}
        <div class="fx-vs">
          <span class="fx-team"><img src="${teamLogoUrl(H)}" alt=""><span>${escapeHtml(hn)}</span></span>
          <span class="score-pill ${scoreClass}">${scoreTxt}</span>
          <span class="fx-team"><img src="${teamLogoUrl(A)}" alt=""><span>${escapeHtml(an)}</span></span>
        </div>
        <div class="meta"><span class="chip">Champions Cup${f.group?` • Group ${f.group}`:''}${f.round?` • ${escapeHtml(f.round)}`:''}</span> • ${whenTxt} • ${escapeHtml(f.status||'')}</div>
      </div>
      ${editBtn}
    </div>`;
  }).join('') : `<div class="muted">No Champions Cup fixtures yet.</div>`;

  // wire CC quick edit / JSON
  list.forEach(f=>{
    const q = document.querySelector(`[data-ccq="${f.id}"]`);
    const j = document.querySelector(`[data-ccj="${f.id}"]`);
    if (q) q.onclick = ()=> openResultEditor(f);
    if (j) j.onclick = async ()=>{
      if (!isAdmin) return alert('Admin only');
      const hs = Number(prompt('Home score (hs)')||0);
      const as = Number(prompt('Away score (as)')||0);
      const template = JSON.stringify({ details:{ home:[{ player:"Player A", goals:1, assists:0, rating:9.5 }], away:[{ player:"Player B", goals:2, assists:0, rating:8.7 }] }}, null, 2);
      const raw = prompt('Paste JSON (or edit the template):', template);
      if (!raw) return;
      try{
        const obj = JSON.parse(raw);
        await apiPost(`/api/cup/fixtures/${f.id}/report`, { hs, as, details: obj.details || obj });
        await loadChampions();
        await refreshFixturesPublic(); renderFixturesPublic();
      }catch(e){ alert('JSON upload failed: '+e.message); }
    };
  });
}

function buildManualGroupsEditor(groups){
  const root = document.getElementById('ccManualGroups');
  const opts = teams.map(t=> `<option value="${t.id}">${escapeHtml(t.name)} (${t.id})</option>`).join('');
  root.innerHTML = ['A','B','C','D'].map(g=>{
    const rows = (groups[g]||[]).map(v=>
      `<div class="grow"><select data-val="${v}">${opts}</select> <button data-rm>X</button></div>`
    ).join('');
    return `<div class="m-card"><strong>Group ${g}</strong>
      <div data-g="${g}" class="gbox">${rows}</div>
      <div style="margin-top:6px"><button data-add="${g}">+ Add team</button></div>
    </div>`;
  }).join('');

  root.querySelectorAll('select[data-val]').forEach(sel=>{
    sel.value = sel.getAttribute('data-val');
  });

  function attachRemove(btn){
    if(!btn) return;
    btn.onclick = ()=> btn.parentElement.remove();
  }
  root.querySelectorAll('[data-rm]').forEach(attachRemove);

  // add rows
  root.querySelectorAll('[data-add]').forEach(btn=>{
    btn.onclick = ()=>{
      const g = btn.getAttribute('data-add');
      const box = root.querySelector(`.gbox[data-g="${g}"]`);
      const div = document.createElement('div');
      div.className = 'grow';
      div.innerHTML = `<select>${opts}</select> <button data-rm>X</button>`;
      box.appendChild(div);
      attachRemove(div.querySelector('[data-rm]'));
    };
  });

  // save groups (no 16-team requirement; any count allowed)
  document.getElementById('ccBtnSaveGroups').onclick = async ()=>{
    const out = { A:[], B:[], C:[], D:[] };
    root.querySelectorAll('.gbox').forEach(box=>{
      const g = box.getAttribute('data-g');
      box.querySelectorAll('select').forEach(sel=>{
        const v = sel.value; if (v) out[g].push(v);
      });
    });
    // ensure no duplicates across groups
    const all = [...out.A, ...out.B, ...out.C, ...out.D];
    const set = new Set(all);
    if (all.length !== set.size) return alert('Duplicate club across groups.');
    try{
      await apiPost(`/api/champions/${CC_ID}/groups`, { groups: out });
      alert('Groups saved'); await loadChampions();
    }catch(e){ alert('Save groups failed: '+e.message); }
  };

  setupCcFixtureForm();
}
function setupCcFixtureForm(){
  const homeSel = document.getElementById('ccHomeSel');
  const awaySel = document.getElementById('ccAwaySel');
  const groupSel = document.getElementById('ccGroupSel');
  const roundInput = document.getElementById('ccRoundInput');
  const whenInput = document.getElementById('ccWhenInput');
  const createBtn = document.getElementById('ccFormCreate');
  if (!homeSel || !awaySel || !createBtn) return;

  const optionsHtml = teams.map(t=>`<option value="${t.id}">${escapeHtml(t.name)} (${t.id})</option>`).join('');
  homeSel.innerHTML = `<option value="">— choose —</option>${optionsHtml}`;
  awaySel.innerHTML = `<option value="">— choose —</option>${optionsHtml}`;

  function ensureDifferent(){
    if (homeSel.value && awaySel.value && homeSel.value === awaySel.value) {
      alert('Home and away cannot be the same club.');
      awaySel.value = '';
    }
  }
  homeSel.onchange = ensureDifferent;
  awaySel.onchange = ensureDifferent;

  createBtn.onclick = async ()=>{
    const home = homeSel.value;
    const away = awaySel.value;
    const group = groupSel.value || null;
    const round = (roundInput.value || '').trim() || (group ? `Group ${group}` : 'Round');
    const when = whenInput.value ? Date.parse(whenInput.value) : null;
    if (!home || !away) return alert('Pick both teams');
    try{
      await apiPost('/api/cup/fixtures', { home, away, round, cup: CC_ID, group, when });
      alert('Fixture created'); await loadChampions();
    }catch(e){ alert('Create failed: '+e.message); }
  };
}

async function loadLeague(force = false){
  const data = await fetchLeagueData(force);
  renderStandings(data.standings || [], data.matches || [], data.playerStandings || []);
  renderStats(data.players || []);
  renderTopScorers(data.scorers || []);

  const toggleBtn = document.getElementById('statsToggleBtn');
  const leagueView = document.getElementById('leagueView');
  const statsView = document.getElementById('statsView');
  const holderLeague = document.getElementById('statsBtnHolderLeague');
  const holderStats = document.getElementById('statsBtnHolderStats');

  // reset view
  statsView.style.display = 'none';
  leagueView.style.display = 'block';
  holderLeague.appendChild(toggleBtn);
  toggleBtn.textContent = 'Stats';

  toggleBtn.onclick = () => {
    const showStats = statsView.style.display === 'none';
    statsView.style.display = showStats ? 'block' : 'none';
    leagueView.style.display = showStats ? 'none' : 'block';
    (showStats ? holderStats : holderLeague).appendChild(toggleBtn);
    toggleBtn.textContent = showStats ? 'Standings' : 'Stats';
    if (showStats) {
      populateLeagueTopScorers();
    }
  };
}

function renderStandings(rows, matches, fallbackRows = []){
  const computed = computeStandings(rows, matches, fallbackRows);
  applyStandingsToTeamCards(computed);
  renderLeagueStandings(computed);
  renderHomepageStandings(computed);
  return computed;
}

function applyStandingsToTeamCards(standings){
  if (!Array.isArray(standings) || !standings.length) return;

  const parseCount = value => {
    const num = Number(value);
    return Number.isFinite(num) ? num : 0;
  };

  const escapeForSelector = value => {
    const str = String(value);
    if (typeof CSS !== 'undefined' && typeof CSS.escape === 'function'){
      return CSS.escape(str);
    }
    return str.replace(/[`"'\\]/g, "\\$&");
  };

  standings.forEach(entry => {
    if (!entry) return;
    const rawId = entry.clubId ?? entry.club_id ?? entry.id;
    if (rawId === undefined || rawId === null) return;
    const clubId = String(rawId);

    const wins = parseCount(entry.wins);
    const draws = parseCount(entry.draws);
    const losses = parseCount(entry.losses);
    const record = `${wins}-${draws}-${losses}`;

    entry.wins = wins;
    entry.draws = draws;
    entry.losses = losses;
    entry.record = record;

    let card = null;
    try {
      card = document.querySelector(`.team-card[data-club-id="${escapeForSelector(clubId)}"]`);
    } catch {
      card = document.querySelector(`.team-card[data-club-id="${clubId}"]`);
    }

    if (card){
      const recordEl = card.querySelector('.record');
      if (recordEl) recordEl.textContent = record;
      const extraRecordEl = card.querySelector('.team-extra-record');
      if (extraRecordEl) extraRecordEl.textContent = record;
    }

    const normalizedClubId = normalizeId(clubId);
    const team = teams.find(t => {
      const teamId = t?.id ?? '';
      return String(teamId) === clubId || normalizeId(teamId) === normalizedClubId;
    });
    if (team){
      team.wins = wins;
      team.draws = draws;
      team.losses = losses;
      team.record = record;
    }
  });
}

function computeStandings(rows, matches, fallbackRows = []){
  const allowedClubIds = new Set();
  const nameFallbacks = new Map();
  const hasPrimaryStandings = Array.isArray(rows) && rows.length > 0;

  (rows || []).forEach(r => {
    const rawId = r?.club_id ?? r?.clubId ?? r?.id;
    if (!rawId) return;
    const id = String(rawId);
    allowedClubIds.add(id);
    const label = r?.club_name || r?.name || r?.club || r?.team;
    if (label) nameFallbacks.set(id, label);
  });

  (fallbackRows || []).forEach(r => {
    const rawId = r?.clubId ?? r?.club_id ?? r?.id;
    if (!rawId) return;
    const id = String(rawId);
    const label = r?.name || r?.club_name || r?.club || r?.team;
    if (!hasPrimaryStandings && !allowedClubIds.has(id)){
      allowedClubIds.add(id);
    }
    if (label){
      const canUseLabel = !hasPrimaryStandings || allowedClubIds.has(id);
      if (canUseLabel && !nameFallbacks.has(id)) nameFallbacks.set(id, label);
    }
  });

  if (!allowedClubIds.size){
    (teams || []).forEach(team => {
      const teamId = team?.id;
      if (!teamId) return;
      allowedClubIds.add(String(teamId));
    });
  }

  const standingsMap = new Map();
  const clubIsAllowed = clubId => {
    if (!allowedClubIds.size) return !hasPrimaryStandings;
    return allowedClubIds.has(String(clubId ?? ''));
  };
  const ensureEntry = (clubId, clubData = {}) => {
    const id = String(clubId);
    if (!standingsMap.has(id)){
      standingsMap.set(id, {
        clubId: id,
        name: '',
        played: 0,
        wins: 0,
        draws: 0,
        losses: 0,
        goalsFor: 0,
        goalsAgainst: 0,
        points: 0
      });
    }
    const entry = standingsMap.get(id);
    const clubName = clubData?.details?.name;
    if (clubName) entry.name = clubName;
    return entry;
  };

  (matches || []).forEach(match => {
    if (!match || !match.clubs) return;
    const clubEntries = Object.entries(match.clubs).filter(([, data]) => data);
    if (!clubEntries.length) return;
    if (clubEntries.length === 1){
      const [singleId, singleData] = clubEntries[0];
      ensureEntry(singleId, singleData);
      return;
    }
    const [[idA, dataA], [idB, dataB]] = clubEntries;
    const entryA = ensureEntry(idA, dataA);
    const entryB = ensureEntry(idB, dataB);

    const goalsA = Number(dataA?.goals ?? 0);
    const goalsB = Number(dataB?.goals ?? 0);

    entryA.played += 1;
    entryB.played += 1;
    entryA.goalsFor += goalsA;
    entryA.goalsAgainst += goalsB;
    entryB.goalsFor += goalsB;
    entryB.goalsAgainst += goalsA;

    if (goalsA > goalsB){
      entryA.wins += 1;
      entryA.points += 3;
      entryB.losses += 1;
    } else if (goalsB > goalsA){
      entryB.wins += 1;
      entryB.points += 3;
      entryA.losses += 1;
    } else {
      entryA.draws += 1;
      entryB.draws += 1;
      entryA.points += 1;
      entryB.points += 1;
    }
  });

  let computed = Array.from(standingsMap.values()).filter(entry => clubIsAllowed(entry?.clubId));
  if (!computed.length){
    computed = (rows || []).map(r => {
      const id = r?.club_id ?? r?.clubId ?? r?.id;
      if (!id) return null;
      const wins = Number(r?.wins ?? 0);
      const draws = Number(r?.draws ?? 0);
      const losses = Number(r?.losses ?? 0);
      const played = Number(r?.played ?? r?.games_played ?? wins + draws + losses);
      return {
        clubId: String(id),
        name: r?.club_name || r?.name || r?.club || r?.team || byId(id)?.name || String(id),
        played,
        wins,
        draws,
        losses,
        goalsFor: Number(r?.goals_for ?? r?.goalsFor ?? 0),
        goalsAgainst: Number(r?.goals_against ?? r?.goalsAgainst ?? 0),
        points: Number(r?.points ?? 0)
      };
    }).filter(Boolean);
    computed = computed.filter(entry => clubIsAllowed(entry?.clubId));
  }

  if (!computed.length && fallbackRows && fallbackRows.length){
    computed = fallbackRows.map(r => {
      const id = r?.clubId ?? r?.club_id ?? r?.id;
      if (!id) return null;
      const wins = Number(r?.wins ?? 0);
      const draws = Number(r?.draws ?? 0);
      const losses = Number(r?.losses ?? 0);
      const played = Number(r?.played ?? r?.games_played ?? wins + draws + losses);
      return {
        clubId: String(id),
        name: r?.name || r?.club_name || r?.club || r?.team || String(id),
        played,
        wins,
        draws,
        losses,
        goalsFor: Number(r?.goalsFor ?? r?.goals_for ?? 0),
        goalsAgainst: Number(r?.goalsAgainst ?? r?.goals_against ?? 0),
        points: Number(r?.points ?? 0)
      };
    }).filter(Boolean);
    computed = computed.filter(entry => clubIsAllowed(entry?.clubId));
  }

  computed = computed.filter(entry => clubIsAllowed(entry?.clubId));

  computed.forEach(entry => {
    if (!entry.name){
      entry.name = nameFallbacks.get(entry.clubId) || byId(entry.clubId)?.name || entry.clubId;
    }
  });

  computed.sort((a,b) => {
    if (b.points !== a.points) return b.points - a.points;
    const gdA = a.goalsFor - a.goalsAgainst;
    const gdB = b.goalsFor - b.goalsAgainst;
    if (gdB !== gdA) return gdB - gdA;
    if (b.goalsFor !== a.goalsFor) return b.goalsFor - a.goalsFor;
    return (a.name || '').localeCompare(b.name || '');
  });

  return computed;
}

function renderLeagueStandings(sorted){
  const body = document.getElementById('league-standings');
  if (!body) return;
  if (!sorted.length){
    body.innerHTML = '<tr><td colspan="10" class="muted">No standings.</td></tr>';
    return;
  }
  const rowsHtml = sorted.map((row, idx) => {
    const played = Number(row.played ?? 0);
    const wins = Number(row.wins ?? 0);
    const draws = Number(row.draws ?? 0);
    const losses = Number(row.losses ?? 0);
    const gf = Number(row.goalsFor ?? 0);
    const ga = Number(row.goalsAgainst ?? 0);
    const gd = gf - ga;
    const pts = Number(row.points ?? 0);
    const classes = [];
    if (idx < 4) classes.push('top4');
    if (idx === 0) classes.push('rank-1');
    else if (idx === 1) classes.push('rank-2');
    else if (idx === 2) classes.push('rank-3');
    const classAttr = classes.length ? ` class="${classes.join(' ')}"` : '';
    const name = row.name || byId(row.clubId)?.name || row.clubId;
    return `<tr${classAttr}><td>${idx + 1}</td><td class="club-name">${escapeHtml(name)}</td><td>${played}</td><td>${wins}</td><td>${draws}</td><td>${losses}</td><td>${gf}</td><td>${ga}</td><td>${gd}</td><td>${pts}</td></tr>`;
  }).join('');
  body.innerHTML = rowsHtml;
}

function renderHomepageStandings(sorted){
  const container = document.getElementById('homepage-standings');
  if (!container) return;
  if (!sorted.length){
    container.innerHTML = '<div class="muted">No standings.</div>';
    return;
  }
  const top = sorted.slice(0,5);
  const rows = top.map((row, idx) => {
    const rank = idx + 1;
    const name = row.name || byId(row.clubId)?.name || row.clubId;
    return `<tr><td>${rank}</td><td>${escapeHtml(name)}</td><td>${Number(row.wins ?? 0)}</td><td>${Number(row.draws ?? 0)}</td><td>${Number(row.losses ?? 0)}</td><td>${Number(row.points ?? 0)}</td></tr>`;
  }).join('');
  container.innerHTML = `<table class="league-table"><thead><tr><th>#</th><th>Club</th><th>W</th><th>D</th><th>L</th><th>Pts</th></tr></thead><tbody>${rows}</tbody></table>`;
}

let latestTopScorers = [];

function populateLeagueTopScorers(list = latestTopScorers){
  const league = document.getElementById('league-topscorers');
  if (!league) return;
  if (!list || !list.length){
    league.innerHTML = '<div class="muted">No data.</div>';
    return;
  }
  league.innerHTML = list.map((r, idx) => {
    const clubName = byId(r.clubId)?.name || r.clubId || '';
    return `<div class="stats-row" data-rank="${idx + 1}" data-club-id="${r.clubId}"><span class="rank-badge">${idx + 1}</span><img class="player-kit" src="/assets/silhouette.png" alt=""><div class="info"><div>${escapeHtml(r.name)}</div><div class="muted">${escapeHtml(clubName)}</div></div><div class="value">${r.goals}</div></div>`;
  }).join('');
  const unique = new Set(list.map(r => r.clubId).filter(Boolean));
  unique.forEach(cid => renderClubKits(cid, league));
}

function renderTopScorers(rows){
  const homepage = document.getElementById('homepage-topscorers');
  const normalized = (rows || []).map(r => {
    if (!r) return null;
    const clubId = r?.club_id ?? r?.clubId ?? r?.team_id ?? r?.teamId ?? r?.club;
    const name = r?.name || r?.player || r?.player_name || r?.personaName || r?.persona_name || r?.gamertag || r?.displayName || '';
    const goals = numberFrom(r?.count ?? r?.goals ?? r?.total ?? r?.goal ?? r?.totalGoals);
    if (!name) return null;
    return {
      clubId: clubId ? String(clubId) : '',
      name,
      goals
    };
  }).filter(Boolean);
  normalized.sort((a,b) => {
    if (b.goals !== a.goals) return b.goals - a.goals;
    return a.name.localeCompare(b.name);
  });
  const top = normalized.slice(0,5);
  latestTopScorers = top;

  if (homepage){
    if (!top.length){
      homepage.innerHTML = '<div class="muted">No data.</div>';
    } else {
      homepage.innerHTML = top.map((r, idx) => {
        const clubName = byId(r.clubId)?.name || r.clubId || '';
        return `<div class="stats-row" data-rank="${idx + 1}" data-club-id="${r.clubId}"><img class="player-kit" src="/assets/silhouette.png" alt=""><div class="info"><div>${escapeHtml(r.name)}</div><div class="muted">${escapeHtml(clubName)}</div></div><div class="value">${r.goals}</div></div>`;
      }).join('');
      const unique = new Set(top.map(r => r.clubId).filter(Boolean));
      unique.forEach(cid => renderClubKits(cid, homepage));
    }
  }

  const statsView = document.getElementById('statsView');
  if (statsView && statsView.style.display !== 'none'){
    populateLeagueTopScorers(top);
  }

  return top;
}

const STAT_CATEGORIES = [
  { id:'goals', label:'Goals', calc:p=>p.goals||0 },
  { id:'assists', label:'Assists', calc:p=>p.assists||0 },
  { id:'ga', label:'G+A', calc:p=>(p.goals||0)+(p.assists||0) },
  { id:'goals90', label:'Goals per 90', calc:p=>per90(p.goals, p.realtimegame), decimals:2 },
  { id:'assists90', label:'Assists per 90', calc:p=>per90(p.assists, p.realtimegame), decimals:2 },
  { id:'ga90', label:'G+A per 90', calc:p=>per90((p.goals||0)+(p.assists||0), p.realtimegame), decimals:2 },
  { id:'shots90', label:'Shots per 90', calc:p=>per90(p.shots, p.realtimegame), decimals:2 },
  { id:'passAcc', label:'Pass Accuracy %', calc:p=>pct(p.passesmade, p.passattempts), decimals:1 },
  { id:'tackles90', label:'Tackles per 90', calc:p=>per90(p.tacklesmade, p.realtimegame), decimals:2 },
  { id:'tacklePct', label:'Tackle Success %', calc:p=>pct(p.tacklesmade, p.tackleattempts), decimals:1 },
  { id:'cleanSheets', label:'Clean Sheets', calc:p=>p.cleansheetsany||0 },
  { id:'savePct', label:'Save %', calc:p=>pct(p.saves, (p.saves||0)+(p.goalsconceded||0)), decimals:1 },
  { id:'avgRating', label:'Average Rating', calc:p=>p.rating||0, decimals:2 },
  { id:'motm', label:'MOTM', calc:p=>p.mom||0 }
];

function per90(val, mins){ const m = Number(mins)||0; return m ? (Number(val||0)/m)*90 : 0; }
function pct(num, den){ const d = Number(den)||0; return d ? (Number(num||0)/d)*100 : 0; }

function renderStats(players){
  const section = document.getElementById('statsView');
  const container = section.querySelector('.leaderboards');
  if (!container) return;
  container.innerHTML = '';
  STAT_CATEGORIES.forEach(cat => {
    const rows = players.map(p => ({ p, v:cat.calc(p) }))
      .filter(r => r.v && isFinite(r.v))
      .sort((a,b)=>b.v - a.v)
      .slice(0,5);
    if (!rows.length) return;
    const card = document.createElement('div');
    card.className = 'm-card';
    card.innerHTML = `<strong>${cat.label}</strong>`;
    const list = document.createElement('div');
    const clubIds = new Set();
    rows.forEach((r, idx) => {
      const rowDiv = document.createElement('div');
      rowDiv.className = 'stats-row';
      rowDiv.dataset.clubId = String(r.p.club_id);
      rowDiv.dataset.rank = String(idx + 1);

      const kitImg = document.createElement('img');
      kitImg.className = 'player-kit';
      kitImg.src = '/assets/silhouette.png';
      rowDiv.appendChild(kitImg);

      const info = document.createElement('div');
      info.className = 'info';
      const clubName = byId(r.p.club_id)?.name || r.p.club_id;
      info.innerHTML = `<div>${escapeHtml(r.p.name)}</div><div class="muted">${escapeHtml(clubName)}</div>`;
      rowDiv.appendChild(info);

      const val = document.createElement('div');
      val.className = 'value';
      val.textContent = typeof cat.decimals === 'number' ? r.v.toFixed(cat.decimals) : String(Math.round(r.v));
      rowDiv.appendChild(val);

      list.appendChild(rowDiv);
      clubIds.add(r.p.club_id);
    });
    clubIds.forEach(cid=>{
      renderClubKits(cid, list);
    });
    card.appendChild(list);
    container.appendChild(card);
  });
}


// =======================
//   COMPETITIONS ADMIN
// =======================
function setupCompetitionDefaultsForm(){
  if (competitionDefaultsSetup) return;
  if (!competitionDefaultsForm) return;
  competitionDefaultsSetup = true;
  const syncDefaults = ()=>{
    competitionsAdminState.defaults = {
      competitionId: competitionDefaultId ? competitionDefaultId.value.trim() : '',
      groupName: competitionDefaultGroup ? competitionDefaultGroup.value.trim() : '',
      roundName: competitionDefaultRound ? competitionDefaultRound.value.trim() : ''
    };
    renderCompetitionsPending();
  };
  competitionDefaultsForm.addEventListener('input', syncDefaults);
  syncDefaults();
}

function updateCompetitionsStatusMessage(){
  if (!competitionsAdminStatus) return;
  if (!isAdmin){
    competitionsAdminStatus.textContent = '';
    return;
  }
  if (competitionsAdminState.loading){
    competitionsAdminStatus.textContent = 'Loading pending matches…';
    return;
  }
  if (competitionsAdminState.errorMessage){
    competitionsAdminStatus.textContent = competitionsAdminState.errorMessage;
    return;
  }
  if (!competitionsAdminState.loaded){
    competitionsAdminStatus.textContent = 'Load the queue to review pending matches.';
    return;
  }
  const count = (competitionsAdminState.items || []).length;
  competitionsAdminStatus.textContent = count
    ? `${count} pending match${count === 1 ? '' : 'es'} awaiting review.`
    : 'No pending matches at this time.';
}

function renderCompetitionPlayerRow(player){
  const club = player?.clubId ? byId(player.clubId) : null;
  const clubName = club?.name || player?.clubId || '';
  const goals = Number(player?.goals || 0);
  const assists = Number(player?.assists || 0);
  const rating = Number(player?.rating || 0);
  const stats = [];
  if (goals > 0) stats.push(`${goals} G`);
  if (assists > 0) stats.push(`${assists} A`);
  if (rating > 0) stats.push(`${rating.toFixed(1)} RTG`);
  const pos = player?.position ? String(player.position).toUpperCase() : '';
  const statLine = stats.length ? stats.join(' • ') : '—';
  const detail = pos ? `${pos} • ${statLine}` : statLine;
  return `
    <div class="pending-player">
      <div class="info">
        <div>${escapeHtml(player?.name || 'Unknown')}</div>
        <div class="club">${escapeHtml(clubName)}</div>
      </div>
      <div class="stat">${escapeHtml(detail)}</div>
    </div>
  `.trim();
}

function renderPendingMatchCard(item){
  const homeClub = item?.home?.clubId ? byId(item.home.clubId) : null;
  const awayClub = item?.away?.clubId ? byId(item.away.clubId) : null;
  const homeName = escapeHtml(homeClub?.name || item?.home?.name || item?.home?.clubId || 'Home');
  const awayName = escapeHtml(awayClub?.name || item?.away?.name || item?.away?.clubId || 'Away');
  const homeGoals = Number.isFinite(Number(item?.home?.goals)) ? Number(item.home.goals) : '—';
  const awayGoals = Number.isFinite(Number(item?.away?.goals)) ? Number(item.away.goals) : '—';
  const metaBits = [];
  if (item?.playedAt) metaBits.push(`Played ${fmtDate(item.playedAt)}`);
  if (item?.createdAt) metaBits.push(`Queued ${fmtDate(item.createdAt)}`);
  const meta = metaBits.length ? `<div class="pending-match-meta">${escapeHtml(metaBits.join(' • '))}</div>` : '';
  const players = Array.isArray(item?.players) ? item.players.slice(0, 10) : [];
  const playersHtml = players.length
    ? players.map(renderCompetitionPlayerRow).join('')
    : '<div class="muted">No player stats captured for this match.</div>';
  const overrides = competitionsAdminState.formValues[item.matchId] || {};
  const defaults = competitionsAdminState.defaults || {};
  const compValue = overrides.competitionId ?? defaults.competitionId ?? '';
  const groupValue = overrides.groupName ?? defaults.groupName ?? '';
  const roundValue = overrides.roundName ?? defaults.roundName ?? '';
  const matchId = escapeHtml(String(item.matchId || ''));
  return `
    <article class="pending-match-card" data-match-id="${matchId}">
      <div class="pending-match-header">
        <div class="pending-match-score"><span>${homeName}</span><span class="score">${escapeHtml(String(homeGoals))} – ${escapeHtml(String(awayGoals))}</span><span>${awayName}</span></div>
        <div class="muted text-xs uppercase tracking-[0.3em]">Match ID ${matchId}</div>
      </div>
      ${meta}
      <div class="pending-player-grid">${playersHtml}</div>
      <div class="pending-match-form">
        <label>Competition<input type="text" data-field="competitionId" value="${escapeHtml(String(compValue))}" placeholder="Competition ID" maxlength="80"></label>
        <label>Group<input type="text" data-field="groupName" value="${escapeHtml(String(groupValue))}" placeholder="Group" maxlength="40"></label>
        <label>Round<input type="text" data-field="roundName" value="${escapeHtml(String(roundValue))}" placeholder="Round" maxlength="60"></label>
      </div>
      <div class="pending-match-actions">
        <button type="button" class="approve" data-action="approve" data-match-id="${matchId}">Approve</button>
        <button type="button" class="reject" data-action="reject" data-match-id="${matchId}">Reject</button>
      </div>
    </article>
  `.trim();
}

function attachCompetitionCardHandlers(){
  if (!competitionsPendingList) return;
  competitionsPendingList.querySelectorAll('.pending-match-card').forEach(card => {
    const matchId = card.getAttribute('data-match-id');
    card.querySelectorAll('input[data-field]').forEach(input => {
      input.addEventListener('input', ()=>{
        const field = input.getAttribute('data-field');
        if (!field || !matchId) return;
        const entry = competitionsAdminState.formValues[matchId] || {};
        entry[field] = input.value;
        competitionsAdminState.formValues[matchId] = entry;
      });
    });
    const approveBtn = card.querySelector('[data-action="approve"]');
    const rejectBtn  = card.querySelector('[data-action="reject"]');
    if (approveBtn){
      approveBtn.addEventListener('click', async ()=>{
        if (!isAdmin) return alert('Admin access required.');
        const competitionInput = card.querySelector('input[data-field="competitionId"]');
        const groupInput = card.querySelector('input[data-field="groupName"]');
        const roundInput = card.querySelector('input[data-field="roundName"]');
        const competitionId = (competitionInput?.value || competitionsAdminState.defaults.competitionId || '').trim();
        if (!competitionId){
          alert('Enter a competition ID before approving.');
          competitionInput?.focus();
          return;
        }
        const payload = {
          competitionId,
          groupName: (groupInput?.value || competitionsAdminState.defaults.groupName || '').trim(),
          roundName: (roundInput?.value || competitionsAdminState.defaults.roundName || '').trim()
        };
        approveBtn.disabled = true;
        approveBtn.setAttribute('aria-busy','true');
        if (rejectBtn) rejectBtn.disabled = true;
        try{
          await apiPost(`/api/admin/competitions/pending/${encodeURIComponent(matchId)}/approve`, payload);
          delete competitionsAdminState.formValues[matchId];
          competitionsAdminState.items = competitionsAdminState.items.filter(item => String(item.matchId) !== String(matchId));
          competitionsAdminState.loaded = true;
          updateCompetitionsStatusMessage();
          renderCompetitionsPending();
          if (competitionsAdminStatus){
            competitionsAdminStatus.textContent = 'Match approved and recorded.';
          }
        }catch(err){
          const message = err?.message || 'Failed to approve match.';
          alert(message);
          if (competitionsAdminStatus){
            competitionsAdminStatus.textContent = `Approve failed: ${message}`;
          }
        }finally{
          approveBtn.disabled = false;
          approveBtn.removeAttribute('aria-busy');
          if (rejectBtn) rejectBtn.disabled = false;
        }
      });
    }
    if (rejectBtn){
      rejectBtn.addEventListener('click', async ()=>{
        if (!isAdmin) return alert('Admin access required.');
        if (!confirm('Reject this friendly result?')) return;
        rejectBtn.disabled = true;
        rejectBtn.setAttribute('aria-busy','true');
        if (approveBtn) approveBtn.disabled = true;
        try{
          await apiPost(`/api/admin/competitions/pending/${encodeURIComponent(matchId)}/reject`, {});
          delete competitionsAdminState.formValues[matchId];
          competitionsAdminState.items = competitionsAdminState.items.filter(item => String(item.matchId) !== String(matchId));
          competitionsAdminState.loaded = true;
          updateCompetitionsStatusMessage();
          renderCompetitionsPending();
          if (competitionsAdminStatus){
            competitionsAdminStatus.textContent = 'Match rejected.';
          }
        }catch(err){
          const message = err?.message || 'Failed to reject match.';
          alert(message);
          if (competitionsAdminStatus){
            competitionsAdminStatus.textContent = `Reject failed: ${message}`;
          }
        }finally{
          rejectBtn.disabled = false;
          rejectBtn.removeAttribute('aria-busy');
          if (approveBtn) approveBtn.disabled = false;
        }
      });
    }
  });
}

function renderCompetitionsPending(){
  if (!competitionsPendingList) return;
  if (!isAdmin){
    competitionsPendingList.innerHTML = '<div class="muted">Sign in as an admin to review pending competition matches.</div>';
    updateCompetitionsStatusMessage();
    return;
  }
  if (!competitionsAdminState.loaded){
    competitionsPendingList.innerHTML = '<div class="muted">Open the competition queue to load pending matches.</div>';
    updateCompetitionsStatusMessage();
    return;
  }
  const items = Array.isArray(competitionsAdminState.items) ? competitionsAdminState.items : [];
  if (!items.length){
    competitionsPendingList.innerHTML = '<div class="muted">No pending matches right now.</div>';
    updateCompetitionsStatusMessage();
    return;
  }
  competitionsPendingList.innerHTML = items.map(renderPendingMatchCard).join('');
  attachCompetitionCardHandlers();
  updateCompetitionsStatusMessage();
}

function setupCompetitionsAdminControls(){
  if (competitionsAdminRefresh && !competitionsAdminRefresh.dataset.bound){
    competitionsAdminRefresh.dataset.bound = 'true';
    competitionsAdminRefresh.addEventListener('click', async ()=>{
      if (!isAdmin) return alert('Admin access required.');
      competitionsAdminRefresh.disabled = true;
      competitionsAdminRefresh.setAttribute('aria-busy','true');
      try{ await loadCompetitionsAdmin(true); }
      finally{
        competitionsAdminRefresh.disabled = false;
        competitionsAdminRefresh.removeAttribute('aria-busy');
      }
    });
  }
}

async function loadCompetitionsAdmin(force = false){
  if (!isAdmin){
    competitionsAdminState.loaded = false;
    competitionsAdminState.items = [];
    renderCompetitionsPending();
    return;
  }
  setupCompetitionDefaultsForm();
  setupCompetitionsAdminControls();
  competitionsAdminState.errorMessage = '';
  if (competitionsAdminState.loading) return;
  if (competitionsAdminState.loaded && !force){
    renderCompetitionsPending();
    return;
  }
  competitionsAdminState.loading = true;
  updateCompetitionsStatusMessage();
  if (competitionsPendingList){
    competitionsPendingList.innerHTML = '<div class="muted">Loading pending matches…</div>';
  }
  try{
    const res = await apiGet('/api/admin/competitions/pending');
    competitionsAdminState.formValues = {};
    competitionsAdminState.items = Array.isArray(res.pending) ? res.pending : [];
    competitionsAdminState.items.sort((a, b) => {
      const aTime = new Date(a?.playedAt || a?.createdAt || 0).getTime();
      const bTime = new Date(b?.playedAt || b?.createdAt || 0).getTime();
      return bTime - aTime;
    });
    competitionsAdminState.loaded = true;
    renderCompetitionsPending();
    if (!competitionsAdminState.items.length && competitionsAdminStatus){
      competitionsAdminStatus.textContent = 'No pending matches at this time.';
    }
  }catch(err){
    const message = err?.message || 'Unable to load pending matches.';
    competitionsAdminState.errorMessage = message;
    if (competitionsAdminStatus){
      competitionsAdminStatus.textContent = message;
    }
    if (competitionsPendingList){
      competitionsPendingList.innerHTML = '<div class="muted">Unable to load pending matches.</div>';
    }
  }finally{
    competitionsAdminState.loading = false;
    updateCompetitionsStatusMessage();
  }
}

function updateCompetitionsAdminPanel(){
  if (!competitionsAdminView) return;
  if (isAdmin){
    setupCompetitionDefaultsForm();
    setupCompetitionsAdminControls();
    if (navAdminCompetitions && navAdminCompetitions.getAttribute('aria-pressed') === 'true'){
      loadCompetitionsAdmin();
    }else if (competitionsAdminState.loaded){
      renderCompetitionsPending();
    }else if (competitionsPendingList){
      competitionsPendingList.innerHTML = '<div class="muted">Open the competition queue to load pending matches.</div>';
      updateCompetitionsStatusMessage();
    }
  }else{
    competitionsAdminState.items = [];
    competitionsAdminState.loaded = false;
    competitionsAdminState.formValues = {};
    competitionsAdminState.errorMessage = '';
    renderCompetitionsPending();
  }
}


// =======================
//   FRIENDLIES
// =======================
async function loadFriendlies(){
  document.getElementById('frCupId').textContent = FRIENDLIES_ID;

  let fr = { friendly:{ teams:[] } };
  try { fr = await apiGet(`/api/friendlies/${encodeURIComponent(FRIENDLIES_ID)}`); }
  catch {}
  friendliesTeams = fr.friendly?.teams || [];

  try {
    const fx = await apiGet(`/api/cup/fixtures?cup=${encodeURIComponent(FRIENDLIES_ID)}`);
    friendliesFxCache = normalizeFixtures(fx.fixtures || []);
  } catch { friendliesFxCache = []; }
  renderFriendliesFixtures(friendliesFxCache);

  document.getElementById('friendliesAdmin').style.display = isAdmin ? 'block' : 'none';
  if (isAdmin) buildFriendliesAdmin(friendliesTeams);
}

function renderFriendliesFixtures(list){
  const el = document.getElementById('friendliesFixtures');
  list.sort((a,b)=>(a.when||a.createdAt)-(b.when||b.createdAt));
  el.innerHTML = list.length ? list.map(f=>{
    const H=byId(f.home), A=byId(f.away);
    const hn=H?.name||f.home; const an=A?.name||f.away;
    const whenTxt=f.when?fmtDate(f.when):'TBD';
    const isFinal=(String(f.status||'').toLowerCase()==='final');
    const scoreTxt=isFinal?`${f.score.hs}–${f.score.as}`:'vs';
    const scoreClass=isFinal?'score-final':'score-upcoming';
    const banner=getFixtureBanner();
    const editBtn = isAdmin ? `<div class="act"><button data-frq="${f.id}">Quick Edit</button></div>` : '';
    return `<div class="fx glow-card glow-silver" id="frfx_${f.id}"><div>${banner?`<img class="fx-banner" src="${banner}" alt="">`:''}<div class="fx-vs"><span class="fx-team"><img src="${teamLogoUrl(H)}" alt=""><span>${escapeHtml(hn)}</span></span><span class="score-pill ${scoreClass}">${scoreTxt}</span><span class="fx-team"><img src="${teamLogoUrl(A)}" alt=""><span>${escapeHtml(an)}</span></span></div><div class="meta"><span class="chip">Friendly${f.round?` • ${escapeHtml(f.round)}`:''}</span> • ${whenTxt} • ${escapeHtml(f.status||'')}</div></div>${editBtn}</div>`;
  }).join('') : `<div class="muted">No friendly fixtures yet.</div>`;
  list.forEach(f=>{ const q=document.querySelector(`[data-frq="${f.id}"]`); if(q) q.onclick=()=> openResultEditor(f); });
}

function buildFriendliesAdmin(teamIds){
  const listEl = document.getElementById('frTeamList');
  listEl.innerHTML = teamIds.length ? teamIds.map(id=>{ const T=byId(id); return `<div style="margin-top:4px"><span>${escapeHtml(T?.name||id)}</span> <button data-remove="${id}">Remove</button></div>`; }).join('') : '<div class="muted">No teams.</div>';
  listEl.querySelectorAll('[data-remove]').forEach(btn=>{
    btn.onclick = async ()=>{
      const id = btn.getAttribute('data-remove');
      const next = teamIds.filter(t=>t!==id);
      try { await apiPost(`/api/friendlies/${FRIENDLIES_ID}/teams`, { teams: next }); await loadFriendlies(); }
      catch(e){ alert('Update failed: '+e.message); }
    };
  });

  const addSel = document.getElementById('frAddSel');
  const addBtn = document.getElementById('frAddBtn');
  const options = teams.filter(t=>!teamIds.includes(t.id)).map(t=>`<option value="${t.id}">${escapeHtml(t.name)} (${t.id})</option>`).join('');
  addSel.innerHTML = `<option value="">— choose —</option>${options}`;
  addBtn.onclick = async ()=>{
    const id = addSel.value; if(!id) return alert('Pick a team');
    const next=[...teamIds,id];
    try{ await apiPost(`/api/friendlies/${FRIENDLIES_ID}/teams`, { teams: next }); await loadFriendlies(); }
    catch(e){ alert('Update failed: '+e.message); }
  };

  const genBtn = document.getElementById('frGenBtn');
  genBtn.onclick = async ()=>{
    if (!confirm('Generate fixtures for all selected teams?')) return;
    try{ await apiPost(`/api/friendlies/${FRIENDLIES_ID}/generate`, {}); alert('Fixtures generated'); await loadFriendlies(); }
    catch(e){ alert('Generate failed: '+e.message); }
  };
}


// =======================
//   NEWS ADMIN PANEL
// =======================
function renderAdminManualNews(items){
  if (!adminNewsList) return;
  if (!isAdmin){
    adminNewsList.innerHTML = '<div class="muted">Administrator tools available after signing in.</div>';
    return;
  }
  const normalized = Array.isArray(items) ? items.map(item => ({ ...item, type: (item.type || 'manual') })) : [];
  renderNewsCollection(
    adminNewsList,
    normalized,
    '<div class="muted">No manual stories published yet.</div>',
    {
      showAdminActions: true,
      renderAdminActions: item => {
        if (!item || item.id === undefined || item.id === null) return '';
        return `<button type="button" class="danger" data-delete-news="${escapeAttr(item.id)}">Delete</button>`;
      }
    }
  );
  adminNewsList.querySelectorAll('[data-delete-news]').forEach(btn => {
    btn.addEventListener('click', async () => {
      if (!isAdmin) return;
      const id = btn.getAttribute('data-delete-news');
      if (!id) return;
      if (!confirm('Delete this story?')) return;
      btn.disabled = true;
      btn.setAttribute('aria-busy','true');
      try{
        await apiDelete(`/api/news/${encodeURIComponent(id)}`);
        if (adminNewsStatus){
          adminNewsStatus.textContent = 'Story deleted.';
        }
        await loadNews();
      }catch(err){
        alert(`Failed to delete story: ${err?.message || err}`);
      }finally{
        btn.removeAttribute('aria-busy');
        btn.disabled = false;
      }
    });
  });
}

function readFileAsDataURL(file){
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = () => reject(new Error('Failed to read image file.'));
    reader.readAsDataURL(file);
  });
}

async function handleAdminNewsSubmit(event){
  event.preventDefault();
  if (!isAdmin){
    alert('Admins only');
    return;
  }
  if (!adminNewsForm) return;
  const submitBtn = adminNewsForm.querySelector('button[type="submit"]');
  const formData = new FormData(adminNewsForm);
  const title = String(formData.get('title') || '').trim();
  const body = String(formData.get('body') || '').trim();
  const author = String(formData.get('author') || '').trim();
  const videoUrl = String(formData.get('video') || '').trim();
  const imageFile = formData.get('image');

  if (adminNewsStatus){
    adminNewsStatus.textContent = 'Publishing…';
  }
  if (submitBtn){
    submitBtn.disabled = true;
    submitBtn.setAttribute('aria-busy','true');
  }

  if (!title || !body){
    if (adminNewsStatus){
      adminNewsStatus.textContent = 'Headline and story are required.';
    }
    if (submitBtn){
      submitBtn.disabled = false;
      submitBtn.removeAttribute('aria-busy');
    }
    return;
  }

  let imageData = null;
  if (imageFile && imageFile.size){
    if (imageFile.size > 3 * 1024 * 1024){
      if (adminNewsStatus){
        adminNewsStatus.textContent = 'Image is larger than 3MB.';
      }
      if (submitBtn){
        submitBtn.disabled = false;
        submitBtn.removeAttribute('aria-busy');
      }
      return;
    }
    try{
      imageData = await readFileAsDataURL(imageFile);
    }catch(err){
      if (adminNewsStatus){
        adminNewsStatus.textContent = err?.message || 'Image upload failed.';
      }
      if (submitBtn){
        submitBtn.disabled = false;
        submitBtn.removeAttribute('aria-busy');
      }
      return;
    }
  }

  const payload = { title, body };
  if (author) payload.author = author;
  if (videoUrl) payload.videoUrl = videoUrl;
  if (imageData) payload.imageData = imageData;

  try{
    const res = await fetch(`${API_BASE}/api/news`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify(payload)
    });
    let data = null;
    try{ data = await res.json(); }
    catch{ data = null; }
    if (!res.ok){
      throw new Error(data?.error || `HTTP ${res.status}`);
    }
    if (adminNewsStatus){
      adminNewsStatus.textContent = 'Story published successfully!';
    }
    adminNewsForm.reset();
    await loadNews();
  }catch(err){
    if (adminNewsStatus){
      adminNewsStatus.textContent = err?.message || 'Publish failed.';
    }
  }finally{
    if (submitBtn){
      submitBtn.disabled = false;
      submitBtn.removeAttribute('aria-busy');
    }
  }
}

function setupAdminNewsPanel(){
  if (adminNewsSetup) return;
  if (!adminNewsForm) return;
  adminNewsSetup = true;
  adminNewsForm.addEventListener('submit', handleAdminNewsSubmit);
  if (adminNewsRefresh){
    adminNewsRefresh.addEventListener('click', async ()=>{
      if (!isAdmin) return;
      if (adminNewsRefresh){
        adminNewsRefresh.disabled = true;
        adminNewsRefresh.setAttribute('aria-busy','true');
      }
      if (adminNewsList){
        adminNewsList.innerHTML = '<div class="muted">Refreshing…</div>';
      }
      try{ await loadNews(); }
      finally{
        if (adminNewsRefresh){
          adminNewsRefresh.disabled = false;
          adminNewsRefresh.removeAttribute('aria-busy');
        }
      }
    });
  }
}

function updateAdminNewsPanel(){
  if (!adminNewsPanel) return;
  if (isAdmin){
    adminNewsPanel.style.display = 'block';
    setupAdminNewsPanel();
    if (!adminNewsFetched){
      if (adminNewsList){
        adminNewsList.innerHTML = '<div class="muted">Loading manual stories…</div>';
      }
      loadNews();
    }else{
      renderAdminManualNews(latestManualNews);
    }
  }else{
    adminNewsPanel.style.display = 'none';
    if (adminNewsStatus){
      adminNewsStatus.textContent = '';
    }
    if (adminNewsList){
      adminNewsList.innerHTML = '<div class="muted">Administrator tools available after signing in.</div>';
    }
  }
}

// =======================
//   NEWS (dynamic; client-side fallback from fixtures)
// =======================
function normalizeNewsItem(n){
  if (!n) return null;
  const item = { ...n };
  if (item.createdAt){
    const d = new Date(item.createdAt);
    if (!Number.isNaN(d.getTime())) item.createdAt = d.toISOString();
  } else if (item.ts){
    const d = new Date(item.ts);
    if (!Number.isNaN(d.getTime())) item.createdAt = d.toISOString();
  }
  if (item.type) item.type = String(item.type).toLowerCase();
  if (item.category) item.category = String(item.category).toLowerCase();
  return item;
}

function renderNewsCollection(target, items, emptyHtml, options){
  if (!target) return;
  const list = (items || []).map(normalizeNewsItem).filter(Boolean);
  list.sort((a,b)=>{
    const aTs = new Date(a.createdAt || a.ts || 0).getTime();
    const bTs = new Date(b.createdAt || b.ts || 0).getTime();
    return bTs - aTs;
  });
  if (!list.length){
    target.innerHTML = emptyHtml || '<div class="muted">No news yet.</div>';
    return;
  }
  const charts = [];
  target.innerHTML = list.map(item => renderNewsItem(item, charts, options)).join('');
  if (charts.length){
    requestAnimationFrame(()=>hydrateNewsCharts(charts));
  }
}

async function loadNews(){
  const mainWrap = document.getElementById('newsMainFeed');
  const generalWrap = document.getElementById('newsGeneralFeed');
  if (mainWrap) mainWrap.innerHTML = '<div class="muted">Loading main news…</div>';
  if (generalWrap) generalWrap.innerHTML = '<div class="muted">Loading community posts…</div>';
  if (isAdmin && adminNewsList){
    adminNewsList.innerHTML = '<div class="muted">Loading manual stories…</div>';
  }
  try{
    const d = await apiGet('/api/news');
    const fallbackItems = Array.isArray(d.items) ? d.items.map(item => ({
      ...item,
      type: (item.type || '').toLowerCase()
    })) : [];
    const mainItems = Array.isArray(d.main) && d.main.length
      ? d.main
      : fallbackItems.filter(item => item.type !== 'manual_post' && item.type !== 'manual');
    const generalItems = Array.isArray(d.general) && d.general.length
      ? d.general
      : fallbackItems.filter(item => item.type === 'manual_post' || item.type === 'manual');
    if (mainWrap){
      renderNewsCollection(mainWrap, mainItems, '<div class="muted">No main news yet.</div>');
    }
    if (generalWrap){
      renderNewsCollection(generalWrap, generalItems, '<div class="muted">No community posts yet.</div>');
    }
    latestManualNews = generalItems.map(item => ({ ...item, type: (item.type || 'manual') }));
    adminNewsFetched = true;
    if (isAdmin){
      renderAdminManualNews(latestManualNews);
    }
    return;
  }catch(err){
    console.warn('Failed to load news feed via API', err);
    if (isAdmin && adminNewsList){
      adminNewsList.innerHTML = '<div class="muted">Unable to load manual stories.</div>';
    }
  }
  try{
    await refreshFixturesPublic();
    const cc = await apiGet(`/api/cup/fixtures?cup=${encodeURIComponent(CC_ID)}`).catch(()=>({fixtures:[]}));
    const fr = await apiGet(`/api/cup/fixtures?cup=${encodeURIComponent(FRIENDLIES_ID)}`).catch(()=>({fixtures:[]}));
    const computed = await computeNewsFromFixtures([
      ...fixturesPublicCache,
      ...normalizeFixtures(cc.fixtures||[]),
      ...normalizeFixtures(fr.fixtures||[])
    ]);
    if (mainWrap){
      renderNewsCollection(mainWrap, computed, '<div class="muted">No main news yet.</div>');
    }
  }catch{
    if (mainWrap){
      mainWrap.innerHTML = '<div class="muted">Failed to load news.</div>';
    }
  }
  if (generalWrap){
    generalWrap.innerHTML = '<div class="muted">No community posts yet.</div>';
  }
  if (isAdmin && adminNewsList){
    adminNewsList.innerHTML = '<div class="muted">No manual stories yet.</div>';
    latestManualNews = [];
    adminNewsFetched = true;
  }
}

function renderNewsItem(n, chartsCollector, options){
  if (!n) return '';
  const charts = chartsCollector || [];
  const type = (n.type || '').toLowerCase();
  if (type === 'manual' || type === 'manual_post') return renderManualNewsItem(n, options);
  if (type === 'hidden_gem') return renderHiddenGemNewsItem(n);
  if (type === 'standings_snapshot' || type === 'auto') return renderAutoNewsItem(n, charts);
  return renderLegacyNewsItem(n);
}

function renderManualNewsItem(n, options){
  const title = escapeHtml(n.title || '');
  const body = n.body ? escapeHtml(n.body).replace(/\n/g, '<br>') : '';
  const metaParts = [];
  const whenTxt = fmtDate(n.createdAt || n.ts || Date.now());
  if (whenTxt) metaParts.push(escapeHtml(whenTxt));
  if (n.author) metaParts.push(escapeHtml(n.author));
  const meta = metaParts.join(' • ');
  const media = [];
  if (n.imageUrl){
    media.push(`<div class="news-media"><img src="${escapeAttr(n.imageUrl)}" alt="${title}"></div>`);
  }
  if (n.videoUrl){
    media.push(`<div class="news-media news-video"><iframe src="${escapeAttr(n.videoUrl)}" allowfullscreen loading="lazy"></iframe></div>`);
  }
  let adminActions = '';
  if (options?.showAdminActions){
    const actions = typeof options.renderAdminActions === 'function'
      ? options.renderAdminActions(n)
      : '';
    if (actions){
      adminActions = `<div class="news-admin-actions">${actions}</div>`;
    }
  }
  return `<article class="news-post news-manual glow-card glow-gold">
    <div class="news-badge">${escapeHtml(n.badge || 'Community Post')}</div>
    <div class="news-title">${title}</div>
    ${meta ? `<div class="news-meta">${meta}</div>` : ''}
    ${body ? `<div class="news-body">${body}</div>` : ''}
    ${media.join('')}
    ${adminActions}
  </article>`;
}

function renderAutoNewsItem(n, charts){
  const title = escapeHtml(replaceClubIds(n.title || ''));
  const summary = n.body ? `<div class="news-body">${escapeHtml(replaceClubIds(n.body))}</div>` : '';
  let detail = '';
  if (Array.isArray(n.stats) && n.stats.length){
    detail = renderNewsStats(n.stats);
  } else if (n.chart && Array.isArray(n.chart.data) && n.chart.data.length){
    const chartId = `newsChart_${Math.random().toString(36).slice(2,10)}`;
    charts.push({ id: chartId, config: n.chart });
    detail = `<div class="news-chart" id="${chartId}"></div>`;
  } else if (n.highlight){
    detail = renderNewsHighlight(n.highlight);
  }
  const meta = fmtDate(n.createdAt || n.ts || Date.now());
  return `<article class="news-post news-auto glow-card glow-silver">
    <div class="news-badge">${escapeHtml(n.badge || 'Auto Update')}</div>
    <div class="news-title">${title}</div>
    ${summary}
    ${detail}
    ${meta ? `<div class="news-meta">${escapeHtml(meta)}</div>` : ''}
  </article>`;
}

function renderHiddenGemNewsItem(n){
  const details = n.details || {};
  const title = n.title || 'Hidden Gem Spotlight 🌟';
  const playerName = escapeHtml(details.playerName || title);
  const position = escapeHtml(details.position || '');
  const clubName = escapeHtml(details.clubName || '');
  const overallText = escapeHtml(String(formatOverallValue(details.overallRating)));
  const potentialText = escapeHtml(String(formatOverallValue(details.potentialRating)));
  const matches = formatStatValue(details.matches);
  const goals = formatStatValue(details.goals);
  const assists = formatStatValue(details.assists);
  const saves = details.saves !== undefined ? formatStatValue(details.saves) : null;
  const tackles = details.tackles !== undefined ? formatStatValue(details.tackles) : null;
  const isKeeper = (details.position || '').toUpperCase() === 'GK';
  const highlightValue = isKeeper ? saves : tackles;
  const highlightLabel = isKeeper ? 'Saves' : 'Tackles';
  const summary = details.summary || n.body || '';
  const perMatch = details.perMatch || {};
  const perChips = [];
  const goalsPer = Number(perMatch.goals);
  if (Number.isFinite(goalsPer)) perChips.push(`<span>G/Match <strong>${goalsPer.toFixed(2)}</strong></span>`);
  const assistsPer = Number(perMatch.assists);
  if (Number.isFinite(assistsPer)) perChips.push(`<span>A/Match <strong>${assistsPer.toFixed(2)}</strong></span>`);
  const tacklesPer = Number(perMatch.tackles);
  if (Number.isFinite(tacklesPer) && !isKeeper) perChips.push(`<span>Tackles/Match <strong>${tacklesPer.toFixed(2)}</strong></span>`);
  const savesPer = Number(perMatch.saves);
  if (Number.isFinite(savesPer)) perChips.push(`<span>Saves/Match <strong>${savesPer.toFixed(2)}</strong></span>`);
  const savePct = Number(perMatch.savePct);
  if (Number.isFinite(savePct) && isKeeper) perChips.push(`<span>Save% <strong>${savePct.toFixed(1)}%</strong></span>`);
  const stats = [
    { label: 'Matches', value: matches },
    { label: 'Goals', value: goals },
    { label: 'Assists', value: assists }
  ];
  if (highlightValue !== null && highlightValue !== undefined){
    stats.push({ label: highlightLabel, value: highlightValue });
  }
  const meta = fmtDate(n.createdAt || n.ts || Date.now());
  return `<article class="news-post news-hidden-gem glow-card glow-gold">
    <div class="news-badge">${escapeHtml(n.badge || 'Hidden Gem')}</div>
    <div class="hidden-gem-header">
      <div class="hidden-gem-player">
        <div class="hidden-gem-name">${playerName}</div>
        <div class="hidden-gem-meta">${position ? `${position} • ` : ''}${clubName}</div>
      </div>
      <div class="hidden-gem-overall">
        <span class="label">OVR</span>
        <span class="value">${overallText}</span>
        <span class="potential">Potential ${potentialText}</span>
      </div>
    </div>
    <div class="hidden-gem-stats">
      ${stats.map(stat => `<div class="hidden-gem-stat"><span class="stat-label">${escapeHtml(stat.label)}</span><span class="stat-value">${escapeHtml(String(stat.value))}</span></div>`).join('')}
    </div>
    ${perChips.length ? `<div class="hidden-gem-traits">${perChips.join('')}</div>` : ''}
    ${summary ? `<div class="news-body">${escapeHtml(summary).replace(/\n/g, '<br>')}</div>` : ''}
    ${meta ? `<div class="news-meta">${escapeHtml(meta)}</div>` : ''}
  </article>`;
}

function renderNewsStats(stats){
  return `<ul class="news-stats">${stats.map((row, idx)=>{
    const club = row.clubId ? byId(row.clubId) : null;
    const rank = row.rank ?? (idx + 1);
    const label = row.label ? replaceClubIds(row.label) : (club?.name || row.clubId || '');
    const metaBits = [];
    if (row.points !== undefined) metaBits.push(`${row.points} pts`);
    if (row.record) metaBits.push(row.record);
    if (row.goalDiff !== undefined) metaBits.push(`GD ${row.goalDiff}`);
    if (row.value !== undefined && !metaBits.length) metaBits.push(String(row.value));
    const meta = metaBits.filter(Boolean).join(' • ');
    return `<li class="news-stat-row">
      <span class="rank">${escapeHtml(rank)}</span>
      <span class="stat-club">${escapeHtml(label)}</span>
      <span class="stat-meta">${escapeHtml(meta)}</span>
    </li>`;
  }).join('')}</ul>`;
}

function renderNewsHighlight(highlight){
  const homeClub = highlight?.home?.clubId ? byId(highlight.home.clubId) : null;
  const awayClub = highlight?.away?.clubId ? byId(highlight.away.clubId) : null;
  const homeName = escapeHtml(homeClub?.name || highlight?.home?.clubId || 'Home');
  const awayName = escapeHtml(awayClub?.name || highlight?.away?.clubId || 'Away');
  const homeGoals = Number(highlight?.home?.goals ?? 0);
  const awayGoals = Number(highlight?.away?.goals ?? 0);
  return `<div class="news-highlight">
    <div class="club"><img src="${teamLogoUrl(homeClub)}" alt="${homeName}"><span>${homeName}</span></div>
    <div class="score">${homeGoals}–${awayGoals}</div>
    <div class="club"><img src="${teamLogoUrl(awayClub)}" alt="${awayName}"><span>${awayName}</span></div>
  </div>`;
}

function renderLegacyNewsItem(n){
  const club = byId(n.clubId);
  let title = n.title;
  let body  = n.body;
  if (!title || title===n.clubId){
    if (n.type==='clean_sheet' && club){
      title = `${club.name} clean sheet`;
      body  = `${club.name} keep ${Number(n.score?.hs||0)}-${Number(n.score?.as||0)} shutout`;
    } else if (n.type==='high_scoring'){
      const hn = byId(n.home)?.name || n.home;
      const an = byId(n.away)?.name || n.away;
      title = 'High scoring match';
      body  = `${hn} ${Number(n.score?.hs||0)}-${Number(n.score?.as||0)} ${an}`;
    } else if (n.type==='blowout' && club){
      title = `${club.name} blowout win`;
      body  = `${Number(n.score?.hs||0)}-${Number(n.score?.as||0)} victory`;
    } else if (n.type==='final'){
      const hn = byId(n.home)?.name || n.home;
      const an = byId(n.away)?.name || n.away;
      title = `${hn} ${Number(n.score?.hs||0)}-${Number(n.score?.as||0)} ${an}`;
      body  = 'Full time score';
  }
}
  title = replaceClubIds(title);
  body  = replaceClubIds(body);
  const metaBits = [];
  if (n.ts) metaBits.push(escapeHtml(fmtDate(n.ts)));
  if (n.tag) metaBits.push(escapeHtml(n.tag));
  return `<article class="news-post news-auto glow-card glow-silver">
    <div class="news-badge">${escapeHtml(n.tag || 'Auto Update')}</div>
    <div class="news-title">${escapeHtml(title||'')}</div>
    <div class="news-body">${escapeHtml(body||'')}</div>
    ${metaBits.length ? `<div class="news-meta">${metaBits.join(' • ')}</div>` : ''}
  </article>`;
}

function hydrateNewsCharts(charts){
  if (!charts || !charts.length) return;
  if (!window.React || !window.ReactDOM || !window.Recharts) return;
  const React = window.React;
  const ReactDOM = window.ReactDOM;
  const { ResponsiveContainer, BarChart, Bar, AreaChart, Area, XAxis, YAxis, Tooltip, CartesianGrid } = window.Recharts;
  const axisTick = { fill:'#cbd5f5', fontSize:12 };
  const tooltipStyle = { background:'rgba(15,23,42,0.92)', border:'1px solid rgba(148,163,184,0.35)', borderRadius:12, color:'#f8fafc' };
  charts.forEach(cfg => {
    const el = document.getElementById(cfg.id);
    if (!el) return;
    const data = (cfg.config?.data || []).map(d => ({
      name: d.name || '',
      value: Number(d.value || 0)
    }));
    if (!data.length) return;
    const color = cfg.config?.color || '#facc15';
    const type = (cfg.config?.type || 'bar').toLowerCase();
    const margin = { top:10, right:16, left:0, bottom:0 };
    const content = type === 'area'
      ? React.createElement(ResponsiveContainer, { width:'100%', height:'100%' },
          React.createElement(AreaChart, { data, margin },
            React.createElement(CartesianGrid, { strokeDasharray:'3 3', stroke:'rgba(148,163,184,0.25)' }),
            React.createElement(XAxis, { dataKey:'name', stroke:'#94a3b8', tick:axisTick }),
            React.createElement(YAxis, { stroke:'#94a3b8', allowDecimals:false, tick:axisTick }),
            React.createElement(Tooltip, { contentStyle:tooltipStyle }),
            React.createElement(Area, { dataKey:'value', stroke:color, fill:color, fillOpacity:0.32, strokeWidth:3, dot:{ r:4, stroke:'#0f172a', strokeWidth:1, fill:color } })
          )
        )
      : React.createElement(ResponsiveContainer, { width:'100%', height:'100%' },
          React.createElement(BarChart, { data, margin },
            React.createElement(CartesianGrid, { strokeDasharray:'3 3', stroke:'rgba(148,163,184,0.25)' }),
            React.createElement(XAxis, { dataKey:'name', stroke:'#94a3b8', tick:axisTick }),
            React.createElement(YAxis, { stroke:'#94a3b8', allowDecimals:false, tick:axisTick }),
            React.createElement(Tooltip, { contentStyle:tooltipStyle }),
            React.createElement(Bar, { dataKey:'value', fill:color, radius:[8,8,0,0] })
          )
        );
    if (!el.__newsRoot){
      el.__newsRoot = ReactDOM.createRoot(el);
    }
    el.__newsRoot.render(content);
  });
}
async function computeNewsFromFixtures(list){
  const out = [];
  const byPlayer = new Map(); // name => { goalStreak, assistStreak, contribStreak, lastAt }
  const tallyGoals = new Map();
  const tallyAssists = new Map();
  const goalTotals = new Map();
  const assistTotals = new Map();
  const now = Date.now();

  const ids = new Set();
  list.forEach(f=>{
    ['home','away'].forEach(side=>{
      (f.details?.[side]||[]).forEach(r=>{ if(!r.player && r.playerId) ids.add(r.playerId); });
    });
  });
  await Promise.all(Array.from(ids).map(id=>resolvePlayerName(id)));

  const finals = list.filter(f=>String(f.status||'').toLowerCase()==='final').sort((a,b)=> (a.when||0)-(b.when||0));
  finals.forEach(f=>{
    const total = Number(f.score?.hs||0)+Number(f.score?.as||0);
    const diff = Math.abs(Number(f.score?.hs||0)-Number(f.score?.as||0));
    if (Number(f.score?.as||0)===0){ out.push({ tag:'Clean Sheet', title:`${byId(f.home)?.name||f.home} clean sheet`, body:`${byId(f.home)?.name||f.home} keep ${Number(f.score.hs||0)}-${Number(f.score.as||0)} shutout`, clubId:f.home, ts:f.when||now }); }
    if (Number(f.score?.hs||0)===0){ out.push({ tag:'Clean Sheet', title:`${byId(f.away)?.name||f.away} clean sheet`, body:`${byId(f.away)?.name||f.away} keep ${Number(f.score.hs||0)}-${Number(f.score.as||0)} shutout`, clubId:f.away, ts:f.when||now }); }
    if (total>=8){ out.push({ tag:'High Scoring', title:'High scoring match', body:`${byId(f.home)?.name||f.home} ${Number(f.score.hs||0)}-${Number(f.score.as||0)} ${byId(f.away)?.name||f.away}`, clubId:'', ts:f.when||now }); }
    if (diff>=5){ const winner = Number(f.score.hs||0)>Number(f.score.as||0) ? f.home : f.away; out.push({ tag:'Blowout', title:`${byId(winner)?.name||winner} blowout win`, body:`${Number(f.score.hs||0)}-${Number(f.score.as||0)} victory`, clubId:winner, ts:f.when||now }); }

    ['home','away'].forEach(side=>{
      (f.details?.[side]||[]).forEach(r=>{
        const name = (r.player && r.player.trim()) || playerNameCache.get(r.playerId) || r.playerId || 'Unknown';
        const g = Number(r.goals||0);
        const a = Number(r.assists||0);
        const rating = Number(r.rating||0);
        const clubId = side==='home'?f.home:f.away;

        if (g===2){ out.push({ tag:'Brace', title:`${name} scores a brace`, body:`${name} struck twice for ${(byId(clubId)?.name)||'their club'} in ${f.round||'League'}.`, clubId, ts:f.when||now }); }
        else if (g===3){ out.push({ tag:'Hattrick', title:`${name} nets a hat-trick!`, body:`${name} scored ${g} for ${(byId(clubId)?.name)||'their club'} in ${f.round||'League'}.`, clubId, ts:f.when||now }); }
        else if (g>=4){ out.push({ tag:'Haul', title:`${name} scores ${g}!`, body:`${name} recorded ${g} goals for ${(byId(clubId)?.name)||'their club'} in ${f.round||'League'}.`, clubId, ts:f.when||now }); }

        if (a===2){ out.push({ tag:'Assist Brace', title:`${name} with two assists`, body:`${name} set up two goals for ${(byId(clubId)?.name)||'their club'} in ${f.round||'League'}.`, clubId, ts:f.when||now }); }
        else if (a>=3){ out.push({ tag:'Assist Hat-trick', title:`${name} assists ${a}`, body:`${name} tallied ${a} assists for ${(byId(clubId)?.name)||'their club'} in ${f.round||'League'}.`, clubId, ts:f.when||now }); }

        if (g>=2 && a>=2){ out.push({ tag:'Big Game', title:`${name} stars with ${g}G/${a}A`, body:`${name} contributed ${g} goals and ${a} assists for ${(byId(clubId)?.name)||'their club'} in ${f.round||'League'}.`, clubId, ts:f.when||now }); }

        if (rating>=9){ out.push({ tag:'High Rating', title:`${name} shines with ${rating}`, body:`${name} earned a ${rating} rating for ${(byId(clubId)?.name)||'their club'}.`, clubId, ts:f.when||now }); }

        const meta = byPlayer.get(name) || { goalStreak:0, assistStreak:0, contribStreak:0, lastAt:0 };
        meta.goalStreak = g>0 ? meta.goalStreak+1 : 0;
        meta.assistStreak = a>0 ? meta.assistStreak+1 : 0;
        meta.contribStreak = (g>0||a>0) ? meta.contribStreak+1 : 0;
        meta.lastAt = f.when||now;
        byPlayer.set(name, meta);

        const goalTotal = (goalTotals.get(name)||0) + g;
        goalTotals.set(name, goalTotal);
        if (g>0 && [1,10,50].includes(goalTotal)){ out.push({ tag:'Milestone', title:`${name} reaches ${goalTotal} goals`, body:`${name} has now scored ${goalTotal} career goals.`, clubId, ts:f.when||now }); }

        const assistTotal = (assistTotals.get(name)||0) + a;
        assistTotals.set(name, assistTotal);
        if (a>0 && [1,10,50].includes(assistTotal)){ out.push({ tag:'Milestone', title:`${name} reaches ${assistTotal} assists`, body:`${name} has now provided ${assistTotal} career assists.`, clubId, ts:f.when||now }); }

        if (g>0) tallyGoals.set(name, (tallyGoals.get(name)||0)+g);
        if (a>0) tallyAssists.set(name, (tallyAssists.get(name)||0)+a);
      });
    });
  });

  for (const [name,meta] of byPlayer.entries()){
    if (meta.goalStreak>=3){ out.push({ tag:'Streak', title:`${name} scoring streak`, body:`${name} has scored in ${meta.goalStreak} consecutive matches.`, clubId:'', ts:meta.lastAt||now }); }
    if (meta.assistStreak>=3){ out.push({ tag:'Streak', title:`${name} assist streak`, body:`${name} has assisted in ${meta.assistStreak} straight matches.`, clubId:'', ts:meta.lastAt||now }); }
    if (meta.contribStreak>=3){ out.push({ tag:'Streak', title:`${name} contribution streak`, body:`${name} has contributed in ${meta.contribStreak} consecutive matches.`, clubId:'', ts:meta.lastAt||now }); }
  }

  const leaders = Array.from(tallyGoals.entries()).sort((a,b)=>b[1]-a[1]).slice(0,3);
  if (leaders.length){ const line = leaders.map(([n,c],i)=>`${i+1}. ${n} (${c})`).join('  '); out.push({ tag:'Leaders', title:'Top Scorers Update', body: line, clubId:'', ts: now }); }
  const assistsLead = Array.from(tallyAssists.entries()).sort((a,b)=>b[1]-a[1]).slice(0,3);
  if (assistsLead.length){ const line = assistsLead.map(([n,c],i)=>`${i+1}. ${n} (${c})`).join('  '); out.push({ tag:'Leaders', title:'Top Assists Update', body: line, clubId:'', ts: now }); }

  out.sort((a,b)=> (b.ts||0) - (a.ts||0));
  return out;
}

// =======================
//   INIT
// =======================
setupRankings();
setupCommunityNewsForm();
async function init(){

  buildStaticTeams();
  await loadPlayers();
  await checkAdmin();
  await checkMe();
  await loadHome();

  const initialNav = resolveInitialNav();
  setNav(initialNav);
  if (initialNav === 'news'){
    await loadNews();
  }else if (initialNav === 'friendlies'){
    await loadFriendlies();
  }else if (initialNav === 'champions'){
    await loadChampions();
  }else if (initialNav === 'league'){
    loadLeague();
  }else if (initialNav === 'competitionsAdmin'){
    await loadCompetitionsAdmin();
  }
  const normalizedPath = window.location.pathname.replace(/\/+$/, '');
  if (normalizedPath === '/admin/news' || normalizedPath === '/admin/competitions'){
    try{
      const nextUrl = new URL(window.location.href);
      nextUrl.pathname = '/';
      if (!nextUrl.searchParams.get('view')){
        nextUrl.searchParams.set('view', normalizedPath === '/admin/competitions' ? 'competitionsAdmin' : 'news');
      }
      history.replaceState(null, '', nextUrl);
    }catch{}
  }

  await refreshMatches();
  setInterval(async () => { await refreshMatches(); }, 10*60*1000);

  await refreshFixturesPublic(); renderFixturesPublic();
  if (isAdmin){ await refreshFixturesSched(); renderFixturesSched(); }

  // hash-open team
  try{
    const m = location.hash.match(/team=([^&]+)/);
    if (m){ const team = byId(decodeURIComponent(m[1])); if (team) setTimeout(()=>showTeam(team), 120); }
  }catch{}
}
init();

window.addEventListener('load', () => {
  const introAudio = document.getElementById('introAudio');
  const intro = document.getElementById('intro');

  if (introAudio) {
    const tryPlay = () => introAudio.play().catch(() => {});
    tryPlay();
    document.addEventListener('click', tryPlay, { once: true });
  }

  setTimeout(() => {
    if (intro) {
      intro.classList.add('hidden');
      intro.addEventListener('transitionend', () => {
        intro.remove();
        if (introAudio) {
          introAudio.pause();
          introAudio.remove();
        }
      });
    }
  }, 3000);
});
</script>
</body>
</html>
