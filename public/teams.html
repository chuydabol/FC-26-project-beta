<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pro Club ‚Äî League Hub</title>
<style>
:root{--accent:#e00;--muted:#bb8888;--card-h:400px}
*{box-sizing:border-box}
body{background:#000;color:#fff;font-family:Arial,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",sans-serif;margin:0;min-height:100vh}
header{background:linear-gradient(90deg,#a00000,#d50000);color:#fff;padding:14px 18px;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
header h1{margin:0;font-size:20px;letter-spacing:.2px}
.navbar{display:flex;gap:8px;align-items:center;margin-left:auto;flex-wrap:wrap}
.navbar button{background:#330000;color:#fff;border:1px solid #551111;border-radius:10px;padding:8px 10px;cursor:pointer}
.navbar button[aria-pressed="true"]{background:#550000;border-color:#aa1111}
main{padding:20px;max-width:1200px;margin:0 auto;background:#000}
h2{margin:0 0 8px}
.muted{color:var(--muted)}
.center{text-align:center}
.chip{background:#220000;border:1px solid #440000;border-radius:999px;padding:4px 8px;font-size:12px}
hr{border:none;border-top:1px solid #220000;margin:14px 0}

/* Cards / grids */
.teams-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:16px;margin-top:18px}
.team-card{background:#110000;border-radius:12px;box-shadow:0 6px 18px rgba(255,0,0,.25);overflow:hidden;cursor:pointer;transition:.14s;display:flex;flex-direction:column;align-items:center;padding:14px;color:#fff}
.team-card:hover{transform:translateY(-6px);box-shadow:0 12px 28px rgba(255,0,0,.45)}
/* Taller, responsive logos on team cards */
.team-logo{width:100%;height:clamp(150px,22vw,240px);object-fit:cover;border-radius:8px;background:#330000;display:block}
.team-meta{width:100%;display:flex;align-items:center;justify-content:space-between;margin-top:10px;gap:8px}
.team-meta .name{font-weight:700;font-size:16px}
.trophy-badge{background:#e00;color:#fff;font-weight:700;padding:6px 10px;border-radius:999px;display:inline-flex;align-items:center;gap:8px;box-shadow:0 2px 6px rgba(255,0,0,.6)}
.small-logo{width:22px;height:22px;border-radius:4px;object-fit:cover;vertical-align:middle;margin-right:6px}

/* Generic card */
.m-card{background:#110000;border:1px solid #2a0000;border-radius:12px;box-shadow:0 6px 18px rgba(255,0,0,.15);padding:12px}

/* Fixtures */
.fx-list{display:flex;flex-direction:column;gap:12px}
.fx{background:#110000;border:1px solid #300000;border-radius:10px;padding:10px;display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center}
.fx .meta{font-size:12px;color:var(--muted)}
.fx .vs{font-weight:700}
.fx .act{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end}
.fx button{background:#330000;border:1px solid #551111;color:#fff;border-radius:8px;padding:6px 8px;cursor:pointer}
.fx-banner{width:100%;max-height:120px;object-fit:cover;border-radius:8px;margin:6px 0}

/* Inputs */
input,select,textarea{background:#0d0000;color:#fff;border:1px solid #3a0000;border-radius:8px;padding:8px}
label{font-size:12px;color:var(--muted)}

/* Modal (manager + result entry) */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1000}
.modal.show{display:flex}
.modal .dialog{background:#110000;border:1px solid #2a0000;border-radius:12px;padding:16px;width:min(920px,96vw);max-height:92vh;overflow:auto;box-shadow:0 6px 18px rgba(255,0,0,.25)}
.modal .dialog h3{margin:0 0 8px}
.modal .row{display:grid;grid-template-columns:120px 1fr;gap:8px;align-items:center;margin:8px 0}
.modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

/* Squad panel */
.squad-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:18px;margin-top:14px}

/* Leaders (Champions Cup) */
.leaders{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
.leader-card{background:#110000;border:1px solid #2a0000;border-radius:12px;padding:12px}
.leader-card ol{margin:8px 0 0 18px}
.leader-card li{margin:2px 0}

/* NEWS feed: big social cards */
#newsList{max-width:760px;margin:10px auto 40px;display:flex;flex-direction:column;gap:16px}
.news-card{background:#110000;border:1px solid #2a0000;border-radius:14px;overflow:hidden;box-shadow:0 6px 18px rgba(255,0,0,.12)}
.news-cover{width:100%;height:clamp(220px,38vw,360px);object-fit:cover;border-bottom:1px solid #2a0000}
.news-body{padding:14px}
.news-title{font-weight:800;font-size:20px;line-height:1.2}
.news-text{margin-top:6px;color:#ddd;font-size:15px}
.news-meta{margin-top:8px;font-size:12px;color:var(--muted)}

@media(max-width:720px){
  .fx{grid-template-columns:1fr;gap:6px}
  .fx .act{justify-content:flex-start}
  .team-logo{height:180px}
}
</style>
</head>
<body>
<header>
  <h1>Pro Club ‚Äî League Hub</h1>
  <div class="navbar">
    <button id="navTeams"    aria-pressed="true">Teams</button>
    <button id="navMarket"   aria-pressed="false">Market</button>
    <button id="navFixturesPublic" aria-pressed="false">Fixtures</button>
    <button id="navFixturesSched"  aria-pressed="false" style="display:none">Fixtures Scheduling</button>
    <button id="navChampions" aria-pressed="false">Champions Cup</button>
    <button id="navNews"      aria-pressed="false">News</button>
    <button id="navRankings"  aria-pressed="false" style="display:none">Rankings</button>
    <button id="btnManagerLogin">Manager sign in</button>
    <button id="btnAdminLogin">Admin sign in</button>
    <button id="btnAdminLogout" style="display:none">Admin sign out</button>
  </div>
</header>

<main>
  <!-- TEAMS OVERVIEW -->
  <section id="teams-view" aria-live="polite">
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <h2 style="margin:0">Teams</h2>
      <div class="muted">Total teams: <span id="teams-count">0</span></div>
    </div>
    <div class="teams-grid" id="teamsGrid" role="list"></div>
  </section>

  <!-- TEAM DETAIL -->
  <section id="detail-view" aria-live="polite" style="display:none">
    <div id="detail-header" style="display:flex;align-items:center;gap:12px;margin-bottom:14px;color:#fff">
      <button id="backBtn">‚Üê Back</button>
      <div>
        <div id="detail-title" style="font-size:20px;font-weight:700">Team name</div>
        <div class="muted" id="detail-sub">squad & trophies</div>
      </div>
      <div style="margin-left:auto">
        <span class="trophy-badge" id="detail-trophies">0 üèÜ</span>
      </div>
    </div>

    <div id="teamPanels" class="grid-panels" style="display:grid;grid-template-columns:1fr;gap:12px">
      <div class="m-card">
        <strong>Club Wallet</strong>
        <div id="walletBody" class="muted" style="margin-top:6px">Loading‚Ä¶</div>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
          <button id="btnCollect" style="display:none">Collect daily payout</button>
          <small class="muted" id="walletHint"></small>
        </div>
      </div>

      <div class="m-card">
        <strong>Next UPCL Match</strong>
        <div id="nextMatchBody" class="muted" style="margin-top:6px">No scheduled match yet.</div>
      </div>

      <div id="teamResultsPanel" class="m-card">
        <strong>Recent Results</strong>
        <div id="teamResultsBody" class="muted" style="margin-top:6px">No finals yet.</div>
      </div>

      <!-- Squad editor/view (manual only; EA removed) -->
      <div class="m-card" id="squadPanel">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
          <strong>Squad</strong>
          <div id="squadTools" style="display:none;gap:8px">
            <button id="btnBootstrapSlots" title="Create S01..S15">Bootstrap slots</button>
          </div>
        </div>
        <div id="squadBody" class="muted" style="margin-top:6px">Loading‚Ä¶</div>
      </div>

    </div>

    <div id="squadContainer" class="squad-grid" style="margin-top:12px"></div>

    <div id="detail-footer" style="margin-top:18px" class="muted center">
      <small>Manual squads ‚Äî managers maintain slots. EA API disabled.</small>
    </div>
  </section>

  <!-- MARKET -->
  <section id="market-view" style="display:none">
    <h2>Transfer Market</h2>
    <div class="m-card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
        <strong>Free Agents</strong>
        <div>
          <button id="btnListFA">List me</button>
          <button id="btnUnlistFA">Unlist</button>
        </div>
      </div>
      <div id="faList" style="margin-top:8px" class="muted">Loading‚Ä¶</div>
    </div>
  </section>

  <!-- FIXTURES (PUBLIC) -->
  <section id="fixtures-public" style="display:none">
    <h2>Fixtures</h2>
    <div id="fixturesPublicList" class="fx-list" style="margin-top:10px"></div>
  </section>

  <!-- FIXTURES SCHEDULING (MANAGERS/Admins) -->
  <section id="fixtures-sched" style="display:none">
    <div style="display:flex;align-items:center;gap:8px;justify-content:space-between;flex-wrap:wrap">
      <h2>Fixtures Scheduling</h2>
      <div style="display:flex;gap:6px;align-items:center">
        <button data-fxf="upcoming" aria-pressed="true">Upcoming</button>
        <button data-fxf="final" aria-pressed="false">Final</button>
        <button data-fxf="all" aria-pressed="false">All</button>
        <button data-fxf="mine" aria-pressed="false">My club</button>
        <button id="btnCreateFx" style="display:none">Create fixture</button>
      </div>
    </div>
    <div id="fixturesList" class="fx-list" style="margin-top:10px"></div>
  </section>

  <!-- CHAMPIONS CUP -->
  <section id="champions-view" style="display:none">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap">
      <h2>UPCL Champions Cup</h2>
      <div class="chip">Cup ID: <span id="ccCupId"></span></div>
    </div>

    <div class="m-card" style="margin-top:10px">
      <strong>Groups</strong>
      <div id="ccGroups" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin-top:8px"></div>
    </div>

    <div class="m-card" id="ccLeadersCard" style="margin-top:10px">
      <strong>Leaders</strong>
      <div id="ccLeaders" class="leaders" style="margin-top:8px">
        <div class="muted">Loading leaders‚Ä¶</div>
      </div>
    </div>

    <div class="m-card" id="ccAdmin" style="display:none;margin-top:10px">
      <strong>Admin tools</strong>
      <div class="muted">Randomize groups (12 or 16 clubs ‚Üí A‚ÄìD), save groups, and create fixtures (group stage/knockouts).</div>
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="ccBtnRandom">Randomize (pick 12/16)</button>
        <button id="ccBtnSaveGroups">Save groups</button>
        <button id="ccBtnCreateFx">Create fixture</button>
      </div>
      <div id="ccManualGroups" style="display:grid;grid-template-columns:repeat(4,minmax(220px,1fr));gap:10px;margin-top:10px"></div>
    </div>

    <div class="m-card" style="margin-top:10px">
      <strong>Champions Cup Fixtures</strong>
      <div id="ccFixtures" class="fx-list" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- NEWS -->
  <section id="news-view" style="display:none">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap">
      <h2>League News</h2>
      <div class="chip">Auto-generated highlights & updates</div>
    </div>
    <div id="newsList"></div>
  </section>

  <!-- RANKINGS (trimmed / optional) -->
  <section id="rankings-view" style="display:none">
    <div style="display:flex;align-items:center;gap:8px;justify-content:space-between;flex-wrap:wrap">
      <h2>Rankings & Payouts</h2>
      <div id="adminControls" style="display:none;gap:8px">
        <button id="btnSaveRankings">Save</button>
        <button id="btnRecalc">Recalc tiers</button>
      </div>
    </div>
    <div class="m-card" style="margin-top:10px">
      <div class="muted" style="margin-bottom:8px">Admins only.</div>
      <div id="rankingsTable">Loading‚Ä¶</div>
    </div>
  </section>
</main>

<!-- Manager Sign-In Modal -->
<div class="modal" id="mgrModal" aria-hidden="true">
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="mgrTitle">
    <h3 id="mgrTitle">Manager sign in</h3>
    <div class="row"><label for="mgrClubSel">Club</label><select id="mgrClubSel"></select></div>
    <div class="row"><label for="mgrName">Your name</label><input id="mgrName" placeholder="Display name" /></div>
    <div class="row"><label for="mgrCode">Manager code</label><input id="mgrCode" placeholder="8-char code" /></div>
    <div class="actions"><button id="mgrCancel">Cancel</button><button id="mgrSubmit">Sign in</button></div>
  </div>
</div>

<!-- Result Entry Modal (Form + JSON paste) -->
<div class="modal" id="resultModal" aria-hidden="true">
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="resTitle">
    <h3 id="resTitle">Submit Result</h3>
    <div id="resFixtureMeta" class="muted" style="margin:6px 0 10px"></div>

    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
      <div class="chip">Form</div>
      <button id="resTabForm">Form Entry</button>
      <button id="resTabJson">JSON Paste</button>
    </div>

    <!-- Scores + Notes -->
    <div class="m-card" style="margin:8px 0">
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <label>Home score</label><input id="resHs" type="number" min="0" style="width:80px">
        <label>Away score</label><input id="resAs" type="number" min="0" style="width:80px">
        <label>Notes</label><input id="resNotes" placeholder="optional" style="flex:1;min-width:220px">
      </div>
    </div>

    <!-- FORM TAB -->
    <div id="resFormPane">
      <div class="m-card" style="margin:8px 0">
        <strong>Home Line (select players & stats)</strong>
        <div id="resHomeTable" style="margin-top:6px;overflow:auto"></div>
      </div>
      <div class="m-card" style="margin:8px 0">
        <strong>Away Line (select players & stats)</strong>
        <div id="resAwayTable" style="margin-top:6px;overflow:auto"></div>
      </div>
      <small class="muted">Tip: Only rows with any value (goals/assists/rating/pos) will be submitted.</small>
    </div>

    <!-- JSON TAB -->
    <div id="resJsonPane" style="display:none">
      <div class="m-card" style="margin:8px 0">
        <strong>Paste JSON</strong>
        <div class="muted">Format: { "details": { "home":[{playerId?,player?,goals,assists,rating}], "away":[...] } }</div>
        <textarea id="resJson" rows="12" style="width:100%;margin-top:6px" placeholder='{"details":{"home":[{"player":"Nick","goals":2,"assists":1,"rating":8.5}],"away":[]}}'></textarea>
      </div>
    </div>

    <div class="actions">
      <button id="resCancel">Cancel</button>
      <button id="resQuickText" title="Admin quick paste text (score & lines)">Quick Paste</button>
      <button id="resSubmit">Submit Result</button>
    </div>
  </div>
</div>

<script>
// =======================
//   CONFIG / CONSTANTS
// =======================
const API_BASE = '';
const CC_ID = 'UPCL_CC_2025_08'; // season cup id

const TEAM_TITLES = {
  '3638105': [
    { count: 1, name: 'United Pro Clubs League Title' },
    { count: 1, name: 'Leagues Cup' }
  ]
};

// Teams (added FC Dhizz)
const teams = [
  { id: '2491998', name: 'Royal Republic',   logo: '/assets/logos/royal-republic-logo.png' },
  { id: '1527486', name: 'Gungan FC',         logo: '/assets/logos/gungan-fc.png' },
  { id: '1969494', name: 'Club Frijol',       logo: '/assets/logos/club-frijol.png' },
  { id: '2086022', name: 'Brehemen',          logo: '/assets/logos/brehemen.png' },
  { id: '2462194', name: 'Costa Chica FC',    logo: '/assets/logos/costa-chica-fc.png' },
  { id: '5098824', name: 'Sporting de la ma', logo: '/assets/logos/sporting-de-la-ma.png' },
  { id: '4869810', name: 'Afc Tekki',         logo: '/assets/logos/afc-tekki.png' },
  { id: '576007',  name: 'Ethabella FC',      logo: '/assets/logos/ethabella-fc.png' },
  { id: '4933507', name: 'Loss Toyz',         logo: '/assets/logos/loss-toyz.png' },
  { id: '4824736', name: 'GoldenGoals FC',    logo: '/assets/logos/goldengoals-fc.png' },
  { id: '481847',  name: 'Rooney tunes',      logo: '/assets/logos/rooney-tunes.png' },
  { id: '3050467', name: 'invincible afc',    logo: '/assets/logos/invincible-afc.png' },
  { id: '4154835', name: 'khalch Fc',         logo: '/assets/logos/khalch-fc.png' },
  { id: '3638105', name: 'Real mvc',          logo: '/assets/logos/real-mvc.png' },
  { id: '55408',   name: 'Elite VT',          logo: '/assets/logos/elite-vt.png' },
  { id: '4819681', name: 'EVERYTHING DEAD',   logo: '/assets/logos/everything-dead.png' },
  { id: '35642',   name: 'EBK FC',            logo: '/assets/logos/ebk-fc.png' },
  // Manual clubs
  { id: 'afc-warriors',  name: 'AFC Warriors',  logo: '/assets/logos/afc-warriors.png' },
  { id: 'jids-trivela',  name: 'Jids Trivela',  logo: '/assets/logos/jids-trivela.png' },
  { id: 'razorblack-fc', name: 'Razorblack FC', logo: '/assets/logos/razorblack-fc.png' },
  { id: 'fc-dhizz',      name: 'FC Dhizz',      logo: '/assets/logos/fc-dhizz.png' }
];

const byId = id => teams.find(t=>String(t.id)===String(id));
function teamLogoUrl(team){ return team.logo || `https://via.placeholder.com/800x400.png?text=${encodeURIComponent(team.name)}`; }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
function fmtMoney(n){ return '‚Çµ' + Number(n||0).toLocaleString(); }
function fmtDate(ms){ try{ return new Date(ms).toLocaleString(); } catch{ return ''; } }
function getFixtureBanner(){ return '/assets/ui/fixture-banner.png'; } // your banner

// =======================
//   STATE
// =======================
let isAdmin=false, meUser=null, isMgr=false;
let rankings={}, payouts={ elite:0, mid:0, bottom:0 };
let fixturesPublicCache=[], fixturesSchedCache=[];
let newsItems=[], newsPage=0, newsLoading=false;
const NEWS_PAGE=8;

// =======================
//   API HELPERS
// =======================
async function apiGet(p){ const r = await fetch(API_BASE+p,{credentials:'include'}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
async function apiPost(p, body){ const r = await fetch(API_BASE+p,{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(body||{})}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
async function apiPut(p, body){ const r = await fetch(API_BASE+p,{method:'PUT',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(body||{})}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }

// =======================
//   NAV
// =======================
const navTeams    = document.getElementById('navTeams');
const navMarket   = document.getElementById('navMarket');
const navFxPublic = document.getElementById('navFixturesPublic');
const navFxSched  = document.getElementById('navFixturesSched');
const navChampions= document.getElementById('navChampions');
const navNews     = document.getElementById('navNews');
const navRankings = document.getElementById('navRankings');

const teamsViewEl = document.getElementById('teams-view');
const marketView  = document.getElementById('market-view');
const fxPublic    = document.getElementById('fixtures-public');
const fxSched     = document.getElementById('fixtures-sched');
const cupView     = document.getElementById('champions-view');
const newsView    = document.getElementById('news-view');
const rankingsView= document.getElementById('rankings-view');

function setNav(active){
  if (active==='rankings' && !isAdmin) { alert('Admin only'); active='teams'; }
  if (active==='fixturesSched' && !(isMgr || isAdmin)) { alert('Managers only'); active='fixturesPublic'; }
  const map = {
    teams:[teamsViewEl, navTeams],
    market:[marketView, navMarket],
    fixturesPublic:[fxPublic, navFxPublic],
    fixturesSched:[fxSched, navFxSched],
    champions:[cupView, navChampions],
    news:[newsView, navNews],
    rankings:[rankingsView, navRankings]
  };
  for (const key of Object.keys(map)){
    const [view,btn] = map[key];
    const is = key===active;
    view.style.display = is ? 'block' : 'none';
    btn.setAttribute('aria-pressed', String(is));
  }
}
navTeams.onclick     = ()=> setNav('teams');
navMarket.onclick    = ()=> setNav('market');
navFxPublic.onclick  = ()=> setNav('fixturesPublic');
navFxSched.onclick   = ()=> setNav('fixturesSched');
navChampions.onclick = async ()=>{ setNav('champions'); await loadChampions(); };
navNews.onclick      = async ()=>{ setNav('news'); await loadNews(); };
navRankings.onclick  = ()=> setNav('rankings');

// auth / admin / manager
const btnAdminLogin = document.getElementById('btnAdminLogin');
const btnAdminLogout= document.getElementById('btnAdminLogout');
const btnManagerLogin= document.getElementById('btnManagerLogin');

btnAdminLogin.onclick = async ()=>{
  const pw = prompt('Admin password'); if (!pw) return;
  try{ await apiPost('/api/admin/login',{ password: pw }); await checkAdmin(); await checkMe(); alert('Admin signed in'); }
  catch(e){ alert('Login failed: '+e.message); }
};
btnAdminLogout.onclick = async ()=>{ try{ await apiPost('/api/admin/logout',{}); }catch{}; await checkAdmin(); await checkMe(); alert('Signed out'); };

async function checkAdmin(){
  try{ const d = await apiGet('/api/admin/me'); isAdmin = !!d.admin; }catch{ isAdmin=false; }
  navRankings.style.display = isAdmin ? 'inline-block' : 'none';
  btnAdminLogout.style.display = isAdmin ? 'inline-block' : 'none';
  navFxSched.style.display = (isMgr || isAdmin) ? 'inline-block' : 'none';
  if (isAdmin) { await loadRankings(); renderRankings(); }
}
async function checkMe(){
  try { meUser = (await apiGet('/api/auth/me')).user || null; } catch { meUser = null; }
  isMgr = !!(meUser && meUser.role==='Manager');
  navFxSched.style.display = (isMgr || isAdmin) ? 'inline-block' : 'none';
}

// Manager Sign-In modal
const mgrModal = document.getElementById('mgrModal');
const mgrClubSel = document.getElementById('mgrClubSel');
const mgrName = document.getElementById('mgrName');
const mgrCode = document.getElementById('mgrCode');
const mgrCancel = document.getElementById('mgrCancel');
const mgrSubmit = document.getElementById('mgrSubmit');

btnManagerLogin.onclick = ()=>{
  mgrClubSel.innerHTML = teams.map(t=>`<option value="${t.id}">${escapeHtml(t.name)} (${t.id})</option>`).join('');
  mgrName.value = ''; mgrCode.value = '';
  mgrModal.classList.add('show'); mgrModal.setAttribute('aria-hidden','false');
};
mgrCancel.onclick = ()=>{ mgrModal.classList.remove('show'); mgrModal.setAttribute('aria-hidden','true'); };
mgrSubmit.onclick = async ()=>{
  const clubId = mgrClubSel.value, name=(mgrName.value||'').trim(), code=(mgrCode.value||'').trim();
  if (!clubId || !name || !code) return alert('Pick a club, enter your name and code.');
  try{
    await apiPost(`/api/clubs/${encodeURIComponent(clubId)}/claim-manager`, { name, code });
    await checkMe(); await refreshFixturesSched(); renderFixturesSched();
    mgrModal.classList.remove('show'); mgrModal.setAttribute('aria-hidden','true');
    alert('Manager session started.');
  }catch(e){ alert('Sign-in failed: '+e.message); }
};

// =======================
//   TEAMS LIST / DETAIL
// =======================
const teamsGrid = document.getElementById('teamsGrid');
const teamsCount = document.getElementById('teams-count');
const detailView = document.getElementById('detail-view');
const detailTitle = document.getElementById('detail-title');
const detailSub   = document.getElementById('detail-sub');
const detailTrophies = document.getElementById('detail-trophies');
const squadContainer = document.getElementById('squadContainer');
const backBtn = document.getElementById('backBtn');

function renderTeams(){
  teamsGrid.innerHTML=''; teamsCount.textContent = teams.length;
  teams.forEach(team=>{
    const card = document.createElement('div');
    card.className='team-card'; card.setAttribute('role','listitem');
    card.innerHTML = `
      <img class="team-logo"
           src="${teamLogoUrl(team)}"
           onerror="this.onerror=null;this.src='https://via.placeholder.com/800x400.png?text=${encodeURIComponent(team.name)}';"
           alt="${escapeHtml(team.name)} logo" />
      <div class="team-meta">
        <div class="name"><img class="small-logo" src="${teamLogoUrl(team)}" alt="">${escapeHtml(team.name)}</div>
        <div class="trophy-badge">${Array.isArray(TEAM_TITLES[team.id]) ? TEAM_TITLES[team.id].map(t=>`${t.count}x ${t.name}`).join(', ') : ''}</div>
      </div>`;
    card.addEventListener('click', ()=> showTeam(team));
    teamsGrid.appendChild(card);
  });
}

async function showTeam(team){
  window.scrollTo({top:0,behavior:'smooth'});
  teamsViewEl.style.display='none'; detailView.style.display='block';
  detailTitle.textContent = team.name; detailSub.textContent = 'Loading club info‚Ä¶';

  if(Array.isArray(TEAM_TITLES[team.id])){
    detailTrophies.innerHTML = TEAM_TITLES[team.id].map(t=>`<div>${t.count}x ${t.name}</div>`).join('');
  } else detailTrophies.textContent = 'No trophies';

  await renderWallet(team.id);
  await refreshFixturesPublic(); renderNextFor(team.id); renderTeamResults(team.id);
  renderManualPlayers(team); // EA disabled
  await loadSquad(team.id);
  detailSub.textContent = 'Club overview';
}
backBtn.addEventListener('click', ()=>{ detailView.style.display='none'; teamsViewEl.style.display='block'; window.scrollTo({top:0,behavior:'smooth'}); });

// Wallet
async function renderWallet(clubId){
  const body = document.getElementById('walletBody');
  const hint = document.getElementById('walletHint');
  const btn = document.getElementById('btnCollect');
  try{
    const d = await apiGet(`/api/wallets/${encodeURIComponent(clubId)}`);
    const w = d.wallet||{}, prev = d.preview||{}; const per = d.perDay||0;
    body.innerHTML = `Balance: <strong>${fmtMoney(w.balance||0)}</strong><br>Tier payout: <strong>${fmtMoney(per)}</strong> / day<br>Pending payout: <strong>${fmtMoney(prev.amount||0)}</strong> (${prev.days||0} days)`;
    const canCollect = meUser && meUser.role==='Manager' && String(meUser.teamId)===String(clubId);
    btn.style.display = canCollect ? 'inline-block' : 'none';
    btn.onclick = async ()=>{ try{
      const r = await apiPost(`/api/wallets/${encodeURIComponent(clubId)}/collect`,{});
      alert(r.ok ? `Collected ${fmtMoney(r.collected||0)}` : (r.message||'No payout'));
      await renderWallet(clubId);
    }catch(e){ alert('Collect failed: '+e.message); } };
    hint.textContent = canCollect ? 'Only the club manager can collect.' : 'Sign in as manager to collect.';
  }catch(e){ body.textContent = 'Wallet unavailable'; hint.textContent = ''; btn.style.display='none'; }
}

// Players (manual only)
function renderManualPlayers(team){
  squadContainer.innerHTML = `<div class="m-card muted">Manual club ‚Äî managers can maintain squads below.</div>`;
}

// Squad editor (manual)
async function loadSquad(clubId){
  const panel = document.getElementById('squadPanel');
  const body  = document.getElementById('squadBody');
  const tools = document.getElementById('squadTools');
  panel.style.display = 'block'; body.textContent = 'Loading‚Ä¶'; tools.style.display = (isAdmin ? 'flex' : 'none');

  try{
    const res = await fetch(`/api/clubs/${encodeURIComponent(clubId)}/squad`, {credentials:'include'});
    if (!res.ok){ body.textContent = 'Squad not available.'; return; }
    const { slots=[] } = await res.json();
    const canEdit = meUser && meUser.role==='Manager' && String(meUser.teamId)===String(clubId);
    if (!slots.length){
      body.innerHTML = '<div class="muted">No slots yet.</div>';
      if (isAdmin){
        tools.style.display = 'flex';
        document.getElementById('btnBootstrapSlots').onclick = async ()=>{ try{
          await apiPost(`/api/clubs/${encodeURIComponent(clubId)}/squad/bootstrap`, { size: 15 });
          await loadSquad(clubId);
        }catch(e){ alert('Bootstrap failed: '+e.message); } };
      }
      return;
    }
    tools.style.display = (isAdmin ? 'flex' : 'none');
    body.innerHTML = slots.map(s=>{
      const name = s.player?.eaName || '';
      const pid  = s.playerId || '';
      return `
        <div class="m-card" style="margin:6px 0">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
            <div><strong>${escapeHtml(s.label)}</strong> ${pid ? `<span class="chip">ID: ${pid}</span>` : ''}</div>
          </div>
          <div class="muted" style="margin-top:4px">Nickname / Last name</div>
          <div style="display:flex;gap:6px;align-items:center;margin-top:4px;flex-wrap:wrap">
            <input type="text" data-slot="${s.slotId}" value="${escapeHtml(name)}" ${canEdit?'':'disabled'}>
            ${canEdit ? `
              <button data-assign="${s.slotId}">${pid ? 'Update' : 'Assign'}</button>
              ${pid ? `<button data-unassign="${s.slotId}">Unassign</button>`:''}
            `:''}
          </div>
        </div>`;
    }).join('');

    if (canEdit){
      body.querySelectorAll('[data-assign]').forEach(btn=>{
        btn.onclick = async ()=>{
          const slotId = btn.getAttribute('data-assign');
          const input  = body.querySelector(`input[data-slot="${slotId}"]`);
          const displayName = (input?.value||'').trim();
          if (!displayName) return alert('Enter a nickname/last name');
          try{
            await apiPost(`/api/clubs/${encodeURIComponent(clubId)}/squad/slots/${encodeURIComponent(slotId)}/assign`, {
              eaName: displayName, platform:'manual', aliases:[displayName]
            });
            await loadSquad(clubId);
          }catch(e){ alert('Assign failed: '+e.message); }
        };
      });
      body.querySelectorAll('[data-unassign]').forEach(btn=>{
        btn.onclick = async ()=>{
          const slotId = btn.getAttribute('data-unassign');
          try{
            await apiPost(`/api/clubs/${encodeURIComponent(clubId)}/squad/slots/${encodeURIComponent(slotId)}/unassign`, {});
            await loadSquad(clubId);
          }catch(e){ alert('Unassign failed: '+e.message); }
        };
      });
    }
  }catch(e){ body.textContent = 'Failed to load squad.'; }
}

// =======================
//   FREE AGENTS
// =======================
async function loadFA(){
  try{
    const d = await apiGet('/api/free-agents');
    const arr = d.agents || [];
    document.getElementById('faList').innerHTML = arr.length ? arr.map(a=>{
      const pos = (a.positions||[]).join(', ');
      return `<div class="m-card" style="margin:8px 0;padding:8px">
        <strong>${escapeHtml(a.name)}</strong> <span class="muted">(${escapeHtml(a.region||'')})</span><br>
        <span class="muted">${escapeHtml(pos)}</span>
        ${a.discord ? `<div>Discord: ${escapeHtml(a.discord)}</div>`:''}
        ${a.bio ? `<div class="muted">${escapeHtml(a.bio)}</div>`:''}
      </div>`;
    }).join('') : 'No free agents listed.';
  }catch{ document.getElementById('faList').textContent = 'Failed to load.'; }
}
document.getElementById('btnListFA').onclick = async ()=>{
  const name = meUser?.name || prompt('Your display name'); if (!name) return;
  const positions = prompt('Positions (comma separated, e.g., ST, CAM, CB)')||'';
  const region = prompt('Region/Timezone (e.g., EST, EU)')||'';
  const foot = prompt('Strong foot (L/R)')||'';
  const availability = prompt('Availability (e.g., Mon-Thu 7-10pm)')||'';
  const discord = prompt('Discord tag (optional)')||'';
  const bio = prompt('Short bio (optional)')||'';
  try{ await apiPost('/api/free-agents/me',{ name, positions, region, foot, availability, discord, bio }); alert('Listed!'); await loadFA(); }
  catch(e){ alert('List failed: '+e.message); }
};
document.getElementById('btnUnlistFA').onclick = async ()=>{ try{ await fetch('/api/free-agents/me',{ method:'DELETE', credentials:'include' }); alert('Unlisted'); await loadFA(); } catch(e){ alert('Unlist failed: '+e.message); } };

// =======================
//   FIXTURES ‚Äî PUBLIC
// =======================
const fixturesPublicList = document.getElementById('fixturesPublicList');
async function refreshFixturesPublic(){
  try{ const d = await apiGet('/api/cup/fixtures?cup=UPCL'); fixturesPublicCache = d.fixtures || []; }
  catch{ try{ const d2 = await apiGet('/api/cup/fixtures/public?cup=UPCL'); fixturesPublicCache = d2.fixtures || []; } catch { fixturesPublicCache = []; } }
}
function renderFixturesPublic(){
  const list = fixturesPublicCache.slice().sort((a,b)=>(a.when||a.createdAt)-(b.when||b.createdAt));
  fixturesPublicList.innerHTML = list.length ? list.map(f=>{
    const banner = getFixtureBanner();
    const hn = byId(f.home)?.name || f.home, an = byId(f.away)?.name || f.away;
    const whenTxt = f.when ? fmtDate(f.when) : 'TBD';
    const scoreTxt = (f.status==='final') ? `${f.score.hs}‚Äì${f.score.as}` : 'vs';
    const ccBadge = (f.cup===CC_ID) ? ' ‚Ä¢ <span class="chip">Champions Cup</span>' : '';
    const homeSc = (f.details?.home||[]).map(p=>`<li>${escapeHtml(p.player||p.playerId||'')}${p.goals?` (${p.goals})`:''}${p.rating?` ‚Äî ${Number(p.rating).toFixed(1)}`:''}</li>`).join('');
    const awaySc = (f.details?.away||[]).map(p=>`<li>${escapeHtml(p.player||p.playerId||'')}${p.goals?` (${p.goals})`:''}${p.rating?` ‚Äî ${Number(p.rating).toFixed(1)}`:''}</li>`).join('');
    return `
      <div class="fx">
        <div>
          ${banner ? `<img class="fx-banner" src="${banner}" alt="">` : ''}
          <div class="vs"><strong>${escapeHtml(hn)}</strong> <span class="muted">${scoreTxt}</span> <strong>${escapeHtml(an)}</strong></div>
          <div class="meta">${escapeHtml(f.round||'')}${ccBadge} ‚Ä¢ ${escapeHtml(whenTxt)} ‚Ä¢ ${escapeHtml(f.status||'')}</div>
          ${(f.status==='final' && (homeSc||awaySc)) ? `
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:6px">
              <div><em>${escapeHtml(hn)} scorers</em><ul>${homeSc||'<li class="muted">‚Äî</li>'}</ul></div>
              <div><em>${escapeHtml(an)} scorers</em><ul>${awaySc||'<li class="muted">‚Äî</li>'}</ul></div>
            </div>` : ''
          }
        </div>
      </div>`;
  }).join('') : `<div class="muted">No fixtures yet.</div>`;
}

// =======================
//   FIXTURES ‚Äî SCHEDULING
// =======================
const fixturesList = document.getElementById('fixturesList');
const btnCreateFx  = document.getElementById('btnCreateFx');

btnCreateFx.onclick = async ()=>{
  const home = prompt('Home club ID (exact from Teams list)');
  const away = prompt('Away club ID');
  const round= prompt('Round (e.g., League MD1 or Cup QF)');
  if (!home || !away) return;
  try{ await apiPost('/api/cup/fixtures', { home, away, round, cup:'UPCL' }); alert('Created fixture'); await refreshFixturesSched(); renderFixturesSched(); }
  catch(e){ alert('Create failed: '+e.message); }
};

document.querySelectorAll('[data-fxf]').forEach(btn=>{
  btn.onclick = ()=>{ document.querySelectorAll('[data-fxf]').forEach(b=>b.setAttribute('aria-pressed','false')); btn.setAttribute('aria-pressed','true'); renderFixturesSched(); };
});

async function refreshFixturesSched(){
  if (!(isMgr || isAdmin)) { fixturesSchedCache=[]; return; }
  try{ const d = await apiGet('/api/cup/fixtures/scheduling?cup=UPCL'); fixturesSchedCache = d.fixtures || []; }
  catch{ try{ const d2 = await apiGet('/api/cup/fixtures?cup=UPCL'); fixturesSchedCache = d2.fixtures || []; } catch { fixturesSchedCache = []; } }
}
function filterKey(){ const active = [...document.querySelectorAll('[data-fxf]')].find(b=>b.getAttribute('aria-pressed')==='true'); return active ? active.getAttribute('data-fxf') : 'upcoming'; }
function renderFixturesSched(){
  const key = filterKey(); let list = fixturesSchedCache.slice(); const now = Date.now();
  if (key==='upcoming') list = list.filter(f => f.status!=='final' && (!f.when || f.when>=now));
  else if (key==='final') list = list.filter(f => f.status==='final');
  else if (key==='mine' && meUser) list = list.filter(f => f.home===meUser.teamId || f.away===meUser.teamId);
  list.sort((a,b)=>(a.when||a.createdAt)-(b.when||b.createdAt));
  fixturesList.innerHTML = list.length ? list.map(renderFxSchedRow).join('') : `<div class="muted">No fixtures.</div>`;
  list.forEach(wireFxRowHandlers);
}
function renderFxSchedRow(f){
  const hn = byId(f.home)?.name || f.home, an = byId(f.away)?.name || f.away;
  const whenTxt = f.when ? fmtDate(f.when) : 'TBD';
  const props = (f.proposals||[]).map(p=>{
    const who = (teams.find(t=>String(t.id)===String(p.by))?.name) || p.by || 'unknown';
    return `<option value="${p.at}">${fmtDate(p.at)} ‚Äî proposed by ${escapeHtml(who)}</option>`;
  }).join('');
  const status = f.status || 'pending';
  const ccBadge = (f.cup===CC_ID) ? `<span class="chip">Champions Cup${f.group?` ‚Ä¢ Group ${f.group}`:''}</span>` : '';
  const adminBtns = isAdmin ? `<button class="json">JSON</button>` : '';
  const banner = getFixtureBanner();
  return `
  <div class="fx" id="fx_${f.id}">
    <div>
      ${banner ? `<img class="fx-banner" src="${banner}" alt="">` : ''}
      <div class="vs">${escapeHtml(hn)} <span class="muted">vs</span> ${escapeHtml(an)}</div>
      <div class="meta">Round: ${escapeHtml(f.round||'')}${ccBadge?` ‚Ä¢ ${ccBadge}`:''} ‚Ä¢ When: ${escapeHtml(whenTxt)} ‚Ä¢ Status: <span class="chip">${escapeHtml(status)}</span></div>
    </div>
    <div class="center">
      ${(f.proposals||[]).length ? `<label>Proposals</label><br><select name="slot">${props}</select>` : `<span class="muted">No proposals</span>`}
    </div>
    <div class="act">
      <button class="prop">Propose</button>
      <button class="agree">Agree</button>
      <button class="decl">Decline</button>
      <button class="line">Lineup</button>
      <button class="rep">Enter Result</button>
      ${adminBtns}
    </div>
  </div>`;
}
function wireFxRowHandlers(f){
  const root = document.getElementById('fx_'+f.id); if (!root) return;
  const isManagerOf = meUser && meUser.role==='Manager' && [f.home,f.away].includes(meUser.teamId);

  const btnProp = root.querySelector('.act .prop');
  if (btnProp) btnProp.onclick = async ()=>{
    if (!isManagerOf && !isAdmin) return alert('Managers only');
    const atStr = prompt('Propose time (YYYY-MM-DD HH:mm)'); if (!atStr) return;
    const at = Date.parse(atStr); if (!at) return alert('Could not parse date');
    try{ await apiPost(`/api/cup/fixtures/${f.id}/propose`, { at }); await refreshFixturesSched(); renderFixturesSched(); }
    catch(e){ alert('Propose failed: '+e.message); }
  };

  const btnAgree = root.querySelector('.act .agree');
  if (btnAgree) btnAgree.onclick = async ()=>{
    if (!isManagerOf && !isAdmin) return alert('Managers only');
    const at = root.querySelector('select[name="slot"]')?.value; if (!at) return alert('Pick a proposed slot');
    try{
      await apiPost(`/api/cup/fixtures/${f.id}/vote`, { at, agree:true });
      await refreshFixturesSched(); renderFixturesSched();
      await refreshFixturesPublic(); renderFixturesPublic();
    }catch(e){ alert('Vote failed: '+e.message); }
  };

  const btnDecl = root.querySelector('.act .decl');
  if (btnDecl) btnDecl.onclick = async ()=>{
    if (!isManagerOf && !isAdmin) return alert('Managers only');
    const at = root.querySelector('select[name="slot"]')?.value; if (!at) return alert('Pick a proposed slot');
    try{ await apiPost(`/api/cup/fixtures/${f.id}/vote`, { at, agree:false }); await refreshFixturesSched(); renderFixturesSched(); }
    catch(e){ alert('Vote failed: '+e.message); }
  };

  const btnLine = root.querySelector('.act .line');
  if (btnLine) btnLine.onclick = async ()=>{
    if (!isManagerOf && !isAdmin) return alert('Managers only');
    const formation = prompt('Formation (e.g., 4-3-3)') || '';
    const starters = prompt('Comma-separated starters (GK,RB,CB,...) or names list') || '';
    const lineup = {}; starters.split(',').map(s=>s.trim()).filter(Boolean).forEach((name,i)=> lineup['P'+(i+1)] = name);
    try{ await apiPut(`/api/cup/fixtures/${f.id}/lineup`, { formation, lineup }); await refreshFixturesSched(); renderFixturesSched(); }
    catch(e){ alert('Lineup failed: '+e.message); }
  };

  const btnReport = root.querySelector('.act .rep');
  if (btnReport) btnReport.onclick = ()=> openResultModal(f);

  const btnJson = root.querySelector('.act .json');
  if (btnJson) btnJson.onclick = async ()=>{
    if (!isAdmin) return alert('Admin only');
    const hs = Number(prompt('Home score (hs)')||0);
    const as = Number(prompt('Away score (as)')||0);
    const template = JSON.stringify({details:{home:[{player:"Player A",goals:1,assists:0,rating:9.5}],away:[{player:"Player B",goals:2,assists:0,rating:8.7}] }}, null, 2);
    const raw = prompt('Paste JSON (or edit template):', template); if (!raw) return;
    try{
      const obj = JSON.parse(raw);
      await apiPost(`/api/cup/fixtures/${f.id}/report`, { hs, as, details: obj.details || obj });
      document.querySelector('[data-fxf="final"]').click();
      await refreshFixturesSched(); renderFixturesSched();
      await refreshFixturesPublic(); renderFixturesPublic();
    }catch(e){ alert('JSON upload failed: '+e.message); }
  };
}

// =======================
//   NEXT & RECENT (team)
// =======================
function nextFor(teamId){
  const now = Date.now();
  return fixturesPublicCache.filter(f => (f.home===teamId||f.away===teamId) && f.status!=='final' && f.when && f.when>=now).sort((a,b)=>a.when-b.when)[0];
}
function finalsFor(teamId, n=5){
  return fixturesPublicCache.filter(f => f.status==='final' && (f.home===teamId||f.away===teamId)).sort((a,b)=>(b.when||b.createdAt)-(a.when||a.createdAt)).slice(0,n);
}
function renderNextFor(teamId){
  const el = document.getElementById('nextMatchBody');
  const f = nextFor(teamId);
  if (!f){ el.textContent='No scheduled match yet.'; return; }
  const hn = byId(f.home)?.name || f.home, an = byId(f.away)?.name || f.away;
  el.innerHTML = `<div><strong>${escapeHtml(hn)}</strong> vs <strong>${escapeHtml(an)}</strong></div><div class="muted">${fmtDate(f.when)}</div>`;
}
function renderTeamResults(teamId){
  const el = document.getElementById('teamResultsBody');
  const list = finalsFor(teamId);
  el.innerHTML = list.length ? list.map(f=>{
    const hn = byId(f.home)?.name || f.home, an = byId(f.away)?.name || f.away;
    return `<div>FT ${f.score.hs}-${f.score.as}: <strong>${escapeHtml(hn)}</strong> vs <strong>${escapeHtml(an)}</strong> ‚Ä¢ ${fmtDate(f.when||f.createdAt)}</div>`;
  }).join('') : 'No finals yet.';
}

// =======================
//   RANKINGS (trimmed)
// =======================
async function loadRankings(){ try{ const d = await apiGet('/api/rankings'); rankings = d.rankings || {}; payouts = d.payouts || payouts; }catch(e){ rankings={}; } }
function perDayFor(clubId){ const r = rankings[clubId] || { tier:'mid' }; const t = r.tier || 'mid'; return payouts[t] || 0; }
function renderRankings(){
  const rows = teams.map(t=>{
    const r = rankings[t.id] || { leaguePos:'', cup:'none', points:0, tier:'mid' };
    const cupOpts = ['none','round_of_16','quarterfinal','semifinal','runner_up','winner'].map(v=>`<option value="${v}" ${r.cup===v?'selected':''}>${v.replace(/_/g,' ')}</option>`).join('');
    return `<tr>
      <td>${escapeHtml(t.name)}</td>
      <td><input type="number" min="0" style="width:80px" value="${r.leaguePos||''}" data-k="leaguePos" data-id="${t.id}"></td>
      <td><select data-k="cup" data-id="${t.id}">${cupOpts}</select></td>
      <td>${escapeHtml(r.tier||'mid')}</td>
      <td>${fmtMoney(perDayFor(t.id))}</td>
    </tr>`;
  }).join('');
  document.getElementById('rankingsTable').innerHTML = `
    <table style="width:100%;border-collapse:collapse">
      <thead><tr><th style="text-align:left">Club</th><th>League pos</th><th>Cup</th><th>Tier</th><th>Payout/day</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
  const adminControls = document.getElementById('adminControls'); adminControls.style.display = isAdmin ? 'flex' : 'none';
  document.getElementById('btnSaveRankings').onclick = async ()=>{
    const payload = { rankings: {} };
    document.querySelectorAll('#rankingsTable [data-id]').forEach(el=>{
      const id = el.getAttribute('data-id'); const k  = el.getAttribute('data-k');
      payload.rankings[id] = payload.rankings[id] || {}; payload.rankings[id][k] = k==='leaguePos' ? Number(el.value||0) : el.value;
    });
    try{ await apiPost('/api/rankings/bulk', payload); alert('Saved'); await loadRankings(); renderRankings(); } catch(e){ alert('Save failed: '+e.message); }
  };
  document.getElementById('btnRecalc').onclick = async ()=>{ try{ await apiPost('/api/rankings/recalc',{}); await loadRankings(); renderRankings(); alert('Recalculated'); } catch(e){ alert('Recalc failed: '+e.message); } };
}

// =======================
//   CHAMPIONS CUP
// =======================
async function loadChampions(){
  document.getElementById('ccCupId').textContent = CC_ID;
  let cupData = { cup:{ groups:{A:[],B:[],C:[],D:[]} }, tables:{} };
  try { cupData = await apiGet(`/api/champions/${encodeURIComponent(CC_ID)}`); } catch(e) { console.warn('Champions fetch failed:', e.message); }
  renderCcGroups(cupData.cup.groups, cupData.tables);

  let ccList = [];
  try { const fx = await apiGet(`/api/cup/fixtures?cup=${encodeURIComponent(CC_ID)}`); ccList = fx.fixtures || []; renderCcFixtures(ccList); }
  catch { renderCcFixtures([]); }

  try{ const ld = await apiGet(`/api/champions/${encodeURIComponent(CC_ID)}/leaders`); renderCcLeaders(ld); }
  catch{ const ld = computeLeadersFromFixtures(ccList); renderCcLeaders(ld); }

  document.getElementById('ccAdmin').style.display = isAdmin ? 'block' : 'none';
  if (isAdmin) buildManualGroupsEditor(cupData.cup.groups);
}
function renderCcGroups(groups, tables){
  const el = document.getElementById('ccGroups');
  el.innerHTML = ['A','B','C','D'].map(g=>{
    const list = (groups[g]||[]).map(id=> `<li>${escapeHtml(byId(id)?.name||id)}</li>`).join('');
    const tbl = (tables?.[g]||[]).map(r=>`<tr><td>${escapeHtml(byId(r.clubId)?.name||r.clubId)}</td><td>${r.P}</td><td>${r.W}</td><td>${r.D}</td><td>${r.L}</td><td>${r.GF}-${r.GA}</td><td>${r.Pts}</td></tr>`).join('');
    return `<div class="m-card"><strong>Group ${g}</strong>
      <div style="display:grid;grid-template-columns:1fr;gap:6px;margin-top:6px">
        <div><em>Teams</em><ul style="margin:6px 0 0 18px">${list||'<li class="muted">‚Äî</li>'}</ul></div>
        <div style="overflow:auto">
          <em>Table</em>
          <table style="width:100%;border-collapse:collapse;margin-top:6px">
            <thead><tr><th style="text-align:left">Club</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GF-GA</th><th>Pts</th></tr></thead>
            <tbody>${tbl||''}</tbody>
          </table>
        </div>
      </div>
    </div>`;
  }).join('');
}
function renderCcFixtures(list){
  const el = document.getElementById('ccFixtures');
  list.sort((a,b)=>(a.when||a.createdAt)-(b.when||b.createdAt));
  el.innerHTML = list.length ? list.map(f=>{
    const hn = byId(f.home)?.name || f.home, an = byId(f.away)?.name || f.away;
    const whenTxt = f.when ? fmtDate(f.when) : 'TBD';
    const scoreTxt = (f.status==='final') ? `${f.score.hs}‚Äì${f.score.as}` : 'vs';
    const badge = `<span class="chip">Champions Cup${f.group?` ‚Ä¢ Group ${f.group}`:''}${f.round?` ‚Ä¢ ${escapeHtml(f.round)}`:''}</span>`;
    const banner = getFixtureBanner();
    const canAct = isAdmin || (meUser && meUser.role==='Manager' && [f.home,f.away].includes(meUser.teamId));
    return `<div class="fx" id="ccfx_${f.id}">
      <div>
        ${banner ? `<img class="fx-banner" src="${banner}" alt="">` : ''}
        <div class="vs"><strong>${escapeHtml(hn)}</strong> <span class="muted">${scoreTxt}</span> <strong>${escapeHtml(an)}</strong></div>
        <div class="meta">${badge} ‚Ä¢ ${whenTxt} ‚Ä¢ ${escapeHtml(f.status||'')}</div>
      </div>
      <div></div>
      <div class="act">
        ${canAct ? `<button class="rep">Enter Result</button>${isAdmin?`<button class="json">JSON</button>`:''}` : ''}
      </div>
    </div>`;
  }).join('') : `<div class="muted">No Champions Cup fixtures yet.</div>`;

  // wire actions
  list.forEach(f=>{
    const root = document.getElementById('ccfx_'+f.id); if (!root) return;
    const btnRep = root.querySelector('.rep'); if (btnRep) btnRep.onclick = ()=> openResultModal(f);
    const btnJson= root.querySelector('.json'); if (btnJson) btnJson.onclick = async ()=>{
      if (!isAdmin) return alert('Admin only');
      const hs = Number(prompt('Home score (hs)')||0), as = Number(prompt('Away score (as)')||0);
      const template = JSON.stringify({details:{home:[{player:"Player A",goals:1,assists:0,rating:9.5}],away:[{player:"Player B",goals:2,assists:0,rating:8.7}] }}, null, 2);
      const raw = prompt('Paste JSON (or edit the template):', template); if (!raw) return;
      try{
        const obj = JSON.parse(raw);
        await apiPost(`/api/cup/fixtures/${f.id}/report`, { hs, as, details: obj.details || obj });
        await loadChampions();
        await refreshFixturesPublic(); renderFixturesPublic();
      }catch(e){ alert('JSON upload failed: '+e.message); }
    };
  });
}

// Leaders (client fallback)
function computeLeadersFromFixtures(list){
  const goalMap = new Map(), astMap  = new Map(); const nameOf = (row)=> (row.player && row.player.trim()) || row.playerId || 'Unknown';
  list.filter(f=>f.status==='final').forEach(f=>{ ['home','away'].forEach(side=>{ (f.details?.[side]||[]).forEach(r=>{
    const name = nameOf(r); const g = Number(r.goals||0), a=Number(r.assists||0);
    if (g>0) goalMap.set(name, (goalMap.get(name)||0)+g); if (a>0) astMap.set(name, (astMap.get(name)||0)+a);
  }); }); });
  const toSorted = (m)=> Array.from(m.entries()).map(([name,stat])=>({name,stat})).sort((x,y)=> y.stat-x.stat).slice(0,10);
  return { topScorers: toSorted(goalMap), topAssisters: toSorted(astMap) };
}
function renderCcLeaders(data){
  const el = document.getElementById('ccLeaders');
  const s = data?.scorers || data?.topScorers || [], a = data?.assisters || data?.topAssisters || [];
  el.innerHTML = `
    <div class="leader-card">
      <strong>Top Scorers</strong>
      ${s.length ? `<ol>${s.map(x=>`<li><strong>${escapeHtml(x.name||x.playerId)}</strong> ‚Äî ${x.count||x.stat} goals</li>`).join('')}</ol>`:'<div class="muted">No data yet.</div>'}
    </div>
    <div class="leader-card">
      <strong>Top Assisters</strong>
      ${a.length ? `<ol>${a.map(x=>`<li><strong>${escapeHtml(x.name||x.playerId)}</strong> ‚Äî ${x.count||x.stat} assists</li>`).join('')}</ol>`:'<div class="muted">No data yet.</div>'}
    </div>`;
}
function buildManualGroupsEditor(groups){
  const root = document.getElementById('ccManualGroups');
  const opts = teams.map(t=> `<option value="${t.id}">${escapeHtml(t.name)} (${t.id})</option>`).join('');
  root.innerHTML = ['A','B','C','D'].map(g=>{
    const rows = (groups[g]||[]).map(v=>`<div><select>${opts}</select></div>`).join('');
    return `<div class="m-card"><strong>Group ${g}</strong>
      <div data-g="${g}" class="gbox">${rows||''}</div>
      <div style="margin-top:6px"><button data-add="${g}">+ Add team</button></div>
    </div>`;
  }).join('');
  root.querySelectorAll('[data-add]').forEach(btn=>{
    btn.onclick = ()=>{
      const g = btn.getAttribute('data-add');
      const box = root.querySelector(`.gbox[data-g="${g}"]`);
      const div = document.createElement('div'); div.innerHTML = `<div><select>${opts}</select></div>`;
      box.appendChild(div);
    };
  });

  document.getElementById('ccBtnRandom').onclick = async ()=>{
    const picked = prompt('Pick 12 or 16 club IDs (comma separated) or leave blank to use first 12 on Teams tab', '');
    let ids = [];
    if (picked && picked.trim()){ ids = picked.split(',').map(s=>s.trim()).filter(Boolean); }
    else { ids = teams.map(t=>t.id).slice(0,12); }
    if (![12,16].includes(ids.length)) return alert('Need 12 or 16 clubIds.');
    try{ await apiPost(`/api/champions/${CC_ID}/randomize`, { clubs: ids }); alert('Groups randomized'); await loadChampions(); }
    catch(e){ alert('Randomize failed: '+e.message); }
  };

  document.getElementById('ccBtnSaveGroups').onclick = async ()=>{
    const out = { A:[], B:[], C:[], D:[] };
    root.querySelectorAll('.gbox').forEach(box=>{
      const g = box.getAttribute('data-g');
      box.querySelectorAll('select').forEach(sel=>{ const v = sel.value; if(v) out[g].push(v); });
    });
    const all = [...out.A, ...out.B, ...out.C, ...out.D]; const set = new Set(all);
    if (![12,16].includes(all.length)) return alert('Need 12 or 16 unique clubs total.');
    if (all.length!==set.size) return alert('Duplicate club across groups.');
    try{ await apiPost(`/api/champions/${CC_ID}/groups`, { groups: out }); alert('Groups saved'); await loadChampions(); }
    catch(e){ alert('Save groups failed: '+e.message); }
  };

  document.getElementById('ccBtnCreateFx').onclick = async ()=>{
    const stage = prompt('Stage (e.g., Group A MD1, Semifinal, Final)','Group A MD1')||'';
    const group = (/^group\s+([ABCD])/i.exec(stage)||[])[1]?.toUpperCase() || null;
    const home = prompt('Home clubId'); if(!home) return;
    const away = prompt('Away clubId'); if(!away) return;
    const whenStr = prompt('Date/time (e.g., 2025-08-20 20:30 local) or blank for TBD',''); const when = whenStr ? Date.parse(whenStr) : null;
    try{ await apiPost('/api/cup/fixtures', { home, away, round: stage, cup: CC_ID, group, when }); alert('Fixture created'); await loadChampions(); }
    catch(e){ alert('Create failed: '+e.message); }
  };
}

// =======================
//   NEWS (social feed)
// =======================
const newsList = document.getElementById('newsList');
async function loadNews(){
  try{
    const q = await apiGet('/api/news?limit=200');
    newsItems = Array.isArray(q.items) ? q.items : (q.news || []);
    newsPage = 0; newsList.innerHTML = ''; appendNewsPage();
  }catch(e){ newsList.innerHTML = `<div class="m-card muted">News unavailable.</div>`; }
}
function appendNewsPage(){
  const start = newsPage * NEWS_PAGE;
  const slice = newsItems.slice(start, start + NEWS_PAGE);
  if (!slice.length) return;
  newsList.insertAdjacentHTML('beforeend', slice.map(renderNewsCard).join(''));
  newsPage++;
}
function renderNewsCard(n){
  const club = n.clubId ? byId(n.clubId) : (n.homeId ? byId(n.homeId) : null);
  const cover = n.image || (club && club.logo) || (n.homeId && byId(n.homeId)?.logo) || '';
  const when = n.ts ? new Date(n.ts).toLocaleString() : '';
  return `
    <article class="news-card">
      ${cover ? `<img class="news-cover" src="${cover}" alt="">` : ''}
      <div class="news-body">
        <div class="news-title">${escapeHtml(n.title || 'Update')}</div>
        ${n.text ? `<div class="news-text">${escapeHtml(n.text)}</div>` : ''}
        <div class="news-meta">
          ${when}
          ${n.type ? ` ‚Ä¢ ${escapeHtml(n.type)}` : ''}
          ${n.clubId ? ` ‚Ä¢ ${escapeHtml(byId(n.clubId)?.name || n.clubId)}` : ''}
        </div>
      </div>
    </article>`;
}
window.addEventListener('scroll', ()=>{
  if (newsLoading) return;
  if (newsView.style.display !== 'block') return;
  const nearBottom = (window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 600);
  if (nearBottom){ newsLoading = true; appendNewsPage(); newsLoading = false; }
});

// =======================
//   RESULT ENTRY MODAL
// =======================
const resultModal = document.getElementById('resultModal');
const resCancel = document.getElementById('resCancel');
const resSubmit = document.getElementById('resSubmit');
const resQuickText = document.getElementById('resQuickText');
const resTabFormBtn = document.getElementById('resTabForm');
const resTabJsonBtn = document.getElementById('resTabJson');
const resFormPane = document.getElementById('resFormPane');
const resJsonPane = document.getElementById('resJsonPane');
const resHomeTable = document.getElementById('resHomeTable');
const resAwayTable = document.getElementById('resAwayTable');
const resJson = document.getElementById('resJson');
const resHs = document.getElementById('resHs');
const resAs = document.getElementById('resAs');
const resNotes = document.getElementById('resNotes');
const resFixtureMeta = document.getElementById('resFixtureMeta');
let resFixture = null;

resCancel.onclick = ()=>{ resultModal.classList.remove('show'); resultModal.setAttribute('aria-hidden','true'); resFixture=null; };
resTabFormBtn.onclick = ()=>{ resFormPane.style.display='block'; resJsonPane.style.display='none'; };
resTabJsonBtn.onclick = ()=>{ resFormPane.style.display='none'; resJsonPane.style.display='block'; };

async function openResultModal(f){
  resFixture = f;
  const hn = byId(f.home)?.name || f.home, an = byId(f.away)?.name || f.away;
  resFixtureMeta.textContent = `${hn} vs ${an} ‚Ä¢ ${f.round||''}`;
  resHs.value = f.score?.hs ?? 0; resAs.value = f.score?.as ?? 0; resNotes.value='';
  resJson.value='';

  // load squads for form picker
  const [homeSquad, awaySquad] = await Promise.all([
    fetch(`/api/clubs/${encodeURIComponent(f.home)}/squad`, {credentials:'include'}).then(r=>r.ok?r.json():{slots:[]}).catch(()=>({slots:[]})),
    fetch(`/api/clubs/${encodeURIComponent(f.away)}/squad`, {credentials:'include'}).then(r=>r.ok?r.json():{slots:[]}).catch(()=>({slots:[]}))
  ]);
  buildResultTable(resHomeTable, homeSquad.slots||[]);
  buildResultTable(resAwayTable, awaySquad.slots||[]);

  resultModal.classList.add('show'); resultModal.setAttribute('aria-hidden','false');
}
function buildResultTable(root, slots){
  const rows = slots.map(s=>{
    const name = s.player?.eaName || '';
    const pid  = s.playerId || '';
    return `<tr>
      <td style="white-space:nowrap">${pid?`<span class="chip">${pid.slice(0,8)}</span>`:''} ${escapeHtml(name||s.label)}</td>
      <td><input type="number" min="0" step="1" style="width:64px" data-k="goals" data-id="${pid}" data-name="${escapeHtml(name)}"></td>
      <td><input type="number" min="0" step="1" style="width:64px" data-k="assists" data-id="${pid}" data-name="${escapeHtml(name)}"></td>
      <td><input type="number" min="0" step="0.1" style="width:80px" data-k="rating" data-id="${pid}" data-name="${escapeHtml(name)}" placeholder="7.5"></td>
      <td><input type="text" style="width:96px" data-k="pos" data-id="${pid}" data-name="${escapeHtml(name)}" placeholder="ST/CB/CAM"></td>
    </tr>`;
  }).join('');
  root.innerHTML = `
    <table style="width:100%;border-collapse:collapse">
      <thead><tr><th style="text-align:left">Player</th><th>G</th><th>A</th><th>Rating</th><th>Pos</th></tr></thead>
      <tbody>${rows || `<tr><td class="muted">No squad slots yet</td><td></td><td></td><td></td><td></td></tr>`}</tbody>
    </table>`;
}
resQuickText.onclick = async ()=>{
  if (!isAdmin) return alert('Admin only');
  const text = prompt('Paste quick result (score & player lines)'); if (!text) return;
  try{
    await apiPost(`/api/cup/fixtures/${resFixture.id}/ingest-text`, { text });
    resultModal.classList.remove('show'); resFixture=null;
    await refreshFixturesSched(); renderFixturesSched();
    await refreshFixturesPublic(); renderFixturesPublic();
    await loadChampions();
  }catch(e){ alert('Ingest failed: '+e.message); }
};
resSubmit.onclick = async ()=>{
  if (!resFixture) return;
  const hs = Number(resHs.value||0), as = Number(resAs.value||0), text = String(resNotes.value||'');
  // If JSON tab visible, use it
  if (resJsonPane.style.display!=='none' && resJson.value.trim()){
    try{
      const obj = JSON.parse(resJson.value);
      await apiPost(`/api/cup/fixtures/${resFixture.id}/report`, { hs, as, details: obj.details || obj, text });
    }catch(e){ alert('JSON invalid or submit failed: '+e.message); return; }
  } else {
    // Build from form panes
    const pack = (root)=> {
      const rows = [];
      root.querySelectorAll('tbody tr').forEach(tr=>{
        const g = Number(tr.querySelector('[data-k="goals"]')?.value||0);
        const a = Number(tr.querySelector('[data-k="assists"]')?.value||0);
        const r = Number(tr.querySelector('[data-k="rating"]')?.value||0);
        const pos= String(tr.querySelector('[data-k="pos"]')?.value||'').trim();
        if (g>0 || a>0 || r>0 || pos){
          const inp = tr.querySelector('[data-k="goals"]');
          const playerId = inp?.getAttribute('data-id') || '';
          const player   = inp?.getAttribute('data-name') || '';
          rows.push({ playerId, player, goals:g, assists:a, rating:r, pos });
        }
      });
      return rows;
    };
    const details = { home: pack(resHomeTable), away: pack(resAwayTable) };
    try{ await apiPost(`/api/cup/fixtures/${resFixture.id}/report`, { hs, as, text, details }); }
    catch(e){ alert('Submit failed: '+e.message); return; }
  }
  resultModal.classList.remove('show'); resFixture=null;
  document.querySelectorAll('[data-fxf]').forEach(x=>x.setAttribute('aria-pressed','false'));
  const finalBtn = document.querySelector('[data-fxf="final"]'); if (finalBtn) finalBtn.setAttribute('aria-pressed','true');
  await refreshFixturesSched(); renderFixturesSched();
  await refreshFixturesPublic(); renderFixturesPublic();
  await loadChampions();
};

// =======================
//   INIT
// =======================
async function init(){
  renderTeams();
  await checkAdmin(); await checkMe();

  setNav('teams');
  await refreshFixturesPublic(); renderFixturesPublic();
  if (isMgr || isAdmin){ await refreshFixturesSched(); renderFixturesSched(); }
  await loadFA();

  // hash-open team
  try{
    const m = location.hash.match(/team=([^&]+)/);
    if (m){ const team = byId(decodeURIComponent(m[1])); if (team) setTimeout(()=>showTeam(team), 150); }
  }catch{}
}
init();
</script>
</body>
</html>
