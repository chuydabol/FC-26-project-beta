<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Pro Club — League Hub</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{
  --accent:#8b0000; --accent-rgb:139,0,0;
  --muted:#aa4444;
  --pad:12px; --radius:12px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  background: radial-gradient(circle at top, #300000, #000000 70%);
  background-color:#000;
  background-size: cover; background-repeat: no-repeat;
  color:#fff;font-family:'Montserrat',Arial,system-ui,-apple-system,Segoe UI,sans-serif;
  margin:0; min-height:100vh; -webkit-text-size-adjust:100%;
}
a{color:#fff; text-decoration:none}
img{max-width:100%; display:block}

/* Header / Nav */
header{
  position:sticky; top:0; z-index:50;
  background:linear-gradient(90deg,#2a0000,var(--accent));
  color:#fff; padding:14px 18px; display:flex; align-items:center; gap:12px; flex-wrap:wrap
}
h1{margin:0;font-size:20px;letter-spacing:.2px}
.navbar{
  display:flex; gap:8px; align-items:center; margin-left:auto; flex-wrap:nowrap;
  overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none;
  padding-bottom:2px;
}
.navbar::-webkit-scrollbar{display:none}
.navbar button{
  background:var(--accent);color:#fff;border:1px solid rgba(var(--accent-rgb),.6);border-radius:10px;
  padding:10px 12px; cursor:pointer; white-space:nowrap
}
.navbar button[aria-pressed="true"]{background:rgba(var(--accent-rgb),.85);border-color:var(--accent)}

/* Layout */
main{padding:20px;max-width:1200px;margin:0 auto}
h2{margin:0 0 10px}
.muted{color:var(--muted)}
.center{text-align:center}
.chip{background:#220000;border:1px solid #440000;border-radius:999px;padding:4px 8px;font-size:12px}

/* Teams grid/cards */
.teams-grid{
  display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));
  gap:16px;margin-top:18px
}
.team-card{
  background:#110000;border-radius:12px;padding:12px;
  display:flex;flex-direction:column;align-items:center;
  color:#fff;box-shadow:0 6px 18px rgba(var(--accent-rgb),.3);
  overflow:hidden;cursor:pointer;transition:transform .14s,box-shadow .14s;
}
.team-card:hover{transform:translateY(-6px);box-shadow:0 12px 28px rgba(var(--accent-rgb),.5)}
/* Taller, responsive logos — desktop = taller; mobile = slightly shorter */
.team-logo{
  width:100%;
  aspect-ratio:5/3;               /* taller than 16:9 for desktop */
  height:auto; object-fit:contain; border-radius:10px; background:#330000; padding:8px
}
.team-meta{width:100%;display:flex;align-items:center;justify-content:space-between;margin-top:10px;gap:8px}
.team-meta .name{font-weight:800;font-size:17px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.team-meta .record{font-weight:700;font-size:14px}.players-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  justify-content: center;
  margin-top: 12px; /* pick 12px instead of 10px for consistency */
  width: 100%;
}
.player-card{position:relative;width:200px;height:280px;flex:0 1 auto}
.card-frame{width:100%;height:100%;object-fit:cover;border-radius:12px}
.card-overlay{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;padding:12px;color:#fff;text-shadow:0 0 6px black;z-index:3}
.player-silhouette{position:absolute;top:20%;left:50%;transform:translateX(-50%);width:70%;opacity:.85;z-index:1}
.player-kit{position:absolute;top:20%;left:50%;transform:translateX(-50%);width:70%;z-index:2}
.player-kit-box{position:absolute;top:20%;left:50%;transform:translateX(-50%);width:70%;height:70%;z-index:2;border-radius:8px}
.player-overall{font-size:28px;font-weight:900}
.player-name{font-size:16px;font-weight:bold}
.player-position{font-size:14px;font-weight:600;margin-bottom:8px}
.player-stats{font-size:14px;display:grid;grid-template-columns:repeat(2,1fr);gap:2px;text-align:left}

/* Generic card */
.m-card{background:#110000;border:1px solid #2a0000;border-radius:12px;box-shadow:0 6px 18px rgba(255,0,0,.15);padding:12px}

/* Squad editor */
.squad-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:18px;margin-top:14px}

/* Fixtures list */
.fx-list{display:flex;flex-direction:column;gap:12px}
.fx{
  background:#110000;border:1px solid #300000;border-radius:12px;padding:12px;
  display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center
}
.fx .meta{font-size:12px;color:var(--muted)}
.fx .act{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end}
.fx button{background:#330000;border:1px solid #551111;color:#fff;border-radius:8px;padding:8px 10px;cursor:pointer}
.fx-banner{width:100%;max-height:120px;object-fit:cover;border-radius:8px;margin:6px 0}
.fx-vs{display:flex;align-items:center;gap:10px;font-weight:800}
.fx-team{display:inline-flex;align-items:center;gap:8px;min-width:0}
.fx-team img{width:28px;height:28px;border-radius:50%;object-fit:cover;background:#300}
.fx-team span{display:inline-block;max-width:160px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* Results modal (sheet editor) */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1000}
.modal.show{display:flex}
.dialog{background:#110000;border:1px solid #2a0000;border-radius:12px;padding:16px;width:min(960px,96vw);max-height:96vh;overflow:auto;box-shadow:0 6px 18px rgba(255,0,0,.25)}
.dialog h3{margin:0 0 8px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.sheet{border:1px solid #2a0000;border-radius:10px;padding:8px}
.sheet table{width:100%;border-collapse:collapse}
.sheet th,.sheet td{border-bottom:1px solid #220000;padding:6px}
.sheet th{font-size:12px;color:var(--muted);text-align:left}
.sheet select,.sheet input, .dialog textarea{width:100%;background:#0d0000;color:#fff;border:1px solid #3a0000;border-radius:8px;padding:10px}
/* Ensure numeric inputs in result sheet are wide enough to show values */
.sheet td input[type=number]{
  padding:4px;
  min-width:36px;
  text-align:center;
}
.sheet .row-btns{display:flex;gap:6px}
.dialog .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

/* News feed (social style) */
.news-wrap{display:flex;flex-direction:column;gap:20px;max-width:700px;margin:0 auto}
.news-post{background:#110000;border:1px solid #2a0000;border-radius:14px;padding:20px;display:flex;gap:12px;font-size:18px;width:100%}
.news-avatar{width:48px;height:48px;border-radius:8px;object-fit:cover;background:#300;flex:0 0 auto}
.news-body{flex:1;text-align:center}
.news-title{font-weight:800;margin-bottom:8px;font-size:20px}
.news-meta{font-size:12px;color:var(--muted);margin-top:6px}

/* Champions Cup groups — compact standings only */
.group-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
.group-card{background:#110000;border:1px solid #2a0000;border-radius:12px;padding:12px}
.group-title{font-weight:800;margin:0 0 8px}
.group-table{width:100%;border-collapse:collapse}
.group-table th,.group-table td{padding:6px 8px;border-bottom:1px solid #2a0000;text-align:right;font-variant-numeric:tabular-nums}
.group-table th:first-child,.group-table td:first-child{text-align:left}
.group-table tbody tr:hover{background:#160000}
.group-team{display:inline-flex;align-items:center;gap:8px}
.group-team img{width:18px;height:18px;border-radius:3px;object-fit:cover}

/* Champions Cup bracket */
.bracket-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
.bracket-card{background:#110000;border:1px solid #2a0000;border-radius:12px;padding:12px;text-align:center}
.bracket-match{display:flex;flex-direction:column;gap:4px}
.bracket-vs{font-size:12px;color:var(--muted)}

/* Mobile & small tablets */
@media (max-width: 900px){
  .teams-grid{grid-template-columns:repeat(auto-fill,minmax(200px,1fr))}
  .fx-team span{max-width:120px}
}
@media (max-width: 640px){
  main{padding:14px}
  .team-logo{aspect-ratio:16/9}       /* slightly shorter on phones */
  .teams-grid{gap:14px}
  .news-post{gap:10px}
  .news-avatar{width:42px;height:42px}
  .grid2{grid-template-columns:1fr}   /* modals stack */
  .fx{grid-template-columns:1fr;gap:8px}
  .fx .act{justify-content:flex-start}
}
/* Motion-safe */
@media (prefers-reduced-motion: reduce){
  .team-card,.navbar button{transition:none}
}

/* Intro splash */
#intro{
  position:fixed;
  inset:0;
  background:#000;
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:9999;
  transition:opacity 1s ease;
}
#intro.hidden{opacity:0;pointer-events:none;}
#intro img{max-width:80vw;max-height:80vh;}
</style>
</head>
<body>
<div id="intro">
    <img src="/assets/logos/UPCL.png" alt="League logo">
  <audio id="introAudio" src="/intro.mp3"></audio>
</div>
<header>
  <h1>Pro Club — League Hub</h1>
  <div class="navbar" aria-label="Primary">
    <button id="navTeams"    aria-pressed="true">Teams</button>
    <button id="navNews"     aria-pressed="false">News</button>
    <button id="navMarket"   aria-pressed="false">Market</button>
    <button id="navFixturesPublic" aria-pressed="false">Fixtures</button>
    <button id="navFixturesSched"  aria-pressed="false" style="display:none">Scheduling</button>
    <button id="navChampions" aria-pressed="false">Champions Cup</button>
    <button id="navLeague" aria-pressed="false">UPCL League</button>
    <button id="navFriendlies" aria-pressed="false">Friendlies</button>
    <button id="btnManagerLogin">Manager sign in</button>
    <button id="btnAdminLogin">Admin sign in</button>
    <button id="btnAdminLogout" style="display:none">Admin sign out</button>
  </div>
</header>

<main>
  <!-- TEAMS -->
  <section id="teams-view" aria-live="polite">
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <h2 style="margin:0">Teams</h2>
      <div class="muted">Total teams: <span id="teams-count">0</span></div>
    </div>
    <div class="teams-grid" id="teamsGrid" role="list">
      <div class="team-card" data-club-id="2491998" role="listitem">
        <img class="team-logo" src="/assets/logos/royal-republic-logo.png" alt="Royal Republic logo" onerror="this.onerror=null;this.src='https://via.placeholder.com/800x480.png?text=Royal%20Republic';" />
        <div class="team-meta"><div class="name">Royal Republic</div><div class="record"></div></div>
        <div class="players-grid"></div>
      </div>
      <div class="team-card" data-club-id="1527486" role="listitem">
        <img class="team-logo" src="/assets/logos/gungan-fc.png" alt="Gungan FC logo" onerror="this.onerror=null;this.src='https://via.placeholder.com/800x480.png?text=Gungan%20FC';" />
        <div class="team-meta"><div class="name">Gungan FC</div><div class="record"></div></div>
        <div class="players-grid"></div>
      </div>
      <div class="team-card" data-club-id="1969494" role="listitem">
        <img class="team-logo" src="/assets/logos/club-frijol.png" alt="Club Frijol logo" onerror="this.onerror=null;this.src='https://via.placeholder.com/800x480.png?text=Club%20Frijol';" />
        <div class="team-meta"><div class="name">Club Frijol</div><div class="record"></div></div>
        <div class="players-grid"></div>
      </div>
      <div class="team-card" data-club-id="2086022" role="listitem">
        <img class="team-logo" src="/assets/logos/brehemen.png" alt="Brehemen logo" onerror="this.onerror=null;this.src='https://via.placeholder.com/800x480.png?text=Brehemen';" />
        <div class="team-meta"><div class="name">Brehemen</div><div class="record"></div></div>
        <div class="players-grid"></div>
      </div>
      <div class="team-card" data-club-id="2462194" role="listitem">
        <img class="team-logo" src="/assets/logos/costa-chica-fc.png" alt="Costa Chica FC logo" onerror="this.onerror=null;this.src='https://via.placeholder.com/800x480.png?text=Costa%20Chica%20FC';" />
        <div class="team-meta"><div class="name">Costa Chica FC</div><div class="record"></div></div>
        <div class="players-grid"></div>
      </div>
      <div class="team-card" data-club-id="5098824" role="listitem">
        <img class="team-logo" src="/assets/logos/sporting-de-la-ma.png" alt="Sporting de la ma logo" onerror="this.onerror=null;this.src='https://via.placeholder.com/800x480.png?text=Sporting%20de%20la%20ma';" />
        <div class="team-meta"><div class="name">Sporting de la ma</div><div class="record"></div></div>
        <div class="players-grid"></div>
      </div>
      <div class="team-card" data-club-id="4869810" role="listitem">
        <img class="team-logo" src="/assets/logos/afc-tekki.png" alt="Afc Tekki logo" onerror="this.onerror=null;this.src='https://via.placeholder.com/800x480.png?text=Afc%20Tekki';" />
        <div class="team-meta"><div class="name">Afc Tekki</div><div class="record"></div></div>
        <div class="players-grid"></div>
      </div>
      <div class="team-card" data-club-id="576007" role="listitem">
        <img class="team-logo" src="/assets/logos/ethabella-fc.png" alt="Ethabella FC logo" onerror="this.onerror=null;this.src='https://via.placeholder.com/800x480.png?text=Ethabella%20FC';" />
        <div class="team-meta"><div class="name">Ethabella FC</div><div class="record"></div></div>
        <div class="players-grid"></div>
      </div>
      <div class="team-card" data-club-id="4933507" role="listitem">
        <img class="team-logo" src="/assets/logos/loss-toyz.png" alt="Loss Toyz logo" onerror="this.onerror=null;this.src='https://via.placeholder.com/800x480.png?text=Loss%20Toyz';" />
        <div class="team-meta"><div class="name">Loss Toyz</div><div class="record"></div></div>
        <div class="players-grid"></div>
      </div>
      <div class="team-card" data-club-id="4824736" role="listitem">
        <img class="team-logo" src="/assets/logos/goldengoals-fc.png" alt="GoldenGoals FC logo" onerror="this.onerror=null;this.src='https://via.placeholder.com/800x480.png?text=GoldenGoals%20FC';" />
        <div class="team-meta"><div class="name">GoldenGoals FC</div><div class="record"></div></div>
        <div class="players-grid"></div>
      </div>
      <div class="team-card" data-club-id="481847" role="listitem">
        <img class="team-logo" src="/assets/logos/rooney-tunes.png" alt="Rooney tunes logo" onerror="this.onerror=null;this.src='https://via.placeholder.com/800x480.png?text=Rooney%20tunes';" />
        <div class="team-meta"><div class="name">Rooney tunes</div><div class="record"></div></div>
        <div class="players-grid"></div>
      </div>
      <div class="team-card" data-club-id="3050467" role="listitem">
        <img class="team-logo" src="/assets/logos/invincible-afc.png" alt="invincible afc logo" onerror="this.onerror=null;this.src='https://via.placeholder.com/800x480.png?text=invincible%20afc';" />
        <div class="team-meta"><div class="name">invincible afc</div><div class="record"></div></div>
        <div class="players-grid"></div>
      </div>
      <div class="team-card" data-club-id="4154835" role="listitem">
        <img class="team-logo" src="/assets/logos/khalch-fc.png" alt="khalch Fc logo" onerror="this.onerror=null;this.src='https://via.placeholder.com/800x480.png?text=khalch%20Fc';" />
        <div class="team-meta"><div class="name">khalch Fc</div><div class="record"></div></div>
        <div class="players-grid"></div>
      </div>
      <div class="team-card" data-club-id="3638105" role="listitem">
        <img class="team-logo" src="/assets/logos/real-mvc.png" alt="Real mvc logo" onerror="this.onerror=null;this.src='https://via.placeholder.com/800x480.png?text=Real%20mvc';" />
        <div class="team-meta"><div class="name">Real mvc</div><div class="record"></div></div>
        <div class="players-grid"></div>
      </div>
      <div class="team-card" data-club-id="55408" role="listitem">
        <img class="team-logo" src="/assets/logos/elite-vt.png" alt="Elite VT logo" onerror="this.onerror=null;this.src='https://via.placeholder.com/800x480.png?text=Elite%20VT';" />
        <div class="team-meta"><div class="name">Elite VT</div><div class="record"></div></div>
        <div class="players-grid"></div>
      </div>
      <div class="team-card" data-club-id="4819681" role="listitem">
        <img class="team-logo" src="/assets/logos/everything-dead.png" alt="EVERYTHING DEAD logo" onerror="this.onerror=null;this.src='https://via.placeholder.com/800x480.png?text=EVERYTHING%20DEAD';" />
        <div class="team-meta"><div class="name">EVERYTHING DEAD</div><div class="record"></div></div>
        <div class="players-grid"></div>
      </div>
      <div class="team-card" data-club-id="35642" role="listitem">
        <img class="team-logo" src="/assets/logos/ebk-fc.png" alt="EBK FC logo" onerror="this.onerror=null;this.src='https://via.placeholder.com/800x480.png?text=EBK%20FC';" />
        <div class="team-meta"><div class="name">EBK FC</div><div class="record"></div></div>
        <div class="players-grid"></div>
      </div>
      <div class="team-card" data-club-id="afc-warriors" role="listitem">
        <img class="team-logo" src="/assets/logos/afc-warriors.png" alt="AFC Warriors logo" onerror="this.onerror=null;this.src='https://via.placeholder.com/800x480.png?text=AFC%20Warriors';" />
        <div class="team-meta"><div class="name">AFC Warriors</div><div class="record"></div></div>
        <div class="players-grid"></div>
      </div>
      <div class="team-card" data-club-id="jids-trivela" role="listitem">
        <img class="team-logo" src="/assets/logos/jids-trivela.png" alt="Jids Trivela logo" onerror="this.onerror=null;this.src='https://via.placeholder.com/800x480.png?text=Jids%20Trivela';" />
        <div class="team-meta"><div class="name">Jids Trivela</div><div class="record"></div></div>
        <div class="players-grid"></div>
      </div>
      <div class="team-card" data-club-id="razorblack-fc" role="listitem">
        <img class="team-logo" src="/assets/logos/razorblack-fc.png" alt="Razorblack FC logo" onerror="this.onerror=null;this.src='https://via.placeholder.com/800x480.png?text=Razorblack%20FC';" />
        <div class="team-meta"><div class="name">Razorblack FC</div><div class="record"></div></div>
        <div class="players-grid"></div>
      </div>
      <div class="team-card" data-club-id="fc-dhizz" role="listitem">
        <img class="team-logo" src="/assets/logos/fc-dhizz.png" alt="FC Dhizz logo" onerror="this.onerror=null;this.src='https://via.placeholder.com/800x480.png?text=FC%20Dhizz';" />
        <div class="team-meta"><div class="name">FC Dhizz</div><div class="record"></div></div>
        <div class="players-grid"></div>
      </div>
      <div class="team-card" data-club-id="elite-xi" role="listitem">
        <img class="team-logo" src="/assets/logos/elite-xi.png" alt="Elite xi logo" onerror="this.onerror=null;this.src='https://via.placeholder.com/800x480.png?text=Elite%20xi';" />
        <div class="team-meta"><div class="name">Elite xi</div><div class="record"></div></div>
        <div class="players-grid"></div>
      </div>
    </div>
  </section>
  <div id="teamView" style="display:none"></div>

  <!-- NEWS -->
  <section id="news-view" style="display:none">
    <h2>League News</h2>
    <div id="newsFeed" class="news-wrap" style="margin-top:8px">
      <div class="muted">Loading news…</div>
    </div>
  </section>

  <!-- TEAM DETAIL -->
  <section id="detail-view" aria-live="polite" style="display:none">
    <div id="detail-header" style="display:flex;align-items:center;gap:12px;margin-bottom:14px">
      <button id="backBtn">← Back</button>
      <div>
        <div id="detail-title" style="font-size:20px;font-weight:800">Team name</div>
        <div class="muted" id="detail-sub">squad & trophies</div>
      </div>
    </div>

    <div id="teamPanels" class="grid-panels" style="display:grid;grid-template-columns:1fr;gap:12px">
      <div class="m-card">
        <strong>Club Wallet</strong>
        <div id="walletBody" class="muted" style="margin-top:6px">Loading…</div>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button id="btnCollect" style="display:none">Collect daily payout</button>
          <small class="muted" id="walletHint"></small>
        </div>
      </div>

      <div class="m-card">
        <strong>Next UPCL Match</strong>
        <div id="nextMatchBody" class="muted" style="margin-top:6px">No scheduled match yet.</div>
      </div>

      <div id="teamResultsPanel" class="m-card">
        <strong>Recent Results</strong>
        <div id="teamResultsBody" class="muted" style="margin-top:6px">No finals yet.</div>
      </div>

      <!-- Manual squad editor -->
      <div class="m-card" id="squadPanel">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
          <strong>Squad</strong>
          <div id="squadTools" style="display:none;gap:8px"><button id="btnBootstrapSlots" title="Create S01..S15">Bootstrap slots</button></div>
        </div>
        <div id="squadBody" class="players-grid" style="margin-top:6px"></div>
      </div>
    </div>

    <div id="detail-footer" style="margin-top:18px" class="muted center">
      <small>Manual squads (EA API disabled).</small>
    </div>
  </section>

  <!-- MARKET -->
  <section id="market-view" style="display:none">
    <h2>Transfer Market</h2>
    <div class="m-card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap">
        <strong>Free Agents</strong>
        <div><button id="btnListFA">List me</button><button id="btnUnlistFA">Unlist</button></div>
      </div>
      <div id="faList" style="margin-top:8px" class="muted">Loading…</div>
    </div>
  </section>

  <!-- FIXTURES (PUBLIC) -->
  <section id="fixtures-public" style="display:none">
    <h2>Fixtures</h2>
    <div id="fixtures" class="fx-list" style="margin-top:10px"></div>
    <div id="fixturesPublicList" class="fx-list" style="margin-top:10px"></div>
  </section>

  <!-- FIXTURES SCHEDULING (MANAGERS/Admins) -->
  <section id="fixtures-sched" style="display:none">
    <div style="display:flex;align-items:center;gap:8px;justify-content:space-between;flex-wrap:wrap">
      <h2>Fixtures Scheduling</h2>
      <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
        <button data-fxf="upcoming" aria-pressed="true">Upcoming</button>
        <button data-fxf="final" aria-pressed="false">Final</button>
        <button data-fxf="all" aria-pressed="false">All</button>
        <button data-fxf="mine" aria-pressed="false">My club</button>
        <button id="btnCreateFx" style="display:none">Create fixture</button>
      </div>
    </div>
    <div id="fixturesList" class="fx-list" style="margin-top:10px"></div>
  </section>

  <!-- CHAMPIONS CUP -->
  <section id="champions-view" style="display:none">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap">
      <h2>UPCL Champions Cup</h2>
      <div class="chip">Cup ID: <span id="ccCupId"></span></div>
    </div>

    <!-- Groups + tables (names once, standings only) -->
    <div class="m-card" style="margin-top:10px">
      <strong>Groups</strong>
      <div id="ccGroups" class="group-grid" style="margin-top:8px"></div>
    </div>

    <!-- Bracket -->
    <div class="m-card" style="margin-top:10px">
      <strong>Bracket</strong>
      <div id="ccBracket" class="bracket-grid" style="margin-top:8px"></div>
    </div>

    <!-- Leaders -->
    <div class="m-card" style="margin-top:10px">
      <strong>Leaders</strong>
      <div id="ccLeaders" style="margin-top:8px;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px"></div>
    </div>

    <!-- Admin tools (group editor + easy create fixture) -->
    <div class="m-card" id="ccAdmin" style="display:none;margin-top:10px">
      <strong>Admin tools</strong>
      <div class="muted">Assign teams to groups, save groups, and create fixtures.</div>

      <div id="ccManualGroups" style="display:grid;grid-template-columns:repeat(4,minmax(220px,1fr));gap:10px;margin-top:10px"></div>
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="ccBtnSaveGroups">Save groups</button>
      </div>

      <hr style="border:none;border-top:1px solid #220000;margin:12px 0">

      <div>
        <strong>Create Champions Cup fixture</strong>
        <div class="grid2" style="margin-top:8px">
          <div>
            <label class="muted">Home</label>
            <select id="ccHomeSel"></select>
          </div>
          <div>
            <label class="muted">Away</label>
            <select id="ccAwaySel"></select>
          </div>
          <div>
            <label class="muted">Group (optional)</label>
            <select id="ccGroupSel">
              <option value="">— none —</option>
              <option value="A">Group A</option>
              <option value="B">Group B</option>
              <option value="C">Group C</option>
              <option value="D">Group D</option>
            </select>
          </div>
          <div>
            <label class="muted">Stage / Round</label>
            <input id="ccRoundInput" placeholder="e.g., Group A MD1 or Semifinal">
          </div>
          <div>
            <label class="muted">Date & time (optional)</label>
            <input id="ccWhenInput" type="datetime-local">
          </div>
          <div style="align-self:end">
            <button id="ccFormCreate">Create fixture</button>
          </div>
        </div>
      </div>
    </div>

    <!-- CC Fixtures -->
    <div class="m-card" style="margin-top:10px">
      <strong>Champions Cup Fixtures</strong>
      <div id="ccFixtures" class="fx-list" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- UPCL LEAGUE -->
  <section id="league-view" style="display:none">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap">
      <h2>UPCL League</h2>
      <div class="chip">League ID: <span id="leagueCupId"></span></div>
    </div>

    <div class="m-card" style="margin-top:10px">
      <strong>Standings</strong>
      <div id="leagueTable" style="margin-top:8px"></div>
    </div>

    <div class="m-card" style="margin-top:10px">
      <strong>Leaders</strong>
      <div id="leagueLeaders" style="margin-top:8px;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px"></div>
    </div>

    <div class="m-card" id="leagueAdmin" style="display:none;margin-top:10px">
      <strong>Admin tools</strong>
      <div>
        <strong>Create League fixture</strong>
        <div class="grid2" style="margin-top:8px">
          <div>
            <label class="muted">Home</label>
            <select id="leagueHomeSel"></select>
          </div>
          <div>
            <label class="muted">Away</label>
            <select id="leagueAwaySel"></select>
          </div>
          <div>
            <label class="muted">Stage / Round</label>
            <input id="leagueRoundInput" placeholder="e.g., Week 1">
          </div>
          <div>
            <label class="muted">Date & time (optional)</label>
            <input id="leagueWhenInput" type="datetime-local">
          </div>
          <div style="align-self:end">
            <button id="leagueFormCreate">Create fixture</button>
          </div>
        </div>
      </div>
    </div>

    <div class="m-card" style="margin-top:10px">
      <strong>League Fixtures</strong>
      <div id="leagueFixtures" class="fx-list" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- FRIENDLIES -->
  <section id="friendlies-view" style="display:none">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap">
      <h2>Friendlies</h2>
      <div class="chip">Cup ID: <span id="frCupId"></span></div>
    </div>

    <div class="m-card" style="margin-top:10px">
      <strong>Fixtures</strong>
      <div id="friendliesFixtures" class="fx-list" style="margin-top:8px"></div>
    </div>

    <div class="m-card" id="friendliesAdmin" style="display:none;margin-top:10px">
      <strong>Admin tools</strong>
      <div class="muted">Manage friendly teams and generate fixtures.</div>
      <div id="frTeamList" style="margin-top:8px"></div>
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
        <select id="frAddSel"></select>
        <button id="frAddBtn">Add team</button>
      </div>
      <div style="margin-top:8px">
        <button id="frGenBtn">Generate fixtures</button>
      </div>
    </div>
  </section>

</main>

<!-- Manager Sign-In Modal -->
<div class="modal" id="mgrModal" aria-hidden="true">
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="mgrTitle">
    <h3 id="mgrTitle">Manager sign in</h3>
    <div class="grid2">
      <div>
        <label class="muted" for="mgrClubSel">Club</label>
        <select id="mgrClubSel"></select>
      </div>
      <div>
        <label class="muted" for="mgrName">Your name</label>
        <input id="mgrName" placeholder="Display name" />
      </div>
    </div>
    <div style="margin-top:8px">
      <label class="muted" for="mgrCode">Manager code</label>
      <input id="mgrCode" placeholder="8-char code" />
    </div>
    <div class="actions">
      <button id="mgrCancel">Cancel</button>
      <button id="mgrSubmit">Sign in</button>
    </div>
  </div>
</div>

<!-- Result Sheet Modal -->
<div class="modal" id="resultModal" aria-hidden="true">
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="resTitle">
    <h3 id="resTitle">Submit Result</h3>

    <div id="resMeta" class="muted"></div>

    <div class="grid2" style="margin-top:10px">
      <div class="sheet">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
          <strong id="homeTitle">Home</strong>
          <div class="row-btns"><button id="addHomeRow">+ Add row</button></div>
        </div>
        <table id="homeTable" style="margin-top:6px">
          <thead>
            <tr><th style="width:40%">Player</th><th>G</th><th>A</th><th>Rating</th><th>Pos</th><th></th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="sheet">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
          <strong id="awayTitle">Away</strong>
          <div class="row-btns"><button id="addAwayRow">+ Add row</button></div>
        </div>
        <table id="awayTable" style="margin-top:6px">
          <thead>
            <tr><th style="width:40%">Player</th><th>G</th><th>A</th><th>Rating</th><th>Pos</th><th></th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="grid2" style="margin-top:10px">
      <div>
        <label class="muted">Home Score</label>
        <input id="homeScore" type="number" min="0" value="0">
      </div>
      <div>
        <label class="muted">Away Score</label>
        <input id="awayScore" type="number" min="0" value="0">
      </div>
    </div>

    <div style="margin-top:8px">
      <label class="muted">Notes (optional)</label>
      <textarea id="resNotes" rows="3" placeholder="Short match notes or MVPs"></textarea>
    </div>

    <div class="actions">
      <button id="resCancel">Cancel</button>
      <button id="resPasteJson">Admin paste JSON</button>
      <button id="resSubmit">Submit Result</button>
    </div>
  </div>
</div>

<script>
// =======================
//   CONFIG / CONSTANTS
// =======================
const API_BASE = '';
const CC_ID = 'UPCL_CC_2025_08'; // current Champions Cup id
const LEAGUE_ID = 'UPCL_LEAGUE_2025'; // current League id
const FRIENDLIES_ID = 'UPCL_FRIENDLIES_2025'; // current Friendlies id

// Teams
let teams = [];

function buildStaticTeams(){
  teams = Array.from(document.querySelectorAll('.team-card')).map(card => {
    const id = card.getAttribute('data-club-id');
    const name = card.querySelector('.name').textContent.trim();
    const logo = card.querySelector('.team-logo').getAttribute('src');
    const team = { id, name, logo };
    card.addEventListener('click', () => openTeamView(id));
    return team;
  });
  document.getElementById('teams-count').textContent = teams.length;
}

// helpers
function normalizeId(id){
  return String(id||'').toLowerCase().replace(/[^a-z0-9]+/g,'-');
}
const byId = id => {
  const norm = normalizeId(id);
  return teams.find(t => normalizeId(t.id) === norm);
};
function replaceClubIds(str){
  if(!str) return str;
  return String(str).replace(/[A-Za-z0-9_-]+/g, token => {
    const club = byId(token);
    return club ? club.name : token;
  });
}
function teamLogoUrl(team){ return team?.logo || `https://via.placeholder.com/800x480.png?text=${encodeURIComponent(team?.name||'Club')}`; }
function escapeHtml(s){
  const map = { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' };
  return String(s).replace(/[&<>"']/g, c => map[c]);
}
function fmtMoney(n){ return '₵' + Number(n||0).toLocaleString(); }
function fmtDate(ms){ try{ return new Date(ms).toLocaleString(); } catch{ return ''; } }
function getFixtureBanner(){ return '/assets/ui/fixture-banner.png'; }

let isAdmin = false;
let meUser  = null;
let isMgr   = false;
let rankings = {};
let payouts  = { elite:0, mid:0, bottom:0 };
let fixturesPublicCache = [];
let fixturesSchedCache  = [];
let friendliesFxCache  = [];
let friendliesTeams    = [];

// api
async function apiGet(p){ const r = await fetch(API_BASE+p,{credentials:'include'}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
async function apiPost(p, body){ const r = await fetch(API_BASE+p,{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(body||{})}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
async function apiPut(p, body){ const r = await fetch(API_BASE+p,{method:'PUT',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(body||{})}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }

// players cache
let playersByClub = {};

const playerNameCache = new Map();
async function resolvePlayerName(id){
  if(!id) return '';
  if(playerNameCache.has(id)) return playerNameCache.get(id);
  for (const arr of Object.values(playersByClub)) {
    const p = arr.find(m => String(m.personaId||m.playerId||m.id) === String(id));
    if (p) {
      const name = p.name || p.playername || p.personaName || '';
      playerNameCache.set(id, name || id);
      return name || id;
    }
  }
  playerNameCache.set(id, id);
  return id;
}

// nav elements
const navTeams    = document.getElementById('navTeams');
const navNews     = document.getElementById('navNews');
const navMarket   = document.getElementById('navMarket');
const navFxPublic = document.getElementById('navFixturesPublic');
const navFxSched  = document.getElementById('navFixturesSched');
const navChampions= document.getElementById('navChampions');
const navLeague   = document.getElementById('navLeague');
const navFriendlies = document.getElementById('navFriendlies');

const teamsViewEl = document.getElementById('teams-view');
const newsView    = document.getElementById('news-view');
const marketView  = document.getElementById('market-view');
const fxPublic    = document.getElementById('fixtures-public');
const fxSched     = document.getElementById('fixtures-sched');
const cupView     = document.getElementById('champions-view');
const leagueView  = document.getElementById('league-view');
const friendliesView = document.getElementById('friendlies-view');

function setNav(active){
  if (active==='fixturesSched' && !(isMgr || isAdmin)) { alert('Managers only'); active='fixturesPublic'; }
  const s = {
    teams:[teamsViewEl, navTeams],
    news:[newsView, navNews],
    market:[marketView, navMarket],
    fixturesPublic:[fxPublic, navFxPublic],
    fixturesSched:[fxSched, navFxSched],
    champions:[cupView, navChampions],
    league:[leagueView, navLeague],
    friendlies:[friendliesView, navFriendlies]
  };
  for (const key of Object.keys(s)){
    const [view,btn] = s[key];
    const is = key===active;
    view.style.display = is ? 'block' : 'none';
    btn.setAttribute('aria-pressed', String(is));
  }
}
navTeams.onclick       = ()=> setNav('teams');
navNews.onclick        = async ()=>{ setNav('news'); await loadNews(); };
navMarket.onclick      = ()=> setNav('market');
navFxPublic.onclick    = ()=> setNav('fixturesPublic');
navFxSched.onclick     = ()=> setNav('fixturesSched');
navChampions.onclick   = async ()=> { setNav('champions'); await loadChampions(); };
navLeague.onclick      = async ()=> { setNav('league'); await loadLeague(); };
navFriendlies.onclick  = async ()=> { setNav('friendlies'); await loadFriendlies(); };

// auth / admin / manager
const btnAdminLogin = document.getElementById('btnAdminLogin');
const btnAdminLogout= document.getElementById('btnAdminLogout');
const btnManagerLogin= document.getElementById('btnManagerLogin');

btnAdminLogin.onclick = async ()=>{
  const pw = prompt('Admin password');
  if (!pw) return;
  try{
    await apiPost('/api/admin/login',{ password: pw });
    await checkAdmin(); await checkMe();
    alert('Admin signed in');
  }catch(e){ alert('Login failed: '+e.message); }
};
btnAdminLogout.onclick = async ()=>{
  try{ await apiPost('/api/admin/logout',{}); }catch{}
  await checkAdmin(); await checkMe();
  alert('Signed out');
};

async function checkAdmin(){
  try{ const d = await apiGet('/api/admin/me'); isAdmin = !!d.admin; }catch{ isAdmin=false; }
  btnAdminLogout.style.display = isAdmin ? 'inline-block' : 'none';
  navFxSched.style.display = (isMgr || isAdmin) ? 'inline-block' : 'none';
}
async function checkMe(){
  try { meUser = (await apiGet('/api/auth/me')).user || null; } catch { meUser = null; }
  isMgr = !!(meUser && meUser.role==='Manager');
  navFxSched.style.display = (isMgr || isAdmin) ? 'inline-block' : 'none';
}

// Manager modal
const mgrModal = document.getElementById('mgrModal');
const mgrClubSel = document.getElementById('mgrClubSel');
const mgrName = document.getElementById('mgrName');
const mgrCode = document.getElementById('mgrCode');
document.getElementById('mgrCancel').onclick = ()=>{ mgrModal.classList.remove('show'); mgrModal.setAttribute('aria-hidden','true'); };
btnManagerLogin.onclick = ()=>{
  mgrClubSel.innerHTML = teams.map(t=>`<option value="${t.id}">${escapeHtml(t.name)} (${t.id})</option>`).join('');
  mgrName.value=''; mgrCode.value=''; mgrModal.classList.add('show'); mgrModal.setAttribute('aria-hidden','false');
};
document.getElementById('mgrSubmit').onclick = async ()=>{
  const clubId = mgrClubSel.value;
  const name = (mgrName.value||'').trim();
  const code = (mgrCode.value||'').trim();
  if (!clubId || !name || !code) return alert('Pick a club, enter your name and code.');
  try{
    await apiPost(`/api/clubs/${encodeURIComponent(clubId)}/claim-manager`, { name, code });
    await checkMe(); await refreshFixturesSched(); renderFixturesSched();
    mgrModal.classList.remove('show'); mgrModal.setAttribute('aria-hidden','true');
    alert('Manager session started.');
  }catch(e){ alert('Sign-in failed: '+e.message); }
};

// =======================
//   TEAMS LIST / DETAIL
// =======================
const teamsGrid = document.getElementById('teamsGrid');
const teamsCount = document.getElementById('teams-count');
const detailView = document.getElementById('detail-view');
const detailTitle = document.getElementById('detail-title');
const detailSub   = document.getElementById('detail-sub');
const backBtn = document.getElementById('backBtn');

function parseVpro(vproattr){
  const parts=String(vproattr||'').split('|').map(n=>parseInt(n,10));
  if(parts.length<26||parts.some(n=>isNaN(n))) return null;
  const avg=a=>Math.round(a.reduce((x,y)=>x+y,0)/a.length);
  const pac=avg([parts[0],parts[1]]);
  const sho=avg([parts[4],parts[5],parts[6]]);
  const pas=avg([parts[9],parts[10],parts[12]]);
  const dri=avg([parts[2],parts[7],parts[8]]);
  const def=avg([parts[19],parts[20]]);
  const phy=avg([parts[23],parts[24],parts[25]]);
  const ovr=Math.round(pac*0.2+sho*0.2+pas*0.2+dri*0.2+def*0.1+phy*0.1);
  return {pac,sho,pas,dri,def,phy,ovr};
}

function tierFromOvr(ovr){
  if(ovr==null) return {frame:'iron_rookie.png',className:'tier-iron'};
  const n=Number(ovr)||0;
  if(n<70) return {frame:'iron_rookie.png',className:'tier-iron'};
  if(n<=84) return {frame:'steel_card.png',className:'tier-steel'};
  if(n<=94) return {frame:'crimson_card.png',className:'tier-crimson'};
  return {frame:'obsidian_elite.png',className:'tier-obsidian'};
}

const clubInfoCache = new Map();
async function getClubInfo(clubId){
  if(clubInfoCache.has(clubId)) return clubInfoCache.get(clubId);
  const res = await fetch(`/api/club-info/${encodeURIComponent(clubId)}`);
  const data = await res.json();
  const info = data?.club || data[clubId];
  if(info) clubInfoCache.set(clubId, info);
  return info;
}

async function getTeamId(clubId){
  const info = await getClubInfo(clubId);
  return info?.teamId;
}

function getKitUrl(teamId){
  return `https://proclubsdatabase.s3.us-east-2.amazonaws.com/minikits/j0_${teamId}_0.png`;
}

function applyGradient(img, customKit){
  const box = document.createElement('div');
  box.className = 'player-kit-box';
  const colors = [customKit?.kitColor1,customKit?.kitColor2,customKit?.kitColor3,customKit?.kitColor4]
    .filter(Boolean)
    .map(c=>`#${Number(c).toString(16).padStart(6,'0')}`);
  box.style.background = colors.length ? `linear-gradient(45deg, ${colors.join(',')})` : '#666';
  img.replaceWith(box);
}

async function renderClubKits(clubId, root = document){
  let info=null;
  try{ info = await getClubInfo(clubId); }catch(e){ info=null; }
  const teamId = info?.teamId;
  const customKit = info?.customKit || {};
  const kitUrl = teamId ? getKitUrl(teamId) : null;
  root.querySelectorAll(`[data-club-id="${clubId}"] .player-kit`).forEach(img=>{
    if(kitUrl){
      img.src = kitUrl;
      img.onerror = () => applyGradient(img, customKit);
    }else{
      applyGradient(img, customKit);
    }
  });
}

function buildPlayerCard(p, stats, tier){
  const s = stats || {pac:'??',sho:'??',pas:'??',dri:'??',def:'??',phy:'??',ovr:'??'};
  const t = tier || tierFromOvr(stats?stats.ovr:null);
  const card = document.createElement('div');
  card.className = `player-card ${t.className}`;
  if(p.player_id||p.playerId) card.dataset.playerId = String(p.player_id||p.playerId);
  if(p.name) card.dataset.playerName = p.name;
  // Ensure kit placeholder exists for renderClubKits
  card.innerHTML = `
    <img src="/assets/cards/${t.frame}" class="card-frame" />
    <img src="/assets/silhouette.png" class="player-silhouette" />
    <img class="player-kit" />
    <div class="card-overlay">
      <div class="player-overall">${s.ovr}</div>
      <div class="player-name">${escapeHtml(p.name||'Unknown')}</div>
      <div class="player-position">${escapeHtml(p.position||'')}</div>
      <div class="player-stats">
        <span>PAC ${s.pac}</span>
        <span>SHO ${s.sho}</span>
        <span>PAS ${s.pas}</span>
        <span>DRI ${s.dri}</span>
        <span>DEF ${s.def}</span>
        <span>PHY ${s.phy}</span>
      </div>
    </div>`;
  return card;
}

function updatePlayerCard(card, stats){
  const tier = tierFromOvr(stats.ovr);
  card.className = `player-card ${tier.className}`;
  const img = card.querySelector('.card-frame');
  if(img) img.src = `/assets/cards/${tier.frame}`;
  const over = card.querySelector('.player-overall');
  if(over) over.textContent = stats.ovr;
  const spans = card.querySelectorAll('.player-stats span');
  const labels = [stats.pac,stats.sho,stats.pas,stats.dri,stats.def,stats.phy];
  spans.forEach((span,i)=>{ span.textContent = `${['PAC','SHO','PAS','DRI','DEF','PHY'][i]} ${labels[i]}`; });
}

async function upgradeClubPlayers(clubId){
  try{
    const d = await fetch(`/api/clubs/${encodeURIComponent(clubId)}/player-cards`).then(r=>r.json());
    const grid = document.querySelector(`.team-card[data-club-id="${clubId}"] .players-grid`);
    if(!grid) return;
    (d.members||[]).forEach(m=>{
      const id = m.playerId || m.playerid;
      let card = grid.querySelector(`.player-card[data-player-id="${id}"]`);
      if(!card){
        card = Array.from(grid.querySelectorAll('.player-card')).find(el=>el.dataset.playerName === m.name);
      }
      if(card && m.stats) updatePlayerCard(card, m.stats);
    });
  }catch(e){
    console.error('upgrade failed', e);
  }
}
async function openTeamView(clubId){
  document.querySelector('.teams-grid').style.display = 'none';
  const teamView = document.getElementById('teamView');
  teamView.style.display = 'block';
  const team = byId(clubId);
  const name = team ? team.name : ((typeof CLUB_NAMES !== 'undefined' && CLUB_NAMES[clubId]) || 'Unknown Club');
  teamView.innerHTML = `<button id="teamBackBtn">← Back</button>
    <h2>${escapeHtml(name)}</h2>
    <div class="team-wallet">Wallet: TBD</div>
    <div class="players-grid"></div>`;
  teamView.dataset.clubId = clubId;
  document.getElementById('teamBackBtn').addEventListener('click', closeTeamView);
  const grid = teamView.querySelector('.players-grid');
  grid.innerHTML = '';
  let members = [];
  try {
    const d = await fetch(`/api/clubs/${encodeURIComponent(clubId)}/player-cards`).then(r=>r.json());
    members = d.members || [];
  } catch(e) {
    console.error('Failed to load player cards', e);
  }
  if (!members.length) members = playersByClub[clubId] || [];
  members.forEach(m => {
    const stats = m.vproattr ? parseVpro(m.vproattr) : null;
    const tier = tierFromOvr(stats?.ovr);
    const card = buildPlayerCard(m, stats, tier);
    grid.appendChild(card);
  });
  renderClubKits(clubId, teamView);
}

function closeTeamView(){
  document.getElementById('teamView').style.display = 'none';
  document.querySelector('.teams-grid').style.display = 'grid';
}


async function loadPlayers(){
  try{
    playersByClub = {};
    const res = await fetch('/api/players');
    const data = await res.json();
    const players = data.players || [];
    players.forEach(p => {
      const cid = String(p.club_id || p.clubId || '');
      if(!cid) return;
      if(!playersByClub[cid]) playersByClub[cid] = [];
      playersByClub[cid].push(p);
    });
    const cards = document.querySelectorAll('.team-card');
    await Promise.all(Array.from(cards).map(async card => {
      const clubId = card.getAttribute('data-club-id');
      const grid = card.querySelector('.players-grid');
      if(!grid) return;
      grid.innerHTML='';
      try {
        const d = await fetch(`/api/clubs/${encodeURIComponent(clubId)}/player-cards`).then(r=>r.json());
        (d.members||[]).forEach(m => {
          const stats = m.vproattr ? parseVpro(m.vproattr) : null;
          const tier = tierFromOvr(stats?.ovr);
          const el = buildPlayerCard(m, stats, tier);
          grid.appendChild(el);
        });
      } catch(e){
        console.error('Failed to load player cards for club', clubId, e);
      }
      renderClubKits(clubId);
    }));
  }catch(e){
    console.error('Failed to load players', e);
  }
}

async function showTeam(team){
  window.scrollTo({top:0,behavior:'smooth'});
  document.getElementById('teams-view').style.display='none';
  detailView.style.display='block';
  detailTitle.textContent = team.name;
  detailSub.textContent = 'Loading club info…';

  await renderWallet(team.id);
  await refreshFixturesPublic(); renderNextFor(team.id); renderTeamResults(team.id);
  await loadSquad(team.id);

  detailSub.textContent = 'Club overview';
}

backBtn.addEventListener('click', ()=>{
  detailView.style.display='none';
  teamsViewEl.style.display='block';
  window.scrollTo({top:0,behavior:'smooth'});
});

// Wallet
async function renderWallet(clubId){
  const body = document.getElementById('walletBody');
  const hint = document.getElementById('walletHint');
  const btn = document.getElementById('btnCollect');
  try{
    const d = await apiGet(`/api/wallets/${encodeURIComponent(clubId)}`);
    const w = d.wallet||{}, prev = d.preview||{};
    const per = d.perDay||0;
    body.innerHTML = `
      Balance: <strong>${fmtMoney(w.balance||0)}</strong><br>
      Tier payout: <strong>${fmtMoney(per)}</strong> / day<br>
      Pending payout: <strong>${fmtMoney(prev.amount||0)}</strong> (${prev.days||0} days)
    `;
    const canCollect = meUser && meUser.role==='Manager' && String(meUser.teamId)===String(clubId);
    btn.style.display = canCollect ? 'inline-block' : 'none';
    btn.onclick = async ()=>{
      try{
        const r = await apiPost(`/api/wallets/${encodeURIComponent(clubId)}/collect`,{});
        alert(r.ok ? `Collected ${fmtMoney(r.collected||0)}` : (r.message||'No payout'));
        await renderWallet(clubId);
      }catch(e){ alert('Collect failed: '+e.message); }
    };
    hint.textContent = canCollect ? 'Only the club manager can collect.' : 'Sign in as manager to collect.';
  }catch(e){
    body.textContent = 'Wallet unavailable';
    hint.textContent = '';
    btn.style.display='none';
  }
}

async function loadSquad(clubId){
  const panel = document.getElementById('squadPanel');
  const body  = document.getElementById('squadBody');
  panel.style.display = 'block';
  body.innerHTML = 'Loading…';
  document.getElementById('squadTools').style.display = 'none';
  try{
    let members = playersByClub[clubId] || [];
    if (!members.length){
      const r = await fetch(`/api/clubs/${encodeURIComponent(clubId)}/squad`, {credentials:'include'})
        .then(res => res.ok ? res.json() : { slots: [] })
        .catch(() => ({ slots: [] }));
      members = r.slots
        .filter(s => s.player && (s.player.eaName || s.player.name))
        .map(s => ({ name: s.player.eaName || s.player.name || s.label }));
    }
    if (!members.length){
      body.innerHTML = '<div class="muted">No players registered.</div>';
      return;
    }
    body.innerHTML = '';
    members.forEach(p=>{
      const nameRaw = p.name || p.playername || p.proName || p.personaName;
      const name = nameRaw ? nameRaw : `Unknown_${p.playerId||p.playerid||''}`;
      const pos = p.position || p.pos || '';
      const stats = parseVpro(p.vproattr);
      const t = tierFromOvr(stats?stats.ovr:null);
      const s = stats || {pac:'??',sho:'??',pas:'??',dri:'??',def:'??',phy:'??',ovr:'??'};
      const card = buildPlayerCard({ name, position: pos, playerId: p.playerId||p.playerid }, s, t);
      body.appendChild(card);
    });
    renderClubKits(clubId);
  }catch(e){
    if (e.status === 504) {
      body.innerHTML = 'EA API timed out. Try again.';
    } else if (e.status === 502) {
      body.innerHTML = 'EA API request failed.';
    } else {
      body.innerHTML = 'Failed to load squad.';
    }
  }
}

// =======================
//   FREE AGENTS
// =======================
async function loadFA(){
  try{
    const d = await apiGet('/api/free-agents');
    const arr = d.agents || [];
    document.getElementById('faList').innerHTML = arr.length ? arr.map(a=>{
      const pos = (a.positions||[]).join(', ');
      return `<div class="m-card" style="margin:8px 0;padding:8px">
        <strong>${escapeHtml(a.name)}</strong> <span class="muted">(${escapeHtml(a.region||'')})</span><br>
        <span class="muted">${escapeHtml(pos)}</span>
        ${a.discord ? `<div>Discord: ${escapeHtml(a.discord)}</div>`:''}
        ${a.bio ? `<div class="muted">${escapeHtml(a.bio)}</div>`:''}
      </div>`;
    }).join('') : 'No free agents listed.';
  }catch{ document.getElementById('faList').textContent = 'Failed to load.'; }
}

document.getElementById('btnListFA').onclick = async ()=>{
  const name = meUser?.name || prompt('Your display name');
  if (!name) return;
  const positions = prompt('Positions (comma separated, e.g., ST, CAM, CB)')||'';
  const region = prompt('Region/Timezone (e.g., EST, EU)')||'';
  const foot = prompt('Strong foot (L/R)')||'';
  const availability = prompt('Availability (e.g., Mon-Thu 7-10pm)')||'';
  const discord = prompt('Discord tag (optional)')||'';
  const bio = prompt('Short bio (optional)')||'';
  try{
    await apiPost('/api/free-agents/me',{ name, positions, region, foot, availability, discord, bio });
    alert('Listed!');
    await loadFA();
  }catch(e){ alert('List failed: '+e.message); }
};
document.getElementById('btnUnlistFA').onclick = async ()=>{
  try{ await fetch('/api/free-agents/me',{ method:'DELETE', credentials:'include' }); alert('Unlisted'); await loadFA(); }
  catch(e){ alert('Unlist failed: '+e.message); }
};

// =======================
//   FIXTURES — PUBLIC
// =======================
const fixturesPublicList = document.getElementById('fixturesPublicList');

async function refreshMatches() {
  try {
    const res = await fetch('/api/matches');
    const { matches } = await res.json();
    renderMatches(matches);
  } catch (err) {
    console.error('Failed to load matches', err);
  }
}

function renderMatches(matches) {
  const container = document.querySelector('#fixtures');
  container.innerHTML = '';
  if (!Array.isArray(matches) || !matches.length) {
    container.innerHTML = '<p>No matches yet.</p>';
    return;
  }
  matches.forEach(m => {
    const teams = Object.values(m.clubs || {}).map(c => ({
      name: c.details?.name || '',
      score: c.goals
    }));
    if (teams.length < 2) return;
    const card = document.createElement('div');
    card.className = 'match-card';
    card.innerHTML = `
      <div>${teams[0].name} ${teams[0].score} - ${teams[1].score} ${teams[1].name}</div>
      <small>${new Date(m.timestamp).toLocaleString()}</small>
    `;
    container.appendChild(card);
  });
}

async function refreshFixturesPublic(){
  try {
    const d = await apiGet('/api/cup/fixtures?cup=UPCL');
    fixturesPublicCache = d.fixtures || [];
  } catch { fixturesPublicCache = []; }
}
function renderFixturesPublic(){
  const list = fixturesPublicCache.slice().sort((a,b)=>(a.when||a.createdAt)-(b.when||b.createdAt));
  fixturesPublicList.innerHTML = list.length ? list.map(f=>{
    const banner = getFixtureBanner();
    const H = byId(f.home), A = byId(f.away);
    const hn = H?.name || f.home;
    const an = A?.name || f.away;
    const whenTxt = f.when ? fmtDate(f.when) : 'TBD';
    const scoreTxt = (f.status==='final') ? `${f.score.hs}–${f.score.as}` : 'vs';
    const ccBadge = (f.cup===CC_ID) ? ' • <span class="chip">Champions Cup</span>' : '';
    return `
      <div class="fx">
        <div>
          ${banner ? `<img class="fx-banner" src="${banner}" alt="">` : ''}
          <div class="fx-vs">
            <span class="fx-team"><img src="${teamLogoUrl(H)}" alt=""><span>${escapeHtml(hn)}</span></span>
            <span class="muted">${scoreTxt}</span>
            <span class="fx-team"><img src="${teamLogoUrl(A)}" alt=""><span>${escapeHtml(an)}</span></span>
          </div>
          <div class="meta">${escapeHtml(f.round||'')}${ccBadge} • ${escapeHtml(whenTxt)} • ${escapeHtml(f.status||'')}</div>
        </div>
      </div>`;
  }).join('') : `<div class="muted">No fixtures yet.</div>`;
}

// Next & recent for team (from public cache)
function nextFor(teamId){
  const now = Date.now();
  return fixturesPublicCache
    .filter(f => (f.home===teamId||f.away===teamId) && f.status!=='final' && f.when && f.when>=now)
    .sort((a,b)=>a.when-b.when)[0];
}
function finalsFor(teamId, n=5){
  return fixturesPublicCache
    .filter(f => f.status==='final' && (f.home===teamId||f.away===teamId))
    .sort((a,b)=>(b.when||b.createdAt)-(a.when||a.createdAt))
    .slice(0,n);
}
function renderNextFor(teamId){
  const el = document.getElementById('nextMatchBody');
  const f = nextFor(teamId);
  if (!f){ el.textContent='No scheduled match yet.'; return; }
  const hn = byId(f.home)?.name || f.home;
  const an = byId(f.away)?.name || f.away;
  el.innerHTML = `<div class="fx-vs"><span class="fx-team"><img src="${teamLogoUrl(byId(f.home))}" alt=""><span>${escapeHtml(hn)}</span></span>
                  <span class="muted">vs</span>
                  <span class="fx-team"><img src="${teamLogoUrl(byId(f.away))}" alt=""><span>${escapeHtml(an)}</span></span></div>
                  <div class="muted">${fmtDate(f.when)}</div>`;
}
function renderTeamResults(teamId){
  const el = document.getElementById('teamResultsBody');
  const list = finalsFor(teamId);
  el.innerHTML = list.length ? list.map(f=>{
    const hn = byId(f.home)?.name || f.home;
    const an = byId(f.away)?.name || f.away;
    return `<div>FT ${f.score.hs}-${f.score.as}: <strong>${escapeHtml(hn)}</strong> vs <strong>${escapeHtml(an)}</strong> • ${fmtDate(f.when||f.createdAt)}</div>`;
  }).join('') : 'No finals yet.';
}

// =======================
//   FIXTURES — SCHEDULING
// =======================
const fixturesList = document.getElementById('fixturesList');
const btnCreateFx  = document.getElementById('btnCreateFx');

btnCreateFx.onclick = async ()=>{
  const home = prompt('Home club ID');
  const away = prompt('Away club ID');
  const round= prompt('Round (e.g., League MD1 or Cup QF)');
  if (!home || !away) return;
  try{
    const d = await apiPost('/api/cup/fixtures', { home, away, round, cup:'UPCL' });
    alert('Created fixture'); await refreshFixturesSched(); renderFixturesSched();
  }catch(e){ alert('Create failed: '+e.message); }
};

document.querySelectorAll('[data-fxf]').forEach(btn=>{
  btn.onclick = ()=>{
    document.querySelectorAll('[data-fxf]').forEach(b=>b.setAttribute('aria-pressed','false'));
    btn.setAttribute('aria-pressed','true');
    renderFixturesSched();
  };
});

async function refreshFixturesSched(){
  if (!(isMgr || isAdmin)) { fixturesSchedCache=[]; return; }
  try {
    const d = await apiGet('/api/cup/fixtures/scheduling?cup=UPCL');
    fixturesSchedCache = d.fixtures || [];
  } catch {
    fixturesSchedCache = [];
  }
}
function filterKey(){
  const active = [...document.querySelectorAll('[data-fxf]')].find(b=>b.getAttribute('aria-pressed')==='true');
  return active ? active.getAttribute('data-fxf') : 'upcoming';
}
function renderFixturesSched(){
  const key = filterKey();
  let list = fixturesSchedCache.slice();
  const now = Date.now();

  if (key==='upcoming'){
    list = list.filter(f => f.status!=='final' && (!f.when || f.when>=now));
  } else if (key==='final'){
    list = list.filter(f => f.status==='final');
  } else if (key==='mine' && meUser){
    list = list.filter(f => f.home===meUser.teamId || f.away===meUser.teamId);
  }

  list.sort((a,b)=>(a.when||a.createdAt)-(b.when||b.createdAt));
  fixturesList.innerHTML = list.length ? list.map(renderFxSchedRow).join('') : `<div class="muted">No fixtures.</div>`;

  // wire buttons
  list.forEach(f=>{
    const root = document.getElementById('fx_'+f.id);
    if (!root) return;
    const isManagerOf = meUser && meUser.role==='Manager' && [f.home,f.away].includes(meUser.teamId);

    const btnProp = root.querySelector('.act .prop');
    if (btnProp) btnProp.onclick = async ()=>{
      if (!isManagerOf && !isAdmin) return alert('Managers only');
      const atStr = prompt('Propose time (e.g., 2025-08-20 20:30)');
      if (!atStr) return;
      const at = Date.parse(atStr);
      if (!at) return alert('Could not parse date');
      try{ await apiPost(`/api/cup/fixtures/${f.id}/propose`, { at }); await refreshFixturesSched(); renderFixturesSched(); }
      catch(e){ alert('Propose failed: '+e.message); }
    };

    const btnAgree = root.querySelector('.act .agree');
    if (btnAgree) btnAgree.onclick = async ()=>{
      if (!isManagerOf && !isAdmin) return alert('Managers only');
      const at = root.querySelector('select[name="slot"]').value;
      if (!at) return alert('Pick a proposed slot first');
      try{ await apiPost(`/api/cup/fixtures/${f.id}/vote`, { at, agree:true }); await refreshFixturesSched(); renderFixturesSched(); await refreshFixturesPublic(); renderFixturesPublic(); }
      catch(e){ alert('Vote failed: '+e.message); }
    };

    const btnDecl = root.querySelector('.act .decl');
    if (btnDecl) btnDecl.onclick = async ()=>{
      if (!isManagerOf && !isAdmin) return alert('Managers only');
      const at = root.querySelector('select[name="slot"]').value;
      if (!at) return alert('Pick a proposed slot first');
      try{ await apiPost(`/api/cup/fixtures/${f.id}/vote`, { at, agree:false }); await refreshFixturesSched(); renderFixturesSched(); }
      catch(e){ alert('Vote failed: '+e.message); }
    };

    const btnQuick = root.querySelector('.act .quick');
    if (btnQuick) btnQuick.onclick = ()=> openResultEditor(f);

    const btnJson = root.querySelector('.act .json');
    if (btnJson) btnJson.onclick = async ()=>{
      if (!isAdmin) return alert('Admin only');
      const hs = Number(prompt('Home score (hs)')||0);
      const as = Number(prompt('Away score (as)')||0);
      const template = JSON.stringify({
        details:{
          home:[{ player:"Player A", goals:1, assists:0, rating:9.5, position:"ST" }],
          away:[{ player:"Player B", goals:2, assists:0, rating:8.7, position:"CB" }]
        }
      }, null, 2);
      const raw = prompt('Paste JSON (or edit the template):', template);
      if (!raw) return;
      try{
        const obj = JSON.parse(raw);
        await apiPost(`/api/cup/fixtures/${f.id}/report`, { hs, as, details: obj.details || obj });
        document.querySelectorAll('[data-fxf]').forEach(x=>x.setAttribute('aria-pressed','false'));
        document.querySelector('[data-fxf="final"]').setAttribute('aria-pressed','true');
        await refreshFixturesSched(); renderFixturesSched();
        await refreshFixturesPublic(); renderFixturesPublic();
      }catch(e){ alert('JSON upload failed: '+e.message); }
    };
  });
}

function renderFxSchedRow(f){
  const H = byId(f.home), A = byId(f.away);
  const hn = H?.name || f.home;
  const an = A?.name || f.away;
  const whenTxt = f.when ? fmtDate(f.when) : 'TBD';
  const props = (f.proposals||[]).map(p=>{
    const who = (teams.find(t=>String(t.id)===String(p.by))?.name) || p.by || 'unknown';
    return `<option value="${p.at}">${fmtDate(p.at)} — proposed by ${escapeHtml(who)}</option>`;
  }).join('');
  const status = f.status || 'pending';
  const adminBtns = isAdmin ? `<button class="json">Admin JSON</button>` : '';
  const banner = getFixtureBanner();
  return `
  <div class="fx" id="fx_${f.id}">
    <div>
      ${banner ? `<img class="fx-banner" src="${banner}" alt="">` : ''}
      <div class="fx-vs">
        <span class="fx-team"><img src="${teamLogoUrl(H)}" alt=""><span>${escapeHtml(hn)}</span></span>
        <span class="muted">vs</span>
        <span class="fx-team"><img src="${teamLogoUrl(A)}" alt=""><span>${escapeHtml(an)}</span></span>
      </div>
      <div class="meta">Round: ${escapeHtml(f.round||'')} • When: ${escapeHtml(whenTxt)} • Status: <span class="chip">${escapeHtml(status)}</span></div>
    </div>
    <div class="center">
      ${(f.proposals||[]).length ? `<label>Proposals</label><br><select name="slot">${props}</select>` : `<span class="muted">No proposals</span>`}
    </div>
    <div class="act">
      <button class="prop">Propose</button>
      <button class="agree">Agree</button>
      <button class="decl">Decline</button>
      <button class="quick">Quick Edit</button>
      ${adminBtns}
    </div>
  </div>`;
}

// =======================
//   RESULT SHEET MODAL
// =======================
const resultModal = document.getElementById('resultModal');
const resCancel = document.getElementById('resCancel');
const resSubmit = document.getElementById('resSubmit');
const resPasteJson = document.getElementById('resPasteJson');
let activeFixture = null;

resCancel.onclick = ()=>{ resultModal.classList.remove('show'); resultModal.setAttribute('aria-hidden','true'); };

function rowHtml(playersOptions){
  return `<tr>
    <td>
      <select class="playerSel">
        <option value="">— select player —</option>
        ${playersOptions}
      </select>
      <input class="playerCustom" placeholder="or type a name" style="margin-top:6px">
    </td>
    <td><input class="g" type="number" min="0" value="0"></td>
    <td><input class="a" type="number" min="0" value="0"></td>
    <td><input class="r" type="number" min="0" step="0.1" value="0"></td>
    <td><input class="pos" placeholder="e.g., ST"></td>
    <td><button class="rm">✕</button></td>
  </tr>`;
}

function toOptions(slots){
  const pts = (slots||[]).map(s=>{
    const p = s.player;
    const label = p?.eaName || '';
    const id = s.playerId || '';
    if (!id && !label) return '';
    return `<option value="${escapeHtml(id)}">${escapeHtml(label)}${id?` (#${id.slice(0,6)})`:''}</option>`;
  }).join('');
  return pts;
}

async function openResultEditor(f){
  activeFixture = f;
  document.getElementById('resTitle').textContent = `Submit Result — ${byId(f.home)?.name || f.home} vs ${byId(f.away)?.name || f.away}`;
  document.getElementById('resMeta').textContent = `${fmtDate(f.when||Date.now())} • ${f.round||''}`;

  const homeSlots = await fetch(`/api/clubs/${encodeURIComponent(f.home)}/squad`, {credentials:'include'}).then(r=>r.ok?r.json():{slots:[]}).catch(()=>({slots:[]}));
  const awaySlots = await fetch(`/api/clubs/${encodeURIComponent(f.away)}/squad`, {credentials:'include'}).then(r=>r.ok?r.json():{slots:[]}).catch(()=>({slots:[]}));

  const homeOpts = toOptions(homeSlots.slots);
  const awayOpts = toOptions(awaySlots.slots);

  const HT = document.querySelector('#homeTable tbody');
  const AT = document.querySelector('#awayTable tbody');
  HT.innerHTML=''; AT.innerHTML='';
  // start with 3 rows each
  for (let i=0;i<3;i++){ HT.insertAdjacentHTML('beforeend', rowHtml(homeOpts)); }
  for (let i=0;i<3;i++){ AT.insertAdjacentHTML('beforeend', rowHtml(awayOpts)); }

  document.getElementById('homeTitle').textContent = `Home — ${byId(f.home)?.name || f.home}`;
  document.getElementById('awayTitle').textContent = `Away — ${byId(f.away)?.name || f.away}`;

  document.getElementById('homeScore').value = f.score?.hs ?? 0;
  document.getElementById('awayScore').value = f.score?.as ?? 0;
  document.getElementById('resNotes').value = f.report?.text || '';

  const wireTable = (tbody)=> tbody.querySelectorAll('.rm').forEach(btn=> btn.onclick = ()=> btn.closest('tr')?.remove());
  wireTable(HT); wireTable(AT);

  document.getElementById('addHomeRow').onclick = ()=>{ HT.insertAdjacentHTML('beforeend', rowHtml(homeOpts)); wireTable(HT); };
  document.getElementById('addAwayRow').onclick = ()=>{ AT.insertAdjacentHTML('beforeend', rowHtml(awayOpts)); wireTable(AT); };

  resPasteJson.onclick = async ()=>{
    if (!isAdmin) return alert('Admin only');
    const hs = Number(prompt('Home score (hs)')||0);
    const as = Number(prompt('Away score (as)')||0);
    const template = JSON.stringify({
      details:{
        home:[{ player:"Player A", goals:1, assists:0, rating:9.5, position:"ST" }],
        away:[{ player:"Player B", goals:2, assists:0, rating:8.7, position:"CB" }]
      }
    }, null, 2);
    const raw = prompt('Paste JSON (or edit the template):', template);
    if (!raw) return;
    try{
      const obj = JSON.parse(raw);
      await apiPost(`/api/cup/fixtures/${f.id}/report`, { hs, as, details: obj.details || obj });
      alert('Saved');
      resultModal.classList.remove('show'); resultModal.setAttribute('aria-hidden','true');
      await refreshFixturesSched(); renderFixturesSched();
      await refreshFixturesPublic(); renderFixturesPublic();
      await loadChampions();
    }catch(e){ alert('JSON upload failed: '+e.message); }
  };

  resSubmit.onclick = async ()=>{
    const rowsToDetails = (tbody)=> {
      const out = [];
      tbody.querySelectorAll('tr').forEach(tr=>{
        const playerId = (tr.querySelector('.playerSel')?.value||'').trim();
        const custom   = (tr.querySelector('.playerCustom')?.value||'').trim();
        const goals = Number(tr.querySelector('.g')?.value||0);
        const assists = Number(tr.querySelector('.a')?.value||0);
        const rating = Number(tr.querySelector('.r')?.value||0);
        const pos = (tr.querySelector('.pos')?.value||'').trim();
        if (!playerId && !custom && !goals && !assists && !rating) return; // empty row
        out.push({ playerId, player: custom, goals, assists, rating, position: pos });
      });
      return out;
    };
    const details = {
      home: rowsToDetails(document.querySelector('#homeTable tbody')),
      away: rowsToDetails(document.querySelector('#awayTable tbody')),
    };
    const hs = Number(document.getElementById('homeScore').value||0);
    const as = Number(document.getElementById('awayScore').value||0);
    const text = document.getElementById('resNotes').value||'';
    try{
      await apiPost(`/api/cup/fixtures/${activeFixture.id}/report`, { hs, as, text, details });
      alert('Result submitted');
      resultModal.classList.remove('show'); resultModal.setAttribute('aria-hidden','true');
      await refreshFixturesSched(); renderFixturesSched();
      await refreshFixturesPublic(); renderFixturesPublic();
      await loadChampions();
    }catch(e){ alert('Submit failed: '+e.message); }
  };

  resultModal.classList.add('show'); resultModal.setAttribute('aria-hidden','false');
}

// =======================
//   CHAMPIONS CUP
// =======================
async function loadChampions(){
  document.getElementById('ccCupId').textContent = CC_ID;

  // groups
  let cupData = { cup:{ groups:{A:[],B:[],C:[],D:[]} } };
  try {
    cupData = await apiGet(`/api/champions/${encodeURIComponent(CC_ID)}`);
  } catch(e) {
    console.warn('Champions fetch failed:', e.message);
  }

  // cc fixtures
  let ccList = [];
  try {
    const fx = await apiGet(`/api/cup/fixtures?cup=${encodeURIComponent(CC_ID)}`);
    ccList = fx.fixtures || [];
  } catch {}

  renderCcGroups(cupData.cup.groups, ccList);
  renderCcFixtures(ccList);

  // leaders
  try {
    const leaders = await apiGet(`/api/champions/${encodeURIComponent(CC_ID)}/leaders`);
    renderCcLeaders(leaders);
  } catch {}

  // bracket
  renderCcBracket(cupData.cup.groups, ccList);

  // admin panel
  document.getElementById('ccAdmin').style.display = isAdmin ? 'block' : 'none';
  if (isAdmin) buildManualGroupsEditor(cupData.cup.groups);
}
function renderCcGroups(groups, fixtures){
  const el = document.getElementById('ccGroups');
  const tables = computeGroupTablesClient(groups, fixtures); // client fallback for standings
  el.innerHTML = ['A','B','C','D'].map(g=>{
    const rows = (tables[g]||[]).map(r=>{
      const T = byId(r.clubId);
      return `<tr>
        <td><span class="group-team"><img src="${teamLogoUrl(T)}" alt=""><span>${escapeHtml(T?.name||r.clubId)}</span></span></td>
        <td>${r.P}</td><td>${r.W}</td><td>${r.D}</td><td>${r.L}</td><td>${r.GD}</td><td>${r.Pts}</td>
      </tr>`;
    }).join('');
    return `
      <div class="group-card">
        <div class="group-title">Group ${g}</div>
        <table class="group-table">
          <thead><tr><th>Club</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GD</th><th>Pts</th></tr></thead>
          <tbody>${rows||''}</tbody>
        </table>
      </div>`;
    }).join('');
  }
function computeGroupTablesClient(groups, fixtures){
  // derive from provided fixtures + public cache
  const table = { A:{}, B:{}, C:{}, D:{} };
  const touch = (g,id)=> table[g][id] = table[g][id] || { clubId:id, P:0, W:0, D:0, L:0, GF:0, GA:0, GD:0, Pts:0 };
  ['A','B','C','D'].forEach(g=> (groups[g]||[]).forEach(id=> touch(g,id)));

  const merged = []
    .concat(Array.isArray(fixtures) ? fixtures : [])
    .concat(fixturesPublicCache || [])
    .filter(f=>f.cup===CC_ID && f.status==='final');

  merged.forEach(f=>{
    const g = f.group || null; if(!g || !table[g]) return;
    touch(g, f.home); touch(g, f.away);
    const H = table[g][f.home], A = table[g][f.away];
    const hs = Number(f.score?.hs||0), as = Number(f.score?.as||0);
    H.P++; A.P++;
    H.GF+=hs; H.GA+=as; H.GD=H.GF-H.GA;
    A.GF+=as; A.GA+=hs; A.GD=A.GF-A.GA;
    if(hs>as){ H.W++; H.Pts+=3; A.L++; }
    else if(hs<as){ A.W++; A.Pts+=3; H.L++; }
    else { H.D++; A.D++; H.Pts++; A.Pts++; }
  });
  const sorted = {};
  ['A','B','C','D'].forEach(g=>{
    sorted[g] = Object.values(table[g]).sort((x,y)=>(y.Pts-x.Pts)||(y.GD-x.GD)||(y.GF-x.GF));
  });
  return sorted;
  }

  function renderCcBracket(groups, fixtures){
    const el = document.getElementById('ccBracket');
    if (!el) return;
    const tables = computeGroupTablesClient(groups, fixtures);
    const top = g => (tables[g] && tables[g][0]) ? tables[g][0].clubId : '';
    const winners = { A: top('A'), B: top('B'), C: top('C'), D: top('D') };

    const semiList = fixtures.filter(f => String(f.round || '').toLowerCase().includes('semi'));
    const finalFx = fixtures.find(f => {
      const r = String(f.round || '').toLowerCase();
      return r === 'final' || (r.includes('final') && !r.includes('semi'));
    }) || null;

    const makeSemi = (home, away) => ({ home, away, status:'pending', score:{ hs:0, as:0 } });
    const semi1 = semiList[0] || makeSemi(winners.A, winners.B);
    const semi2 = semiList[1] || makeSemi(winners.C, winners.D);
    const finalMatch = finalFx || { home:'Winner SF1', away:'Winner SF2', status:'pending', score:{ hs:0, as:0 } };

    const teamHtml = id => {
      const T = byId(id);
      const name = T?.name || id;
      const logo = T ? `<img src="${teamLogoUrl(T)}" alt="">` : '';
      return `<span class="group-team">${logo}<span>${escapeHtml(name)}</span></span>`;
    };
    const matchHtml = f => {
      const scoreTxt = (f.status === 'final') ? `${f.score.hs}-${f.score.as}` : 'vs';
      return `<div class="bracket-match">${teamHtml(f.home)}<span class="bracket-vs">${scoreTxt}</span>${teamHtml(f.away)}</div>`;
    };

    el.innerHTML = `
      <div class="bracket-card"><strong>Semifinal 1</strong>${matchHtml(semi1)}</div>
      <div class="bracket-card"><strong>Final</strong>${matchHtml(finalMatch)}</div>
      <div class="bracket-card"><strong>Semifinal 2</strong>${matchHtml(semi2)}</div>
    `;
  }

  function renderCcLeaders(data){
    const wrap = document.getElementById('ccLeaders');
    const scorers = (data?.scorers||[]).map((r,i)=>{
      const T = byId(r.clubId);
      const club = T?.shortName || T?.name || r.clubId;
      return `<li>${escapeHtml(r.name)} <span class="muted">(${r.count}) - ${escapeHtml(club)}</span></li>`;
    }).join('');
    const assisters = (data?.assisters||[]).map((r,i)=>{
      const T = byId(r.clubId);
      const club = T?.shortName || T?.name || r.clubId;
      return `<li>${escapeHtml(r.name)} <span class="muted">(${r.count}) - ${escapeHtml(club)}</span></li>`;
    }).join('');
    if (!scorers && !assisters){
      wrap.innerHTML = '<div class="muted">No stats yet.</div>';
      return;
    }
    wrap.innerHTML = `
      <div>
        <div class="muted">Top Scorers</div>
        <ol style="margin-top:6px;padding-left:18px">${scorers||''}</ol>
      </div>
      <div>
        <div class="muted">Top Assisters</div>
        <ol style="margin-top:6px;padding-left:18px">${assisters||''}</ol>
      </div>`;
  }
function renderCcFixtures(list){
  const el = document.getElementById('ccFixtures');
  list.sort((a,b)=>(a.when||a.createdAt)-(b.when||b.createdAt));
  el.innerHTML = list.length ? list.map(f=>{
    const H = byId(f.home), A = byId(f.away);
    const hn = H?.name || f.home;
    const an = A?.name || f.away;
    const whenTxt = f.when ? fmtDate(f.when) : 'TBD';
    const scoreTxt = (f.status==='final') ? `${f.score.hs}–${f.score.as}` : 'vs';
    const banner = getFixtureBanner();
    const editBtn = isAdmin ? `<div class="act"><button data-ccq="${f.id}">Quick Edit</button><button data-ccj="${f.id}">Admin JSON</button></div>` : '';
    return `<div class="fx" id="ccfx_${f.id}">
      <div>
        ${banner ? `<img class="fx-banner" src="${banner}" alt="">` : ''}
        <div class="fx-vs">
          <span class="fx-team"><img src="${teamLogoUrl(H)}" alt=""><span>${escapeHtml(hn)}</span></span>
          <span class="muted">${scoreTxt}</span>
          <span class="fx-team"><img src="${teamLogoUrl(A)}" alt=""><span>${escapeHtml(an)}</span></span>
        </div>
        <div class="meta"><span class="chip">Champions Cup${f.group?` • Group ${f.group}`:''}${f.round?` • ${escapeHtml(f.round)}`:''}</span> • ${whenTxt} • ${escapeHtml(f.status||'')}</div>
      </div>
      ${editBtn}
    </div>`;
  }).join('') : `<div class="muted">No Champions Cup fixtures yet.</div>`;

  // wire CC quick edit / JSON
  list.forEach(f=>{
    const q = document.querySelector(`[data-ccq="${f.id}"]`);
    const j = document.querySelector(`[data-ccj="${f.id}"]`);
    if (q) q.onclick = ()=> openResultEditor(f);
    if (j) j.onclick = async ()=>{
      if (!isAdmin) return alert('Admin only');
      const hs = Number(prompt('Home score (hs)')||0);
      const as = Number(prompt('Away score (as)')||0);
      const template = JSON.stringify({ details:{ home:[{ player:"Player A", goals:1, assists:0, rating:9.5 }], away:[{ player:"Player B", goals:2, assists:0, rating:8.7 }] }}, null, 2);
      const raw = prompt('Paste JSON (or edit the template):', template);
      if (!raw) return;
      try{
        const obj = JSON.parse(raw);
        await apiPost(`/api/cup/fixtures/${f.id}/report`, { hs, as, details: obj.details || obj });
        await loadChampions();
        await refreshFixturesPublic(); renderFixturesPublic();
      }catch(e){ alert('JSON upload failed: '+e.message); }
    };
  });
}

function buildManualGroupsEditor(groups){
  const root = document.getElementById('ccManualGroups');
  const opts = teams.map(t=> `<option value="${t.id}">${escapeHtml(t.name)} (${t.id})</option>`).join('');
  root.innerHTML = ['A','B','C','D'].map(g=>{
    const rows = (groups[g]||[]).map(v=>
      `<div class="grow"><select data-val="${v}">${opts}</select> <button data-rm>X</button></div>`
    ).join('');
    return `<div class="m-card"><strong>Group ${g}</strong>
      <div data-g="${g}" class="gbox">${rows}</div>
      <div style="margin-top:6px"><button data-add="${g}">+ Add team</button></div>
    </div>`;
  }).join('');

  root.querySelectorAll('select[data-val]').forEach(sel=>{
    sel.value = sel.getAttribute('data-val');
  });

  function attachRemove(btn){
    if(!btn) return;
    btn.onclick = ()=> btn.parentElement.remove();
  }
  root.querySelectorAll('[data-rm]').forEach(attachRemove);

  // add rows
  root.querySelectorAll('[data-add]').forEach(btn=>{
    btn.onclick = ()=>{
      const g = btn.getAttribute('data-add');
      const box = root.querySelector(`.gbox[data-g="${g}"]`);
      const div = document.createElement('div');
      div.className = 'grow';
      div.innerHTML = `<select>${opts}</select> <button data-rm>X</button>`;
      box.appendChild(div);
      attachRemove(div.querySelector('[data-rm]'));
    };
  });

  // save groups (no 16-team requirement; any count allowed)
  document.getElementById('ccBtnSaveGroups').onclick = async ()=>{
    const out = { A:[], B:[], C:[], D:[] };
    root.querySelectorAll('.gbox').forEach(box=>{
      const g = box.getAttribute('data-g');
      box.querySelectorAll('select').forEach(sel=>{
        const v = sel.value; if (v) out[g].push(v);
      });
    });
    // ensure no duplicates across groups
    const all = [...out.A, ...out.B, ...out.C, ...out.D];
    const set = new Set(all);
    if (all.length !== set.size) return alert('Duplicate club across groups.');
    try{
      await apiPost(`/api/champions/${CC_ID}/groups`, { groups: out });
      alert('Groups saved'); await loadChampions();
    }catch(e){ alert('Save groups failed: '+e.message); }
  };

  setupCcFixtureForm();
}
function setupCcFixtureForm(){
  const homeSel = document.getElementById('ccHomeSel');
  const awaySel = document.getElementById('ccAwaySel');
  const groupSel = document.getElementById('ccGroupSel');
  const roundInput = document.getElementById('ccRoundInput');
  const whenInput = document.getElementById('ccWhenInput');
  const createBtn = document.getElementById('ccFormCreate');
  if (!homeSel || !awaySel || !createBtn) return;

  const optionsHtml = teams.map(t=>`<option value="${t.id}">${escapeHtml(t.name)} (${t.id})</option>`).join('');
  homeSel.innerHTML = `<option value="">— choose —</option>${optionsHtml}`;
  awaySel.innerHTML = `<option value="">— choose —</option>${optionsHtml}`;

  function ensureDifferent(){
    if (homeSel.value && awaySel.value && homeSel.value === awaySel.value) {
      alert('Home and away cannot be the same club.');
      awaySel.value = '';
    }
  }
  homeSel.onchange = ensureDifferent;
  awaySel.onchange = ensureDifferent;

  createBtn.onclick = async ()=>{
    const home = homeSel.value;
    const away = awaySel.value;
    const group = groupSel.value || null;
    const round = (roundInput.value || '').trim() || (group ? `Group ${group}` : 'Round');
    const when = whenInput.value ? Date.parse(whenInput.value) : null;
    if (!home || !away) return alert('Pick both teams');
    try{
      await apiPost('/api/cup/fixtures', { home, away, round, cup: CC_ID, group, when });
      alert('Fixture created'); await loadChampions();
    }catch(e){ alert('Create failed: '+e.message); }
  };
}

async function loadLeague(){
  document.getElementById('leagueCupId').textContent = LEAGUE_ID;

  let leagueData = { teams:[], standings:[] };
  try { leagueData = await apiGet(`/api/leagues/${encodeURIComponent(LEAGUE_ID)}`); } catch {}
  renderLeagueTable(leagueData.standings);

  try { const leaders = await apiGet(`/api/leagues/${encodeURIComponent(LEAGUE_ID)}/leaders`); renderLeagueLeaders(leaders); } catch {}

  let fxList = [];
  try { const fx = await apiGet(`/api/cup/fixtures?cup=${encodeURIComponent(LEAGUE_ID)}`); fxList = fx.fixtures || []; } catch {}
  renderLeagueFixtures(fxList);

  const adminEl = document.getElementById('leagueAdmin');
  if (adminEl) adminEl.style.display = isAdmin ? 'block' : 'none';
  if (isAdmin) setupLeagueFixtureForm(leagueData.teams);
}

function renderLeagueTable(rows){
  const el = document.getElementById('leagueTable');
  if (!rows.length){ el.innerHTML = '<div class="muted">No standings yet.</div>'; return; }
  el.innerHTML = `<table class="group-table"><thead><tr><th>Club</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GF</th><th>GA</th><th>GD</th><th>Pts</th></tr></thead><tbody>${rows.map(r=>{ const T=byId(r.clubId); return `<tr><td><span class="group-team"><img src="${teamLogoUrl(T)}" alt=""><span>${escapeHtml(T?.name||r.clubId)}</span></span></td><td>${r.P}</td><td>${r.W}</td><td>${r.D}</td><td>${r.L}</td><td>${r.GF}</td><td>${r.GA}</td><td>${r.GD}</td><td>${r.Pts}</td></tr>`; }).join('')}</tbody></table>`;
}

function renderLeagueLeaders(data){
  const wrap = document.getElementById('leagueLeaders');
  const scorers = (data?.scorers||[]).map(r=>{ const T=byId(r.clubId); const club=T?.shortName||T?.name||r.clubId; return `<li>${escapeHtml(r.name)} <span class="muted">(${r.count}) - ${escapeHtml(club)}</span></li>`; }).join('');
  const assisters = (data?.assisters||[]).map(r=>{ const T=byId(r.clubId); const club=T?.shortName||T?.name||r.clubId; return `<li>${escapeHtml(r.name)} <span class="muted">(${r.count}) - ${escapeHtml(club)}</span></li>`; }).join('');
  if (!scorers && !assisters){ wrap.innerHTML = '<div class="muted">No stats yet.</div>'; return; }
  wrap.innerHTML = `<div><div class="muted">Top Scorers</div><ol style="margin-top:6px;padding-left:18px">${scorers||''}</ol></div><div><div class="muted">Top Assisters</div><ol style="margin-top:6px;padding-left:18px">${assisters||''}</ol></div>`;
}

function renderLeagueFixtures(list){
  const el = document.getElementById('leagueFixtures');
  list.sort((a,b)=>(a.when||a.createdAt)-(b.when||b.createdAt));
  el.innerHTML = list.length ? list.map(f=>{ const H=byId(f.home), A=byId(f.away); const hn=H?.name||f.home; const an=A?.name||f.away; const whenTxt=f.when?fmtDate(f.when):'TBD'; const scoreTxt=(f.status==='final')?`${f.score.hs}–${f.score.as}`:'vs'; const banner=getFixtureBanner(); const editBtn = isAdmin ? `<div class="act"><button data-lq="${f.id}">Quick Edit</button></div>` : ''; return `<div class="fx" id="lffx_${f.id}"><div>${banner?`<img class="fx-banner" src="${banner}" alt="">`:''}<div class="fx-vs"><span class="fx-team"><img src="${teamLogoUrl(H)}" alt=""><span>${escapeHtml(hn)}</span></span><span class="muted">${scoreTxt}</span><span class="fx-team"><img src="${teamLogoUrl(A)}" alt=""><span>${escapeHtml(an)}</span></span></div><div class="meta"><span class="chip">UPCL League${f.round?` • ${escapeHtml(f.round)}`:''}</span> • ${whenTxt} • ${escapeHtml(f.status||'')}</div></div>${editBtn}</div>`; }).join('') : `<div class="muted">No league fixtures yet.</div>`;
  list.forEach(f=>{ const q=document.querySelector(`[data-lq="${f.id}"]`); if(q) q.onclick=()=> openResultEditor(f); });
}


function setupLeagueFixtureForm(teamIds){
  const homeSel=document.getElementById('leagueHomeSel');
  const awaySel=document.getElementById('leagueAwaySel');
  const roundInput=document.getElementById('leagueRoundInput');
  const whenInput=document.getElementById('leagueWhenInput');
  const createBtn=document.getElementById('leagueFormCreate');
  if(!homeSel||!awaySel||!createBtn) return;
  const opts=teamIds.map(id=>{ const T=byId(id); return `<option value="${id}">${escapeHtml(T?.name||id)}</option>`; }).join('');
  homeSel.innerHTML=`<option value="">— choose —</option>${opts}`;
  awaySel.innerHTML=`<option value="">— choose —</option>${opts}`;
  function ensureDifferent(){ if(homeSel.value && awaySel.value && homeSel.value===awaySel.value){ alert('Home and away cannot be the same club.'); awaySel.value=''; } }
  homeSel.onchange=ensureDifferent; awaySel.onchange=ensureDifferent;
  createBtn.onclick=async ()=>{
    const home=homeSel.value; const away=awaySel.value; const round=(roundInput.value||'').trim()||'Round';
    const when=whenInput.value?Date.parse(whenInput.value):null;
    if(!home||!away) return alert('Pick both teams');
    try{ await apiPost('/api/cup/fixtures', { home, away, round, cup: LEAGUE_ID, when }); alert('Fixture created'); await loadLeague(); }
    catch(e){ alert('Create failed: '+e.message); }
  };
}

// =======================
//   FRIENDLIES
// =======================
async function loadFriendlies(){
  document.getElementById('frCupId').textContent = FRIENDLIES_ID;

  let fr = { friendly:{ teams:[] } };
  try { fr = await apiGet(`/api/friendlies/${encodeURIComponent(FRIENDLIES_ID)}`); }
  catch {}
  friendliesTeams = fr.friendly?.teams || [];

  try {
    const fx = await apiGet(`/api/cup/fixtures?cup=${encodeURIComponent(FRIENDLIES_ID)}`);
    friendliesFxCache = fx.fixtures || [];
  } catch { friendliesFxCache = []; }
  renderFriendliesFixtures(friendliesFxCache);

  document.getElementById('friendliesAdmin').style.display = isAdmin ? 'block' : 'none';
  if (isAdmin) buildFriendliesAdmin(friendliesTeams);
}

function renderFriendliesFixtures(list){
  const el = document.getElementById('friendliesFixtures');
  list.sort((a,b)=>(a.when||a.createdAt)-(b.when||b.createdAt));
  el.innerHTML = list.length ? list.map(f=>{
    const H=byId(f.home), A=byId(f.away);
    const hn=H?.name||f.home; const an=A?.name||f.away;
    const whenTxt=f.when?fmtDate(f.when):'TBD';
    const scoreTxt=(f.status==='final')?`${f.score.hs}–${f.score.as}`:'vs';
    const banner=getFixtureBanner();
    const editBtn = isAdmin ? `<div class="act"><button data-frq="${f.id}">Quick Edit</button></div>` : '';
    return `<div class="fx" id="frfx_${f.id}"><div>${banner?`<img class="fx-banner" src="${banner}" alt="">`:''}<div class="fx-vs"><span class="fx-team"><img src="${teamLogoUrl(H)}" alt=""><span>${escapeHtml(hn)}</span></span><span class="muted">${scoreTxt}</span><span class="fx-team"><img src="${teamLogoUrl(A)}" alt=""><span>${escapeHtml(an)}</span></span></div><div class="meta"><span class="chip">Friendly${f.round?` • ${escapeHtml(f.round)}`:''}</span> • ${whenTxt} • ${escapeHtml(f.status||'')}</div></div>${editBtn}</div>`;
  }).join('') : `<div class="muted">No friendly fixtures yet.</div>`;
  list.forEach(f=>{ const q=document.querySelector(`[data-frq="${f.id}"]`); if(q) q.onclick=()=> openResultEditor(f); });
}

function buildFriendliesAdmin(teamIds){
  const listEl = document.getElementById('frTeamList');
  listEl.innerHTML = teamIds.length ? teamIds.map(id=>{ const T=byId(id); return `<div style="margin-top:4px"><span>${escapeHtml(T?.name||id)}</span> <button data-remove="${id}">Remove</button></div>`; }).join('') : '<div class="muted">No teams.</div>';
  listEl.querySelectorAll('[data-remove]').forEach(btn=>{
    btn.onclick = async ()=>{
      const id = btn.getAttribute('data-remove');
      const next = teamIds.filter(t=>t!==id);
      try { await apiPost(`/api/friendlies/${FRIENDLIES_ID}/teams`, { teams: next }); await loadFriendlies(); }
      catch(e){ alert('Update failed: '+e.message); }
    };
  });

  const addSel = document.getElementById('frAddSel');
  const addBtn = document.getElementById('frAddBtn');
  const options = teams.filter(t=>!teamIds.includes(t.id)).map(t=>`<option value="${t.id}">${escapeHtml(t.name)} (${t.id})</option>`).join('');
  addSel.innerHTML = `<option value="">— choose —</option>${options}`;
  addBtn.onclick = async ()=>{
    const id = addSel.value; if(!id) return alert('Pick a team');
    const next=[...teamIds,id];
    try{ await apiPost(`/api/friendlies/${FRIENDLIES_ID}/teams`, { teams: next }); await loadFriendlies(); }
    catch(e){ alert('Update failed: '+e.message); }
  };

  const genBtn = document.getElementById('frGenBtn');
  genBtn.onclick = async ()=>{
    if (!confirm('Generate fixtures for all selected teams?')) return;
    try{ await apiPost(`/api/friendlies/${FRIENDLIES_ID}/generate`, {}); alert('Fixtures generated'); await loadFriendlies(); }
    catch(e){ alert('Generate failed: '+e.message); }
  };
}


// =======================
//   NEWS (dynamic; client-side fallback from fixtures)
// =======================
async function loadNews(){
  const wrap = document.getElementById('newsFeed');
  // Try server feed first (if you implemented /api/news). Fallback to client compute.
  try{
    const d = await apiGet('/api/news');
    const items = d.items || [];
    const complete = items.every(n=>n.title && n.body);
    if (complete && items.length){
      wrap.innerHTML = items.map(renderNewsItem).join('');
      return;
    }
  }catch{}
  // Fallback: compute from fixtures (league + CC + friendlies)
  try{
    await refreshFixturesPublic();
    const cc = await apiGet(`/api/cup/fixtures?cup=${encodeURIComponent(CC_ID)}`).catch(()=>({fixtures:[]}));
    const fr = await apiGet(`/api/cup/fixtures?cup=${encodeURIComponent(FRIENDLIES_ID)}`).catch(()=>({fixtures:[]}));
    const computed = await computeNewsFromFixtures([...fixturesPublicCache, ...(cc.fixtures||[]), ...(fr.fixtures||[])]);
    wrap.innerHTML = computed.length ? computed.map(renderNewsItem).join('') : '<div class="muted">No news yet.</div>';
  }catch{ wrap.innerHTML = '<div class="muted">Failed to load news.</div>'; }
}
function renderNewsItem(n){
  const club = byId(n.clubId);
  let title = n.title;
  let body  = n.body;
  if (!title || title===n.clubId){
    if (n.type==='clean_sheet' && club){
      title = `${club.name} clean sheet`;
      body  = `${club.name} keep ${Number(n.score?.hs||0)}-${Number(n.score?.as||0)} shutout`;
    } else if (n.type==='high_scoring'){
      const hn = byId(n.home)?.name || n.home;
      const an = byId(n.away)?.name || n.away;
      title = 'High scoring match';
      body  = `${hn} ${Number(n.score?.hs||0)}-${Number(n.score?.as||0)} ${an}`;
    } else if (n.type==='blowout' && club){
      title = `${club.name} blowout win`;
      body  = `${Number(n.score?.hs||0)}-${Number(n.score?.as||0)} victory`;
    } else if (n.type==='final'){
      const hn = byId(n.home)?.name || n.home;
      const an = byId(n.away)?.name || n.away;
      title = `${hn} ${Number(n.score?.hs||0)}-${Number(n.score?.as||0)} ${an}`;
      body  = 'Full time score';
    }
  }
  title = replaceClubIds(title);
  body  = replaceClubIds(body);
  return `<article class="news-post">
    <img class="news-avatar" src="${teamLogoUrl(club)}" alt="">
    <div class="news-body">
      <div class="news-title">${escapeHtml(title||'')}</div>
      <div>${escapeHtml(body||'')}</div>
      <div class="news-meta">${fmtDate(n.ts)} • ${escapeHtml(n.tag||'')}</div>
    </div>
  </article>`;
}
async function computeNewsFromFixtures(list){
  const out = [];
  const byPlayer = new Map(); // name => { goalStreak, assistStreak, contribStreak, lastAt }
  const tallyGoals = new Map();
  const tallyAssists = new Map();
  const goalTotals = new Map();
  const assistTotals = new Map();
  const now = Date.now();

  const ids = new Set();
  list.forEach(f=>{
    ['home','away'].forEach(side=>{
      (f.details?.[side]||[]).forEach(r=>{ if(!r.player && r.playerId) ids.add(r.playerId); });
    });
  });
  await Promise.all(Array.from(ids).map(id=>resolvePlayerName(id)));

  const finals = list.filter(f=>f.status==='final').sort((a,b)=> (a.when||0)-(b.when||0));
  finals.forEach(f=>{
    const total = Number(f.score?.hs||0)+Number(f.score?.as||0);
    const diff = Math.abs(Number(f.score?.hs||0)-Number(f.score?.as||0));
    if (Number(f.score?.as||0)===0){ out.push({ tag:'Clean Sheet', title:`${byId(f.home)?.name||f.home} clean sheet`, body:`${byId(f.home)?.name||f.home} keep ${Number(f.score.hs||0)}-${Number(f.score.as||0)} shutout`, clubId:f.home, ts:f.when||now }); }
    if (Number(f.score?.hs||0)===0){ out.push({ tag:'Clean Sheet', title:`${byId(f.away)?.name||f.away} clean sheet`, body:`${byId(f.away)?.name||f.away} keep ${Number(f.score.hs||0)}-${Number(f.score.as||0)} shutout`, clubId:f.away, ts:f.when||now }); }
    if (total>=8){ out.push({ tag:'High Scoring', title:'High scoring match', body:`${byId(f.home)?.name||f.home} ${Number(f.score.hs||0)}-${Number(f.score.as||0)} ${byId(f.away)?.name||f.away}`, clubId:'', ts:f.when||now }); }
    if (diff>=5){ const winner = Number(f.score.hs||0)>Number(f.score.as||0) ? f.home : f.away; out.push({ tag:'Blowout', title:`${byId(winner)?.name||winner} blowout win`, body:`${Number(f.score.hs||0)}-${Number(f.score.as||0)} victory`, clubId:winner, ts:f.when||now }); }

    ['home','away'].forEach(side=>{
      (f.details?.[side]||[]).forEach(r=>{
        const name = (r.player && r.player.trim()) || playerNameCache.get(r.playerId) || r.playerId || 'Unknown';
        const g = Number(r.goals||0);
        const a = Number(r.assists||0);
        const rating = Number(r.rating||0);
        const clubId = side==='home'?f.home:f.away;

        if (g===2){ out.push({ tag:'Brace', title:`${name} scores a brace`, body:`${name} struck twice for ${(byId(clubId)?.name)||'their club'} in ${f.round||'League'}.`, clubId, ts:f.when||now }); }
        else if (g===3){ out.push({ tag:'Hattrick', title:`${name} nets a hat-trick!`, body:`${name} scored ${g} for ${(byId(clubId)?.name)||'their club'} in ${f.round||'League'}.`, clubId, ts:f.when||now }); }
        else if (g>=4){ out.push({ tag:'Haul', title:`${name} scores ${g}!`, body:`${name} recorded ${g} goals for ${(byId(clubId)?.name)||'their club'} in ${f.round||'League'}.`, clubId, ts:f.when||now }); }

        if (a===2){ out.push({ tag:'Assist Brace', title:`${name} with two assists`, body:`${name} set up two goals for ${(byId(clubId)?.name)||'their club'} in ${f.round||'League'}.`, clubId, ts:f.when||now }); }
        else if (a>=3){ out.push({ tag:'Assist Hat-trick', title:`${name} assists ${a}`, body:`${name} tallied ${a} assists for ${(byId(clubId)?.name)||'their club'} in ${f.round||'League'}.`, clubId, ts:f.when||now }); }

        if (g>=2 && a>=2){ out.push({ tag:'Big Game', title:`${name} stars with ${g}G/${a}A`, body:`${name} contributed ${g} goals and ${a} assists for ${(byId(clubId)?.name)||'their club'} in ${f.round||'League'}.`, clubId, ts:f.when||now }); }

        if (rating>=9){ out.push({ tag:'High Rating', title:`${name} shines with ${rating}`, body:`${name} earned a ${rating} rating for ${(byId(clubId)?.name)||'their club'}.`, clubId, ts:f.when||now }); }

        const meta = byPlayer.get(name) || { goalStreak:0, assistStreak:0, contribStreak:0, lastAt:0 };
        meta.goalStreak = g>0 ? meta.goalStreak+1 : 0;
        meta.assistStreak = a>0 ? meta.assistStreak+1 : 0;
        meta.contribStreak = (g>0||a>0) ? meta.contribStreak+1 : 0;
        meta.lastAt = f.when||now;
        byPlayer.set(name, meta);

        const goalTotal = (goalTotals.get(name)||0) + g;
        goalTotals.set(name, goalTotal);
        if (g>0 && [1,10,50].includes(goalTotal)){ out.push({ tag:'Milestone', title:`${name} reaches ${goalTotal} goals`, body:`${name} has now scored ${goalTotal} career goals.`, clubId, ts:f.when||now }); }

        const assistTotal = (assistTotals.get(name)||0) + a;
        assistTotals.set(name, assistTotal);
        if (a>0 && [1,10,50].includes(assistTotal)){ out.push({ tag:'Milestone', title:`${name} reaches ${assistTotal} assists`, body:`${name} has now provided ${assistTotal} career assists.`, clubId, ts:f.when||now }); }

        if (g>0) tallyGoals.set(name, (tallyGoals.get(name)||0)+g);
        if (a>0) tallyAssists.set(name, (tallyAssists.get(name)||0)+a);
      });
    });
  });

  for (const [name,meta] of byPlayer.entries()){
    if (meta.goalStreak>=3){ out.push({ tag:'Streak', title:`${name} scoring streak`, body:`${name} has scored in ${meta.goalStreak} consecutive matches.`, clubId:'', ts:meta.lastAt||now }); }
    if (meta.assistStreak>=3){ out.push({ tag:'Streak', title:`${name} assist streak`, body:`${name} has assisted in ${meta.assistStreak} straight matches.`, clubId:'', ts:meta.lastAt||now }); }
    if (meta.contribStreak>=3){ out.push({ tag:'Streak', title:`${name} contribution streak`, body:`${name} has contributed in ${meta.contribStreak} consecutive matches.`, clubId:'', ts:meta.lastAt||now }); }
  }

  const leaders = Array.from(tallyGoals.entries()).sort((a,b)=>b[1]-a[1]).slice(0,3);
  if (leaders.length){ const line = leaders.map(([n,c],i)=>`${i+1}. ${n} (${c})`).join('  '); out.push({ tag:'Leaders', title:'Top Scorers Update', body: line, clubId:'', ts: now }); }
  const assistsLead = Array.from(tallyAssists.entries()).sort((a,b)=>b[1]-a[1]).slice(0,3);
  if (assistsLead.length){ const line = assistsLead.map(([n,c],i)=>`${i+1}. ${n} (${c})`).join('  '); out.push({ tag:'Leaders', title:'Top Assists Update', body: line, clubId:'', ts: now }); }

  out.sort((a,b)=> (b.ts||0) - (a.ts||0));
  return out;
}

// =======================
//   INIT
// =======================
async function init(){

  buildStaticTeams();
  await loadPlayers();
  await checkAdmin();
  await checkMe();

  // default
  setNav('teams');

  await refreshMatches();
  setInterval(async () => { await refreshMatches(); }, 10*60*1000);

  await refreshFixturesPublic(); renderFixturesPublic();
  if (isMgr || isAdmin){ await refreshFixturesSched(); renderFixturesSched(); }
  await loadFA();

  // hash-open team
  try{
    const m = location.hash.match(/team=([^&]+)/);
    if (m){ const team = byId(decodeURIComponent(m[1])); if (team) setTimeout(()=>showTeam(team), 120); }
  }catch{}
}
init();

window.addEventListener('load', () => {
  const introAudio = document.getElementById('introAudio');
  const intro = document.getElementById('intro');

  if (introAudio) {
    const tryPlay = () => introAudio.play().catch(() => {});
    tryPlay();
    document.addEventListener('click', tryPlay, { once: true });
  }

  setTimeout(() => {
    if (intro) {
      intro.classList.add('hidden');
      intro.addEventListener('transitionend', () => {
        intro.remove();
        if (introAudio) {
          introAudio.pause();
          introAudio.remove();
        }
      });
    }
  }, 3000);
});
</script>
</body>
</html>
