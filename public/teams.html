<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>UPCL</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          crimson: '#0f172a',
          midnight: '#02060d',
          gold: '#d4af37',
          silver: '#aeb7c2',
          teal: '#1ec9c3'
        },
        fontFamily: {
          montserrat: ['Montserrat', 'sans-serif']
        },
        boxShadow: {
          'crimson-glow': '0 18px 45px rgba(139, 0, 0, 0.45)'
        }
      }
    }
  };
</script>
<style>
/* === Core palette === */
:root{
  --accent:#1ec9c3;
  --accent-rgb:30,201,195;
  --accent-dark:#041017;
  --accent-soft:#0a1b23;
  --muted:#8b97ab;
  --gold:#d4af37;
  --silver:#aeb7c2;
  --emerald:#34d399;
  --pad:16px;
  --radius:18px;
}
html{scroll-behavior:smooth;}
*{box-sizing:border-box}
html,body{
  margin:0;
  padding:0;
  min-height:100%;
  background:
    radial-gradient(circle at center, #0a0f1c, #000000);
  background-size:cover;
  background-attachment:fixed;
  background-color:#000;
  overflow-x:hidden;
}
body{
  position:relative;
  color:#f6f9ff;
  font-family:'Montserrat',Arial,system-ui,-apple-system,'Segoe UI',sans-serif;
  -webkit-text-size-adjust:100%;
  min-height:100vh;
  background:
    radial-gradient(120% 90% at 50% -15%, rgba(30,201,195,0.25), transparent 65%),
    radial-gradient(85% 70% at 0% 0%, rgba(212,175,55,0.12), transparent 70%),
    linear-gradient(165deg, #020308 0%, #02060d 40%, #010208 100%);
  background-attachment:fixed;
  letter-spacing:0.02em;
  line-height:1.55;
  padding-top:env(safe-area-inset-top);
  padding-bottom:env(safe-area-inset-bottom);
}
a{color:#fdfcfc; text-decoration:none}
img{max-width:100%; display:block}
button{
  font-family:inherit;
  font-weight:600;
  letter-spacing:0.08em;
  text-transform:uppercase;
  background:linear-gradient(135deg, rgba(45,212,191,0.2), rgba(14,23,32,0.92));
  color:#fdfcfc;
  border:1px solid rgba(212,175,55,0.3);
  border-radius:14px;
  padding:10px 16px;
  cursor:pointer;
  transition:transform .25s ease, box-shadow .25s ease, border-color .25s ease, background .25s ease;
  backdrop-filter:blur(6px);
}
button:hover,
button:focus-visible{
  outline:none;
  transform:translateY(-1px);
  border-color:rgba(45,212,191,0.45);
  box-shadow:0 12px 24px rgba(45,212,191,0.22);
}
button:disabled{
  opacity:0.6;
  cursor:not-allowed;
  transform:none;
  box-shadow:none;
}

.glow-card{
  position:relative;
  background:linear-gradient(145deg, rgba(9,13,20,0.94), rgba(4,7,12,0.92));
  border-radius:22px;
  padding:22px;
  border:1px solid rgba(148,163,184,0.24);
  box-shadow:0 22px 45px rgba(0,0,0,0.65);
  overflow:hidden;
  transition:transform .32s cubic-bezier(.21,.72,.35,1), box-shadow .32s ease, border-color .32s ease;
  --glow-rgb:148,163,184;
}
.glow-card::before{
  content:"";
  position:absolute;
  inset:-2px;
  border-radius:inherit;
  background:
    radial-gradient(circle at 18% 12%, rgba(var(--glow-rgb),0.35), transparent 58%),
    radial-gradient(circle at 82% 20%, rgba(94,234,212,0.16), transparent 70%);
  opacity:0.85;
  pointer-events:none;
  transition:opacity .32s ease;
}
.glow-card::after{
  content:"";
  position:absolute;
  inset:1px;
  border-radius:inherit;
  border:1px solid rgba(var(--glow-rgb),0.28);
  mix-blend-mode:screen;
  opacity:0.55;
  pointer-events:none;
  transition:border-color .32s ease, opacity .32s ease;
}
.glow-card > *{position:relative;z-index:1;}
.glow-card:hover,
.glow-card:focus-visible{
  outline:none;
  transform:translateY(-8px) scale(1.02);
  border-color:rgba(var(--glow-rgb),0.55);
  box-shadow:0 28px 65px rgba(0,0,0,0.72), 0 0 32px rgba(var(--glow-rgb),0.45);
}
.glow-card:hover::after,
.glow-card:focus-visible::after{opacity:0.85;border-color:rgba(var(--glow-rgb),0.55);}
.glow-card:hover::before,
.glow-card:focus-visible::before{opacity:1;}

.glow-gold{--glow-rgb:212,175,55;}
.glow-green{--glow-rgb:45,212,191;}
.glow-silver{--glow-rgb:148,163,184;}
body::before{
  content:"";
  position:fixed;
  inset:0;
  z-index:-1;
  background-image:
    linear-gradient(135deg, rgba(30,201,195,0.2) 0%, rgba(6,8,12,0.92) 60%),
    radial-gradient(65% 55% at 15% 10%, rgba(212,175,55,0.18) 0%, transparent 70%),
    radial-gradient(45% 45% at 85% 0%, rgba(65,120,255,0.15) 0%, transparent 65%),
    url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"%3E%3Cdefs%3E%3ClinearGradient id="g" x1="0" y1="0" x2="1" y2="1"%3E%3Cstop offset="0" stop-color="%23ffffff" stop-opacity="0.08"/%3E%3Cstop offset="1" stop-color="%23ffffff" stop-opacity="0"/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width="200" height="200" fill="url(%23g)"/%3E%3C/svg%3E');
  background-size:120% 120%, 120% 120%, 120% 120%, 280px;
  mix-blend-mode:screen;
  opacity:0.32;
  animation: shimmer 18s ease-in-out infinite alternate;
  pointer-events:none;
}
@keyframes shimmer{
  0%{transform:translate3d(-3%, -3%, 0) scale(1.02);}
  100%{transform:translate3d(3%, 4%, 0) scale(1.05);}
}

/* Header / Nav */
header{
  position:sticky;
  top:0;
  z-index:50;
  background:linear-gradient(120deg, rgba(21,0,0,0.82), rgba(0,0,0,0.82));
  backdrop-filter:blur(16px);
  padding:18px clamp(16px,3vw,32px);
  border-bottom:1px solid rgba(212,175,55,0.18);
  box-shadow:0 12px 24px rgba(0,0,0,0.55);
  display:flex;
  align-items:center;
  gap:18px;
}
h1{
  margin:0;
  font-size:24px;
  letter-spacing:0.28em;
  text-transform:uppercase;
  font-weight:700;
}
.site-brand{
  display:flex;
  align-items:center;
  gap:12px;
}
.brand-copy{display:flex;flex-direction:column;gap:4px;}
.site-brand::after{
  content:"";
  width:42px;
  height:2px;
  background:linear-gradient(90deg, rgba(212,175,55,0.6), rgba(45,212,191,0));
  border-radius:999px;
}
.brand-mark{
  width:44px;
  height:44px;
  border-radius:14px;
  background:radial-gradient(circle at 25% 25%, rgba(212,175,55,0.55), rgba(30,201,195,0.6) 58%, rgba(5,8,12,0.9));
  box-shadow:0 0 25px rgba(212,175,55,0.25);
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  color:rgba(255,255,255,0.9);
}
.brand-tagline{
  font-size:12px;
  text-transform:uppercase;
  letter-spacing:0.38em;
  color:rgba(255,255,255,0.58);
}
.navbar{
  margin-left:auto;
  display:flex;
  gap:24px;
  align-items:stretch;
  flex-wrap:nowrap;
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
  scrollbar-width:none;
  padding-bottom:6px;
}
.navbar::-webkit-scrollbar{display:none}
.nav-group{
  display:flex;
  flex-direction:column;
  gap:10px;
  min-width:max-content;
}
.nav-group-label{
  font-size:10px;
  font-weight:700;
  letter-spacing:0.28em;
  text-transform:uppercase;
  color:rgba(255,255,255,0.42);
}
.nav-group-items{
  display:flex;
  gap:8px;
}
.navbar button{
  position:relative;
  display:flex;
  align-items:center;
  gap:8px;
  padding:10px 16px;
  background:linear-gradient(135deg, rgba(14,23,32,0.82), rgba(6,10,16,0.9));
  border:1px solid rgba(94,234,212,0.2);
  border-radius:999px;
  color:#f6f9ff;
  font-weight:600;
  cursor:pointer;
  transition:transform .3s ease, box-shadow .3s ease, border-color .3s ease;
  white-space:nowrap;
  box-shadow:0 8px 22px rgba(15,23,42,0.45);
}
.navbar button::after{
  content:"";
  position:absolute;
  left:16px;
  right:16px;
  bottom:6px;
  height:3px;
  border-radius:999px;
  background:linear-gradient(90deg, rgba(45,212,191,0.65), rgba(212,175,55,0.85));
  transform-origin:left;
  transform:scaleX(0);
  transition:transform .28s ease;
  opacity:0.7;
}
.navbar button:hover::after,
.navbar button:focus-visible::after{transform:scaleX(1);}
.navbar button:hover,
.navbar button:focus-visible{
  outline:none;
  border-color:rgba(45,212,191,0.48);
  box-shadow:0 18px 36px rgba(45,212,191,0.22);
  transform:translateY(-2px);
}
.navbar button[aria-pressed="true"]{
  border-color:rgba(212,175,55,0.65);
  box-shadow:0 18px 36px rgba(212,175,55,0.24);
}
.nav-icon{
  width:18px;
  height:18px;
  color:rgba(212,175,55,0.9);
  display:flex;
}
.nav-icon svg{width:18px;height:18px;}

/* Layout */
main{
  position:relative;
  padding:0;
  max-width:1280px;
  margin:0 auto;
  z-index:1;
  overflow-x:hidden;
}
main::before{
  content:"";
  position:absolute;
  inset:0;
  left:50%;
  right:auto;
  width:calc(100% + min(20vw, 120px));
  transform:translateX(-50%);
  background:
    radial-gradient(75% 45% at 50% 0%, rgba(30,201,195,0.18) 0%, transparent 65%),
    linear-gradient(0deg, rgba(255,255,255,0.02), rgba(255,255,255,0));
  opacity:0.7;
  filter:blur(42px);
  z-index:-1;
  pointer-events:none;
}
h2{margin:0 0 12px;font-size:28px;letter-spacing:0.08em;text-transform:uppercase}
.muted{color:var(--muted)}
.center{text-align:center}
.chip{
  background:linear-gradient(135deg, rgba(45,212,191,0.22), rgba(14,23,32,0.82));
  border:1px solid rgba(45,212,191,0.35);
  color:#f6f9ff;
  border-radius:999px;
  padding:4px 10px;
  font-size:12px;
  letter-spacing:0.1em;
  text-transform:uppercase;
}

/* Home section */
.home-grid{display:grid;gap:16px;margin-top:18px}
.home-card-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  flex-wrap:wrap;
}
.home-card-action{
  font-size:11px;
  padding:6px 12px;
  letter-spacing:0.16em;
  text-transform:uppercase;
  border-radius:999px;
  background:linear-gradient(135deg, rgba(30,201,195,0.18), rgba(8,14,24,0.88));
  border:1px solid rgba(30,201,195,0.38);
  color:#f6f9ff;
  white-space:nowrap;
}
.home-card-action:hover,
.home-card-action:focus-visible{
  border-color:rgba(30,201,195,0.6);
  box-shadow:0 12px 24px rgba(30,201,195,0.18);
}
.home-card-body{margin-top:10px;}

/* Teams grid/cards */
.teams-grid{
  position:relative;
  display:grid;
  gap:24px;
  margin-top:28px;
  padding:8px 4px 28px;
  grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
}
.teams-grid::before{
  content:"";
  position:absolute;
  inset:0;
  background:
    radial-gradient(90% 65% at 50% 0%, rgba(30,201,195,0.2) 0%, transparent 70%),
    radial-gradient(45% 35% at 50% 12%, rgba(148,163,184,0.18) 0%, transparent 70%);
  opacity:0.65;
  filter:blur(40px);
  transform:translateY(-12%);
  pointer-events:none;
  z-index:-1;
}
.team-card{
  padding:22px 22px 20px;
  display:flex;
  flex-direction:column;
  gap:16px;
  color:#f6f9ff;
  cursor:pointer;
  transform-style:preserve-3d;
  border:1px solid rgba(212,175,55,0.18);
  background:linear-gradient(150deg, rgba(10,15,24,0.92), rgba(3,6,12,0.94));
}
.team-card.glow-card:hover,
.team-card.glow-card:focus-visible{
  transform:perspective(800px) rotateX(2deg) translateY(-10px) scale(1.03);
}
.team-card:hover .team-extra,
.team-card:focus-visible .team-extra{
  opacity:1;
  transform:translateY(0);
  max-height:160px;
}

/* Crest & primary metadata */
.team-crest{
  position:relative;
  border-radius:18px;
  background:linear-gradient(135deg, rgba(17,24,39,0.8), rgba(6,11,17,0.92));
  padding:16px;
  box-shadow:inset 0 0 0 1px rgba(148,163,184,0.25), 0 0 24px rgba(30,201,195,0.18);
  flex-shrink:0;
}
.team-logo{
  width:100%;
  aspect-ratio:5/3;
  object-fit:contain;
  border-radius:12px;
  background:linear-gradient(135deg, rgba(20,28,38,0.85), rgba(9,13,20,0.92));
  padding:12px;
}
.team-card-header{
  display:flex;
  flex-direction:column;
  gap:14px;
}
.team-meta{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:12px;
  flex-wrap:wrap;
}
.team-meta .name{
  font-weight:800;
  font-size:19px;
  text-transform:uppercase;
  letter-spacing:0.06em;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.team-meta .record{
  font-size:12px;
  font-weight:700;
  padding:6px 10px;
  border-radius:999px;
  background:linear-gradient(135deg, rgba(45,212,191,0.2), rgba(12,18,28,0.85));
  border:1px solid rgba(45,212,191,0.45);
  letter-spacing:0.14em;
  text-transform:uppercase;
  color:#f6f9ff;
}
.team-country{
  display:flex;
  align-items:center;
  gap:8px;
  margin-top:6px;
  font-size:13px;
  color:rgba(255,255,255,0.76);
  letter-spacing:0.04em;
}
.team-country img{
  width:22px;
  height:22px;
  border-radius:50%;
  box-shadow:0 0 0 2px rgba(0,0,0,0.35);
}
.jersey-swatches{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:12px;
}
.jersey-swatch{
  display:inline-flex;
  align-items:center;
  gap:6px;
  font-size:12px;
  letter-spacing:0.08em;
  text-transform:uppercase;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,0.3);
  background:linear-gradient(135deg, rgba(13,19,28,0.8), rgba(8,12,20,0.9));
  color:var(--silver);
}
.jersey-dot{
  width:12px;
  height:12px;
  border-radius:50%;
  background:var(--gold);
  box-shadow:0 0 10px rgba(212,175,55,0.6);
}
.team-manager{
  display:flex;
  align-items:center;
  gap:8px;
  font-size:13px;
  color:rgba(255,255,255,0.78);
  letter-spacing:0.05em;
}
.team-manager svg{width:16px;height:16px;color:rgba(212,175,55,0.85);}
.team-extra{
  border-top:1px solid rgba(148,163,184,0.22);
  padding-top:12px;
  display:grid;
  gap:6px;
  opacity:0;
  transform:translateY(12px);
  max-height:0;
  transition:opacity .3s ease, transform .3s ease, max-height .3s ease;
  color:rgba(235,242,255,0.72);
  font-size:12px;
  letter-spacing:0.04em;
}
.team-extra strong{color:var(--gold);font-weight:700;}

.teams-empty{
  margin-top:32px;
  padding:28px;
  border-radius:22px;
  border:1px dashed rgba(148,163,184,0.35);
  background:linear-gradient(145deg, rgba(11,15,22,0.9), rgba(5,8,13,0.92));
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:12px;
  color:rgba(235,242,255,0.72);
  text-align:center;
  box-shadow:0 18px 35px rgba(0,0,0,0.55);
}
.teams-empty .empty-icon{
  width:48px;
  height:48px;
  border-radius:16px;
  display:flex;
  align-items:center;
  justify-content:center;
  background:rgba(45,212,191,0.16);
  border:1px solid rgba(45,212,191,0.45);
  color:var(--accent);
  font-size:22px;
}

.leaderboard-table tbody tr{
  border-radius:22px;
  border:1px solid rgba(212,175,55,0.2);
  background:linear-gradient(155deg, rgba(12,18,30,0.92), rgba(4,7,14,0.94));
  box-shadow:0 22px 44px rgba(2,6,12,0.55);
  transition:transform .25s ease, box-shadow .25s ease, border-color .25s ease, background .25s ease;
}
.leaderboard-table tbody tr:hover,
.leaderboard-table tbody tr:focus-within{
  transform:translateY(-2px);
  border-color:rgba(250,204,21,0.45);
  box-shadow:0 26px 52px rgba(2,6,12,0.6);
  background:linear-gradient(155deg, rgba(16,24,38,0.95), rgba(6,10,18,0.97));
}
.leaderboard-table tbody tr td{
  background:transparent;
  border:none;
}
.leaderboard-row{ /* utility hook for JS-generated rows */
  border-radius:22px;
}
@media (max-width:1023px){
  header{flex-direction:column;align-items:flex-start;gap:16px;}
  .site-brand::after{display:none;}
  .navbar{width:100%;gap:18px;}
  .nav-group{min-width:0;}
  .nav-group-items{flex-wrap:wrap;gap:6px;}
  .teams-grid{grid-template-columns:repeat(2,minmax(220px,1fr));gap:20px;}
  .team-card{padding:20px;}
  .team-card-header{flex-direction:row;align-items:center;gap:18px;}
  .team-meta{flex:1;}
  .team-meta .record{margin-top:0;}
  .team-crest{padding:14px;}
}
@media (max-width:768px){
  .navbar{padding-bottom:2px;}
  .navbar button{padding:8px 14px;font-size:12px;}
  .teams-grid{grid-template-columns:1fr;gap:16px;}
  .team-card{padding:16px 18px;gap:14px;}
  .team-card-header{flex-direction:row;align-items:center;gap:16px;}
  .team-crest{width:92px;padding:12px;}
  .team-logo{max-width:80px;margin:0 auto;}
  .team-meta .name{font-size:16px;}
  .team-meta{gap:6px;}
  .team-meta .record{font-size:11px;padding:5px 9px;letter-spacing:0.12em;}
  .team-meta .record{align-self:flex-start;}
  .team-country{margin-top:4px;font-size:12px;}
  .jersey-swatches{margin-top:8px;gap:6px;}
  .jersey-swatch{padding:5px 8px;font-size:10px;}
  .team-manager{font-size:11px;margin-top:4px;}
  #rankingsTableWrap{padding-left:1.25rem;padding-right:1.25rem;overflow-x:visible;}
  .leaderboard-table{border-spacing:0;}
  .leaderboard-table thead{display:none;}
  .leaderboard-table tbody{display:flex;flex-direction:column;gap:16px;}
  .leaderboard-table tbody tr{display:flex;flex-direction:column;padding:18px 16px;gap:8px;}
  .leaderboard-table tbody tr td{display:flex;align-items:center;justify-content:space-between;gap:12px;width:100%;padding:6px 0;font-size:13px;}
  .leaderboard-table tbody tr td::before{content:attr(data-label) ': ';font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.18em;color:rgba(250,204,21,0.75);margin-right:12px;flex:0 0 auto;}
  .leaderboard-table tbody tr td:first-child{padding-top:0;}
  .leaderboard-table tbody tr td:last-child{padding-bottom:0;}
  .leaderboard-table tbody tr td > .pointer-events-none{display:none !important;}
  .brand-tagline{letter-spacing:0.24em;font-size:10px;}
}
@media (max-width:480px){
  .team-card{padding:14px 16px;gap:12px;}
  .team-card-header{gap:14px;}
  .team-crest{width:78px;padding:10px;}
  .team-logo{max-width:72px;}
  .team-meta .name{font-size:15px;}
  .team-meta .record{font-size:10px;padding:4px 8px;letter-spacing:0.1em;}
  .team-country{font-size:11px;}
  .jersey-swatch{padding:4px 7px;font-size:9px;letter-spacing:0.06em;}
  .leaderboard-table tbody tr{padding:16px 14px;}
  .leaderboard-table tbody tr td{font-size:12px;gap:10px;}
  .leaderboard-table tbody tr td::before{font-size:10px;letter-spacing:0.16em;}
}
.players-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  justify-content: center;
  margin-top: 12px; /* pick 12px instead of 10px for consistency */
  width: 100%;
}
.team-card > .players-grid{display:none}
.player-card{position:relative;width:180px;min-height:260px;margin:0 auto;display:flex;flex-direction:column;align-items:center;overflow:hidden}
.player-card img{max-width:100%;object-fit:contain}
.card-frame{width:100%;height:100%;object-fit:cover;border-radius:12px}
.card-overlay{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;padding:12px;color:#fff;text-shadow:0 0 6px black;z-index:3;text-align:center}
.player-silhouette{position:absolute;top:20%;left:50%;transform:translateX(-50%);width:70%;opacity:.85;z-index:1}
.player-kit{position:absolute;top:20%;left:50%;transform:translateX(-50%);width:70%;z-index:2}
.player-kit-box{position:absolute;top:20%;left:50%;transform:translateX(-50%);width:70%;height:70%;z-index:2;border-radius:8px}
.player-overall{font-size:28px;font-weight:900;margin-top:auto}
.player-name{font-size:16px;font-weight:bold;text-align:center}
.player-position{font-size:14px;font-weight:600;margin-bottom:8px;text-align:center}
.player-stats{font-size:12px;display:grid;grid-template-columns:repeat(2,1fr);gap:2px;text-align:left;width:100%}

/* Generic card wrappers */
.m-card{padding:0;}
.m-card.glow-card{padding:24px;}
.m-card strong{font-weight:700;letter-spacing:0.08em;text-transform:uppercase;}
.mini-card{padding:0;}
.mini-card.glow-card{padding:18px;}

/* Squad editor */
.squad-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:18px;margin-top:14px}

/* Fixtures list */
.fx-list{display:flex;flex-direction:column;gap:16px}
.fx{
  display:grid;
  grid-template-columns:1fr auto 1fr;
  gap:12px;
  align-items:center;
  padding:0;
}
.fx.glow-card{padding:20px;}
.fx .meta{font-size:12px;color:var(--muted)}
.fx .act{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end}
.fx button{
  background:linear-gradient(135deg, rgba(45,212,191,0.2), rgba(15,23,42,0.92));
  border:1px solid rgba(45,212,191,0.45);
  color:#f6f9ff;
  border-radius:10px;
  padding:8px 12px;
  cursor:pointer;
  transition:transform .25s ease, box-shadow .25s ease, border-color .25s ease;
}
.fx button:hover,
.fx button:focus-visible{
  outline:none;
  transform:translateY(-2px);
  border-color:rgba(212,175,55,0.55);
  box-shadow:0 12px 24px rgba(212,175,55,0.2);
}
.fx-banner{width:100%;max-height:120px;object-fit:cover;border-radius:8px;margin:6px 0}
.fx-vs{display:flex;align-items:center;gap:10px;font-weight:800}
.fx-team{display:inline-flex;align-items:center;gap:8px;min-width:0}
.fx-team img{width:32px;height:32px;border-radius:50%;object-fit:cover;background:rgba(15,23,42,0.8);box-shadow:0 0 0 2px rgba(45,212,191,0.25)}
.fx-team span{display:inline-block;max-width:160px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

.score-pill{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:4px 12px;
  border-radius:999px;
  font-weight:700;
  letter-spacing:0.08em;
  text-transform:uppercase;
  background:rgba(15,23,42,0.78);
  border:1px solid rgba(148,163,184,0.28);
  color:var(--silver);
}
.score-pill.score-final{color:var(--gold);border-color:rgba(212,175,55,0.45);}
.score-pill.score-upcoming{color:rgba(45,212,191,0.95);border-color:rgba(45,212,191,0.35);}

.match-card{display:flex;flex-direction:column;gap:6px;font-size:16px;padding:0;}
.match-card.glow-card{padding:18px;}
.match-card small{color:var(--muted);}
.match-card .match-line{display:flex;align-items:center;flex-wrap:wrap;gap:6px;justify-content:center;font-weight:600;letter-spacing:0.04em;text-transform:uppercase;}
.match-card .club{color:#f6f9ff;}
.match-card .score{font-weight:800;color:rgba(45,212,191,0.95);font-size:20px;}
.match-card .score.score-gold{color:var(--gold);}
.match-card .score.score-silver{color:var(--silver);}
.match-card .score-pill{margin:0 8px;}

/* Results modal (sheet editor) */
.modal{position:fixed;inset:0;background:rgba(3,6,12,0.85);display:none;align-items:center;justify-content:center;z-index:1000}
.modal.show{display:flex}
.dialog{background:linear-gradient(145deg, rgba(11,15,22,0.94), rgba(5,8,13,0.95));border:1px solid rgba(94,234,212,0.28);border-radius:20px;padding:22px;width:min(960px,96vw);max-height:96vh;overflow:auto;box-shadow:0 28px 60px rgba(0,0,0,0.65)}
.dialog h3{margin:0 0 8px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.sheet{border:1px solid rgba(148,163,184,0.24);border-radius:14px;padding:12px;background:linear-gradient(145deg, rgba(13,19,28,0.85), rgba(8,12,20,0.92));box-shadow:inset 0 0 0 1px rgba(45,212,191,0.08)}
.sheet table{width:100%;border-collapse:collapse}
.sheet th,.sheet td{border-bottom:1px solid rgba(148,163,184,0.15);padding:6px}
.sheet th{font-size:12px;color:var(--muted);text-align:left}
.sheet select,.sheet input, .dialog textarea{width:100%;background:rgba(6,10,16,0.85);color:#f6f9ff;border:1px solid rgba(94,234,212,0.28);border-radius:10px;padding:10px}
/* Ensure numeric inputs in result sheet are wide enough to show values */
.sheet td input[type=number]{
  padding:4px;
  min-width:36px;
  text-align:center;
}
.sheet .row-btns{display:flex;gap:6px}
.dialog .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

/* News feed (social style) */
.news-wrap{display:flex;flex-direction:column;gap:20px;max-width:700px;margin:0 auto}
.news-post{display:flex;gap:16px;font-size:18px;width:100%;padding:0;align-items:center}
.news-post.glow-card{padding:20px;}
.news-avatar{width:52px;height:52px;border-radius:12px;object-fit:cover;background:rgba(15,23,42,0.8);flex:0 0 auto;box-shadow:0 0 0 2px rgba(45,212,191,0.25)}
.news-body{flex:1;text-align:center}
.news-title{font-weight:800;margin-bottom:8px;font-size:20px}
.news-meta{font-size:12px;color:var(--muted);margin-top:6px}

/* Champions Cup groups — compact standings only */
.group-grid{display:grid;gap:16px}
.group-card{padding:0;overflow:hidden}
.group-card.glow-card{padding:18px;}
.group-title{font-weight:800;margin:0 0 10px;letter-spacing:0.08em;text-transform:uppercase}
.group-table{width:100%;border-collapse:collapse;background:linear-gradient(145deg, rgba(9,13,20,0.8), rgba(4,6,12,0.85));border-radius:16px;overflow:hidden}
.group-table th,.group-table td{padding:8px 10px;border-bottom:1px solid rgba(148,163,184,0.16);text-align:right;font-variant-numeric:tabular-nums}
.group-table th{color:rgba(226,232,240,0.9);text-transform:uppercase;font-size:12px;letter-spacing:0.1em;background:rgba(15,23,42,0.75)}
.group-table th:first-child,.group-table td:first-child{text-align:left}
.group-table tbody tr{transition:background .25s ease;}
.group-table tbody tr:hover{background:rgba(45,212,191,0.12)}
.group-table tbody tr td:last-child{font-weight:700;color:rgba(226,232,240,0.9);}
.group-table tbody tr:first-child td:last-child{color:var(--gold);}
.group-table tbody tr:nth-child(2) td:last-child{color:rgba(45,212,191,0.95);}
.group-table tbody tr:nth-child(3) td:last-child{color:var(--silver);}
.standings-table{padding:0;overflow:hidden;border-radius:22px;}
.standings-table.glow-card{padding:0;}
.league-table{width:100%;border-collapse:collapse;background:linear-gradient(145deg, rgba(9,13,20,0.85), rgba(4,6,12,0.88));}
.league-table th,.league-table td{padding:10px 12px;border-bottom:1px solid rgba(148,163,184,0.16);text-align:right;font-variant-numeric:tabular-nums}
.league-table th{color:rgba(226,232,240,0.88);font-size:12px;letter-spacing:0.12em;text-transform:uppercase;background:rgba(15,23,42,0.78)}
.league-table th:first-child,.league-table td:first-child{text-align:center}
.league-table th:nth-child(2),.league-table td:nth-child(2){text-align:left}
.league-table tbody tr{transition:background .25s ease;}
.league-table tbody tr:hover{background:rgba(45,212,191,0.1)}
.league-table .club-name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:160px}
.league-grid{display:grid;grid-template-columns:2fr 1fr;gap:20px;align-items:start}
.podium-list{display:flex;flex-direction:column;gap:12px}
.podium-row{display:flex;align-items:center;gap:8px}
.podium-row .player-card{width:100px;height:140px;flex:0 0 100px}
.podium-info{font-size:14px}
.form-cell{display:flex;gap:4px;justify-content:flex-start}
.form-cell span{width:12px;height:12px;border-radius:50%;box-shadow:0 0 8px rgba(15,23,42,0.45)}
.form-cell span.W{background:var(--emerald)}
.form-cell span.D{background:rgba(148,163,184,0.85)}
.form-cell span.L{background:rgba(239,68,68,0.85)}
.league-table tr.top4{box-shadow:inset 3px 0 0 rgba(45,212,191,0.6)}
.league-table tbody tr td:nth-child(8){font-weight:700;color:rgba(226,232,240,0.9);}
.league-table tbody tr.rank-1 td:nth-child(8){color:var(--gold);}
.league-table tbody tr.rank-2 td:nth-child(8){color:rgba(45,212,191,0.95);}
.league-table tbody tr.rank-3 td:nth-child(8){color:var(--silver);}
.stats-row{display:flex;align-items:center;gap:12px;padding:10px 12px;border-bottom:1px solid rgba(148,163,184,0.12)}
.stats-row .rank-badge{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:50%;background:rgba(148,163,184,0.16);font-weight:700;font-size:13px;color:#f6f9ff;box-shadow:0 0 12px rgba(148,163,184,0.12);}
.stats-row .rank-badge+img{margin-left:4px;}
.stats-row .player-kit,.stats-row .player-silhouette{position:static;transform:none;width:60px;height:auto;flex-shrink:0}
.stats-row .player-kit-box{position:static;transform:none;width:60px;height:60px;border-radius:6px;flex-shrink:0}
.stats-row .info{flex:1;min-width:0;line-height:1.2}
.stats-row .info div:first-child{font-weight:600;font-size:14px}
.stats-row .value{margin-left:auto;font-size:16px;font-weight:700;color:#f6f9ff;text-align:right}
.stats-row[data-rank="1"] .value{color:var(--gold);}
.stats-row[data-rank="2"] .value{color:rgba(45,212,191,0.95);}
.stats-row[data-rank="3"] .value{color:var(--silver);}
.group-team{display:inline-flex;align-items:center;gap:8px}
.group-team img{width:18px;height:18px;border-radius:3px;object-fit:cover}

/* Leaderboards layout */
.leaderboards{display:grid;gap:16px;margin-top:12px}
.leaderboards .m-card strong{display:block;font-size:18px;font-weight:700;margin-bottom:8px;text-align:center}

@media (max-width:768px){
  .standings-table{font-size:14px;overflow-x:auto}
  .standings-table table{min-width:480px}
  .league-grid{display:block}
  .stats-section{display:block}
  .player-card{transform:scale(0.85);margin:8px auto}
  .player-name{font-size:14px}
}

/* Champions Cup bracket */
.bracket-grid{display:grid;gap:16px}
.bracket-card{padding:0;text-align:center}
.bracket-card.glow-card{padding:18px;}
.bracket-match{display:flex;flex-direction:column;gap:4px}
.bracket-vs{font-size:12px;color:var(--muted)}

/* Mobile & small tablets */
@media (max-width: 900px){
  .teams-grid{gap:20px;}
  .fx-team span{max-width:120px}
  .league-grid{grid-template-columns:1fr}
}
@media (max-width: 640px){
  main{padding:14px}
  .team-logo{aspect-ratio:16/9}       /* slightly shorter on phones */
  .teams-grid{gap:14px}
  .news-post{gap:10px}
  .news-avatar{width:42px;height:42px}
  .grid2{grid-template-columns:1fr}   /* modals stack */
  .fx{grid-template-columns:1fr;gap:8px}
  .fx .act{justify-content:flex-start}
}
/* Motion-safe */
@media (prefers-reduced-motion: reduce){
  .team-card,.navbar button{transition:none}
}

/* Intro splash */
#intro{
  position:fixed;
  inset:0;
  background:#000;
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:9999;
  transition:opacity 1s ease;
}
#intro.hidden{opacity:0;pointer-events:none;}
#intro img{max-width:80vw;max-height:80vh;}
</style>
</head>
<body>
<div id="intro">
    <img src="/assets/logos/UPCL.png" alt="League logo">
  <audio id="introAudio" src="/intro.mp3"></audio>
</div>
<header class="flex flex-wrap items-center gap-4 md:gap-6">
  <div class="site-brand">
    <div class="brand-mark">UP</div>
    <div class="brand-copy">
      <h1>UPCL</h1>
      <div class="brand-tagline">United Pro Clubs League</div>
    </div>
  </div>
  <button
    type="button"
    id="navToggle"
    class="ml-auto inline-flex h-10 w-10 items-center justify-center rounded-xl border border-yellow-400/40 bg-black/30 p-2 text-yellow-100 shadow-[0_8px_20px_rgba(15,23,42,0.5)] transition hover:border-yellow-300/70 hover:bg-black/50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-yellow-200/60 md:hidden"
    aria-expanded="false"
    aria-controls="primaryNav"
  >
    <span class="sr-only">Toggle navigation</span>
    <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <line x1="3" y1="6" x2="21" y2="6" />
      <line x1="3" y1="12" x2="21" y2="12" />
      <line x1="3" y1="18" x2="21" y2="18" />
    </svg>
  </button>
  <nav id="primaryNav" class="navbar hidden w-full flex-col gap-6 md:ml-auto md:flex md:w-auto md:flex-row md:items-stretch" aria-label="Primary navigation">
    <div class="nav-group" aria-label="Main">
      <span class="nav-group-label">Main</span>
      <div class="nav-group-items">
        <button type="button" id="navHome" data-view="home" aria-pressed="false">
          <span class="nav-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 10.5 12 3l9 7.5" />
              <path d="M5 11v9h5v-5h4v5h5v-9" />
            </svg>
          </span>
          <span>Home</span>
        </button>
        <button type="button" id="navTeams" aria-pressed="true">
          <span class="nav-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <path d="M7 20v-4a3 3 0 0 1 3-3h4a3 3 0 0 1 3 3v4" />
              <circle cx="12" cy="7" r="3.5" />
            </svg>
          </span>
          <span>Teams</span>
        </button>
        <button type="button" id="navRankings" aria-pressed="false">
          <span class="nav-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 18V5" />
              <path d="M15 18v-8" />
              <path d="M21 18v-4" />
              <path d="M3 18v-2" />
              <path d="M21 20H3" />
            </svg>
          </span>
          <span>Rankings</span>
        </button>
        <button type="button" id="navNews" aria-pressed="false">
          <span class="nav-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4 5h16v14H5.5A1.5 1.5 0 0 1 4 17.5V5z" />
              <path d="M8 9h8" />
              <path d="M8 13h5" />
            </svg>
          </span>
          <span>News</span>
        </button>
        <button type="button" id="navFixturesPublic" aria-pressed="false">
          <span class="nav-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="5" width="18" height="16" rx="2" />
              <path d="M16 3v4" />
              <path d="M8 3v4" />
              <path d="M3 11h18" />
            </svg>
          </span>
          <span>Fixtures</span>
        </button>
        <button type="button" id="navFixturesSched" aria-pressed="false" style="display:none">
          <span class="nav-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 8v5l3 1.5" />
              <circle cx="12" cy="12" r="9" />
            </svg>
          </span>
          <span>Scheduling</span>
        </button>
        <button type="button" id="navLeague" aria-pressed="false">
          <span class="nav-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4 4h16l-1 12-7 4-7-4-1-12z" />
              <path d="m8 11 4 2 4-2" />
            </svg>
          </span>
          <span>League</span>
        </button>
      </div>
    </div>
    <div class="nav-group" aria-label="Tournaments">
      <span class="nav-group-label">Tournaments</span>
      <div class="nav-group-items">
        <button type="button" id="navChampions" aria-pressed="false">
          <span class="nav-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <path d="M5 4h14a2 2 0 0 1 2 2v1a5 5 0 0 1-5 5h-1" />
              <path d="M19 4a5 5 0 0 1-10 0" />
              <path d="M7 4h-.5A1.5 1.5 0 0 0 5 5.5V7a5 5 0 0 0 5 5h1" />
              <path d="M8 15h8" />
              <path d="M9 21h6" />
              <path d="M10 15v6" />
              <path d="M14 15v6" />
            </svg>
          </span>
          <span>Champions Cup</span>
        </button>
        <button type="button" id="navFriendlies" aria-pressed="false">
          <span class="nav-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <path d="M7 11a5 5 0 1 1 5-5" />
              <path d="m12 6.5 3.5 3.5" />
              <path d="M17 11a5 5 0 1 0-5-5" />
              <path d="m12 17-2.5 2.5a2 2 0 0 1-2.83 0L4 16" />
              <path d="m12 17 2.5 2.5a2 2 0 0 0 2.83 0L20 16" />
            </svg>
          </span>
          <span>Friendlies</span>
        </button>
      </div>
    </div>
    <div class="nav-group" aria-label="Admin">
      <span class="nav-group-label">Admin</span>
      <div class="nav-group-items">
        <button type="button" id="btnAdminLogin">
          <span class="nav-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <path d="M12 22a10 10 0 0 0 10-10V7l-10-4L2 7v5a10 10 0 0 0 10 10z" />
              <path d="M8.5 12.5 11 15l4.5-4.5" />
            </svg>
          </span>
          <span>Admin Sign In</span>
        </button>
        <button type="button" id="btnAdminLogout" style="display:none">
          <span class="nav-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4" />
              <path d="M10 17 15 12 10 7" />
              <path d="M15 12H3" />
            </svg>
          </span>
          <span>Admin Sign Out</span>
        </button>
      </div>
    </div>
  </nav>
</header>

<main class="relative mx-auto max-w-6xl px-3 pt-6 pb-16 text-xs sm:px-6 sm:pt-8 sm:pb-20 sm:text-sm md:px-10 md:pt-12 md:pb-24 md:text-base">
  <section id="home" class="tab-content space-y-6 p-2 sm:p-4 md:p-8" style="display:none">
    <div class="home-grid grid grid-cols-1 gap-4 sm:grid-cols-2 xl:grid-cols-3">
      <div class="m-card glow-card glow-green">
        <strong>Match of the Day</strong>
        <div id="homeMotd" class="muted" style="margin-top:6px">Loading…</div>
      </div>
      <div class="m-card glow-card glow-silver">
        <strong>Latest News</strong>
        <div id="homeNews" class="news-wrap" style="margin-top:6px"><div class="muted">Loading…</div></div>
      </div>
      <div class="m-card glow-card glow-silver">
        <strong>Featured Clubs</strong>
        <div id="homeClubs" class="teams-grid grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4" style="margin-top:6px"></div>
      </div>
      <div class="m-card glow-card glow-gold home-card">
        <div class="home-card-header">
          <strong>League Standings</strong>
          <button type="button" id="btnViewFullStandings" class="home-card-action">View Full Standings</button>
        </div>
        <div id="homepage-standings" class="muted home-card-body">Loading…</div>
      </div>
      <div class="m-card glow-card glow-gold home-card">
        <div class="home-card-header">
          <strong>Top Scorers</strong>
          <button type="button" id="btnViewFullTopScorers" class="home-card-action">View Full Top Scorers</button>
        </div>
        <div id="homepage-topscorers" class="muted home-card-body">Loading…</div>
      </div>
    </div>
  </section>
  <!-- TEAMS -->
  <section id="teams-view" aria-live="polite" class="tab-content space-y-6 p-2 sm:p-4 md:p-8">
    <div class="flex flex-wrap items-center justify-between gap-3 sm:gap-4">
      <h2 style="margin:0">Teams</h2>
      <div class="muted">Total teams: <span id="teams-count">0</span></div>
    </div>
    <div class="teams-grid grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4" id="teamsGrid" role="list">
        <div class="team-card glow-card glow-silver" data-club-id="585548" role="listitem">
          <div class="team-card-header">
            <div class="team-crest">
              <img class="team-logo" src="/assets/logos/club-frijol.png" alt="Club Frijol logo" onerror="this.onerror=null;this.src='https://via.placeholder.com/800x480.png?text=Club%20Frijol';" />
            </div>
            <div>
              <div class="team-meta">
                <div>
                  <div class="name">Club Frijol</div>
                  <div class="team-country">
                    <img src="/assets/flags/mx.png" alt="Mexico flag" onerror="this.style.display='none'">
                    <span class="team-country-name">Mexico</span>
                  </div>
                </div>
                <div class="record">0-0-0</div>
              </div>
              <div class="jersey-swatches" aria-label="Jersey colors">
                <span class="jersey-swatch"><span class="jersey-dot" style="background:#8b0000"></span>Home</span>
                <span class="jersey-swatch"><span class="jersey-dot" style="background:#ffffff"></span>Away</span>
              </div>
              <div class="team-manager">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4z" />
                  <path d="M6 21v-2a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v2" />
                </svg>
                <span class="team-manager-name">Manager TBD</span>
              </div>
            </div>
          </div>
          <div class="team-extra">
            <div><strong>Founded:</strong> <span class="team-founded">2020</span></div>
            <div><strong>Record:</strong> <span class="team-extra-record">Updating soon</span></div>
          </div>
          <div class="players-grid"></div>
        </div>
      </div>
      <div id="teamsEmpty" class="teams-empty p-4 sm:p-6 md:p-7" role="status" aria-live="polite" style="display:none">
        <div class="empty-icon">🏟️</div>
        <div>No teams registered yet.</div>
        <small class="muted">Check back after clubs join the competition.</small>
      </div>
    </section>

  <section id="rankings-section" class="tab-content mt-24 space-y-6 p-2 sm:p-4 md:p-8" style="display:none">
    <div class="relative overflow-hidden rounded-3xl border border-yellow-400/40 bg-slate-900/80 shadow-[0_30px_60px_rgba(12,10,5,0.75)]">
      <div class="flex flex-wrap items-center justify-between gap-4 sm:gap-6 border-b border-yellow-300/20 bg-gradient-to-r from-yellow-500/10 via-amber-400/5 to-transparent px-6 py-5">
        <div class="flex flex-col gap-2">
          <p class="text-xl font-semibold tracking-wide text-yellow-50">Rankings Leaderboard</p>
          <p id="rankingsMeta" class="text-xs uppercase tracking-[0.32em] text-yellow-200/70">Generating universal rankings…</p>
        </div>
        <div class="flex items-center gap-4">
          <span id="rankingsCount" class="rounded-full border border-yellow-300/50 bg-yellow-500/20 px-3 py-1 text-xs font-semibold uppercase tracking-[0.24em] text-yellow-50 shadow-[0_0_18px_rgba(250,204,21,0.4)]">0</span>
          <button
            id="rankingsRefresh"
            type="button"
            class="rounded-full border border-yellow-300/40 bg-yellow-500/20 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-yellow-50 shadow-[0_0_25px_rgba(250,204,21,0.35)] transition hover:border-yellow-200/60 hover:bg-yellow-500/30 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-yellow-200/70"
          >
            Refresh
          </button>
        </div>
      </div>
      <div id="rankingsLoading" class="hidden items-center gap-3 px-6 py-10 text-sm font-semibold text-yellow-100">
        <span class="h-4 w-4 animate-spin rounded-full border-2 border-yellow-200/70 border-t-transparent"></span>
        <span>Compiling live rankings across all clubs…</span>
      </div>
      <div id="rankingsEmpty" class="hidden px-6 py-8 text-sm text-yellow-100/80">
        Unable to load player data. Try refreshing in a moment.
      </div>
      <div id="rankingsTableWrap" class="hidden overflow-x-auto px-4 pb-8">
        <table class="leaderboard-table min-w-full border-separate border-spacing-y-3 text-xs text-slate-100 sm:text-sm md:text-base">
          <thead>
            <tr class="text-xs uppercase tracking-[0.32em] text-yellow-200/70">
              <th scope="col" class="px-4 py-3 text-left">Rank</th>
              <th scope="col" class="px-4 py-3 text-left">Player</th>
              <th scope="col" class="px-4 py-3 text-left">Club</th>
              <th scope="col" class="px-4 py-3 text-left">Position</th>
              <th scope="col" class="px-4 py-3 text-left">Points</th>
              <th scope="col" class="px-4 py-3 text-left">Value (USD)</th>
            </tr>
          </thead>
          <tbody id="rankingsTableBody"></tbody>
        </table>
      </div>
    </div>
  </section>
  <div id="teamView" style="display:none"></div>

  <!-- NEWS -->
  <section id="news-view" class="tab-content space-y-6 p-2 sm:p-4 md:p-8" style="display:none">
    <h2>League News</h2>
    <div id="newsFeed" class="news-wrap" style="margin-top:8px">
      <div class="muted">Loading news…</div>
    </div>
  </section>

  <!-- TEAM DETAIL -->
  <section id="detail-view" aria-live="polite" style="display:none">
    <div id="detail-header" style="display:flex;align-items:center;gap:12px;margin-bottom:14px">
      <button id="backBtn">← Back</button>
      <div>
        <div id="detail-title" style="font-size:20px;font-weight:800">Team name</div>
        <div class="muted" id="detail-sub">squad & trophies</div>
      </div>
    </div>

    <div id="teamPanels" class="grid-panels" style="display:grid;grid-template-columns:1fr;gap:12px">
      <div class="m-card glow-card glow-silver">
        <strong>Club Wallet</strong>
        <div id="walletBody" class="muted" style="margin-top:6px">Loading…</div>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button id="btnCollect" style="display:none">Collect daily payout</button>
          <small class="muted" id="walletHint"></small>
        </div>
      </div>

      <div class="m-card glow-card glow-green">
        <strong>Next UPCL Match</strong>
        <div id="nextMatchBody" class="muted" style="margin-top:6px">No scheduled match yet.</div>
      </div>

      <div id="teamResultsPanel" class="m-card glow-card glow-green">
        <strong>Recent Results</strong>
        <div id="teamResultsBody" class="muted" style="margin-top:6px">No finals yet.</div>
      </div>

      <!-- Manual squad editor -->
      <div class="m-card glow-card glow-silver" id="squadPanel">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
          <strong>Squad</strong>
          <div id="squadTools" style="display:none;gap:8px"><button id="btnBootstrapSlots" title="Create S01..S15">Bootstrap slots</button></div>
        </div>
        <div id="squadBody" class="players-grid" style="margin-top:6px"></div>
      </div>
    </div>

    <div id="detail-footer" style="margin-top:18px" class="muted center">
      <small>Manual squads (EA API disabled).</small>
    </div>
  </section>

  <!-- FIXTURES (PUBLIC) -->
  <section id="fixtures-public" class="tab-content space-y-6 p-2 sm:p-4 md:p-8" style="display:none">
    <h2>Fixtures</h2>
    <div id="fixtures" class="fx-list" style="margin-top:10px"></div>
    <div id="fixturesPublicList" class="fx-list" style="margin-top:10px"></div>
  </section>

  <!-- FIXTURES SCHEDULING (MANAGERS/Admins) -->
  <section id="fixtures-sched" class="tab-content space-y-6 p-2 sm:p-4 md:p-8" style="display:none">
    <div class="flex flex-wrap items-center justify-between gap-3 sm:gap-4">
      <h2>Fixtures Scheduling</h2>
      <div class="flex flex-wrap items-center gap-2 sm:gap-3">
        <button data-fxf="upcoming" aria-pressed="true">Upcoming</button>
        <button data-fxf="final" aria-pressed="false">Final</button>
        <button data-fxf="all" aria-pressed="false">All</button>
        <button data-fxf="mine" aria-pressed="false">My club</button>
        <button id="btnCreateFx" style="display:none">Create fixture</button>
      </div>
    </div>
    <div id="fixturesList" class="fx-list" style="margin-top:10px"></div>
  </section>

  <!-- CHAMPIONS CUP -->
  <section id="champions-view" class="tab-content space-y-6 p-2 sm:p-4 md:p-8" style="display:none">
    <div class="flex flex-wrap items-center justify-between gap-3 sm:gap-4">
      <h2>UPCL Champions Cup</h2>
      <div class="chip">Cup ID: <span id="ccCupId"></span></div>
    </div>

    <!-- Groups + tables (names once, standings only) -->
    <div class="m-card glow-card glow-gold" style="margin-top:10px">
      <strong>Groups</strong>
      <div id="ccGroups" class="group-grid grid grid-cols-1 gap-4 sm:grid-cols-2 xl:grid-cols-4" style="margin-top:8px"></div>
    </div>

    <!-- Bracket -->
    <div class="m-card glow-card glow-gold" style="margin-top:10px">
      <strong>Bracket</strong>
      <div id="ccBracket" class="bracket-grid grid grid-cols-1 gap-4 sm:grid-cols-2 xl:grid-cols-3" style="margin-top:8px"></div>
    </div>

    <!-- Leaders -->
    <div class="m-card glow-card glow-green" style="margin-top:10px">
      <strong>Leaders</strong>
      <div id="ccLeaders" class="mt-2 grid grid-cols-1 gap-4 sm:grid-cols-2 xl:grid-cols-3"></div>
    </div>

    <!-- Admin tools (group editor + easy create fixture) -->
    <div class="m-card glow-card glow-silver" id="ccAdmin" style="display:none;margin-top:10px">
      <strong>Admin tools</strong>
      <div class="muted">Assign teams to groups, save groups, and create fixtures.</div>

      <div id="ccManualGroups" style="display:grid;grid-template-columns:repeat(4,minmax(220px,1fr));gap:10px;margin-top:10px"></div>
      <div class="flex flex-wrap gap-3" style="margin-top:8px">
        <button id="ccBtnSaveGroups">Save groups</button>
      </div>

      <hr style="border:none;border-top:1px solid rgba(148,163,184,0.2);margin:12px 0">

      <div>
        <strong>Create Champions Cup fixture</strong>
        <div class="grid2" style="margin-top:8px">
          <div>
            <label class="muted">Home</label>
            <select id="ccHomeSel"></select>
          </div>
          <div>
            <label class="muted">Away</label>
            <select id="ccAwaySel"></select>
          </div>
          <div>
            <label class="muted">Group (optional)</label>
            <select id="ccGroupSel">
              <option value="">— none —</option>
              <option value="A">Group A</option>
              <option value="B">Group B</option>
              <option value="C">Group C</option>
              <option value="D">Group D</option>
            </select>
          </div>
          <div>
            <label class="muted">Stage / Round</label>
            <input id="ccRoundInput" placeholder="e.g., Group A MD1 or Semifinal">
          </div>
          <div>
            <label class="muted">Date & time (optional)</label>
            <input id="ccWhenInput" type="datetime-local">
          </div>
          <div style="align-self:end">
            <button id="ccFormCreate">Create fixture</button>
          </div>
        </div>
      </div>
    </div>

    <!-- CC Fixtures -->
    <div class="m-card glow-card glow-green" style="margin-top:10px">
      <strong>Champions Cup Fixtures</strong>
      <div id="ccFixtures" class="fx-list" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- LEAGUE STANDINGS -->
  <section id="leagueView" class="tab-content space-y-6 p-2 sm:p-4 md:p-8" style="display:none">
    <div class="flex flex-wrap items-center justify-between gap-3 sm:gap-4">
      <h2>League Standings</h2>
      <div id="statsBtnHolderLeague">
        <button id="statsToggleBtn" class="chip">Stats</button>
      </div>
    </div>
    <div class="league-grid">
      <div class="standings-table glow-card glow-gold">
        <div class="overflow-x-auto">
          <table class="league-table min-w-[560px] text-left text-xs sm:text-sm md:text-base">
            <thead>
              <tr><th>#</th><th>Team</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GF</th><th>GA</th><th>GD</th><th>Pts</th></tr>
            </thead>
            <tbody id="league-standings"></tbody>
          </table>
        </div>
      </div>
      <div class="m-card glow-card glow-green">
        <strong>Top Scorers</strong>
        <div id="league-topscorers" class="mt-2 space-y-2">
          <div class="muted">Loading…</div>
        </div>
      </div>
    </div>
  </section>

  <section id="statsView" class="tab-content space-y-6 p-2 sm:p-4 md:p-8" style="display:none">
    <div class="flex flex-wrap items-center justify-between gap-3 sm:gap-4">
      <h2>League Stats</h2>
      <div id="statsBtnHolderStats"></div>
    </div>
    <div class="leaderboards stats-section grid grid-cols-1 gap-4 sm:grid-cols-2 xl:grid-cols-3"></div>
  </section>

  <!-- FRIENDLIES -->
  <section id="friendlies-view" class="tab-content space-y-6 p-2 sm:p-4 md:p-8" style="display:none">
    <div class="flex flex-wrap items-center justify-between gap-3 sm:gap-4">
      <h2>Friendlies</h2>
      <div class="chip">Cup ID: <span id="frCupId"></span></div>
    </div>

    <div class="m-card glow-card glow-green" style="margin-top:10px">
      <strong>Fixtures</strong>
      <div id="friendliesFixtures" class="fx-list" style="margin-top:8px"></div>
    </div>

    <div class="m-card glow-card glow-silver" id="friendliesAdmin" style="display:none;margin-top:10px">
      <strong>Admin tools</strong>
      <div class="muted">Manage friendly teams and generate fixtures.</div>
      <div id="frTeamList" style="margin-top:8px"></div>
      <div class="flex flex-wrap gap-3" style="margin-top:8px">
        <select id="frAddSel"></select>
        <button id="frAddBtn">Add team</button>
      </div>
      <div style="margin-top:8px">
        <button id="frGenBtn">Generate fixtures</button>
      </div>
    </div>
  </section>

</main>

<!-- Result Sheet Modal -->
<div class="modal" id="resultModal" aria-hidden="true">
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="resTitle">
    <h3 id="resTitle">Submit Result</h3>

    <div id="resMeta" class="muted"></div>

    <div class="grid2" style="margin-top:10px">
      <div class="sheet">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
          <strong id="homeTitle">Home</strong>
          <div class="row-btns"><button id="addHomeRow">+ Add row</button></div>
        </div>
        <div class="overflow-x-auto">
          <table id="homeTable" class="min-w-[520px] text-left text-xs sm:text-sm md:text-base" style="margin-top:6px">
            <thead>
              <tr><th style="width:40%">Player</th><th>G</th><th>A</th><th>Rating</th><th>Pos</th><th></th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="sheet">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
          <strong id="awayTitle">Away</strong>
          <div class="row-btns"><button id="addAwayRow">+ Add row</button></div>
        </div>
        <div class="overflow-x-auto">
          <table id="awayTable" class="min-w-[520px] text-left text-xs sm:text-sm md:text-base" style="margin-top:6px">
            <thead>
              <tr><th style="width:40%">Player</th><th>G</th><th>A</th><th>Rating</th><th>Pos</th><th></th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="grid2" style="margin-top:10px">
      <div>
        <label class="muted">Home Score</label>
        <input id="homeScore" type="number" min="0" value="0">
      </div>
      <div>
        <label class="muted">Away Score</label>
        <input id="awayScore" type="number" min="0" value="0">
      </div>
    </div>

    <div style="margin-top:8px">
      <label class="muted">Notes (optional)</label>
      <textarea id="resNotes" rows="3" placeholder="Short match notes or MVPs"></textarea>
    </div>

    <div class="actions">
      <button id="resCancel">Cancel</button>
      <button id="resPasteJson">Admin paste JSON</button>
      <button id="resSubmit">Submit Result</button>
    </div>
  </div>
</div>

<script src="js/home.js"></script>
<script>
// =======================
//   CONFIG / CONSTANTS
// =======================
const API_BASE = '';
const CC_ID = 'UPCL_CC_2025_08'; // current Champions Cup id
const FRIENDLIES_ID = 'UPCL_FRIENDLIES_2025'; // current Friendlies id

let leagueDataCache = null;
let leagueDataPromise = null;

async function fetchLeagueData(force = false){
  if (!force && leagueDataCache) return leagueDataCache;
  if (!leagueDataPromise || force){
    leagueDataPromise = (async () => {
      const [standingsRes, matchesRes, playersRes] = await Promise.all([
        apiGet('/api/league').catch(()=>({ standings: [] })),
        apiGet('/api/matches').catch(()=>({ matches: [] })),
        apiGet('/api/players').catch(()=>({ players: [] }))
      ]);
      const players = Array.isArray(playersRes.players) ? playersRes.players : [];
      const playerStandings = deriveStandingsFromPlayers(players);
      const topScorers = deriveTopScorersFromPlayers(players);
      leagueDataCache = {
        standings: standingsRes.standings || [],
        matches: matchesRes.matches || [],
        players,
        scorers: topScorers,
        playerStandings
      };
      return leagueDataCache;
    })();
  }
  return leagueDataPromise;
}

function deriveStandingsFromPlayers(players){
  const byClub = new Map();
  const toNumber = value => {
    const num = Number(value);
    return Number.isFinite(num) ? num : 0;
  };
  (Array.isArray(players) ? players : []).forEach(player => {
    const rawId = player?.club_id ?? player?.clubId ?? player?.team_id ?? player?.teamId ?? player?.club;
    if (!rawId) return;
    const clubId = String(rawId);
    const entry = byClub.get(clubId) || {
      clubId,
      name: '',
      played: 0,
      wins: 0,
      draws: 0,
      losses: 0,
      goalsFor: 0,
      goalsAgainst: 0,
      points: 0
    };
    if (!entry.name){
      entry.name = player?.club_name || player?.club || player?.team || player?.team_name || '';
    }
    const wins = toNumber(player?.club_wins ?? player?.wins ?? player?.team_wins ?? player?.record_wins);
    const draws = toNumber(player?.club_draws ?? player?.draws ?? player?.team_draws ?? player?.record_draws);
    const losses = toNumber(player?.club_losses ?? player?.losses ?? player?.team_losses ?? player?.record_losses);
    const playedCandidates = [
      player?.club_played,
      player?.club_games_played,
      player?.games_played,
      player?.gamesPlayed,
      player?.matches,
      wins + draws + losses
    ];
    const goalsFor = toNumber(player?.club_goals_for ?? player?.goals_for ?? player?.team_goals_for);
    const goalsAgainst = toNumber(player?.club_goals_against ?? player?.goals_against ?? player?.team_goals_against);
    const points = toNumber(player?.club_points ?? player?.points ?? player?.team_points ?? player?.clubpts);

    if (wins > entry.wins) entry.wins = wins;
    if (draws > entry.draws) entry.draws = draws;
    if (losses > entry.losses) entry.losses = losses;
    const played = playedCandidates
      .map(toNumber)
      .reduce((acc, val) => (val > acc ? val : acc), entry.played);
    if (played > entry.played) entry.played = played;
    if (goalsFor > entry.goalsFor) entry.goalsFor = goalsFor;
    if (goalsAgainst > entry.goalsAgainst) entry.goalsAgainst = goalsAgainst;
    if (points > entry.points) entry.points = points;

    byClub.set(clubId, entry);
  });

  return Array.from(byClub.values()).map(entry => {
    if (!entry.played){
      entry.played = entry.wins + entry.draws + entry.losses;
    }
    return entry;
  });
}

function deriveTopScorersFromPlayers(players){
  const toNumber = value => {
    const num = Number(value);
    return Number.isFinite(num) ? num : 0;
  };
  const normalized = (Array.isArray(players) ? players : []).map(player => {
    const clubId = player?.club_id ?? player?.clubId ?? player?.team_id ?? player?.teamId ?? player?.club;
    const goals = toNumber(player?.goals ?? player?.goal ?? player?.total_goals ?? player?.totalGoals ?? player?.count);
    const name = player?.name || player?.player || player?.player_name || player?.personaName || player?.persona_name || player?.gamertag || player?.displayName || '';
    if (!name) return null;
    return {
      clubId: clubId ? String(clubId) : '',
      name,
      goals
    };
  }).filter(Boolean);

  normalized.sort((a, b) => {
    if (b.goals !== a.goals) return b.goals - a.goals;
    return a.name.localeCompare(b.name);
  });

  return normalized;
}

// Teams
let teams = [];
let staticTeams = [];

function buildStaticTeams(){
  staticTeams = Array.from(document.querySelectorAll('.team-card')).map(card => {
    const id = card.getAttribute('data-club-id');
    const name = card.querySelector('.name').textContent.trim();
    const logo = card.querySelector('.team-logo').getAttribute('src');
    const team = { id, name, logo };
    card.addEventListener('click', () => openTeamView(id));
    return team;
  });
  teams = [...staticTeams];
  leaderboardState.loaded = false;
  leaderboardState.loading = false;
  leaderboardState.players = [];
  leaderboardState.lastUpdated = null;
  if(leaderboardEls.count) leaderboardEls.count.textContent = '0';
  if(leaderboardEls.meta) leaderboardEls.meta.textContent = 'Generating universal rankings…';
  if(leaderboardEls.body) leaderboardEls.body.innerHTML = '';
  leaderboardEls.tableWrap?.classList.add('hidden');
  leaderboardEls.loading?.classList.add('hidden');
  if(leaderboardEls.empty){
    leaderboardEls.empty.classList.add('hidden');
    leaderboardEls.empty.textContent = 'Unable to load player data. Try refreshing in a moment.';
  }
  document.getElementById('teams-count').textContent = teams.length;
  const emptyState = document.getElementById('teamsEmpty');
  if(emptyState){ emptyState.style.display = teams.length ? 'none' : 'flex'; }
}

// helpers
function normalizeId(id){
  return String(id||'').toLowerCase().replace(/[^a-z0-9]+/g,'-');
}
const byId = id => {
  const norm = normalizeId(id);
  return teams.find(t => normalizeId(t.id) === norm);
};
function replaceClubIds(str){
  if(!str) return str;
  return String(str).replace(/[A-Za-z0-9_-]+/g, token => {
    const club = byId(token);
    return club ? club.name : token;
  });
}
function teamLogoUrl(team){ return team?.logo || `https://via.placeholder.com/800x480.png?text=${encodeURIComponent(team?.name||'Club')}`; }
function escapeHtml(s){
  const map = { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' };
  return String(s).replace(/[&<>"']/g, c => map[c]);
}
function fmtMoney(n){ return '₵' + Number(n||0).toLocaleString(); }
function fmtDate(ms){ try{ return new Date(ms).toLocaleString(); } catch{ return ''; } }
function getFixtureBanner(){ return '/assets/ui/fixture-banner.png'; }

const PRO_POSITION_MAP = {
  0:'GK',
  1:'RWB',
  2:'RB',
  3:'CB',
  4:'LB',
  5:'LWB',
  6:'CDM',
  7:'RM',
  8:'CM',
  9:'LM',
  10:'CAM',
  11:'CF',
  12:'RF',
  13:'LF',
  14:'ST',
  15:'LW',
  16:'RW',
  17:'LM',
  18:'RM',
  19:'CB',
  20:'CDM',
  21:'CM',
  22:'CAM',
  23:'ST',
  24:'GK',
  25:'CB',
  26:'LB',
  27:'RB',
  28:'LM',
  29:'RM',
  30:'CDM',
  31:'CAM'
};

const FAVORITE_POSITION_MAP = {
  'forward':'ST',
  'midfielder':'CM',
  'defender':'CB',
  'goalkeeper':'GK'
};

const usdFormatter = new Intl.NumberFormat('en-US', {
  style: 'currency',
  currency: 'USD',
  maximumFractionDigits: 0
});

function numberFrom(value){
  const n = Number(value);
  return Number.isFinite(n) ? n : 0;
}

function resolvePlayerPosition(player){
  const fav = player?.favoritePosition ?? player?.favoriteposition;
  if(fav != null){
    const favKey = String(fav).trim().toLowerCase();
    if(FAVORITE_POSITION_MAP[favKey]){
      return FAVORITE_POSITION_MAP[favKey];
    }
    if(favKey){
      return favKey.toUpperCase();
    }
  }
  const raw = player.position || player.pos || player.proPos || player.proPosition;
  if(raw == null) return '—';
  const str = String(raw).trim();
  if(!str) return '—';
  const lower = str.toLowerCase();
  if(FAVORITE_POSITION_MAP[lower]) return FAVORITE_POSITION_MAP[lower];
  const num = Number(str);
  if(!Number.isNaN(num) && PRO_POSITION_MAP[num]) return PRO_POSITION_MAP[num];
  return str.toUpperCase();
}

function calculatePlayerPoints(player){
  const goals = numberFrom(player.goals);
  const assists = numberFrom(player.assists);
  const matches = numberFrom(player.gamesPlayed ?? player.matches);
  const winRate = numberFrom(player.winRate);
  const rating = numberFrom(player.ratingAve ?? player.rating);
  const tackles = numberFrom(player.tacklesMade ?? player.tackles);
  const cleanSheetsDef = numberFrom(player.cleanSheetsDef ?? player.cleanSheetsAny ?? player.cleanSheets);
  const cleanSheetsGK = numberFrom(player.cleanSheetsGK ?? player.cleanSheetsKeeper ?? player.cleanSheetsGoalie);
  const motm = numberFrom(player.manOfTheMatch ?? player.mom ?? player.motm);
  const redCards = numberFrom(player.redCards ?? player.redCard ?? player.rc);

  const total =
    goals * 5 +
    assists * 4 +
    matches * 2 +
    winRate * 0.5 +
    rating * 10 +
    tackles * 2 +
    cleanSheetsDef * 10 +
    cleanSheetsGK * 20 +
    motm * 10 +
    redCards * -15;

  const precise = Number.isFinite(total) ? Number(total.toFixed(2)) : 0;
  return precise;
}

function prepareLeaderboardPlayer(member){
  const name = member.name || member.playername || member.proName || member.personaName || `Player ${member.playerId || member.playerid || ''}`.trim();
  const clubName = member.clubName || member.club || member.teamName || member.clubname || 'Unknown Club';
  const matches = numberFrom(member.gamesPlayed ?? member.matches);
  const rating = numberFrom(member.ratingAve ?? member.rating);
  const winRate = numberFrom(member.winRate);
  const goals = numberFrom(member.goals);
  const assists = numberFrom(member.assists);
  const tackles = numberFrom(member.tacklesMade ?? member.tackles);
  const cleanSheetsDef = numberFrom(member.cleanSheetsDef ?? member.cleanSheetsAny ?? member.cleanSheets);
  const cleanSheetsGK = numberFrom(member.cleanSheetsGK ?? member.cleanSheetsKeeper ?? member.cleanSheetsGoalie);
  const motm = numberFrom(member.manOfTheMatch ?? member.mom ?? member.motm);
  const redCards = numberFrom(member.redCards ?? member.redCard ?? member.rc);
  const shotSuccess = numberFrom(member.shotSuccessRate ?? member.shotsSuccessRate);
  const passSuccess = numberFrom(member.passSuccessRate ?? member.passsuccessrate);
  const passesMade = numberFrom(member.passesMade ?? member.passesmade);
  const totalPoints = calculatePlayerPoints(member);
  const valueUsd = Math.round(totalPoints * 10000);

  return {
    name,
    clubName,
    position: resolvePlayerPosition(member),
    points: totalPoints,
    value: valueUsd,
    matches,
    rating,
    winRate,
    goals,
    assists,
    tackles,
    cleanSheetsDef,
    cleanSheetsGK,
    motm,
    redCards,
    shotSuccess,
    passSuccess,
    passesMade
  };
}

function formatPoints(points){
  return Number(points || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function formatUsd(value){
  return usdFormatter.format(Math.round(value || 0));
}

async function fetchLeaderboardPlayers(){
  if(!teams.length){
    buildStaticTeams();
  }
  const clubIds = Array.from(new Set(teams.map(t => t && t.id).filter(Boolean)));
  const players = [];
  for (const clubId of clubIds){
    const club = teams.find(t => String(t.id) === String(clubId));
    try{
      const res = await fetch(`/api/ea/clubs/${encodeURIComponent(clubId)}/members`);
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      const list = Array.isArray(data?.members) ? data.members : [];
      list.forEach(member => {
        players.push({ ...member, clubId, clubName: club?.name || `Club ${clubId}` });
      });
    }catch(err){
      console.error('Failed to load members for club', clubId, err);
    }
  }
  return players;
}

function renderLeaderboard(players){
  if(!leaderboardEls.body) return;
  leaderboardEls.body.innerHTML = '';

  if(!players.length){
    leaderboardEls.tableWrap?.classList.add('hidden');
    if(leaderboardEls.empty){
      leaderboardEls.empty.textContent = 'No player data available yet.';
      leaderboardEls.empty.classList.remove('hidden');
    }
    return;
  }

  leaderboardEls.tableWrap?.classList.remove('hidden');
  leaderboardEls.empty?.classList.add('hidden');

  players.forEach((player, index) => {
    const row = document.createElement('tr');
    const baseClass = 'group leaderboard-row relative overflow-hidden rounded-2xl border bg-slate-950/70 backdrop-blur-sm transition-all duration-300 hover:-translate-y-1 hover:border-yellow-300/60 hover:shadow-[0_18px_35px_rgba(250,204,21,0.25)]';
    let topClass = 'border-slate-700/60 shadow-[0_10px_25px_rgba(5,6,12,0.65)]';
    if(index === 0){
      topClass = 'border-yellow-300/90 shadow-[0_0_55px_rgba(250,204,21,0.55)]';
    }else if(index === 1){
      topClass = 'border-slate-200/80 shadow-[0_0_45px_rgba(226,232,240,0.4)]';
    }else if(index === 2){
      topClass = 'border-amber-500/80 shadow-[0_0_45px_rgba(248,166,70,0.4)]';
    }
    row.className = `${baseClass} ${topClass}`;
    row.dataset.rank = String(index + 1);

    const tooltip = `
      <div class="grid grid-cols-2 gap-x-5 gap-y-1">
        <span class="text-yellow-200/70">Matches</span><span class="font-semibold text-yellow-50">${player.matches}</span>
        <span class="text-yellow-200/70">Win Rate</span><span class="font-semibold text-yellow-50">${player.winRate.toFixed(1)}%</span>
        <span class="text-yellow-200/70">Goals</span><span class="font-semibold text-yellow-50">${player.goals}</span>
        <span class="text-yellow-200/70">Assists</span><span class="font-semibold text-yellow-50">${player.assists}</span>
        <span class="text-yellow-200/70">Tackles</span><span class="font-semibold text-yellow-50">${player.tackles}</span>
        <span class="text-yellow-200/70">Clean Sheets DEF</span><span class="font-semibold text-yellow-50">${player.cleanSheetsDef}</span>
        <span class="text-yellow-200/70">Clean Sheets GK</span><span class="font-semibold text-yellow-50">${player.cleanSheetsGK}</span>
        <span class="text-yellow-200/70">MOTM</span><span class="font-semibold text-yellow-50">${player.motm}</span>
        <span class="text-yellow-200/70">Red Cards</span><span class="font-semibold text-yellow-50">${player.redCards}</span>
        <span class="text-yellow-200/70">Pass Success</span><span class="font-semibold text-yellow-50">${player.passSuccess.toFixed(1)}%</span>
        <span class="text-yellow-200/70">Shot Success</span><span class="font-semibold text-yellow-50">${player.shotSuccess.toFixed(1)}%</span>
        <span class="text-yellow-200/70">Passes Made</span><span class="font-semibold text-yellow-50">${player.passesMade}</span>
      </div>
    `;

    row.innerHTML = `
      <td data-label="Rank" class="px-4 py-3 text-sm font-extrabold tracking-wide text-yellow-200/90">${index + 1}</td>
      <td data-label="Player" class="relative px-4 py-3 text-sm font-semibold text-slate-100">
        <div class="flex flex-col gap-1">
          <span>${escapeHtml(player.name)}</span>
          <span class="text-xs font-medium uppercase tracking-[0.24em] text-yellow-200/70">Rating ${player.rating.toFixed(2)} • Win ${player.winRate.toFixed(1)}%</span>
        </div>
        <div aria-hidden="true" class="pointer-events-none absolute left-1/2 top-full z-30 w-[min(320px,80vw)] -translate-x-1/2 -translate-y-3 rounded-2xl border border-yellow-300/30 bg-slate-950/95 px-4 py-3 text-xs text-yellow-50 shadow-[0_28px_55px_rgba(8,8,3,0.9)] opacity-0 transition-all duration-200 group-hover:opacity-100 group-hover:-translate-y-1 group-focus-within:opacity-100 group-focus-within:-translate-y-1">
          ${tooltip}
        </div>
      </td>
      <td data-label="Club" class="px-4 py-3 text-sm font-medium text-slate-200">${escapeHtml(player.clubName)}</td>
      <td data-label="Position" class="px-4 py-3 text-sm font-semibold uppercase tracking-[0.24em] text-yellow-100">${escapeHtml(player.position)}</td>
      <td data-label="Points" class="px-4 py-3 text-sm font-bold text-yellow-200">${formatPoints(player.points)}</td>
      <td data-label="Value (USD)" class="px-4 py-3 text-sm font-bold text-yellow-100">${formatUsd(player.value)}</td>
    `;

    leaderboardEls.body.appendChild(row);
  });
}

async function ensureRankingsLoaded(force){
  if(!leaderboardEls.section) return;
  if(leaderboardState.loading) return;
  if(leaderboardState.loaded && !force){
    renderLeaderboard(leaderboardState.players);
    if(leaderboardEls.meta && leaderboardState.lastUpdated){
      leaderboardEls.meta.textContent = `Updated ${new Date(leaderboardState.lastUpdated).toLocaleString()} • ${leaderboardState.players.length} players ranked`;
    }
    return;
  }

  leaderboardState.loading = true;
  leaderboardEls.loading?.classList.remove('hidden');
  leaderboardEls.empty?.classList.add('hidden');
  leaderboardEls.tableWrap?.classList.add('hidden');

  try{
    const rawPlayers = await fetchLeaderboardPlayers();
    const prepared = rawPlayers.map(prepareLeaderboardPlayer)
      .filter(p => Number.isFinite(p.points))
      .sort((a, b) => b.points - a.points || b.goals - a.goals || b.assists - a.assists || b.rating - a.rating);

    leaderboardState.players = prepared;
    leaderboardState.loaded = true;
    leaderboardState.lastUpdated = Date.now();

    renderLeaderboard(prepared);

    if(leaderboardEls.meta){
      leaderboardEls.meta.textContent = `Updated ${new Date(leaderboardState.lastUpdated).toLocaleString()} • ${prepared.length} players ranked`;
    }
    if(leaderboardEls.count){
      leaderboardEls.count.textContent = prepared.length.toString();
    }
  }catch(err){
    console.error('Failed to compile rankings', err);
    if(leaderboardEls.empty){
      leaderboardEls.empty.textContent = 'Unable to compile the rankings right now. Please try again.';
      leaderboardEls.empty.classList.remove('hidden');
    }
  }finally{
    leaderboardEls.loading?.classList.add('hidden');
    leaderboardState.loading = false;
  }
}

function setupRankings(){
  leaderboardEls = {
    section: document.getElementById('rankings-section'),
    count: document.getElementById('rankingsCount'),
    meta: document.getElementById('rankingsMeta'),
    loading: document.getElementById('rankingsLoading'),
    empty: document.getElementById('rankingsEmpty'),
    tableWrap: document.getElementById('rankingsTableWrap'),
    body: document.getElementById('rankingsTableBody'),
    refresh: document.getElementById('rankingsRefresh')
  };

  if(!leaderboardEls.section) return;

  if(leaderboardEls.refresh){
    leaderboardEls.refresh.addEventListener('click', async ()=>{
      if(leaderboardState.loading) return;
      leaderboardEls.refresh.disabled = true;
      leaderboardEls.refresh.setAttribute('aria-busy','true');
      try{
        await ensureRankingsLoaded(true);
      }finally{
        leaderboardEls.refresh.removeAttribute('aria-busy');
        leaderboardEls.refresh.disabled = false;
      }
    });
  }

  ensureRankingsLoaded(false);
}

let isAdmin = false;
let meUser  = null;
let isMgr   = false;
let rankings = {};
let payouts  = { elite:0, mid:0, bottom:0 };
let fixturesPublicCache = [];
let fixturesSchedCache  = [];
let friendliesFxCache  = [];
let friendliesTeams    = [];
const leaderboardState = { loaded:false, loading:false, players:[], lastUpdated:null };
let leaderboardEls = {};

function normalizeFixtures(list){
  return (Array.isArray(list)?list:[]).map(f=>({
    ...f,
    when: f.when?Number(f.when):f.when,
    createdAt: f.createdAt?Number(f.createdAt):f.createdAt,
    score: f.score || { hs: f.hs, as: f.as }
  }));
}

// api
async function apiGet(p){ const r = await fetch(API_BASE+p,{credentials:'include'}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
async function apiPost(p, body){ const r = await fetch(API_BASE+p,{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(body||{})}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
async function apiPut(p, body){ const r = await fetch(API_BASE+p,{method:'PUT',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(body||{})}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }

// players cache
let playersByClub = {};

const playerNameCache = new Map();
async function resolvePlayerName(id){
  if(!id) return '';
  if(playerNameCache.has(id)) return playerNameCache.get(id);
  for (const arr of Object.values(playersByClub)) {
    const p = arr.find(m => String(m.personaId||m.playerId||m.id) === String(id));
    if (p) {
      const name = p.name || p.playername || p.personaName || '';
      playerNameCache.set(id, name || id);
      return name || id;
    }
  }
  playerNameCache.set(id, id);
  return id;
}

// nav elements
const navHome       = document.getElementById('navHome');
const navTeams      = document.getElementById('navTeams');
const navRankings   = document.getElementById('navRankings');
const navNews       = document.getElementById('navNews');
const navFxPublic   = document.getElementById('navFixturesPublic');
const navFxSched    = document.getElementById('navFixturesSched');
const navChampions  = document.getElementById('navChampions');
const navLeague     = document.getElementById('navLeague');
const navFriendlies = document.getElementById('navFriendlies');
const navToggle     = document.getElementById('navToggle');
const primaryNav    = document.getElementById('primaryNav');

if(navToggle && primaryNav){
  const syncNavForViewport = ()=>{
    if(window.innerWidth >= 768){
      primaryNav.classList.remove('hidden');
      navToggle.setAttribute('aria-expanded','true');
    }else{
      primaryNav.classList.add('hidden');
      navToggle.setAttribute('aria-expanded','false');
    }
  };
  syncNavForViewport();
  window.addEventListener('resize', syncNavForViewport);
  navToggle.addEventListener('click', ()=>{
    if(window.innerWidth >= 768) return;
    const expanded = navToggle.getAttribute('aria-expanded') === 'true';
    navToggle.setAttribute('aria-expanded', String(!expanded));
    primaryNav.classList.toggle('hidden', expanded);
  });
  primaryNav.querySelectorAll('button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(window.innerWidth < 768){
        primaryNav.classList.add('hidden');
        navToggle.setAttribute('aria-expanded','false');
      }
    });
  });
}

const homeView    = document.getElementById('home');
const teamsViewEl = document.getElementById('teams-view');
const rankingsSection = document.getElementById('rankings-section');
const newsView    = document.getElementById('news-view');
const fxPublic    = document.getElementById('fixtures-public');
const fxSched     = document.getElementById('fixtures-sched');
const cupView     = document.getElementById('champions-view');
const leagueView  = document.getElementById('leagueView');
const friendliesView = document.getElementById('friendlies-view');

function setNav(active){
  if (active==='fixturesSched' && !isAdmin) { alert('Admins only'); active='fixturesPublic'; }
  document.querySelectorAll('.tab-content').forEach(el=>el.style.display='none');
  const s = {
    home:[homeView, navHome],
    teams:[teamsViewEl, navTeams],
    news:[newsView, navNews],
    fixturesPublic:[fxPublic, navFxPublic],
    fixturesSched:[fxSched, navFxSched],
    champions:[cupView, navChampions],
    league:[leagueView, navLeague],
    friendlies:[friendliesView, navFriendlies]
  };
  if(rankingsSection){
    s.rankings = [rankingsSection, navRankings];
  }
  for (const key of Object.keys(s)){
    const [view,btn] = s[key];
    const is = key===active;
    if(view && is) view.style.display = 'block';
    if(btn) btn.setAttribute('aria-pressed', String(is));
  }
  if(active==='rankings'){
    ensureRankingsLoaded(false);
  }
}
navHome.onclick        = async ()=>{ setNav('home'); await loadHome(); };
navTeams.onclick       = ()=> { setNav('teams'); ensureRankingsLoaded(false); };
navNews.onclick        = async ()=>{ setNav('news'); await loadNews(); };
navFxPublic.onclick    = ()=> setNav('fixturesPublic');
navFxSched.onclick     = ()=> setNav('fixturesSched');
navChampions.onclick   = async ()=> { setNav('champions'); await loadChampions(); };
navLeague.onclick      = ()=> { setNav('league'); loadLeague(); };
navFriendlies.onclick  = async ()=> { setNav('friendlies'); await loadFriendlies(); };
if(navRankings){
  navRankings.onclick = ()=>{
    setNav('rankings');
  };
}

const btnViewFullStandings = document.getElementById('btnViewFullStandings');
const btnViewFullTopScorers = document.getElementById('btnViewFullTopScorers');
const goToLeagueView = () => {
  if (navLeague) {
    navLeague.click();
  } else {
    setNav('league');
    loadLeague();
  }
};
if (btnViewFullStandings) {
  btnViewFullStandings.addEventListener('click', goToLeagueView);
}
if (btnViewFullTopScorers) {
  btnViewFullTopScorers.addEventListener('click', goToLeagueView);
}

// auth / admin / manager
const btnAdminLogin = document.getElementById('btnAdminLogin');
const btnAdminLogout= document.getElementById('btnAdminLogout');

btnAdminLogin.onclick = async ()=>{
  const pw = prompt('Admin password');
  if (!pw) return;
  try{
    await apiPost('/api/admin/login',{ password: pw });
    await checkAdmin(); await checkMe();
    alert('Admin signed in');
  }catch(e){ alert('Login failed: '+e.message); }
};
btnAdminLogout.onclick = async ()=>{
  try{ await apiPost('/api/admin/logout',{}); }catch{}
  await checkAdmin(); await checkMe();
  alert('Signed out');
};

async function checkAdmin(){
  try{ const d = await apiGet('/api/admin/me'); isAdmin = !!d.admin; }catch{ isAdmin=false; }
  btnAdminLogout.style.display = isAdmin ? 'inline-block' : 'none';
  navFxSched.style.display = isAdmin ? 'inline-block' : 'none';
}
async function checkMe(){
  try { meUser = (await apiGet('/api/auth/me')).user || null; } catch { meUser = null; }
  isMgr = !!(meUser && meUser.role==='Manager');
  navFxSched.style.display = isAdmin ? 'inline-block' : 'none';
}

// =======================
//   TEAMS LIST / DETAIL
// =======================
const teamsGrid = document.getElementById('teamsGrid');
const teamsCount = document.getElementById('teams-count');
const detailView = document.getElementById('detail-view');
const detailTitle = document.getElementById('detail-title');
const detailSub   = document.getElementById('detail-sub');
const backBtn = document.getElementById('backBtn');

function parseVpro(vproattr){
  const parts=String(vproattr||'').split('|').map(n=>parseInt(n,10));
  if(parts.length<27||parts.some(n=>isNaN(n))) return null;
  const avg=a=>Math.round(a.reduce((x,y)=>x+y,0)/a.length);
  const pac=avg([parts[0],parts[1]]);
  const sho=avg([parts[4],parts[5],parts[8],parts[16],parts[17]]);
  const pas=avg([parts[9],parts[19],parts[12],parts[15],parts[13]]);
  const dri=avg([parts[2],parts[3],parts[7],parts[11]]);
  const def=avg([parts[18],parts[10],parts[20],parts[21]]);
  const phy=avg([parts[22],parts[23],parts[24],parts[25],parts[26]]);
  const ovr=Math.round(pac*0.2+sho*0.2+pas*0.2+dri*0.2+def*0.1+phy*0.1);
  return {pac,sho,pas,dri,def,phy,ovr};
}

function tierFromOvr(ovr){
  if(ovr==null) return {frame:'iron_rookie.png',className:'tier-iron'};
  const n=Number(ovr)||0;
  if(n<70) return {frame:'iron_rookie.png',className:'tier-iron'};
  if(n<=84) return {frame:'steel_card.png',className:'tier-steel'};
  if(n<=94) return {frame:'crimson_card.png',className:'tier-crimson'};
  return {frame:'obsidian_elite.png',className:'tier-obsidian'};
}

async function getClubInfo(clubId){
  const res = await fetch(`/api/club-info/${encodeURIComponent(clubId)}`);
  const data = await res.json();
  return data && data[clubId];
}

async function getTeamId(clubId){
  const info = await getClubInfo(clubId);
  return info?.teamId;
}

function getKitUrl(teamId){
  return `https://proclubsdatabase.s3.us-east-2.amazonaws.com/minikits/j0_${teamId}_0.png`;
}

function applyGradient(img, customKit){
  const box = document.createElement('div');
  box.className = 'player-kit-box';
  const colors = [customKit?.kitColor1,customKit?.kitColor2,customKit?.kitColor3,customKit?.kitColor4]
    .filter(Boolean)
    .map(c=>`#${Number(c).toString(16).padStart(6,'0')}`);
  box.style.background = colors.length ? `linear-gradient(45deg, ${colors.join(',')})` : '#666';
  img.replaceWith(box);
}

const clubInfoCache = new Map();
const kitUrlCache = new Map();

async function renderClubKits(clubId, container){
  if(!clubId) return;
  let info = clubInfoCache.get(clubId);
  if(!info){
    try{ info = await getClubInfo(clubId); clubInfoCache.set(clubId, info); }
    catch(e){ info=null; }
  }
  const teamId = info?.teamId;
  const customKit = info?.customKit || {};
  let kitUrl = teamId ? kitUrlCache.get(teamId) : null;
  if(teamId && !kitUrl){
    kitUrl = getKitUrl(teamId);
    kitUrlCache.set(teamId, kitUrl);
  }
  let imgs;
  if(container){
    imgs = container.querySelectorAll(`[data-club-id="${clubId}"] .player-kit`);
    if(!imgs.length) imgs = container.querySelectorAll('.player-kit');
  }else{
    imgs = document.querySelectorAll(`.team-card[data-club-id="${clubId}"] .player-kit`);
  }
  imgs.forEach(img=>{
    if(kitUrl){
      img.src = kitUrl;
      img.onerror = () => applyGradient(img, customKit);
    }else{
      applyGradient(img, customKit);
    }
  });
}

function buildPlayerCard(p, stats, tier){
  const s = stats || {pac:'??',sho:'??',pas:'??',dri:'??',def:'??',phy:'??',ovr:'??'};
  const t = tier || tierFromOvr(stats?stats.ovr:null);
  const card = document.createElement('div');
  card.className = `player-card ${t.className}`;
  if(p.player_id||p.playerId) card.dataset.playerId = String(p.player_id||p.playerId);
  if(p.name) card.dataset.playerName = p.name;
  card.innerHTML = `
    <img src="/assets/cards/${t.frame}" class="card-frame" />
    <img src="/assets/silhouette.png" class="player-silhouette" />
    <img class="player-kit" />
    <div class="card-overlay">
      <div class="player-overall">${s.ovr}</div>
      <div class="player-name">${escapeHtml(p.name||'Unknown')}</div>
      <div class="player-position">${escapeHtml(p.position||'')}</div>
      <div class="player-stats">
        <span>PAC ${s.pac}</span>
        <span>SHO ${s.sho}</span>
        <span>PAS ${s.pas}</span>
        <span>DRI ${s.dri}</span>
        <span>DEF ${s.def}</span>
        <span>PHY ${s.phy}</span>
      </div>
    </div>`;
  return card;
}

function updatePlayerCard(card, stats){
  const tier = tierFromOvr(stats.ovr);
  card.className = `player-card ${tier.className}`;
  const img = card.querySelector('.card-frame');
  if(img) img.src = `/assets/cards/${tier.frame}`;
  const over = card.querySelector('.player-overall');
  if(over) over.textContent = stats.ovr;
  const spans = card.querySelectorAll('.player-stats span');
  const labels = [stats.pac,stats.sho,stats.pas,stats.dri,stats.def,stats.phy];
  spans.forEach((span,i)=>{ span.textContent = `${['PAC','SHO','PAS','DRI','DEF','PHY'][i]} ${labels[i]}`; });
}

async function upgradeClubPlayers(clubId, container){
  try{
    const d = await fetch(`/api/clubs/${encodeURIComponent(clubId)}/player-cards`).then(r=>r.json());
    const grid = container || document.querySelector(`.team-card[data-club-id="${clubId}"] .players-grid`);
    if(!grid) return;
    (d.members||[]).forEach(m=>{
      const id = m.playerId || m.playerid;
      let card = grid.querySelector(`.player-card[data-player-id="${id}"]`);
      if(!card){
        card = Array.from(grid.querySelectorAll('.player-card')).find(el=>el.dataset.playerName === m.name);
      }
      const stats = m.stats;
      if(card && stats) updatePlayerCard(card, stats);
    });
  }catch(e){
    console.error('upgrade failed', e);
  }
}
async function openTeamView(clubId){
  teamsGrid.style.display = 'none';
  const teamView = document.getElementById('teamView');
  teamView.style.display = 'block';
  const team = byId(clubId);
  const name = team ? team.name : ((typeof CLUB_NAMES !== 'undefined' && CLUB_NAMES[clubId]) || 'Unknown Club');
  teamView.innerHTML = `<button id="teamBackBtn">← Back</button>
    <h2>${escapeHtml(name)}</h2>
    <div class="team-wallet">Wallet: TBD</div>
    <div class="players-grid"></div>`;
  document.getElementById('teamBackBtn').addEventListener('click', closeTeamView);
  const grid = teamView.querySelector('.players-grid');
  let members = [];
  try{
    const res = await fetch(`/api/teams/${clubId}/players`);
    const data = await res.json();
    members = data.members || [];
  }catch(e){console.error(e);} 
  members.forEach(m => {
    const stats = m.stats || (m.vproattr
      ? parseVpro(m.vproattr)
      : { pac:'??', sho:'??', pas:'??', dri:'??', def:'??', phy:'??', ovr: m.proOverall || '??' });
    const tier = tierFromOvr(stats.ovr);
    const card = buildPlayerCard({ ...m, position: resolvePlayerPosition(m) }, stats, tier);
    grid.appendChild(card);
  });
  upgradeClubPlayers(clubId, grid);
  renderClubKits(clubId, teamView);
}

function closeTeamView(){
  document.getElementById('teamView').style.display = 'none';
  teamsGrid.style.display = 'grid';
}


async function loadPlayers(){
  try{
    const d = await apiGet('/api/players');
    playersByClub = {};
    (d.players||[]).forEach(p=>{
      const cid = String(p.club_id);
      (playersByClub[cid] ||= []).push(p);
    });
    document.querySelectorAll('.team-card .players-grid').forEach(grid=>{
      grid.innerHTML = '';
    });
  }catch(e){
    console.error('Failed to load players', e);
  }
}

async function showTeam(team){
  window.scrollTo({top:0,behavior:'smooth'});
  document.getElementById('teams-view').style.display='none';
  detailView.style.display='block';
  detailTitle.textContent = team.name;
  detailSub.textContent = 'Loading club info…';

  await renderWallet(team.id);
  await refreshFixturesPublic(); renderNextFor(team.id); renderTeamResults(team.id);
  await loadSquad(team.id);

  detailSub.textContent = 'Club overview';
}

backBtn.addEventListener('click', ()=>{
  detailView.style.display='none';
  teamsViewEl.style.display='block';
  window.scrollTo({top:0,behavior:'smooth'});
});

// Wallet
async function renderWallet(clubId){
  const body = document.getElementById('walletBody');
  const hint = document.getElementById('walletHint');
  const btn = document.getElementById('btnCollect');
  try{
    const d = await apiGet(`/api/wallets/${encodeURIComponent(clubId)}`);
    const w = d.wallet||{}, prev = d.preview||{};
    const per = d.perDay||0;
    body.innerHTML = `
      Balance: <strong>${fmtMoney(w.balance||0)}</strong><br>
      Tier payout: <strong>${fmtMoney(per)}</strong> / day<br>
      Pending payout: <strong>${fmtMoney(prev.amount||0)}</strong> (${prev.days||0} days)
    `;
    const canCollect = meUser && meUser.role==='Manager' && String(meUser.teamId)===String(clubId);
    btn.style.display = canCollect ? 'inline-block' : 'none';
    btn.onclick = async ()=>{
      try{
        const r = await apiPost(`/api/wallets/${encodeURIComponent(clubId)}/collect`,{});
        alert(r.ok ? `Collected ${fmtMoney(r.collected||0)}` : (r.message||'No payout'));
        await renderWallet(clubId);
      }catch(e){ alert('Collect failed: '+e.message); }
    };
    hint.textContent = canCollect ? 'Only the club manager can collect.' : 'Contact an administrator to collect payouts.';
  }catch(e){
    body.textContent = 'Wallet unavailable';
    hint.textContent = '';
    btn.style.display='none';
  }
}

async function loadSquad(clubId){
  const panel = document.getElementById('squadPanel');
  const body  = document.getElementById('squadBody');
  panel.style.display = 'block';
  body.innerHTML = 'Loading…';
  document.getElementById('squadTools').style.display = 'none';
  try{
    let members = playersByClub[clubId] || [];
    if (!members.length){
      const r = await fetch(`/api/clubs/${encodeURIComponent(clubId)}/squad`, {credentials:'include'})
        .then(res => res.ok ? res.json() : { slots: [] })
        .catch(() => ({ slots: [] }));
      members = r.slots
        .filter(s => s.player && (s.player.eaName || s.player.name))
        .map(s => ({ name: s.player.eaName || s.player.name || s.label }));
    }
    if (!members.length){
      body.innerHTML = '<div class="muted">No players registered.</div>';
      return;
    }
    body.innerHTML = '';
    members.forEach(p=>{
      const nameRaw = p.name || p.playername || p.proName || p.personaName;
      const name = nameRaw ? nameRaw : `Unknown_${p.playerId||p.playerid||''}`;
      const pos = p.position || p.pos || '';
      const stats = parseVpro(p.vproattr);
      const t = tierFromOvr(stats?stats.ovr:null);
      const s = stats || {pac:'??',sho:'??',pas:'??',dri:'??',def:'??',phy:'??',ovr:'??'};
      const card = buildPlayerCard({ name, position: pos, playerId: p.playerId||p.playerid }, s, t);
      body.appendChild(card);
    });
    renderClubKits(clubId, body);
  }catch(e){
    if (e.status === 504) {
      body.innerHTML = 'EA API timed out. Try again.';
    } else if (e.status === 502) {
      body.innerHTML = 'EA API request failed.';
    } else {
      body.innerHTML = 'Failed to load squad.';
    }
  }
}

// =======================
//   FIXTURES — PUBLIC
// =======================
const fixturesPublicList = document.getElementById('fixturesPublicList');

async function refreshMatches() {
  try {
    const res = await fetch('/api/matches');
    const { matches } = await res.json();
    renderMatches(matches);
  } catch (err) {
    console.error('Failed to load matches', err);
  }
}

function renderMatches(matches) {
  const container = document.querySelector('#fixtures');
  container.innerHTML = '';
  if (!Array.isArray(matches) || !matches.length) {
    container.innerHTML = '<p>No matches yet.</p>';
    return;
  }
  matches.forEach(m => {
    const teams = Object.values(m.clubs || {}).map(c => ({
      name: c.details?.name || '',
      score: Number(c.goals ?? c.score ?? 0)
    }));
    if (teams.length < 2) return;
    const card = document.createElement('div');
    card.className = 'match-card glow-card glow-green';
    const status = String(m.status || '').toLowerCase();
    const isFinal = status === 'final';
    const homeClass = !isFinal ? 'score score-silver' : (teams[0].score === teams[1].score ? 'score score-silver' : (teams[0].score > teams[1].score ? 'score score-gold' : 'score'));
    const awayClass = !isFinal ? 'score score-silver' : (teams[1].score === teams[0].score ? 'score score-silver' : (teams[1].score > teams[0].score ? 'score score-gold' : 'score'));
    const scoreMarkup = isFinal
      ? `<span class="${homeClass}">${teams[0].score}</span><span class="muted">-</span><span class="${awayClass}">${teams[1].score}</span>`
      : `<span class="score-pill score-upcoming">vs</span>`;
    card.innerHTML = `
      <div class="match-line"><span class="club">${escapeHtml(teams[0].name)}</span>${scoreMarkup}<span class="club">${escapeHtml(teams[1].name)}</span></div>
      <small>${fmtDate(m.timestamp)}</small>
    `;
    container.appendChild(card);
  });
}

async function refreshFixturesPublic(){
  try {
    const d = await apiGet('/api/cup/fixtures?cup=UPCL');
    fixturesPublicCache = normalizeFixtures(d.fixtures);
  } catch { fixturesPublicCache = []; }
}
function renderFixturesPublic(){
  const list = fixturesPublicCache.slice().sort((a,b)=>(a.when||a.createdAt)-(b.when||b.createdAt));
  fixturesPublicList.innerHTML = list.length ? list.map(f=>{
    const banner = getFixtureBanner();
    const H = byId(f.home), A = byId(f.away);
    const hn = H?.name || f.home;
    const an = A?.name || f.away;
    const whenTxt = f.when ? fmtDate(f.when) : 'TBD';
    const isFinal = f.status==='final';
    const scoreTxt = isFinal ? `${f.score.hs}–${f.score.as}` : 'vs';
    const scoreClass = isFinal ? 'score-final' : 'score-upcoming';
    const ccBadge = (f.cup===CC_ID) ? ' • <span class="chip">Champions Cup</span>' : '';
    return `
      <div class="fx glow-card glow-silver">
        <div>
          ${banner ? `<img class="fx-banner" src="${banner}" alt="">` : ''}
          <div class="fx-vs">
            <span class="fx-team"><img src="${teamLogoUrl(H)}" alt=""><span>${escapeHtml(hn)}</span></span>
            <span class="score-pill ${scoreClass}">${scoreTxt}</span>
            <span class="fx-team"><img src="${teamLogoUrl(A)}" alt=""><span>${escapeHtml(an)}</span></span>
          </div>
          <div class="meta">${escapeHtml(f.round||'')}${ccBadge} • ${escapeHtml(whenTxt)} • ${escapeHtml(f.status||'')}</div>
        </div>
      </div>`;
  }).join('') : `<div class="muted">No fixtures yet.</div>`;
}

// Next & recent for team (from public cache)
function nextFor(teamId){
  const now = Date.now();
  return fixturesPublicCache
    .filter(f => (f.home===teamId||f.away===teamId) && f.status!=='final' && f.when && f.when>=now)
    .sort((a,b)=>a.when-b.when)[0];
}
function finalsFor(teamId, n=5){
  return fixturesPublicCache
    .filter(f => f.status==='final' && (f.home===teamId||f.away===teamId))
    .sort((a,b)=>(b.when||b.createdAt)-(a.when||a.createdAt))
    .slice(0,n);
}
function renderNextFor(teamId){
  const el = document.getElementById('nextMatchBody');
  const f = nextFor(teamId);
  if (!f){ el.textContent='No scheduled match yet.'; return; }
  const hn = byId(f.home)?.name || f.home;
  const an = byId(f.away)?.name || f.away;
  el.innerHTML = `<div class="fx-vs"><span class="fx-team"><img src="${teamLogoUrl(byId(f.home))}" alt=""><span>${escapeHtml(hn)}</span></span>
                  <span class="score-pill score-upcoming">vs</span>
                  <span class="fx-team"><img src="${teamLogoUrl(byId(f.away))}" alt=""><span>${escapeHtml(an)}</span></span></div>
                  <div class="muted">${fmtDate(f.when)}</div>`;
}
function renderTeamResults(teamId){
  const el = document.getElementById('teamResultsBody');
  const list = finalsFor(teamId);
  el.innerHTML = list.length ? list.map(f=>{
    const hn = byId(f.home)?.name || f.home;
    const an = byId(f.away)?.name || f.away;
    return `<div><span class="muted">FT</span> <span class="score-pill score-final">${f.score.hs}–${f.score.as}</span> <strong>${escapeHtml(hn)}</strong> vs <strong>${escapeHtml(an)}</strong> • ${fmtDate(f.when||f.createdAt)}</div>`;
  }).join('') : 'No finals yet.';
}

// =======================
//   FIXTURES — SCHEDULING
// =======================
const fixturesList = document.getElementById('fixturesList');
const btnCreateFx  = document.getElementById('btnCreateFx');

btnCreateFx.onclick = async ()=>{
  const home = prompt('Home club ID');
  const away = prompt('Away club ID');
  const round= prompt('Round (e.g., League MD1 or Cup QF)');
  if (!home || !away) return;
  try{
    const d = await apiPost('/api/cup/fixtures', { home, away, round, cup:'UPCL' });
    alert('Created fixture'); await refreshFixturesSched(); renderFixturesSched();
  }catch(e){ alert('Create failed: '+e.message); }
};

document.querySelectorAll('[data-fxf]').forEach(btn=>{
  btn.onclick = ()=>{
    document.querySelectorAll('[data-fxf]').forEach(b=>b.setAttribute('aria-pressed','false'));
    btn.setAttribute('aria-pressed','true');
    renderFixturesSched();
  };
});

async function refreshFixturesSched(){
  if (!isAdmin) { fixturesSchedCache=[]; return; }
  try {
    const d = await apiGet('/api/cup/fixtures/scheduling?cup=UPCL');
    fixturesSchedCache = d.fixtures || [];
  } catch {
    fixturesSchedCache = [];
  }
}
function filterKey(){
  const active = [...document.querySelectorAll('[data-fxf]')].find(b=>b.getAttribute('aria-pressed')==='true');
  return active ? active.getAttribute('data-fxf') : 'upcoming';
}
function renderFixturesSched(){
  const key = filterKey();
  let list = fixturesSchedCache.slice();
  const now = Date.now();

  if (key==='upcoming'){
    list = list.filter(f => f.status!=='final' && (!f.when || f.when>=now));
  } else if (key==='final'){
    list = list.filter(f => f.status==='final');
  } else if (key==='mine' && meUser){
    list = list.filter(f => f.home===meUser.teamId || f.away===meUser.teamId);
  }

  list.sort((a,b)=>(a.when||a.createdAt)-(b.when||b.createdAt));
  fixturesList.innerHTML = list.length ? list.map(renderFxSchedRow).join('') : `<div class="muted">No fixtures.</div>`;

  // wire buttons
  list.forEach(f=>{
    const root = document.getElementById('fx_'+f.id);
    if (!root) return;
    const btnProp = root.querySelector('.act .prop');
    if (btnProp) btnProp.onclick = async ()=>{
      if (!isAdmin) return alert('Admins only');
      const atStr = prompt('Propose time (e.g., 2025-08-20 20:30)');
      if (!atStr) return;
      const at = Date.parse(atStr);
      if (!at) return alert('Could not parse date');
      try{ await apiPost(`/api/cup/fixtures/${f.id}/propose`, { at }); await refreshFixturesSched(); renderFixturesSched(); }
      catch(e){ alert('Propose failed: '+e.message); }
    };

    const btnAgree = root.querySelector('.act .agree');
    if (btnAgree) btnAgree.onclick = async ()=>{
      if (!isAdmin) return alert('Admins only');
      const at = root.querySelector('select[name="slot"]').value;
      if (!at) return alert('Pick a proposed slot first');
      try{ await apiPost(`/api/cup/fixtures/${f.id}/vote`, { at, agree:true }); await refreshFixturesSched(); renderFixturesSched(); await refreshFixturesPublic(); renderFixturesPublic(); }
      catch(e){ alert('Vote failed: '+e.message); }
    };

    const btnDecl = root.querySelector('.act .decl');
    if (btnDecl) btnDecl.onclick = async ()=>{
      if (!isAdmin) return alert('Admins only');
      const at = root.querySelector('select[name="slot"]').value;
      if (!at) return alert('Pick a proposed slot first');
      try{ await apiPost(`/api/cup/fixtures/${f.id}/vote`, { at, agree:false }); await refreshFixturesSched(); renderFixturesSched(); }
      catch(e){ alert('Vote failed: '+e.message); }
    };

    const btnQuick = root.querySelector('.act .quick');
    if (btnQuick) btnQuick.onclick = ()=> openResultEditor(f);

    const btnJson = root.querySelector('.act .json');
    if (btnJson) btnJson.onclick = async ()=>{
      if (!isAdmin) return alert('Admin only');
      const hs = Number(prompt('Home score (hs)')||0);
      const as = Number(prompt('Away score (as)')||0);
      const template = JSON.stringify({
        details:{
          home:[{ player:"Player A", goals:1, assists:0, rating:9.5, position:"ST" }],
          away:[{ player:"Player B", goals:2, assists:0, rating:8.7, position:"CB" }]
        }
      }, null, 2);
      const raw = prompt('Paste JSON (or edit the template):', template);
      if (!raw) return;
      try{
        const obj = JSON.parse(raw);
        await apiPost(`/api/cup/fixtures/${f.id}/report`, { hs, as, details: obj.details || obj });
        document.querySelectorAll('[data-fxf]').forEach(x=>x.setAttribute('aria-pressed','false'));
        document.querySelector('[data-fxf="final"]').setAttribute('aria-pressed','true');
        await refreshFixturesSched(); renderFixturesSched();
        await refreshFixturesPublic(); renderFixturesPublic();
      }catch(e){ alert('JSON upload failed: '+e.message); }
    };
  });
}

function renderFxSchedRow(f){
  const H = byId(f.home), A = byId(f.away);
  const hn = H?.name || f.home;
  const an = A?.name || f.away;
  const whenTxt = f.when ? fmtDate(f.when) : 'TBD';
  const props = (f.proposals||[]).map(p=>{
    const who = (teams.find(t=>String(t.id)===String(p.by))?.name) || p.by || 'unknown';
    return `<option value="${p.at}">${fmtDate(p.at)} — proposed by ${escapeHtml(who)}</option>`;
  }).join('');
  const status = f.status || 'pending';
  const hs = Number(f.score?.hs ?? f.hs ?? 0);
  const as = Number(f.score?.as ?? f.as ?? 0);
  const isFinal = status === 'final';
  const scoreTxt = isFinal ? `${hs}–${as}` : 'vs';
  const scoreClass = isFinal ? 'score-final' : 'score-upcoming';
  const adminBtns = isAdmin ? `<button class="json">Admin JSON</button>` : '';
  const banner = getFixtureBanner();
  return `
  <div class="fx glow-card glow-silver" id="fx_${f.id}">
    <div>
      ${banner ? `<img class="fx-banner" src="${banner}" alt="">` : ''}
      <div class="fx-vs">
        <span class="fx-team"><img src="${teamLogoUrl(H)}" alt=""><span>${escapeHtml(hn)}</span></span>
        <span class="score-pill ${scoreClass}">${scoreTxt}</span>
        <span class="fx-team"><img src="${teamLogoUrl(A)}" alt=""><span>${escapeHtml(an)}</span></span>
      </div>
      <div class="meta">Round: ${escapeHtml(f.round||'')} • When: ${escapeHtml(whenTxt)} • Status: <span class="chip">${escapeHtml(status)}</span></div>
    </div>
    <div class="center">
      ${(f.proposals||[]).length ? `<label>Proposals</label><br><select name="slot">${props}</select>` : `<span class="muted">No proposals</span>`}
    </div>
    <div class="act">
      <button class="prop">Propose</button>
      <button class="agree">Agree</button>
      <button class="decl">Decline</button>
      <button class="quick">Quick Edit</button>
      ${adminBtns}
    </div>
  </div>`;
}

// =======================
//   RESULT SHEET MODAL
// =======================
const resultModal = document.getElementById('resultModal');
const resCancel = document.getElementById('resCancel');
const resSubmit = document.getElementById('resSubmit');
const resPasteJson = document.getElementById('resPasteJson');
let activeFixture = null;

resCancel.onclick = ()=>{ resultModal.classList.remove('show'); resultModal.setAttribute('aria-hidden','true'); };

function rowHtml(playersOptions){
  return `<tr>
    <td>
      <select class="playerSel">
        <option value="">— select player —</option>
        ${playersOptions}
      </select>
      <input class="playerCustom" placeholder="or type a name" style="margin-top:6px">
    </td>
    <td><input class="g" type="number" min="0" value="0"></td>
    <td><input class="a" type="number" min="0" value="0"></td>
    <td><input class="r" type="number" min="0" step="0.1" value="0"></td>
    <td><input class="pos" placeholder="e.g., ST"></td>
    <td><button class="rm">✕</button></td>
  </tr>`;
}

function toOptions(slots){
  const pts = (slots||[]).map(s=>{
    const p = s.player;
    const label = p?.eaName || '';
    const id = s.playerId || '';
    if (!id && !label) return '';
    return `<option value="${escapeHtml(id)}">${escapeHtml(label)}${id?` (#${id.slice(0,6)})`:''}</option>`;
  }).join('');
  return pts;
}

async function openResultEditor(f){
  activeFixture = f;
  document.getElementById('resTitle').textContent = `Submit Result — ${byId(f.home)?.name || f.home} vs ${byId(f.away)?.name || f.away}`;
  document.getElementById('resMeta').textContent = `${fmtDate(f.when||Date.now())} • ${f.round||''}`;

  const homeSlots = await fetch(`/api/clubs/${encodeURIComponent(f.home)}/squad`, {credentials:'include'}).then(r=>r.ok?r.json():{slots:[]}).catch(()=>({slots:[]}));
  const awaySlots = await fetch(`/api/clubs/${encodeURIComponent(f.away)}/squad`, {credentials:'include'}).then(r=>r.ok?r.json():{slots:[]}).catch(()=>({slots:[]}));

  const homeOpts = toOptions(homeSlots.slots);
  const awayOpts = toOptions(awaySlots.slots);

  const HT = document.querySelector('#homeTable tbody');
  const AT = document.querySelector('#awayTable tbody');
  HT.innerHTML=''; AT.innerHTML='';
  // start with 3 rows each
  for (let i=0;i<3;i++){ HT.insertAdjacentHTML('beforeend', rowHtml(homeOpts)); }
  for (let i=0;i<3;i++){ AT.insertAdjacentHTML('beforeend', rowHtml(awayOpts)); }

  document.getElementById('homeTitle').textContent = `Home — ${byId(f.home)?.name || f.home}`;
  document.getElementById('awayTitle').textContent = `Away — ${byId(f.away)?.name || f.away}`;

  document.getElementById('homeScore').value = f.score?.hs ?? 0;
  document.getElementById('awayScore').value = f.score?.as ?? 0;
  document.getElementById('resNotes').value = f.report?.text || '';

  const wireTable = (tbody)=> tbody.querySelectorAll('.rm').forEach(btn=> btn.onclick = ()=> btn.closest('tr')?.remove());
  wireTable(HT); wireTable(AT);

  document.getElementById('addHomeRow').onclick = ()=>{ HT.insertAdjacentHTML('beforeend', rowHtml(homeOpts)); wireTable(HT); };
  document.getElementById('addAwayRow').onclick = ()=>{ AT.insertAdjacentHTML('beforeend', rowHtml(awayOpts)); wireTable(AT); };

  resPasteJson.onclick = async ()=>{
    if (!isAdmin) return alert('Admin only');
    const hs = Number(prompt('Home score (hs)')||0);
    const as = Number(prompt('Away score (as)')||0);
    const template = JSON.stringify({
      details:{
        home:[{ player:"Player A", goals:1, assists:0, rating:9.5, position:"ST" }],
        away:[{ player:"Player B", goals:2, assists:0, rating:8.7, position:"CB" }]
      }
    }, null, 2);
    const raw = prompt('Paste JSON (or edit the template):', template);
    if (!raw) return;
    try{
      const obj = JSON.parse(raw);
      await apiPost(`/api/cup/fixtures/${f.id}/report`, { hs, as, details: obj.details || obj });
      alert('Saved');
      resultModal.classList.remove('show'); resultModal.setAttribute('aria-hidden','true');
      await refreshFixturesSched(); renderFixturesSched();
      await refreshFixturesPublic(); renderFixturesPublic();
      await loadChampions();
    }catch(e){ alert('JSON upload failed: '+e.message); }
  };

  resSubmit.onclick = async ()=>{
    const rowsToDetails = (tbody)=> {
      const out = [];
      tbody.querySelectorAll('tr').forEach(tr=>{
        const playerId = (tr.querySelector('.playerSel')?.value||'').trim();
        const custom   = (tr.querySelector('.playerCustom')?.value||'').trim();
        const goals = Number(tr.querySelector('.g')?.value||0);
        const assists = Number(tr.querySelector('.a')?.value||0);
        const rating = Number(tr.querySelector('.r')?.value||0);
        const pos = (tr.querySelector('.pos')?.value||'').trim();
        if (!playerId && !custom && !goals && !assists && !rating) return; // empty row
        out.push({ playerId, player: custom, goals, assists, rating, position: pos });
      });
      return out;
    };
    const details = {
      home: rowsToDetails(document.querySelector('#homeTable tbody')),
      away: rowsToDetails(document.querySelector('#awayTable tbody')),
    };
    const hs = Number(document.getElementById('homeScore').value||0);
    const as = Number(document.getElementById('awayScore').value||0);
    const text = document.getElementById('resNotes').value||'';
    try{
      await apiPost(`/api/cup/fixtures/${activeFixture.id}/report`, { hs, as, text, details });
      alert('Result submitted');
      resultModal.classList.remove('show'); resultModal.setAttribute('aria-hidden','true');
      await refreshFixturesSched(); renderFixturesSched();
      await refreshFixturesPublic(); renderFixturesPublic();
      await loadChampions();
    }catch(e){ alert('Submit failed: '+e.message); }
  };

  resultModal.classList.add('show'); resultModal.setAttribute('aria-hidden','false');
}

// =======================
//   CHAMPIONS CUP
// =======================
async function loadChampions(){
  document.getElementById('ccCupId').textContent = CC_ID;

  // groups
  let cupData = { cup:{ groups:{A:[],B:[],C:[],D:[]} } };
  try {
    cupData = await apiGet(`/api/champions/${encodeURIComponent(CC_ID)}`);
  } catch(e) {
    console.warn('Champions fetch failed:', e.message);
  }

  // cc fixtures
  let ccList = [];
  try {
    const fx = await apiGet(`/api/cup/fixtures?cup=${encodeURIComponent(CC_ID)}`);
    ccList = normalizeFixtures(fx.fixtures || []);
  } catch {}

  renderCcGroups(cupData.cup.groups, ccList);
  renderCcFixtures(ccList);

  // leaders
  try {
    const leaders = await apiGet(`/api/champions/${encodeURIComponent(CC_ID)}/leaders`);
    renderCcLeaders(leaders);
  } catch {}

  // bracket
  renderCcBracket(cupData.cup.groups, ccList);

  // admin panel
  document.getElementById('ccAdmin').style.display = isAdmin ? 'block' : 'none';
  if (isAdmin) buildManualGroupsEditor(cupData.cup.groups);
}
function renderCcGroups(groups, fixtures){
  const el = document.getElementById('ccGroups');
  const tables = computeGroupTablesClient(groups, fixtures); // client fallback for standings
  el.innerHTML = ['A','B','C','D'].map(g=>{
    const rows = (tables[g]||[]).map(r=>{
      const T = byId(r.clubId);
      return `<tr>
        <td><span class="group-team"><img src="${teamLogoUrl(T)}" alt=""><span>${escapeHtml(T?.name||r.clubId)}</span></span></td>
        <td>${r.P}</td><td>${r.W}</td><td>${r.D}</td><td>${r.L}</td><td>${r.GD}</td><td>${r.Pts}</td>
      </tr>`;
    }).join('');
    return `
      <div class="group-card glow-card glow-gold mini-card">
        <div class="group-title">Group ${g}</div>
        <div class="overflow-x-auto">
          <table class="group-table w-full min-w-[420px] text-xs sm:text-sm md:text-base">
            <thead><tr><th>Club</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GD</th><th>Pts</th></tr></thead>
            <tbody>${rows||''}</tbody>
          </table>
        </div>
      </div>`;
    }).join('');
  }
function computeGroupTablesClient(groups, fixtures){
  // derive from provided fixtures + public cache
  const table = { A:{}, B:{}, C:{}, D:{} };
  const touch = (g,id)=> table[g][id] = table[g][id] || { clubId:id, P:0, W:0, D:0, L:0, GF:0, GA:0, GD:0, Pts:0 };
  ['A','B','C','D'].forEach(g=> (groups[g]||[]).forEach(id=> touch(g,id)));

  const merged = []
    .concat(Array.isArray(fixtures) ? fixtures : [])
    .concat(fixturesPublicCache || [])
    .filter(f=>f.cup===CC_ID && f.status==='final');

  merged.forEach(f=>{
    const g = f.group || null; if(!g || !table[g]) return;
    touch(g, f.home); touch(g, f.away);
    const H = table[g][f.home], A = table[g][f.away];
    const hs = Number(f.score?.hs||0), as = Number(f.score?.as||0);
    H.P++; A.P++;
    H.GF+=hs; H.GA+=as; H.GD=H.GF-H.GA;
    A.GF+=as; A.GA+=hs; A.GD=A.GF-A.GA;
    if(hs>as){ H.W++; H.Pts+=3; A.L++; }
    else if(hs<as){ A.W++; A.Pts+=3; H.L++; }
    else { H.D++; A.D++; H.Pts++; A.Pts++; }
  });
  const sorted = {};
  ['A','B','C','D'].forEach(g=>{
    sorted[g] = Object.values(table[g]).sort((x,y)=>(y.Pts-x.Pts)||(y.GD-x.GD)||(y.GF-x.GF));
  });
  return sorted;
  }

  function renderCcBracket(groups, fixtures){
    const el = document.getElementById('ccBracket');
    if (!el) return;
    const tables = computeGroupTablesClient(groups, fixtures);
    const top = g => (tables[g] && tables[g][0]) ? tables[g][0].clubId : '';
    const winners = { A: top('A'), B: top('B'), C: top('C'), D: top('D') };

    const semiList = fixtures.filter(f => String(f.round || '').toLowerCase().includes('semi'));
    const finalFx = fixtures.find(f => {
      const r = String(f.round || '').toLowerCase();
      return r === 'final' || (r.includes('final') && !r.includes('semi'));
    }) || null;

    const makeSemi = (home, away) => ({ home, away, status:'pending', score:{ hs:0, as:0 } });
    const semi1 = semiList[0] || makeSemi(winners.A, winners.B);
    const semi2 = semiList[1] || makeSemi(winners.C, winners.D);
    const finalMatch = finalFx || { home:'Winner SF1', away:'Winner SF2', status:'pending', score:{ hs:0, as:0 } };

    const teamHtml = id => {
      const T = byId(id);
      const name = T?.name || id;
      const logo = T ? `<img src="${teamLogoUrl(T)}" alt="">` : '';
      return `<span class="group-team">${logo}<span>${escapeHtml(name)}</span></span>`;
    };
    const matchHtml = f => {
      const scoreTxt = (f.status === 'final') ? `${f.score.hs}-${f.score.as}` : 'vs';
      return `<div class="bracket-match">${teamHtml(f.home)}<span class="bracket-vs">${scoreTxt}</span>${teamHtml(f.away)}</div>`;
    };

    el.innerHTML = `
      <div class="bracket-card glow-card glow-gold mini-card"><strong>Semifinal 1</strong>${matchHtml(semi1)}</div>
      <div class="bracket-card glow-card glow-gold mini-card"><strong>Final</strong>${matchHtml(finalMatch)}</div>
      <div class="bracket-card glow-card glow-gold mini-card"><strong>Semifinal 2</strong>${matchHtml(semi2)}</div>
    `;
  }

  function renderCcLeaders(data){
    const wrap = document.getElementById('ccLeaders');
    const scorers = (data?.scorers||[]).map((r,i)=>{
      const T = byId(r.clubId);
      const club = T?.shortName || T?.name || r.clubId;
      return `<li>${escapeHtml(r.name)} <span class="muted">(${r.count}) - ${escapeHtml(club)}</span></li>`;
    }).join('');
    const assisters = (data?.assisters||[]).map((r,i)=>{
      const T = byId(r.clubId);
      const club = T?.shortName || T?.name || r.clubId;
      return `<li>${escapeHtml(r.name)} <span class="muted">(${r.count}) - ${escapeHtml(club)}</span></li>`;
    }).join('');
    if (!scorers && !assisters){
      wrap.innerHTML = '<div class="muted">No stats yet.</div>';
      return;
    }
    wrap.innerHTML = `
      <div class="mini-card glow-card glow-gold">
        <div class="muted">Top Scorers</div>
        <ol style="margin-top:6px;padding-left:18px">${scorers||''}</ol>
      </div>
      <div class="mini-card glow-card glow-green">
        <div class="muted">Top Assisters</div>
        <ol style="margin-top:6px;padding-left:18px">${assisters||''}</ol>
      </div>`;
  }
function renderCcFixtures(list){
  const el = document.getElementById('ccFixtures');
  list.sort((a,b)=>(a.when||a.createdAt)-(b.when||b.createdAt));
  el.innerHTML = list.length ? list.map(f=>{
    const H = byId(f.home), A = byId(f.away);
    const hn = H?.name || f.home;
    const an = A?.name || f.away;
    const whenTxt = f.when ? fmtDate(f.when) : 'TBD';
    const isFinal = f.status==='final';
    const scoreTxt = isFinal ? `${f.score.hs}–${f.score.as}` : 'vs';
    const scoreClass = isFinal ? 'score-final' : 'score-upcoming';
    const banner = getFixtureBanner();
    const editBtn = isAdmin ? `<div class="act"><button data-ccq="${f.id}">Quick Edit</button><button data-ccj="${f.id}">Admin JSON</button></div>` : '';
    return `<div class="fx glow-card glow-gold" id="ccfx_${f.id}">
      <div>
        ${banner ? `<img class="fx-banner" src="${banner}" alt="">` : ''}
        <div class="fx-vs">
          <span class="fx-team"><img src="${teamLogoUrl(H)}" alt=""><span>${escapeHtml(hn)}</span></span>
          <span class="score-pill ${scoreClass}">${scoreTxt}</span>
          <span class="fx-team"><img src="${teamLogoUrl(A)}" alt=""><span>${escapeHtml(an)}</span></span>
        </div>
        <div class="meta"><span class="chip">Champions Cup${f.group?` • Group ${f.group}`:''}${f.round?` • ${escapeHtml(f.round)}`:''}</span> • ${whenTxt} • ${escapeHtml(f.status||'')}</div>
      </div>
      ${editBtn}
    </div>`;
  }).join('') : `<div class="muted">No Champions Cup fixtures yet.</div>`;

  // wire CC quick edit / JSON
  list.forEach(f=>{
    const q = document.querySelector(`[data-ccq="${f.id}"]`);
    const j = document.querySelector(`[data-ccj="${f.id}"]`);
    if (q) q.onclick = ()=> openResultEditor(f);
    if (j) j.onclick = async ()=>{
      if (!isAdmin) return alert('Admin only');
      const hs = Number(prompt('Home score (hs)')||0);
      const as = Number(prompt('Away score (as)')||0);
      const template = JSON.stringify({ details:{ home:[{ player:"Player A", goals:1, assists:0, rating:9.5 }], away:[{ player:"Player B", goals:2, assists:0, rating:8.7 }] }}, null, 2);
      const raw = prompt('Paste JSON (or edit the template):', template);
      if (!raw) return;
      try{
        const obj = JSON.parse(raw);
        await apiPost(`/api/cup/fixtures/${f.id}/report`, { hs, as, details: obj.details || obj });
        await loadChampions();
        await refreshFixturesPublic(); renderFixturesPublic();
      }catch(e){ alert('JSON upload failed: '+e.message); }
    };
  });
}

function buildManualGroupsEditor(groups){
  const root = document.getElementById('ccManualGroups');
  const opts = teams.map(t=> `<option value="${t.id}">${escapeHtml(t.name)} (${t.id})</option>`).join('');
  root.innerHTML = ['A','B','C','D'].map(g=>{
    const rows = (groups[g]||[]).map(v=>
      `<div class="grow"><select data-val="${v}">${opts}</select> <button data-rm>X</button></div>`
    ).join('');
    return `<div class="m-card"><strong>Group ${g}</strong>
      <div data-g="${g}" class="gbox">${rows}</div>
      <div style="margin-top:6px"><button data-add="${g}">+ Add team</button></div>
    </div>`;
  }).join('');

  root.querySelectorAll('select[data-val]').forEach(sel=>{
    sel.value = sel.getAttribute('data-val');
  });

  function attachRemove(btn){
    if(!btn) return;
    btn.onclick = ()=> btn.parentElement.remove();
  }
  root.querySelectorAll('[data-rm]').forEach(attachRemove);

  // add rows
  root.querySelectorAll('[data-add]').forEach(btn=>{
    btn.onclick = ()=>{
      const g = btn.getAttribute('data-add');
      const box = root.querySelector(`.gbox[data-g="${g}"]`);
      const div = document.createElement('div');
      div.className = 'grow';
      div.innerHTML = `<select>${opts}</select> <button data-rm>X</button>`;
      box.appendChild(div);
      attachRemove(div.querySelector('[data-rm]'));
    };
  });

  // save groups (no 16-team requirement; any count allowed)
  document.getElementById('ccBtnSaveGroups').onclick = async ()=>{
    const out = { A:[], B:[], C:[], D:[] };
    root.querySelectorAll('.gbox').forEach(box=>{
      const g = box.getAttribute('data-g');
      box.querySelectorAll('select').forEach(sel=>{
        const v = sel.value; if (v) out[g].push(v);
      });
    });
    // ensure no duplicates across groups
    const all = [...out.A, ...out.B, ...out.C, ...out.D];
    const set = new Set(all);
    if (all.length !== set.size) return alert('Duplicate club across groups.');
    try{
      await apiPost(`/api/champions/${CC_ID}/groups`, { groups: out });
      alert('Groups saved'); await loadChampions();
    }catch(e){ alert('Save groups failed: '+e.message); }
  };

  setupCcFixtureForm();
}
function setupCcFixtureForm(){
  const homeSel = document.getElementById('ccHomeSel');
  const awaySel = document.getElementById('ccAwaySel');
  const groupSel = document.getElementById('ccGroupSel');
  const roundInput = document.getElementById('ccRoundInput');
  const whenInput = document.getElementById('ccWhenInput');
  const createBtn = document.getElementById('ccFormCreate');
  if (!homeSel || !awaySel || !createBtn) return;

  const optionsHtml = teams.map(t=>`<option value="${t.id}">${escapeHtml(t.name)} (${t.id})</option>`).join('');
  homeSel.innerHTML = `<option value="">— choose —</option>${optionsHtml}`;
  awaySel.innerHTML = `<option value="">— choose —</option>${optionsHtml}`;

  function ensureDifferent(){
    if (homeSel.value && awaySel.value && homeSel.value === awaySel.value) {
      alert('Home and away cannot be the same club.');
      awaySel.value = '';
    }
  }
  homeSel.onchange = ensureDifferent;
  awaySel.onchange = ensureDifferent;

  createBtn.onclick = async ()=>{
    const home = homeSel.value;
    const away = awaySel.value;
    const group = groupSel.value || null;
    const round = (roundInput.value || '').trim() || (group ? `Group ${group}` : 'Round');
    const when = whenInput.value ? Date.parse(whenInput.value) : null;
    if (!home || !away) return alert('Pick both teams');
    try{
      await apiPost('/api/cup/fixtures', { home, away, round, cup: CC_ID, group, when });
      alert('Fixture created'); await loadChampions();
    }catch(e){ alert('Create failed: '+e.message); }
  };
}

async function loadLeague(force = false){
  const data = await fetchLeagueData(force);
  renderStandings(data.standings || [], data.matches || [], data.playerStandings || []);
  renderStats(data.players || []);
  renderTopScorers(data.scorers || []);

  const toggleBtn = document.getElementById('statsToggleBtn');
  const leagueView = document.getElementById('leagueView');
  const statsView = document.getElementById('statsView');
  const holderLeague = document.getElementById('statsBtnHolderLeague');
  const holderStats = document.getElementById('statsBtnHolderStats');

  // reset view
  statsView.style.display = 'none';
  leagueView.style.display = 'block';
  holderLeague.appendChild(toggleBtn);
  toggleBtn.textContent = 'Stats';

  toggleBtn.onclick = () => {
    const showStats = statsView.style.display === 'none';
    statsView.style.display = showStats ? 'block' : 'none';
    leagueView.style.display = showStats ? 'none' : 'block';
    (showStats ? holderStats : holderLeague).appendChild(toggleBtn);
    toggleBtn.textContent = showStats ? 'Standings' : 'Stats';
  };
}

function renderStandings(rows, matches, fallbackRows = []){
  const computed = computeStandings(rows, matches, fallbackRows);
  renderLeagueStandings(computed);
  renderHomepageStandings(computed);
  return computed;
}

function computeStandings(rows, matches, fallbackRows = []){
  const allowedClubIds = new Set();
  const nameFallbacks = new Map();
  (rows || []).forEach(r => {
    const rawId = r?.club_id ?? r?.clubId ?? r?.id;
    if (!rawId) return;
    const id = String(rawId);
    allowedClubIds.add(id);
    const label = r?.club_name || r?.name || r?.club || r?.team;
    if (label) nameFallbacks.set(id, label);
  });

  (fallbackRows || []).forEach(r => {
    const rawId = r?.clubId ?? r?.club_id ?? r?.id;
    if (!rawId) return;
    const id = String(rawId);
    allowedClubIds.add(id);
    const label = r?.name || r?.club_name || r?.club || r?.team;
    if (label && !nameFallbacks.has(id)) nameFallbacks.set(id, label);
  });

  if (!allowedClubIds.size){
    (teams || []).forEach(team => {
      const teamId = team?.id;
      if (!teamId) return;
      allowedClubIds.add(String(teamId));
    });
  }

  const standingsMap = new Map();
  const ensureEntry = (clubId, clubData = {}) => {
    const id = String(clubId);
    if (!standingsMap.has(id)){
      standingsMap.set(id, {
        clubId: id,
        name: '',
        played: 0,
        wins: 0,
        draws: 0,
        losses: 0,
        goalsFor: 0,
        goalsAgainst: 0,
        points: 0
      });
    }
    const entry = standingsMap.get(id);
    const clubName = clubData?.details?.name;
    if (clubName) entry.name = clubName;
    return entry;
  };

  (matches || []).forEach(match => {
    if (!match || !match.clubs) return;
    const clubEntries = Object.entries(match.clubs).filter(([, data]) => data);
    if (!clubEntries.length) return;
    if (clubEntries.length === 1){
      const [singleId, singleData] = clubEntries[0];
      ensureEntry(singleId, singleData);
      return;
    }
    const [[idA, dataA], [idB, dataB]] = clubEntries;
    const entryA = ensureEntry(idA, dataA);
    const entryB = ensureEntry(idB, dataB);

    const goalsA = Number(dataA?.goals ?? 0);
    const goalsB = Number(dataB?.goals ?? 0);

    entryA.played += 1;
    entryB.played += 1;
    entryA.goalsFor += goalsA;
    entryA.goalsAgainst += goalsB;
    entryB.goalsFor += goalsB;
    entryB.goalsAgainst += goalsA;

    if (goalsA > goalsB){
      entryA.wins += 1;
      entryA.points += 3;
      entryB.losses += 1;
    } else if (goalsB > goalsA){
      entryB.wins += 1;
      entryB.points += 3;
      entryA.losses += 1;
    } else {
      entryA.draws += 1;
      entryB.draws += 1;
      entryA.points += 1;
      entryB.points += 1;
    }
  });

  let computed = Array.from(standingsMap.values()).filter(entry => {
    return !allowedClubIds.size || allowedClubIds.has(String(entry?.clubId ?? ''));
  });
  if (!computed.length){
    computed = (rows || []).map(r => {
      const id = r?.club_id ?? r?.clubId ?? r?.id;
      if (!id) return null;
      const wins = Number(r?.wins ?? 0);
      const draws = Number(r?.draws ?? 0);
      const losses = Number(r?.losses ?? 0);
      const played = Number(r?.played ?? r?.games_played ?? wins + draws + losses);
      return {
        clubId: String(id),
        name: r?.club_name || r?.name || r?.club || r?.team || byId(id)?.name || String(id),
        played,
        wins,
        draws,
        losses,
        goalsFor: Number(r?.goals_for ?? r?.goalsFor ?? 0),
        goalsAgainst: Number(r?.goals_against ?? r?.goalsAgainst ?? 0),
        points: Number(r?.points ?? 0)
      };
    }).filter(Boolean);
    computed = computed.filter(entry => {
      return !allowedClubIds.size || allowedClubIds.has(String(entry?.clubId ?? ''));
    });
  }

  if (!computed.length && fallbackRows && fallbackRows.length){
    computed = fallbackRows.map(r => {
      const id = r?.clubId ?? r?.club_id ?? r?.id;
      if (!id) return null;
      const wins = Number(r?.wins ?? 0);
      const draws = Number(r?.draws ?? 0);
      const losses = Number(r?.losses ?? 0);
      const played = Number(r?.played ?? r?.games_played ?? wins + draws + losses);
      return {
        clubId: String(id),
        name: r?.name || r?.club_name || r?.club || r?.team || String(id),
        played,
        wins,
        draws,
        losses,
        goalsFor: Number(r?.goalsFor ?? r?.goals_for ?? 0),
        goalsAgainst: Number(r?.goalsAgainst ?? r?.goals_against ?? 0),
        points: Number(r?.points ?? 0)
      };
    }).filter(Boolean);
  }

  computed = computed.filter(entry => {
    return !allowedClubIds.size || allowedClubIds.has(String(entry?.clubId ?? ''));
  });

  computed.forEach(entry => {
    if (!entry.name){
      entry.name = nameFallbacks.get(entry.clubId) || byId(entry.clubId)?.name || entry.clubId;
    }
  });

  computed.sort((a,b) => {
    if (b.points !== a.points) return b.points - a.points;
    const gdA = a.goalsFor - a.goalsAgainst;
    const gdB = b.goalsFor - b.goalsAgainst;
    if (gdB !== gdA) return gdB - gdA;
    if (b.goalsFor !== a.goalsFor) return b.goalsFor - a.goalsFor;
    return (a.name || '').localeCompare(b.name || '');
  });

  return computed;
}

function renderLeagueStandings(sorted){
  const body = document.getElementById('league-standings');
  if (!body) return;
  if (!sorted.length){
    body.innerHTML = '<tr><td colspan="10" class="muted">No standings.</td></tr>';
    return;
  }
  const rowsHtml = sorted.map((row, idx) => {
    const played = Number(row.played ?? 0);
    const wins = Number(row.wins ?? 0);
    const draws = Number(row.draws ?? 0);
    const losses = Number(row.losses ?? 0);
    const gf = Number(row.goalsFor ?? 0);
    const ga = Number(row.goalsAgainst ?? 0);
    const gd = gf - ga;
    const pts = Number(row.points ?? 0);
    const classes = [];
    if (idx < 4) classes.push('top4');
    if (idx === 0) classes.push('rank-1');
    else if (idx === 1) classes.push('rank-2');
    else if (idx === 2) classes.push('rank-3');
    const classAttr = classes.length ? ` class="${classes.join(' ')}"` : '';
    const name = row.name || byId(row.clubId)?.name || row.clubId;
    return `<tr${classAttr}><td>${idx + 1}</td><td class="club-name">${escapeHtml(name)}</td><td>${played}</td><td>${wins}</td><td>${draws}</td><td>${losses}</td><td>${gf}</td><td>${ga}</td><td>${gd}</td><td>${pts}</td></tr>`;
  }).join('');
  body.innerHTML = rowsHtml;
}

function renderHomepageStandings(sorted){
  const container = document.getElementById('homepage-standings');
  if (!container) return;
  if (!sorted.length){
    container.innerHTML = '<div class="muted">No standings.</div>';
    return;
  }
  const top = sorted.slice(0,5);
  const rows = top.map((row, idx) => {
    const rank = idx + 1;
    const name = row.name || byId(row.clubId)?.name || row.clubId;
    return `<tr><td>${rank}</td><td>${escapeHtml(name)}</td><td>${Number(row.wins ?? 0)}</td><td>${Number(row.draws ?? 0)}</td><td>${Number(row.losses ?? 0)}</td><td>${Number(row.points ?? 0)}</td></tr>`;
  }).join('');
  container.innerHTML = `<table class="league-table"><thead><tr><th>#</th><th>Club</th><th>W</th><th>D</th><th>L</th><th>Pts</th></tr></thead><tbody>${rows}</tbody></table>`;
}

function renderTopScorers(rows){
  const homepage = document.getElementById('homepage-topscorers');
  const league = document.getElementById('league-topscorers');
  const normalized = (rows || []).map(r => {
    if (!r) return null;
    const clubId = r?.club_id ?? r?.clubId ?? r?.team_id ?? r?.teamId ?? r?.club;
    const name = r?.name || r?.player || r?.player_name || r?.personaName || r?.persona_name || r?.gamertag || r?.displayName || '';
    const goals = numberFrom(r?.count ?? r?.goals ?? r?.total ?? r?.goal ?? r?.totalGoals);
    if (!name) return null;
    return {
      clubId: clubId ? String(clubId) : '',
      name,
      goals
    };
  }).filter(Boolean);
  normalized.sort((a,b) => {
    if (b.goals !== a.goals) return b.goals - a.goals;
    return a.name.localeCompare(b.name);
  });
  const top = normalized.slice(0,5);

  if (homepage){
    if (!top.length){
      homepage.innerHTML = '<div class="muted">No data.</div>';
    } else {
      homepage.innerHTML = top.map((r, idx) => {
        const clubName = byId(r.clubId)?.name || r.clubId || '';
        return `<div class="stats-row" data-rank="${idx + 1}" data-club-id="${r.clubId}"><img class="player-kit" src="/assets/silhouette.png" alt=""><div class="info"><div>${escapeHtml(r.name)}</div><div class="muted">${escapeHtml(clubName)}</div></div><div class="value">${r.goals}</div></div>`;
      }).join('');
      const unique = new Set(top.map(r => r.clubId).filter(Boolean));
      unique.forEach(cid => renderClubKits(cid, homepage));
    }
  }

  if (league){
    if (!top.length){
      league.innerHTML = '<div class="muted">No data.</div>';
    } else {
      league.innerHTML = top.map((r, idx) => {
        const clubName = byId(r.clubId)?.name || r.clubId || '';
        return `<div class="stats-row" data-rank="${idx + 1}" data-club-id="${r.clubId}"><span class="rank-badge">${idx + 1}</span><img class="player-kit" src="/assets/silhouette.png" alt=""><div class="info"><div>${escapeHtml(r.name)}</div><div class="muted">${escapeHtml(clubName)}</div></div><div class="value">${r.goals}</div></div>`;
      }).join('');
      const unique = new Set(top.map(r => r.clubId).filter(Boolean));
      unique.forEach(cid => renderClubKits(cid, league));
    }
  }

  return top;
}

const STAT_CATEGORIES = [
  { id:'goals', label:'Goals', calc:p=>p.goals||0 },
  { id:'assists', label:'Assists', calc:p=>p.assists||0 },
  { id:'ga', label:'G+A', calc:p=>(p.goals||0)+(p.assists||0) },
  { id:'goals90', label:'Goals per 90', calc:p=>per90(p.goals, p.realtimegame), decimals:2 },
  { id:'assists90', label:'Assists per 90', calc:p=>per90(p.assists, p.realtimegame), decimals:2 },
  { id:'ga90', label:'G+A per 90', calc:p=>per90((p.goals||0)+(p.assists||0), p.realtimegame), decimals:2 },
  { id:'shots90', label:'Shots per 90', calc:p=>per90(p.shots, p.realtimegame), decimals:2 },
  { id:'passAcc', label:'Pass Accuracy %', calc:p=>pct(p.passesmade, p.passattempts), decimals:1 },
  { id:'tackles90', label:'Tackles per 90', calc:p=>per90(p.tacklesmade, p.realtimegame), decimals:2 },
  { id:'tacklePct', label:'Tackle Success %', calc:p=>pct(p.tacklesmade, p.tackleattempts), decimals:1 },
  { id:'cleanSheets', label:'Clean Sheets', calc:p=>p.cleansheetsany||0 },
  { id:'savePct', label:'Save %', calc:p=>pct(p.saves, (p.saves||0)+(p.goalsconceded||0)), decimals:1 },
  { id:'avgRating', label:'Average Rating', calc:p=>p.rating||0, decimals:2 },
  { id:'motm', label:'MOTM', calc:p=>p.mom||0 }
];

function per90(val, mins){ const m = Number(mins)||0; return m ? (Number(val||0)/m)*90 : 0; }
function pct(num, den){ const d = Number(den)||0; return d ? (Number(num||0)/d)*100 : 0; }

function renderStats(players){
  const section = document.getElementById('statsView');
  const container = section.querySelector('.leaderboards');
  if (!container) return;
  container.innerHTML = '';
  STAT_CATEGORIES.forEach(cat => {
    const rows = players.map(p => ({ p, v:cat.calc(p) }))
      .filter(r => r.v && isFinite(r.v))
      .sort((a,b)=>b.v - a.v)
      .slice(0,5);
    if (!rows.length) return;
    const card = document.createElement('div');
    card.className = 'm-card';
    card.innerHTML = `<strong>${cat.label}</strong>`;
    const list = document.createElement('div');
    const clubIds = new Set();
    rows.forEach((r, idx) => {
      const rowDiv = document.createElement('div');
      rowDiv.className = 'stats-row';
      rowDiv.dataset.clubId = String(r.p.club_id);
      rowDiv.dataset.rank = String(idx + 1);

      const kitImg = document.createElement('img');
      kitImg.className = 'player-kit';
      kitImg.src = '/assets/silhouette.png';
      rowDiv.appendChild(kitImg);

      const info = document.createElement('div');
      info.className = 'info';
      const clubName = byId(r.p.club_id)?.name || r.p.club_id;
      info.innerHTML = `<div>${escapeHtml(r.p.name)}</div><div class="muted">${escapeHtml(clubName)}</div>`;
      rowDiv.appendChild(info);

      const val = document.createElement('div');
      val.className = 'value';
      val.textContent = typeof cat.decimals === 'number' ? r.v.toFixed(cat.decimals) : String(Math.round(r.v));
      rowDiv.appendChild(val);

      list.appendChild(rowDiv);
      clubIds.add(r.p.club_id);
    });
    clubIds.forEach(cid=>{
      renderClubKits(cid, list);
    });
    card.appendChild(list);
    container.appendChild(card);
  });
}


// =======================
//   FRIENDLIES
// =======================
async function loadFriendlies(){
  document.getElementById('frCupId').textContent = FRIENDLIES_ID;

  let fr = { friendly:{ teams:[] } };
  try { fr = await apiGet(`/api/friendlies/${encodeURIComponent(FRIENDLIES_ID)}`); }
  catch {}
  friendliesTeams = fr.friendly?.teams || [];

  try {
    const fx = await apiGet(`/api/cup/fixtures?cup=${encodeURIComponent(FRIENDLIES_ID)}`);
    friendliesFxCache = normalizeFixtures(fx.fixtures || []);
  } catch { friendliesFxCache = []; }
  renderFriendliesFixtures(friendliesFxCache);

  document.getElementById('friendliesAdmin').style.display = isAdmin ? 'block' : 'none';
  if (isAdmin) buildFriendliesAdmin(friendliesTeams);
}

function renderFriendliesFixtures(list){
  const el = document.getElementById('friendliesFixtures');
  list.sort((a,b)=>(a.when||a.createdAt)-(b.when||b.createdAt));
  el.innerHTML = list.length ? list.map(f=>{
    const H=byId(f.home), A=byId(f.away);
    const hn=H?.name||f.home; const an=A?.name||f.away;
    const whenTxt=f.when?fmtDate(f.when):'TBD';
    const isFinal=(f.status==='final');
    const scoreTxt=isFinal?`${f.score.hs}–${f.score.as}`:'vs';
    const scoreClass=isFinal?'score-final':'score-upcoming';
    const banner=getFixtureBanner();
    const editBtn = isAdmin ? `<div class="act"><button data-frq="${f.id}">Quick Edit</button></div>` : '';
    return `<div class="fx glow-card glow-silver" id="frfx_${f.id}"><div>${banner?`<img class="fx-banner" src="${banner}" alt="">`:''}<div class="fx-vs"><span class="fx-team"><img src="${teamLogoUrl(H)}" alt=""><span>${escapeHtml(hn)}</span></span><span class="score-pill ${scoreClass}">${scoreTxt}</span><span class="fx-team"><img src="${teamLogoUrl(A)}" alt=""><span>${escapeHtml(an)}</span></span></div><div class="meta"><span class="chip">Friendly${f.round?` • ${escapeHtml(f.round)}`:''}</span> • ${whenTxt} • ${escapeHtml(f.status||'')}</div></div>${editBtn}</div>`;
  }).join('') : `<div class="muted">No friendly fixtures yet.</div>`;
  list.forEach(f=>{ const q=document.querySelector(`[data-frq="${f.id}"]`); if(q) q.onclick=()=> openResultEditor(f); });
}

function buildFriendliesAdmin(teamIds){
  const listEl = document.getElementById('frTeamList');
  listEl.innerHTML = teamIds.length ? teamIds.map(id=>{ const T=byId(id); return `<div style="margin-top:4px"><span>${escapeHtml(T?.name||id)}</span> <button data-remove="${id}">Remove</button></div>`; }).join('') : '<div class="muted">No teams.</div>';
  listEl.querySelectorAll('[data-remove]').forEach(btn=>{
    btn.onclick = async ()=>{
      const id = btn.getAttribute('data-remove');
      const next = teamIds.filter(t=>t!==id);
      try { await apiPost(`/api/friendlies/${FRIENDLIES_ID}/teams`, { teams: next }); await loadFriendlies(); }
      catch(e){ alert('Update failed: '+e.message); }
    };
  });

  const addSel = document.getElementById('frAddSel');
  const addBtn = document.getElementById('frAddBtn');
  const options = teams.filter(t=>!teamIds.includes(t.id)).map(t=>`<option value="${t.id}">${escapeHtml(t.name)} (${t.id})</option>`).join('');
  addSel.innerHTML = `<option value="">— choose —</option>${options}`;
  addBtn.onclick = async ()=>{
    const id = addSel.value; if(!id) return alert('Pick a team');
    const next=[...teamIds,id];
    try{ await apiPost(`/api/friendlies/${FRIENDLIES_ID}/teams`, { teams: next }); await loadFriendlies(); }
    catch(e){ alert('Update failed: '+e.message); }
  };

  const genBtn = document.getElementById('frGenBtn');
  genBtn.onclick = async ()=>{
    if (!confirm('Generate fixtures for all selected teams?')) return;
    try{ await apiPost(`/api/friendlies/${FRIENDLIES_ID}/generate`, {}); alert('Fixtures generated'); await loadFriendlies(); }
    catch(e){ alert('Generate failed: '+e.message); }
  };
}


// =======================
//   NEWS (dynamic; client-side fallback from fixtures)
// =======================
async function loadNews(){
  const wrap = document.getElementById('newsFeed');
  // Try server feed first (if you implemented /api/news). Fallback to client compute.
  try{
    const d = await apiGet('/api/news');
    const items = d.items || [];
    const complete = items.every(n=>n.title && n.body);
    if (complete && items.length){
      wrap.innerHTML = items.map(renderNewsItem).join('');
      return;
    }
  }catch{}
  // Fallback: compute from fixtures (league + CC + friendlies)
  try{
    await refreshFixturesPublic();
    const cc = await apiGet(`/api/cup/fixtures?cup=${encodeURIComponent(CC_ID)}`).catch(()=>({fixtures:[]}));
    const fr = await apiGet(`/api/cup/fixtures?cup=${encodeURIComponent(FRIENDLIES_ID)}`).catch(()=>({fixtures:[]}));
    const computed = await computeNewsFromFixtures([
      ...fixturesPublicCache,
      ...normalizeFixtures(cc.fixtures||[]),
      ...normalizeFixtures(fr.fixtures||[])
    ]);
    wrap.innerHTML = computed.length ? computed.map(renderNewsItem).join('') : '<div class="muted">No news yet.</div>';
  }catch{ wrap.innerHTML = '<div class="muted">Failed to load news.</div>'; }
}
function renderNewsItem(n){
  const club = byId(n.clubId);
  let title = n.title;
  let body  = n.body;
  if (!title || title===n.clubId){
    if (n.type==='clean_sheet' && club){
      title = `${club.name} clean sheet`;
      body  = `${club.name} keep ${Number(n.score?.hs||0)}-${Number(n.score?.as||0)} shutout`;
    } else if (n.type==='high_scoring'){
      const hn = byId(n.home)?.name || n.home;
      const an = byId(n.away)?.name || n.away;
      title = 'High scoring match';
      body  = `${hn} ${Number(n.score?.hs||0)}-${Number(n.score?.as||0)} ${an}`;
    } else if (n.type==='blowout' && club){
      title = `${club.name} blowout win`;
      body  = `${Number(n.score?.hs||0)}-${Number(n.score?.as||0)} victory`;
    } else if (n.type==='final'){
      const hn = byId(n.home)?.name || n.home;
      const an = byId(n.away)?.name || n.away;
      title = `${hn} ${Number(n.score?.hs||0)}-${Number(n.score?.as||0)} ${an}`;
      body  = 'Full time score';
    }
  }
  title = replaceClubIds(title);
  body  = replaceClubIds(body);
  return `<article class="news-post glow-card glow-silver">
    <img class="news-avatar" src="${teamLogoUrl(club)}" alt="">
    <div class="news-body">
      <div class="news-title">${escapeHtml(title||'')}</div>
      <div>${escapeHtml(body||'')}</div>
      <div class="news-meta">${fmtDate(n.ts)} • ${escapeHtml(n.tag||'')}</div>
    </div>
  </article>`;
}
async function computeNewsFromFixtures(list){
  const out = [];
  const byPlayer = new Map(); // name => { goalStreak, assistStreak, contribStreak, lastAt }
  const tallyGoals = new Map();
  const tallyAssists = new Map();
  const goalTotals = new Map();
  const assistTotals = new Map();
  const now = Date.now();

  const ids = new Set();
  list.forEach(f=>{
    ['home','away'].forEach(side=>{
      (f.details?.[side]||[]).forEach(r=>{ if(!r.player && r.playerId) ids.add(r.playerId); });
    });
  });
  await Promise.all(Array.from(ids).map(id=>resolvePlayerName(id)));

  const finals = list.filter(f=>f.status==='final').sort((a,b)=> (a.when||0)-(b.when||0));
  finals.forEach(f=>{
    const total = Number(f.score?.hs||0)+Number(f.score?.as||0);
    const diff = Math.abs(Number(f.score?.hs||0)-Number(f.score?.as||0));
    if (Number(f.score?.as||0)===0){ out.push({ tag:'Clean Sheet', title:`${byId(f.home)?.name||f.home} clean sheet`, body:`${byId(f.home)?.name||f.home} keep ${Number(f.score.hs||0)}-${Number(f.score.as||0)} shutout`, clubId:f.home, ts:f.when||now }); }
    if (Number(f.score?.hs||0)===0){ out.push({ tag:'Clean Sheet', title:`${byId(f.away)?.name||f.away} clean sheet`, body:`${byId(f.away)?.name||f.away} keep ${Number(f.score.hs||0)}-${Number(f.score.as||0)} shutout`, clubId:f.away, ts:f.when||now }); }
    if (total>=8){ out.push({ tag:'High Scoring', title:'High scoring match', body:`${byId(f.home)?.name||f.home} ${Number(f.score.hs||0)}-${Number(f.score.as||0)} ${byId(f.away)?.name||f.away}`, clubId:'', ts:f.when||now }); }
    if (diff>=5){ const winner = Number(f.score.hs||0)>Number(f.score.as||0) ? f.home : f.away; out.push({ tag:'Blowout', title:`${byId(winner)?.name||winner} blowout win`, body:`${Number(f.score.hs||0)}-${Number(f.score.as||0)} victory`, clubId:winner, ts:f.when||now }); }

    ['home','away'].forEach(side=>{
      (f.details?.[side]||[]).forEach(r=>{
        const name = (r.player && r.player.trim()) || playerNameCache.get(r.playerId) || r.playerId || 'Unknown';
        const g = Number(r.goals||0);
        const a = Number(r.assists||0);
        const rating = Number(r.rating||0);
        const clubId = side==='home'?f.home:f.away;

        if (g===2){ out.push({ tag:'Brace', title:`${name} scores a brace`, body:`${name} struck twice for ${(byId(clubId)?.name)||'their club'} in ${f.round||'League'}.`, clubId, ts:f.when||now }); }
        else if (g===3){ out.push({ tag:'Hattrick', title:`${name} nets a hat-trick!`, body:`${name} scored ${g} for ${(byId(clubId)?.name)||'their club'} in ${f.round||'League'}.`, clubId, ts:f.when||now }); }
        else if (g>=4){ out.push({ tag:'Haul', title:`${name} scores ${g}!`, body:`${name} recorded ${g} goals for ${(byId(clubId)?.name)||'their club'} in ${f.round||'League'}.`, clubId, ts:f.when||now }); }

        if (a===2){ out.push({ tag:'Assist Brace', title:`${name} with two assists`, body:`${name} set up two goals for ${(byId(clubId)?.name)||'their club'} in ${f.round||'League'}.`, clubId, ts:f.when||now }); }
        else if (a>=3){ out.push({ tag:'Assist Hat-trick', title:`${name} assists ${a}`, body:`${name} tallied ${a} assists for ${(byId(clubId)?.name)||'their club'} in ${f.round||'League'}.`, clubId, ts:f.when||now }); }

        if (g>=2 && a>=2){ out.push({ tag:'Big Game', title:`${name} stars with ${g}G/${a}A`, body:`${name} contributed ${g} goals and ${a} assists for ${(byId(clubId)?.name)||'their club'} in ${f.round||'League'}.`, clubId, ts:f.when||now }); }

        if (rating>=9){ out.push({ tag:'High Rating', title:`${name} shines with ${rating}`, body:`${name} earned a ${rating} rating for ${(byId(clubId)?.name)||'their club'}.`, clubId, ts:f.when||now }); }

        const meta = byPlayer.get(name) || { goalStreak:0, assistStreak:0, contribStreak:0, lastAt:0 };
        meta.goalStreak = g>0 ? meta.goalStreak+1 : 0;
        meta.assistStreak = a>0 ? meta.assistStreak+1 : 0;
        meta.contribStreak = (g>0||a>0) ? meta.contribStreak+1 : 0;
        meta.lastAt = f.when||now;
        byPlayer.set(name, meta);

        const goalTotal = (goalTotals.get(name)||0) + g;
        goalTotals.set(name, goalTotal);
        if (g>0 && [1,10,50].includes(goalTotal)){ out.push({ tag:'Milestone', title:`${name} reaches ${goalTotal} goals`, body:`${name} has now scored ${goalTotal} career goals.`, clubId, ts:f.when||now }); }

        const assistTotal = (assistTotals.get(name)||0) + a;
        assistTotals.set(name, assistTotal);
        if (a>0 && [1,10,50].includes(assistTotal)){ out.push({ tag:'Milestone', title:`${name} reaches ${assistTotal} assists`, body:`${name} has now provided ${assistTotal} career assists.`, clubId, ts:f.when||now }); }

        if (g>0) tallyGoals.set(name, (tallyGoals.get(name)||0)+g);
        if (a>0) tallyAssists.set(name, (tallyAssists.get(name)||0)+a);
      });
    });
  });

  for (const [name,meta] of byPlayer.entries()){
    if (meta.goalStreak>=3){ out.push({ tag:'Streak', title:`${name} scoring streak`, body:`${name} has scored in ${meta.goalStreak} consecutive matches.`, clubId:'', ts:meta.lastAt||now }); }
    if (meta.assistStreak>=3){ out.push({ tag:'Streak', title:`${name} assist streak`, body:`${name} has assisted in ${meta.assistStreak} straight matches.`, clubId:'', ts:meta.lastAt||now }); }
    if (meta.contribStreak>=3){ out.push({ tag:'Streak', title:`${name} contribution streak`, body:`${name} has contributed in ${meta.contribStreak} consecutive matches.`, clubId:'', ts:meta.lastAt||now }); }
  }

  const leaders = Array.from(tallyGoals.entries()).sort((a,b)=>b[1]-a[1]).slice(0,3);
  if (leaders.length){ const line = leaders.map(([n,c],i)=>`${i+1}. ${n} (${c})`).join('  '); out.push({ tag:'Leaders', title:'Top Scorers Update', body: line, clubId:'', ts: now }); }
  const assistsLead = Array.from(tallyAssists.entries()).sort((a,b)=>b[1]-a[1]).slice(0,3);
  if (assistsLead.length){ const line = assistsLead.map(([n,c],i)=>`${i+1}. ${n} (${c})`).join('  '); out.push({ tag:'Leaders', title:'Top Assists Update', body: line, clubId:'', ts: now }); }

  out.sort((a,b)=> (b.ts||0) - (a.ts||0));
  return out;
}

// =======================
//   INIT
// =======================
setupRankings();
async function init(){

  buildStaticTeams();
  await loadPlayers();
  await checkAdmin();
  await checkMe();
  await loadHome();

  // default
  setNav('teams');

  await refreshMatches();
  setInterval(async () => { await refreshMatches(); }, 10*60*1000);

  await refreshFixturesPublic(); renderFixturesPublic();
  if (isAdmin){ await refreshFixturesSched(); renderFixturesSched(); }

  // hash-open team
  try{
    const m = location.hash.match(/team=([^&]+)/);
    if (m){ const team = byId(decodeURIComponent(m[1])); if (team) setTimeout(()=>showTeam(team), 120); }
  }catch{}
}
init();

window.addEventListener('load', () => {
  const introAudio = document.getElementById('introAudio');
  const intro = document.getElementById('intro');

  if (introAudio) {
    const tryPlay = () => introAudio.play().catch(() => {});
    tryPlay();
    document.addEventListener('click', tryPlay, { once: true });
  }

  setTimeout(() => {
    if (intro) {
      intro.classList.add('hidden');
      intro.addEventListener('transitionend', () => {
        intro.remove();
        if (introAudio) {
          introAudio.pause();
          introAudio.remove();
        }
      });
    }
  }, 3000);
});
</script>
</body>
</html>
