<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pro Club ‚Äî League Hub</title>
<style>
:root { --accent:#e00; --muted:#bb4444; --card-h:400px; }
*{box-sizing:border-box}
body{background:#000;color:#fff;font-family:Arial,sans-serif;margin:0;min-height:100vh}
header{background:linear-gradient(90deg,#a00000,#d50000);color:#fff;padding:14px 18px;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
header h1{margin:0;font-size:20px;letter-spacing:.2px}
.navbar{display:flex;gap:8px;align-items:center;margin-left:auto;flex-wrap:wrap}
.navbar button{background:#330000;color:#fff;border:1px solid #551111;border-radius:10px;padding:8px 10px;cursor:pointer}
.navbar button[aria-pressed="true"]{background:#550000;border-color:#aa1111}
main{padding:20px;max-width:1200px;margin:0 auto;background:#000}
h2{margin:0 0 8px}

.muted{color:var(--muted)}
.center{text-align:center}

/* Cards / grids */
.teams-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:16px;margin-top:18px}
.team-card{background:#110000;border-radius:12px;box-shadow:0 6px 18px rgba(255,0,0,.3);overflow:hidden;cursor:pointer;transition:.14s;display:flex;flex-direction:column;align-items:center;padding:14px;color:#fff}
.team-card:hover{transform:translateY(-6px);box-shadow:0 12px 28px rgba(255,0,0,.5)}
.team-logo{width:100%;height:120px;object-fit:cover;border-radius:8px;background:#330000;display:block}
.team-meta{width:100%;display:flex;align-items:center;justify-content:space-between;margin-top:10px;gap:8px}
.team-meta .name{font-weight:700;font-size:16px}
.trophy-badge{background:#e00;color:#fff;font-weight:700;padding:6px 10px;border-radius:999px;display:inline-flex;align-items:center;gap:8px;box-shadow:0 2px 6px rgba(255,0,0,.6)}

#teams-view{display:block}
#detail-view{display:none;color:#fff}
#detail-header{display:flex;align-items:center;gap:12px;margin-bottom:14px;color:#fff}
#backBtn{background:#330000;color:#fff;border:1px solid #551111;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
#detail-title{font-size:20px;font-weight:700}
.squad-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:18px;margin-top:14px}

/* Generic card */
.m-card{background:#110000;border:1px solid #2a0000;border-radius:12px;box-shadow:0 6px 18px rgba(255,0,0,.15);padding:12px}

/* Fixtures */
.fx-list{display:flex;flex-direction:column;gap:10px}
.fx{background:#110000;border:1px solid #300000;border-radius:10px;padding:10px;display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center}
.fx .meta{font-size:12px;color:var(--muted)}
.fx .vs{font-weight:700}
.fx .act{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end}
.fx button{background:#330000;border:1px solid #551111;color:#fff;border-radius:8px;padding:6px 8px;cursor:pointer}
.fx .chip{background:#220000;border:1px solid #440000;border-radius:999px;padding:4px 8px;font-size:12px}

input,select,textarea{background:#0d0000;color:#fff;border:1px solid #3a0000;border-radius:8px;padding:8px}
label{font-size:12px;color:var(--muted)}
hr{border:none;border-top:1px solid #220000;margin:14px 0}

@media(max-width:720px){
  .card{height:320px}
  .team-logo{height:100px}
  .fx{grid-template-columns:1fr;gap:6px}
  .fx .act{justify-content:flex-start}
}
</style>
</head>
<body>
<header>
  <h1>Pro Club ‚Äî League Hub</h1>
  <div class="navbar">
    <button id="navTeams"    aria-pressed="true">Teams</button>
    <button id="navMarket"   aria-pressed="false">Market</button>
    <button id="navFixtures" aria-pressed="false">UPCL Fixtures</button>
    <button id="navRankings" aria-pressed="false" style="display:none">Rankings</button>
    <button id="btnSetRole">Set Role</button>
    <button id="btnAdminLogin">Admin sign in</button>
    <button id="btnAdminLogout" style="display:none">Admin sign out</button>
  </div>
</header>

<main>
  <!-- TEAMS OVERVIEW -->
  <section id="teams-view" aria-live="polite">
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <h2 style="margin:0">Teams</h2>
      <div class="muted">Total teams: <span id="teams-count">0</span></div>
    </div>
    <div class="teams-grid" id="teamsGrid" role="list"></div>
  </section>

  <!-- TEAM DETAIL -->
  <section id="detail-view" aria-live="polite">
    <div id="detail-header">
      <button id="backBtn">‚Üê Back</button>
      <div>
        <div id="detail-title">Team name</div>
        <div class="muted" id="detail-sub">squad & trophies</div>
      </div>
      <div style="margin-left:auto">
        <span class="trophy-badge" id="detail-trophies">0 üèÜ</span>
      </div>
    </div>

    <div id="teamPanels" class="grid-panels" style="display:grid;grid-template-columns:1fr;gap:12px">
      <div class="m-card">
        <strong>Club Wallet</strong>
        <div id="walletBody" class="muted" style="margin-top:6px">Loading‚Ä¶</div>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
          <button id="btnCollect" style="display:none">Collect daily payout</button>
          <small class="muted" id="walletHint"></small>
        </div>
      </div>

      <div class="m-card">
        <strong>Next UPCL Match</strong>
        <div id="nextMatchBody" class="muted" style="margin-top:6px">No scheduled match yet.</div>
      </div>

      <div id="teamResultsPanel" class="m-card">
        <strong>Recent Results</strong>
        <div id="teamResultsBody" class="muted" style="margin-top:6px">No finals yet.</div>
      </div>
    </div>

    <div id="squadContainer" class="squad-grid" style="margin-top:12px"></div>
    <div id="detail-footer" style="margin-top:18px" class="muted center">
      <small>Data pulled from EA when available; manual for custom clubs.</small>
    </div>
  </section>

  <!-- MARKET (simple placeholder, your routes already exist) -->
  <section id="market-view" style="display:none">
    <h2>Transfer Market</h2>
    <div class="m-card">
      <p class="muted">Clubs can list transfer/loan offers and free agents here. (UI trimmed)</p>
      <p class="muted">Chat on a listing opens your Discord or preferred channel.</p>
    </div>
  </section>

  <!-- FIXTURES -->
  <section id="fixtures-view" style="display:none">
    <div style="display:flex;align-items:center;gap:8px;justify-content:space-between;flex-wrap:wrap">
      <h2>UPCL Fixtures</h2>
      <div style="display:flex;gap:6px;align-items:center">
        <button data-fxf="upcoming" aria-pressed="true">Upcoming</button>
        <button data-fxf="final" aria-pressed="false">Final</button>
        <button data-fxf="all" aria-pressed="false">All</button>
        <button data-fxf="mine" aria-pressed="false">My club</button>
        <button id="btnCreateFx" style="display:none">Create fixture</button>
      </div>
    </div>
    <div id="fixturesList" class="fx-list" style="margin-top:10px"></div>
  </section>

  <!-- RANKINGS (ADMIN ONLY) -->
  <section id="rankings-view" style="display:none">
    <div style="display:flex;align-items:center;gap:8px;justify-content:space-between;flex-wrap:wrap">
      <h2>Rankings & Payouts</h2>
      <div id="adminControls" style="display:none;gap:8px">
        <button id="btnSaveRankings">Save</button>
        <button id="btnRecalc">Recalc tiers</button>
        <button id="btnCupDry">Cup bonuses (dry run)</button>
        <button id="btnCupPay">Cup bonuses (pay)</button>
      </div>
    </div>
    <div class="m-card" style="margin-top:10px">
      <div class="muted" style="margin-bottom:8px">Only admins can view/edit this section.</div>
      <div id="rankingsTable">Loading‚Ä¶</div>
    </div>
  </section>
</main>

<script>
// =======================
//   CONFIG / CONSTANTS
// =======================
const API_BASE = '';
const TEAM_TITLES = {
  '3638105': [
    { count: 1, name: 'United Pro Clubs League Title' },
    { count: 1, name: 'Leagues Cup' }
  ]
};

// Add teams (includes your new ones)
const teams = [
  { id: '2491998', name: 'Royal Republic', logo: '/assets/logos/royal-republic-logo.png' },
  { id: '1527486', name: 'Gungan FC' },
  { id: '1969494', name: 'Club Frijol' },
  { id: '2086022', name: 'Brehemen' },
  { id: '2462194', name: 'Costa Chica FC' },
  { id: '5098824', name: 'Sporting de la ma' },
  { id: '4869810', name: 'Afc Tekki' },
  { id: '576007', name: 'Ethabella FC' },
  { id: '4933507', name: 'Loss Toyz' },
  { id: '4824736', name: 'GoldenGoals FC' },
  { id: '481847', name: 'Rooney tunes' },
  { id: '3050467', name: 'invincible afc' },
  { id: '4154835', name: 'khalch Fc' },
  { id: '3638105', name: 'Real mvc' },
  { id: '55408', name: 'Elite VT' },
  { id: '4819681', name: 'EVERYTHING DEAD' },
  { id: '35642', name: 'EBK FC' },
  // Custom / manual clubs
  { id: 'afc-warriors',  name: 'AFC Warriors',  logo: '/assets/logos/afc-warriors.png' },
  { id: 'jids-trivela',  name: 'Jids Trivela',  logo: '/assets/logos/jids-trivela.png' },
  { id: 'razorblack-fc', name: 'Razorblack FC', logo: '/assets/logos/razorblack-fc.png' }
];

// helpers
const byId = id => teams.find(t=>String(t.id)===String(id));
function teamLogoUrl(team){ return team.logo || `https://via.placeholder.com/800x400.png?text=${encodeURIComponent(team.name)}`; }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
function fmtMoney(n){ return '‚Çµ' + Number(n||0).toLocaleString(); }
function fmtDate(ms){ try{ return new Date(ms).toLocaleString(); } catch{ return ''; } }

// state
let isAdmin = false;
let meUser  = null;
let rankings = {};
let payouts  = { elite:0, mid:0, bottom:0 };
let fixturesCache = [];

// api
async function apiGet(p){ const r = await fetch(API_BASE+p); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
async function apiPost(p, body){ const r = await fetch(API_BASE+p,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
async function apiPut(p, body){ const r = await fetch(API_BASE+p,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }

// nav
const navTeams    = document.getElementById('navTeams');
const navMarket   = document.getElementById('navMarket');
const navFixtures = document.getElementById('navFixtures');
const navRankings = document.getElementById('navRankings');

const teamsView    = document.getElementById('teams-view');
const marketView   = document.getElementById('market-view');
const fixturesView = document.getElementById('fixtures-view');
const rankingsView = document.getElementById('rankings-view');

function setNav(active){
  // guard: Rankings admin-only
  if (active==='rankings' && !isAdmin) { alert('Admin only'); active='teams'; }
  const map = {
    teams:[teamsView, navTeams],
    market:[marketView, navMarket],
    fixtures:[fixturesView, navFixtures],
    rankings:[rankingsView, navRankings]
  };
  for (const key of Object.keys(map)){
    const [view,btn] = map[key];
    const is = key===active;
    view.style.display = is ? 'block' : 'none';
    btn.setAttribute('aria-pressed', String(is));
  }
}

navTeams.onclick    = ()=> setNav('teams');
navMarket.onclick   = ()=> setNav('market');
navFixtures.onclick = ()=> setNav('fixtures');
navRankings.onclick = ()=> setNav('rankings');

// auth / admin
const btnAdminLogin = document.getElementById('btnAdminLogin');
const btnAdminLogout= document.getElementById('btnAdminLogout');

btnAdminLogin.onclick = async ()=>{
  const pw = prompt('Admin password');
  if (!pw) return;
  try{
    await apiPost('/api/admin/login',{ password: pw });
    await checkAdmin();
    alert('Admin signed in');
  }catch(e){ alert('Login failed: '+e.message); }
};
btnAdminLogout.onclick = async ()=>{
  try{ await apiPost('/api/admin/logout',{}); }catch{}
  await checkAdmin();
  alert('Signed out');
};

async function checkAdmin(){
  try{ const d = await apiGet('/api/admin/me'); isAdmin = !!d.admin; }catch{ isAdmin=false; }
  navRankings.style.display = isAdmin ? 'inline-block' : 'none';
  btnAdminLogout.style.display = isAdmin ? 'inline-block' : 'none';

  // If user somehow is on rankings while losing admin, bump out
  if (!isAdmin && rankingsView.style.display==='block') setNav('teams');

  // show/hide admin-only controls
  const btnCreateFx = document.getElementById('btnCreateFx');
  if (btnCreateFx) btnCreateFx.style.display = isAdmin ? 'inline-block' : 'none';

  // Load rankings only for admin
  if (isAdmin) { await loadRankings(); renderRankings(); }
}

// me (session user / manager)
async function checkMe(){
  try { meUser = (await apiGet('/api/auth/me')).user || null; } catch { meUser = null; }
}

// =======================
//   TEAMS LIST / DETAIL
// =======================
const teamsGrid = document.getElementById('teamsGrid');
const teamsCount = document.getElementById('teams-count');
const detailView = document.getElementById('detail-view');
const teamsViewEl = document.getElementById('teams-view');
const detailTitle = document.getElementById('detail-title');
const detailSub   = document.getElementById('detail-sub');
const detailTrophies = document.getElementById('detail-trophies');
const squadContainer = document.getElementById('squadContainer');
const backBtn = document.getElementById('backBtn');

function renderTeams(){
  teamsGrid.innerHTML='';
  teamsCount.textContent = teams.length;
  teams.forEach(team=>{
    const card = document.createElement('div');
    card.className='team-card';
    card.setAttribute('role','listitem');
    card.innerHTML = `
      <img class="team-logo" src="${teamLogoUrl(team)}" alt="${escapeHtml(team.name)} logo" />
      <div class="team-meta">
        <div class="name">${escapeHtml(team.name)}</div>
        <div class="trophy-badge">${Array.isArray(TEAM_TITLES[team.id]) ? TEAM_TITLES[team.id].map(t=>`${t.count}x ${t.name}`).join(', ') : ''}</div>
      </div>
    `;
    card.addEventListener('click', ()=> showTeam(team));
    teamsGrid.appendChild(card);
  });
}

async function showTeam(team){
  window.scrollTo({top:0,behavior:'smooth'});
  teamsViewEl.style.display='none';
  detailView.style.display='block';
  detailTitle.textContent = team.name;
  detailSub.textContent = 'Loading club info‚Ä¶';

  // trophies
  if(Array.isArray(TEAM_TITLES[team.id])){
    detailTrophies.innerHTML = TEAM_TITLES[team.id].map(t=>`<div>${t.count}x ${t.name}</div>`).join('');
  } else detailTrophies.textContent = 'No trophies';

  // wallet info
  await renderWallet(team.id);
  // fixtures: next + recent
  await refreshFixtures();
  renderNextFor(team.id);
  renderTeamResults(team.id);

  // player display
  if(/^\d+$/.test(team.id)){
    await renderEAPlayers(team.id);
  }else{
    renderManualPlayers(team);
  }

  detailSub.textContent = 'Club overview';
}

backBtn.addEventListener('click', ()=>{
  detailView.style.display='none';
  teamsViewEl.style.display='block';
  window.scrollTo({top:0,behavior:'smooth'});
});

// Wallet
async function renderWallet(clubId){
  const body = document.getElementById('walletBody');
  const hint = document.getElementById('walletHint');
  const btn = document.getElementById('btnCollect');
  try{
    const d = await apiGet(`/api/wallets/${encodeURIComponent(clubId)}`);
    const w = d.wallet||{}, prev = d.preview||{};
    const per = d.perDay||0;
    body.innerHTML = `
      Balance: <strong>${fmtMoney(w.balance||0)}</strong><br>
      Tier payout: <strong>${fmtMoney(per)}</strong> / day<br>
      Pending payout: <strong>${fmtMoney(prev.amount||0)}</strong> (${prev.days||0} days)
    `;
    // Only the manager of this club can collect
    const canCollect = meUser && meUser.role==='Manager' && String(meUser.teamId)===String(clubId);
    btn.style.display = canCollect ? 'inline-block' : 'none';
    btn.onclick = async ()=>{
      try{
        const r = await apiPost(`/api/wallets/${encodeURIComponent(clubId)}/collect`,{});
        alert(r.ok ? 'Payout collected!' : (r.message||'No payout'));
        await renderWallet(clubId);
      }catch(e){ alert('Collect failed: '+e.message); }
    };
    hint.textContent = canCollect ? 'Only the club manager can collect.' : 'Sign in as manager to collect.';
  }catch(e){
    body.textContent = 'Wallet unavailable';
    hint.textContent = '';
    btn.style.display='none';
  }
}

// Players
async function renderEAPlayers(clubId){
  squadContainer.innerHTML = '<div class="m-card">Loading players from EA‚Ä¶</div>';
  try{
    const data = await apiGet(`/api/teams/${encodeURIComponent(clubId)}/players`);
    const members = Array.isArray(data.members) ? data.members : [];
    if (!members.length) {
      squadContainer.innerHTML = '<div class="m-card muted">No players returned by EA.</div>';
      return;
    }
    squadContainer.innerHTML = '';
    members.forEach(p=>{
      const el = document.createElement('div');
      el.className='m-card';
      el.innerHTML = `<strong>${escapeHtml(p.name||'Unknown')}</strong>
        <div class="muted">Pos: ${escapeHtml(p.proPos||p.position||'‚Äî')} ‚Ä¢ Goals: ${p.goals??0} ‚Ä¢ Assists: ${p.assists??0}</div>`;
      squadContainer.appendChild(el);
    });
  }catch(e){
    squadContainer.innerHTML = '<div class="m-card muted">EA API unavailable.</div>';
  }
}
function renderManualPlayers(team){
  squadContainer.innerHTML = `
    <div class="m-card muted">Manual club ‚Äî managers can maintain squads (coming soon).</div>
  `;
}

// =======================
//   FIXTURES
// =======================
const fixturesList = document.getElementById('fixturesList');
const btnCreateFx  = document.getElementById('btnCreateFx');

btnCreateFx.onclick = async ()=>{
  const home = prompt('Home club ID (use exact from Teams list)');
  const away = prompt('Away club ID');
  const round= prompt('Round (e.g., Quarterfinal)');
  if (!home || !away) return;
  try{
    const d = await apiPost('/api/cup/fixtures', { home, away, round, cup:'UPCL' });
    alert('Created fixture'); await refreshFixtures(); renderFixtures();
  }catch(e){ alert('Create failed: '+e.message); }
};

document.querySelectorAll('[data-fxf]').forEach(btn=>{
  btn.onclick = ()=>{
    document.querySelectorAll('[data-fxf]').forEach(b=>b.setAttribute('aria-pressed','false'));
    btn.setAttribute('aria-pressed','true');
    renderFixtures();
  };
});

async function refreshFixtures(){
  try {
    const d = await apiGet('/api/cup/fixtures?cup=UPCL');
    fixturesCache = d.fixtures || [];
  } catch { fixturesCache = []; }
}
function filterKey(){
  const active = [...document.querySelectorAll('[data-fxf]')].find(b=>b.getAttribute('aria-pressed')==='true');
  return active ? active.getAttribute('data-fxf') : 'upcoming';
}
function renderFixtures(){
  const key = filterKey();
  let list = fixturesCache.slice();
  const now = Date.now();

  if (key==='upcoming'){
    list = list.filter(f => f.status!=='final' && (!f.when || f.when>=now));
  } else if (key==='final'){
    list = list.filter(f => f.status==='final');
  } else if (key==='mine' && meUser){
    list = list.filter(f => f.home===meUser.teamId || f.away===meUser.teamId);
  }

  list.sort((a,b)=>(a.when||a.createdAt)-(b.when||b.createdAt));
  fixturesList.innerHTML = list.length ? list.map(renderFxRow).join('') : `<div class="muted">No fixtures.</div>`;

  // attach handlers
  list.forEach(f=>{
    const root = document.getElementById('fx_'+f.id);
    if (!root) return;

    const isMgr = meUser && meUser.role==='Manager' && [f.home,f.away].includes(meUser.teamId);

    const btnProp = root.querySelector('.act .prop');
    if (btnProp) btnProp.onclick = async ()=>{
      if (!isMgr) return alert('Managers only');
      const atStr = prompt('Propose time (e.g., 2025-08-20 20:30 local)');
      if (!atStr) return;
      const at = Date.parse(atStr);
      if (!at) return alert('Could not parse date');
      try{ await apiPost(`/api/cup/fixtures/${f.id}/propose`, { at }); await refreshFixtures(); renderFixtures(); }
      catch(e){ alert('Propose failed: '+e.message); }
    };

    const btnAgree = root.querySelector('.act .agree');
    if (btnAgree) btnAgree.onclick = async ()=>{
      if (!isMgr) return alert('Managers only');
      const at = root.querySelector('select[name="slot"]').value;
      if (!at) return alert('Pick a proposed slot first');
      try{ await apiPost(`/api/cup/fixtures/${f.id}/vote`, { at, agree:true }); await refreshFixtures(); renderFixtures(); }
      catch(e){ alert('Vote failed: '+e.message); }
    };

    const btnDecl = root.querySelector('.act .decl');
    if (btnDecl) btnDecl.onclick = async ()=>{
      if (!isMgr) return alert('Managers only');
      const at = root.querySelector('select[name="slot"]').value;
      if (!at) return alert('Pick a proposed slot first');
      try{ await apiPost(`/api/cup/fixtures/${f.id}/vote`, { at, agree:false }); await refreshFixtures(); renderFixtures(); }
      catch(e){ alert('Vote failed: '+e.message); }
    };

    const btnLine = root.querySelector('.act .line');
    if (btnLine) btnLine.onclick = async ()=>{
      if (!isMgr) return alert('Managers only');
      const formation = prompt('Formation (e.g., 4-3-3)') || '';
      const starters = prompt('Comma-separated starters (GK,RB,CB,...) or names list') || '';
      const lineup = {};
      starters.split(',').map(s=>s.trim()).filter(Boolean).forEach((name,i)=> lineup['P'+(i+1)] = name);
      try{ await apiPut(`/api/cup/fixtures/${f.id}/lineup`, { formation, lineup }); await refreshFixtures(); renderFixtures(); }
      catch(e){ alert('Lineup failed: '+e.message); }
    };

    const btnReport = root.querySelector('.act .rep');
    if (btnReport) btnReport.onclick = async ()=>{
      if (!isMgr) return alert('Managers only');
      const hs = Number(prompt('Home score?')||0);
      const as = Number(prompt('Away score?')||0);
      const mvpHome = prompt('MVP (home)')||'';
      const mvpAway = prompt('MVP (away)')||'';
      const text = prompt('Notes (optional)')||'';
      try{
        await apiPost(`/api/cup/fixtures/${f.id}/report`, { hs, as, text, mvpHome, mvpAway });
        // switch filter to Final so user sees it
        document.querySelectorAll('[data-fxf]').forEach(x=>x.setAttribute('aria-pressed','false'));
        document.querySelector('[data-fxf="final"]').setAttribute('aria-pressed','true');
        await refreshFixtures(); renderFixtures();
      }catch(e){ alert('Report failed: '+e.message); }
    };
  });
}

function renderFxRow(f){
  const hn = byId(f.home)?.name || f.home;
  const an = byId(f.away)?.name || f.away;
  const whenTxt = f.when ? fmtDate(f.when) : 'TBD';
  const props = (f.proposals||[]).map(p=>`<option value="${p.at}">${fmtDate(p.at)}</option>`).join('');
  const status = f.status || 'pending';

  return `
  <div class="fx" id="fx_${f.id}">
    <div>
      <div class="vs">${escapeHtml(hn)} <span class="muted">vs</span> ${escapeHtml(an)}</div>
      <div class="meta">Round: ${escapeHtml(f.round||'')} ‚Ä¢ When: ${escapeHtml(whenTxt)} ‚Ä¢ Status: <span class="chip">${escapeHtml(status)}</span></div>
    </div>
    <div class="center">
      ${(f.proposals||[]).length ? `<label>Proposals</label><br><select name="slot">${props}</select>` : `<span class="muted">No proposals</span>`}
    </div>
    <div class="act">
      <button class="prop">Propose</button>
      <button class="agree">Agree</button>
      <button class="decl">Decline</button>
      <button class="line">Set Lineup</button>
      <button class="rep">Submit Result</button>
    </div>
  </div>`;
}

// Next & recent for team
function nextFor(teamId){
  const now = Date.now();
  return fixturesCache
    .filter(f => (f.home===teamId||f.away===teamId) && f.status!=='final' && f.when && f.when>=now)
    .sort((a,b)=>a.when-b.when)[0];
}
function finalsFor(teamId, n=5){
  return fixturesCache
    .filter(f => f.status==='final' && (f.home===teamId||f.away===teamId))
    .sort((a,b)=>(b.when||b.createdAt)-(a.when||a.createdAt))
    .slice(0,n);
}
function renderNextFor(teamId){
  const el = document.getElementById('nextMatchBody');
  const f = nextFor(teamId);
  if (!f){ el.textContent='No scheduled match yet.'; return; }
  const hn = byId(f.home)?.name || f.home;
  const an = byId(f.away)?.name || f.away;
  el.innerHTML = `<div><strong>${escapeHtml(hn)}</strong> vs <strong>${escapeHtml(an)}</strong></div>
                  <div class="muted">${fmtDate(f.when)}</div>`;
}
function renderTeamResults(teamId){
  const el = document.getElementById('teamResultsBody');
  const list = finalsFor(teamId);
  el.innerHTML = list.length ? list.map(f=>{
    const hn = byId(f.home)?.name || f.home;
    const an = byId(f.away)?.name || f.away;
    return `<div>FT ${f.score.hs}-${f.score.as}: <strong>${escapeHtml(hn)}</strong> vs <strong>${escapeHtml(an)}</strong> ‚Ä¢ ${fmtDate(f.when||f.createdAt)}</div>`;
  }).join('') : 'No finals yet.';
}

// =======================
//   RANKINGS (ADMIN)
// =======================
async function loadRankings(){
  try{
    const d = await apiGet('/api/rankings');
    rankings = d.rankings || {};
    payouts = d.payouts || payouts;
  }catch(e){ rankings={}; }
}

function renderRankings(){
  const rows = teams.map(t=>{
    const r = rankings[t.id] || { leaguePos:'', cup:'none', points:0, tier:'mid' };
    const cupOpts = ['none','round_of_16','quarterfinal','semifinal','runner_up','winner']
      .map(v=>`<option value="${v}" ${r.cup===v?'selected':''}>${v.replace(/_/g,' ')}</option>`).join('');
    return `<tr>
      <td>${escapeHtml(t.name)}</td>
      <td><input type="number" min="0" style="width:80px" value="${r.leaguePos||''}" data-k="leaguePos" data-id="${t.id}"></td>
      <td><select data-k="cup" data-id="${t.id}">${cupOpts}</select></td>
      <td>${escapeHtml(r.tier||'mid')}</td>
      <td>${fmtMoney(perDayFor(t.id))}</td>
    </tr>`;
  }).join('');
  document.getElementById('rankingsTable').innerHTML = `
    <table style="width:100%;border-collapse:collapse">
      <thead><tr>
        <th style="text-align:left">Club</th><th>League pos</th><th>Cup</th><th>Tier</th><th>Payout/day</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>
  `;

  const adminControls = document.getElementById('adminControls');
  adminControls.style.display = isAdmin ? 'flex' : 'none';

  // attach save handlers
  document.getElementById('btnSaveRankings').onclick = async ()=>{
    // collect changes
    const payload = { rankings: {} };
    document.querySelectorAll('#rankingsTable [data-id]').forEach(el=>{
      const id = el.getAttribute('data-id');
      const k  = el.getAttribute('data-k');
      payload.rankings[id] = payload.rankings[id] || {};
      payload.rankings[id][k] = k==='leaguePos' ? Number(el.value||0) : el.value;
    });
    try{
      await apiPost('/api/rankings/bulk', payload);
      alert('Saved');
      await loadRankings(); renderRankings();
    }catch(e){ alert('Save failed: '+e.message); }
  };

  document.getElementById('btnRecalc').onclick = async ()=>{
    try{ await apiPost('/api/rankings/recalc',{}); await loadRankings(); renderRankings(); alert('Recalculated'); }
    catch(e){ alert('Recalc failed: '+e.message); }
  };

  document.getElementById('btnCupDry').onclick = async ()=>{
    try{ const r = await apiPost('/api/bonuses/cup',{ dryRun:true }); alert('Would award: '+fmtMoney(r.totalAwarded)); }
    catch(e){ alert('Dry run failed: '+e.message); }
  };
  document.getElementById('btnCupPay').onclick = async ()=>{
    if (!confirm('Pay cup bonuses now?')) return;
    try{ const r = await apiPost('/api/bonuses/cup',{ dryRun:false }); alert('Awarded: '+fmtMoney(r.totalAwarded)); }
    catch(e){ alert('Pay failed: '+e.message); }
  };
}

function perDayFor(clubId){
  const r = rankings[clubId] || { tier:'mid' };
  const t = r.tier || 'mid';
  return payouts[t] || 0;
}

// =======================
//   ROLE CLAIM (manager)
// =======================
document.getElementById('btnSetRole').onclick = async ()=>{
  const role = prompt('Role (Manager only supported now)');
  if (!role || role.toLowerCase()!=='manager') return alert('Only Manager is supported via code.');
  const clubId = prompt('Enter your Club ID exactly as shown in Teams (e.g., 2491998 or afc-warriors)');
  const name   = prompt('Your display name');
  const code   = prompt('Manager code (ask admin)');
  if (!clubId || !name || !code) return;
  try{
    const d = await apiPost(`/api/clubs/${encodeURIComponent(clubId)}/claim-manager`, { name, code });
    alert('Claimed manager for '+clubId);
    await checkMe();
  }catch(e){ alert('Claim failed: '+e.message); }
};

// =======================
//   INIT
// =======================
async function init(){
  renderTeams();
  await checkMe();
  await checkAdmin();
  await refreshFixtures();
  renderFixtures();

  // open hash team
  try{
    const m = location.hash.match(/team=([^&]+)/);
    if (m){ const team = byId(decodeURIComponent(m[1])); if (team) setTimeout(()=>showTeam(team), 150); }
  }catch{}
}
init();

</script>
</body>
</html>
