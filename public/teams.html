<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pro Clubs League — Squads, Fixtures & Market</title>
<style>
:root{
  --bg:#0a0a0a; --panel:#111; --card:#141414; --muted:#8a8a8a; --text:#fafafa;
  --accent:#e00; --accent2:#f55;
  --ok:#2ecc71; --warn:#f1c40f; --bad:#e74c3c; --link:#4aa3ff;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px;background:linear-gradient(90deg,#900,#c00)}
h1{margin:0;font-size:18px;letter-spacing:.2px}
main{max-width:1200px;margin:0 auto;padding:16px}
.muted{color:var(--muted)}
.btn{background:var(--accent);border:none;color:#fff;border-radius:8px;padding:8px 12px;font-weight:600;cursor:pointer}
.btn.alt{background:#333}
.btn.ghost{background:transparent;border:1px solid #333;color:#ccc}
.btn.small{padding:6px 8px;font-size:12px;border-radius:6px}
.btn.ok{background:var(--ok)}
.btn.bad{background:var(--bad)}
.btn.warn{background:var(--warn);color:#000}
input,select,textarea{background:#0f0f0f;border:1px solid #2a2a2a;color:#fff;border-radius:8px;padding:8px}
input[type="datetime-local"]{color-scheme:dark}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.card{background:var(--card);border:1px solid #222;border-radius:12px;padding:12px}
.grid{display:grid;gap:12px}
.grid.teams{grid-template-columns:repeat(auto-fill,minmax(230px,1fr))}
.team-card{padding:0;overflow:hidden;cursor:pointer;transition:transform .12s ease,box-shadow .12s ease}
.team-card:hover{transform:translateY(-3px);box-shadow:0 10px 24px rgba(255,0,0,.2)}
.team-top{background:#1b0000;height:108px;display:flex;align-items:center;justify-content:center}
.team-top img{max-width:90%;max-height:90%}
.team-meta{padding:10px;display:flex;align-items:center;justify-content:space-between}
.badge{background:var(--accent);color:#fff;border-radius:999px;padding:4px 8px;font-size:12px;font-weight:700}
.tabbar{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
section{display:none}
section.active{display:block}
.kv{display:grid;grid-template-columns:140px 1fr;gap:8px;align-items:center}
hr{border:0;border-top:1px solid #222;margin:12px 0}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid #1f1f1f;padding:8px;text-align:left}
.label{font-size:12px;color:#bbb}
.slot-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
.slot{background:#0f0f0f;border:1px solid #222;border-radius:10px;padding:10px}
.unresolved{background:#2b1a1a;border:1px solid #552222;border-radius:8px;padding:8px}
code.inline{background:#111;border:1px solid #222;padding:2px 6px;border-radius:6px}
a.link{color:var(--link);text-decoration:none}
.empty{padding:16px;border:1px dashed #333;border-radius:10px;text-align:center;color:#aaa}
footer{margin:24px 0;color:#777;font-size:12px;text-align:center}
</style>
</head>
<body>
<header>
  <div class="row">
    <h1>Pro Clubs League</h1>
    <span class="badge" id="envBadge">LIVE</span>
  </div>
  <div class="row">
    <div id="whoami" class="muted">signed out</div>
    <button class="btn small ghost" id="btnAdmin">Admin</button>
    <button class="btn small ghost" id="btnSignOut" style="display:none">Sign out</button>
  </div>
</header>

<main>
  <nav class="tabbar">
    <button class="btn small alt" data-tab="teams">Teams</button>
    <button class="btn small alt" data-tab="market">Transfer Market</button>
    <button class="btn small alt" data-tab="fixtures">Fixtures</button>
    <button class="btn small alt" data-tab="scheduling">Fixtures Scheduling</button>
    <button class="btn small alt" data-tab="rankings">Rankings & Wallet</button>
  </nav>

  <!-- TEAMS -->
  <section id="tab-teams" class="active">
    <div class="row" style="justify-content:space-between">
      <h2 style="margin:0">Teams</h2>
      <div class="muted">Click a team to manage/view</div>
    </div>
    <div class="grid teams" id="teamsGrid"></div>

    <div id="teamDetail" class="card" style="margin-top:14px;display:none">
      <div class="row" style="justify-content:space-between">
        <h3 id="teamTitle" style="margin:0">Team</h3>
        <button class="btn small alt" id="btnCloseTeam">Close</button>
      </div>
      <div class="label" id="teamIdLbl"></div>

      <hr/>
      <h4>Squad Slots (no jersey numbers)</h4>
      <div class="row">
        <button class="btn small" id="btnBootstrapSlots" title="Create S01…S15 (admin)">Bootstrap 15 slots</button>
        <div class="muted" id="slotsHelp">Managers can assign usernames to vacant slots.</div>
      </div>
      <div id="slotsList" class="slot-list" style="margin-top:10px"></div>

      <hr/>
      <h4>Manager Code (admin)</h4>
      <div class="row">
        <button class="btn small warn" id="btnRotateCode">Rotate code</button>
        <button class="btn small alt" id="btnResetSeat">Reset seat</button>
        <div class="label">Last code (only shown on rotate): <code class="inline" id="lastCode">(hidden)</code></div>
      </div>

      <hr/>
      <h4>Claim Manager (use code)</h4>
      <div class="row">
        <input id="claimName" placeholder="Your name" />
        <input id="claimCode" placeholder="8-char code" />
        <button class="btn small" id="btnClaim">Claim</button>
      </div>
    </div>
  </section>

  <!-- MARKET -->
  <section id="tab-market">
    <h2>Transfer Market — Free Agents</h2>
    <div class="card">
      <h4>My Listing</h4>
      <div class="row">
        <input id="faPositions" placeholder="positions e.g. ST, CAM"/>
        <input id="faFoot" placeholder="foot (L/R)"/>
        <input id="faRegion" placeholder="region/timezone"/>
        <input id="faDiscord" placeholder="discord"/>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="faAvailability" style="flex:1" placeholder="availability e.g. M-F 7-10PM"/>
      </div>
      <div class="row" style="margin-top:8px">
        <textarea id="faBio" rows="2" style="width:100%" placeholder="short bio"></textarea>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="faLookingFor" style="flex:1" placeholder="looking for e.g. competitive, casual"/>
        <button class="btn small" id="btnSaveFA">Save/Update</button>
        <button class="btn small alt" id="btnDelFA">Remove</button>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h4>All Free Agents</h4>
      <table class="table" id="faTable">
        <thead><tr><th>Name</th><th>Pos</th><th>Foot</th><th>Region</th><th>Availability</th><th>Discord</th><th>Notes</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- FIXTURES (PUBLIC) -->
  <section id="tab-fixtures">
    <div class="row" style="justify-content:space-between">
      <h2 style="margin:0">Fixtures</h2>
      <div class="row">
        <label class="label">Cup:</label>
        <select id="cupPublic">
          <option value="UPCL">UPCL</option>
        </select>
        <button class="btn small alt" id="btnReloadPublic">Reload</button>
      </div>
    </div>
    <div id="fixturesPublicList" class="grid"></div>
  </section>

  <!-- FIXTURES SCHEDULING (Managers/Admin) -->
  <section id="tab-scheduling">
    <div class="row" style="justify-content:space-between">
      <h2 style="margin:0">Fixtures Scheduling</h2>
      <div class="row">
        <label class="label">Cup:</label>
        <select id="cupSched">
          <option value="UPCL" selected>UPCL</option>
        </select>
        <button class="btn small alt" id="btnReloadSched">Reload</button>
      </div>
    </div>

    <div id="adminCreate" class="card" style="display:none">
      <h4>Admin — Create Fixture</h4>
      <div class="row">
        <input id="fxHome" placeholder="home clubId"/>
        <input id="fxAway" placeholder="away clubId"/>
        <input id="fxRound" placeholder="round (e.g. Group A, QF)"/>
        <button class="btn small" id="btnCreateFx">Create</button>
      </div>
    </div>

    <div id="schedList" class="grid" style="margin-top:12px"></div>
  </section>

  <!-- RANKINGS & WALLET -->
  <section id="tab-rankings">
    <h2>Rankings & Wallet</h2>
    <div class="card">
      <h4>My Club Wallet</h4>
      <div class="row">
        <input id="walletClubId" placeholder="clubId (your team)" />
        <button class="btn small alt" id="btnWalletLoad">Load</button>
        <button class="btn small" id="btnWalletCollect">Collect payout</button>
      </div>
      <div id="walletInfo" class="kv" style="margin-top:10px;display:none">
        <div>Balance</div><div id="walletBal">0</div>
        <div>Per Day</div><div id="walletPer">0</div>
        <div>Accrued</div><div id="walletAccrued">0</div>
        <div>Days</div><div id="walletDays">0</div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h4>League Rankings</h4>
      <table class="table" id="rankTable">
        <thead><tr><th>Club</th><th>Pos</th><th>Cup</th><th>Points</th><th>Tier</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="label" style="margin-top:6px">Payouts (per day): elite/mid/bottom are server-configured.</div>
    </div>
  </section>

  <footer>© United Pro Clubs League</footer>
</main>

<script>
/* =======================
   CONFIG / STATE
======================= */
const API_BASE = ''; // same-origin
let isAdmin = false;
let me = null;

const teams = [
  { id:'2491998', name:'Royal Republic', logo:'/assets/logos/royal-republic-logo.png' },
  { id:'1527486', name:'Gungan FC' },
  { id:'1969494', name:'Club Frijol' },
  { id:'AFCWARR', name:'AFC Warriors' },       // manual club (string id)
  { id:'JIDS', name:'Jids Trivela' },
  { id:'RAZOR', name:'Razorblack FC' },
  { id:'2086022', name:'Brehemen' },
  { id:'2462194', name:'Costa Chica FC' },
  { id:'4869810', name:'Afc Tekki' },
  { id:'55408', name:'Elite VT' },
  { id:'35642', name:'EBK FC' }
];

/* =======================
   UTILS
======================= */
const $ = sel => document.querySelector(sel);
const el = (tag, props={}) => Object.assign(document.createElement(tag), props);
function escapeHtml(s){ return String(s).replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])) }
function fmtWhen(ms){ if(!ms) return 'TBD'; try{ return new Date(ms).toLocaleString(); }catch{ return 'TBD'; } }
async function jget(p){ const r=await fetch(API_BASE+p); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
async function jpost(p,body){ const r=await fetch(API_BASE+p,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
async function jput(p,body){ const r=await fetch(API_BASE+p,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
async function jdel(p){ const r=await fetch(API_BASE+p,{method:'DELETE'}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
function toast(msg, ok=true){ const t=el('div',{textContent:msg,style:`position:fixed;right:12px;bottom:12px;background:${ok?'#1d3b1f':'#3b1d1d'};color:#fff;padding:8px 10px;border-radius:8px;z-index:9999;`}); document.body.appendChild(t); setTimeout(()=>t.remove(),2600); }
function toMsFromLocal(dt){ if(!dt) return 0; const d = new Date(dt); return d.getTime(); }

/* =======================
   AUTH / WHOAMI
======================= */
async function refreshAuth(){
  try{
    const a = await jget('/api/admin/me'); isAdmin = !!a.admin;
  }catch{}
  try{
    const u = await jget('/api/auth/me'); me = u.user||null;
  }catch{}
  $('#whoami').textContent = `${isAdmin?'[ADMIN] ':''}${me?`${me.role}: ${me.name}`:'signed out'}`;
  $('#btnSignOut').style.display = (isAdmin || me) ? '' : 'none';
  $('#adminCreate').style.display = isAdmin ? '' : 'none';
  $('#btnBootstrapSlots').style.display = isAdmin ? '' : 'none';
  // Show/hide Scheduling tab content based on access (we don't hide tab, just handle 403 on load)
}

$('#btnAdmin').addEventListener('click', async ()=>{
  if(isAdmin){ toast('Already admin'); return; }
  const pw = prompt('Admin password:'); if(!pw) return;
  try{ await jpost('/api/admin/login',{password:pw}); toast('Admin signed in'); }catch(e){ toast('Bad password', false); }
  await refreshAuth(); await loadScheduling(); 
});
$('#btnSignOut').addEventListener('click', async ()=>{
  try{ await jpost('/api/admin/logout',{}); }catch{}
  try{ await jpost('/api/auth/logout',{}); }catch{}
  isAdmin=false; me=null; await refreshAuth();
});

/* =======================
   TABS
======================= */
const tabs = Array.from(document.querySelectorAll('.tabbar .btn'));
tabs.forEach(b=>b.addEventListener('click', ()=>{
  document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
  $('#tab-'+b.dataset.tab).classList.add('active');
  if(b.dataset.tab==='fixtures') loadPublic();
  if(b.dataset.tab==='scheduling') loadScheduling();
  if(b.dataset.tab==='market') loadFreeAgents();
  if(b.dataset.tab==='rankings') loadRankings();
}));

/* =======================
   TEAMS GRID + DETAIL
======================= */
function teamLogoUrl(team){ return team.logo || `https://via.placeholder.com/800x400.png?text=${encodeURIComponent(team.name)}`; }

function renderTeams(){
  const g = $('#teamsGrid'); g.innerHTML='';
  teams.forEach(t=>{
    const c = el('div',{className:'card team-card'});
    const top = el('div',{className:'team-top'}); top.append(el('img',{src:teamLogoUrl(t),alt:t.name}));
    const meta = el('div',{className:'team-meta'});
    meta.append(el('div',{textContent:t.name}));
    meta.append(el('span',{className:'badge',textContent:t.id}));
    c.append(top, meta);
    c.addEventListener('click', ()=>openTeam(t));
    g.append(c);
  });
}
renderTeams();

const teamDetail = $('#teamDetail');
let currentTeam = null;

$('#btnCloseTeam').addEventListener('click', ()=>{ teamDetail.style.display='none'; currentTeam=null; });

async function openTeam(team){
  currentTeam = team;
  $('#teamTitle').textContent = team.name;
  $('#teamIdLbl').textContent = 'clubId: '+team.id;
  $('#lastCode').textContent = '(hidden)';
  teamDetail.style.display='';
  await loadSlots();
}

async function loadSlots(){
  if(!currentTeam) return;
  const wrap = $('#slotsList'); wrap.innerHTML = '';
  try{
    const data = await jget(`/api/clubs/${encodeURIComponent(currentTeam.id)}/squad`);
    const slots = data.slots||[];
    if(slots.length===0){
      wrap.append(el('div',{className:'empty',innerHTML:'No slots yet. <b>Admin</b> can click “Bootstrap 15 slots”.'}));
      return;
    }
    slots.forEach(s=>{
      const box = el('div',{className:'slot'});
      box.append(el('div',{className:'label',textContent:s.slotId+' — '+(s.label||'Slot')}));
      if(s.player){
        box.append(el('div',{innerHTML:`EA: <b>${escapeHtml(s.player.eaName)}</b><br><span class="label">playerId: ${s.player.id}</span>`}));
        const row = el('div',{className:'row',style:'margin-top:8px'});
        const btnUn = el('button',{className:'btn small alt',textContent:'Unassign'});
        btnUn.addEventListener('click', async ()=>{
          if(!canManageCurrentClub()) return toast('Only this club manager or admin', false);
          await jpost(`/api/clubs/${encodeURIComponent(currentTeam.id)}/squad/slots/${s.slotId}/unassign`,{});
          toast('Unassigned'); loadSlots();
        });
        row.append(btnUn);
        box.append(row);
      } else {
        box.append(el('div',{className:'muted',textContent:'Vacant'}));
        const row = el('div',{className:'row',style:'margin-top:8px'});
        const inName = el('input',{placeholder:'EA username'});
        const inAliases = el('input',{placeholder:'aliases (comma-separated)',style:'min-width:220px'});
        const btnAsg = el('button',{className:'btn small',textContent:'Assign'});
        btnAsg.addEventListener('click', async ()=>{
          if(!canManageCurrentClub()) return toast('Only this club manager or admin', false);
          const eaName = inName.value.trim(); if(!eaName) return toast('Enter EA username', false);
          await jpost(`/api/clubs/${encodeURIComponent(currentTeam.id)}/squad/slots/${s.slotId}/assign`,{ eaName, aliases: inAliases.value });
          toast('Assigned'); loadSlots();
        });
        row.append(inName,inAliases,btnAsg);
        box.append(row);
      }
      wrap.append(box);
    });
  }catch(e){
    wrap.append(el('div',{className:'empty',textContent:'Failed to load slots'}));
  }
}

function canManageCurrentClub(){
  if(isAdmin) return true;
  if(me && me.role==='Manager' && currentTeam && me.teamId===currentTeam.id) return true;
  return false;
}

$('#btnBootstrapSlots').addEventListener('click', async ()=>{
  if(!isAdmin) return toast('Admin only', false);
  if(!currentTeam) return;
  try{ await jpost(`/api/clubs/${encodeURIComponent(currentTeam.id)}/squad/bootstrap`,{}); toast('Slots created'); loadSlots(); }
  catch(e){ toast('Failed: '+e.message, false); }
});

$('#btnRotateCode').addEventListener('click', async ()=>{
  if(!isAdmin) return toast('Admin only', false);
  if(!currentTeam) return;
  try{
    const r = await jpost(`/api/clubs/${encodeURIComponent(currentTeam.id)}/manager-code/rotate`,{});
    $('#lastCode').textContent = r.code || '(none)';
    toast('New code generated (shown once)');
  }catch(e){ toast('Failed: '+e.message, false); }
});
$('#btnResetSeat').addEventListener('click', async ()=>{
  if(!isAdmin) return toast('Admin only', false);
  if(!currentTeam) return;
  try{ await jpost(`/api/clubs/${encodeURIComponent(currentTeam.id)}/manager-code/reset`,{}); toast('Seat reset'); }
  catch(e){ toast('Failed: '+e.message, false); }
});
$('#btnClaim').addEventListener('click', async ()=>{
  if(!currentTeam) return toast('Pick a team', false);
  const name = $('#claimName').value.trim();
  const code = $('#claimCode').value.trim();
  if(!name || !code) return toast('Name + code required', false);
  try{
    const r = await jpost(`/api/clubs/${encodeURIComponent(currentTeam.id)}/claim-manager`,{name,code});
    toast('Claimed as manager');
    await refreshAuth();
  }catch(e){ toast('Failed: '+e.message, false); }
});

/* =======================
   TRANSFER MARKET
======================= */
async function loadFreeAgents(){
  try{
    const data = await jget('/api/free-agents');
    const tb = $('#faTable tbody'); tb.innerHTML='';
    (data.agents||[]).forEach(a=>{
      const tr = el('tr');
      tr.innerHTML = `<td>${escapeHtml(a.name||'')}</td>
        <td>${escapeHtml((a.positions||[]).join(', '))}</td>
        <td>${escapeHtml(a.foot||'')}</td>
        <td>${escapeHtml(a.region||'')}</td>
        <td>${escapeHtml(a.availability||'')}</td>
        <td>${escapeHtml(a.discord||'')}</td>
        <td>${escapeHtml(a.bio||a.lookingFor||'')}</td>`;
      tb.append(tr);
    });
  }catch(e){
    toast('Failed to load free agents', false);
  }
}

$('#btnSaveFA').addEventListener('click', async ()=>{
  const payload = {
    positions: $('#faPositions').value,
    foot: $('#faFoot').value,
    region: $('#faRegion').value,
    bio: $('#faBio').value,
    availability: $('#faAvailability').value,
    discord: $('#faDiscord').value,
    lookingFor: $('#faLookingFor').value
  };
  try{ await jpost('/api/free-agents/me', payload); toast('Listing saved'); loadFreeAgents(); }
  catch(e){ toast('Sign in as Player/Manager first', false); }
});
$('#btnDelFA').addEventListener('click', async ()=>{
  try{ await jdel('/api/free-agents/me'); toast('Listing removed'); loadFreeAgents(); }
  catch(e){ toast('Not listed or not signed in', false); }
});

/* =======================
   FIXTURES (PUBLIC)
======================= */
async function loadPublic(){
  const cup = $('#cupPublic').value;
  const list = $('#fixturesPublicList'); list.innerHTML='';
  try{
    const r = await jget(`/api/cup/fixtures/public?cup=${encodeURIComponent(cup)}`);
    const arr = (r.fixtures||[]).sort((a,b)=>(a.when||0)-(b.when||0));
    if(arr.length===0){ list.append(el('div',{className:'empty',textContent:'No fixtures yet'})); return; }
    arr.forEach(f=>{
      const c = el('div',{className:'card'});
      c.innerHTML = `
        <div class="row" style="justify-content:space-between">
          <div><b>${escapeHtml(f.home)}</b> vs <b>${escapeHtml(f.away)}</b> — <span class="label">${escapeHtml(f.round||'')}</span></div>
          <div class="label">${fmtWhen(f.when)}</div>
        </div>
        <div style="margin-top:6px">Score: <b>${f.score.hs}</b> - <b>${f.score.as}</b></div>
      `;
      // scorers under each team
      const homeSc = (f.details?.home||[]).filter(r=>Number(r.goals)>0).map(r=>`${escapeHtml(r.player||r.playerId||'')}: ${r.goals}`).join(', ');
      const awaySc = (f.details?.away||[]).filter(r=>Number(r.goals)>0).map(r=>`${escapeHtml(r.player||r.playerId||'')}: ${r.goals}`).join(', ');
      const scorers = el('div',{className:'label',style:'margin-top:6px'});
      scorers.textContent = `Scorers — Home: ${homeSc || '—'} | Away: ${awaySc || '—'}`;
      c.append(scorers);
      list.append(c);
    });
  }catch(e){
    list.append(el('div',{className:'empty',textContent:'Failed to load fixtures'}));
  }
}
$('#btnReloadPublic').addEventListener('click', loadPublic);

/* =======================
   FIXTURES SCHEDULING
======================= */
async function loadScheduling(){
  const cup = $('#cupSched').value;
  const wrap = $('#schedList'); wrap.innerHTML='';
  try{
    const r = await jget(`/api/cup/fixtures/scheduling?cup=${encodeURIComponent(cup)}`);
    if((r.fixtures||[]).length===0){ wrap.append(el('div',{className:'empty',textContent:'No fixtures set'})); return; }
    (r.fixtures||[]).sort((a,b)=>(a.createdAt||0)-(b.createdAt||0)).forEach(f=>{
      wrap.append(renderSchedulingCard(f));
    });
  }catch(e){
    wrap.append(el('div',{className:'empty',textContent:'Managers/Admin only (sign in).'}));
  }
}
$('#btnReloadSched').addEventListener('click', loadScheduling);

function renderSchedulingCard(f){
  const c = el('div',{className:'card'});
  c.append(el('div',{className:'row',style:'justify-content:space-between',innerHTML:
    `<div><b>${escapeHtml(f.home)}</b> vs <b>${escapeHtml(f.away)}</b> — <span class="label">${escapeHtml(f.round||'')}</span></div>
     <div class="label">Status: ${escapeHtml(f.status||'pending')} • ${fmtWhen(f.when)}</div>`}));

  // propose time
  const row1 = el('div',{className:'row',style:'margin-top:8px'});
  const dt = el('input',{type:'datetime-local'});
  const btnProp = el('button',{className:'btn small',textContent:'Propose time'});
  btnProp.addEventListener('click', async ()=>{
    try{
      const at = toMsFromLocal(dt.value);
      if(!at) return toast('Pick a date/time', false);
      await jpost(`/api/cup/fixtures/${f.id}/propose`, { at });
      toast('Proposed'); loadScheduling();
    }catch(e){ toast('Failed: '+e.message, false); }
  });
  row1.append(dt, btnProp);
  c.append(row1);

  // vote
  const row2 = el('div',{className:'row'});
  const sel = el('select');
  (f.proposals||[]).forEach(p=>{
    const o = el('option',{value:String(p.at),textContent:fmtWhen(p.at)+' (by '+(p.by||'?')+')'});
    sel.append(o);
  });
  const btnAgree = el('button',{className:'btn small ok',textContent:'Agree'});
  const btnDecl = el('button',{className:'btn small alt',textContent:'Decline'});
  btnAgree.addEventListener('click', async ()=>{
    try{
      const at = sel.value; if(!at) return toast('Pick a proposal', false);
      await jpost(`/api/cup/fixtures/${f.id}/vote`, { at, agree:true });
      toast('Voted agree'); loadScheduling();
    }catch(e){ toast('Failed: '+e.message, false); }
  });
  btnDecl.addEventListener('click', async ()=>{
    try{
      const at = sel.value; if(!at) return toast('Pick a proposal', false);
      await jpost(`/api/cup/fixtures/${f.id}/vote`, { at, agree:false });
      toast('Voted decline'); loadScheduling();
    }catch(e){ toast('Failed: '+e.message, false); }
  });
  row2.append(sel, btnAgree, btnDecl);
  c.append(row2);

  // lineup
  const row3 = el('div',{className:'row'});
  const inForm = el('input',{placeholder:'formation (e.g. 4-2-3-1)'});
  const inLine = el('input',{placeholder:'lineup JSON (optional)' ,style:'flex:1'});
  const btnLine = el('button',{className:'btn small',textContent:'Set lineup'});
  btnLine.addEventListener('click', async ()=>{
    try{
      let lineup = {};
      if(inLine.value.trim()){
        try{ lineup = JSON.parse(inLine.value); }catch{ return toast('Invalid JSON', false); }
      }
      await jput(`/api/cup/fixtures/${f.id}/lineup`, { formation: inForm.value, lineup });
      toast('Lineup saved'); loadScheduling();
    }catch(e){ toast('Failed: '+e.message, false); }
  });
  row3.append(inForm, inLine, btnLine);
  c.append(row3);

  // submit result
  const row4 = el('div',{className:'row'});
  const inHs = el('input',{placeholder:'home goals',type:'number',style:'width:110px'});
  const inAs = el('input',{placeholder:'away goals',type:'number',style:'width:110px'});
  const btnRes = el('button',{className:'btn small',textContent:'Submit Result'});
  btnRes.addEventListener('click', async ()=>{
    try{
      await jpost(`/api/cup/fixtures/${f.id}/report`, { hs:Number(inHs.value||0), as:Number(inAs.value||0) });
      toast('Result posted'); loadScheduling(); loadPublic();
    }catch(e){ toast('Failed: '+e.message, false); }
  });
  row4.append(inHs, inAs, btnRes);
  c.append(row4);

  // admin tools: paste / upload JSON
  if(isAdmin){
    const row5 = el('div',{className:'row'});
    const btnPaste = el('button',{className:'btn small warn',textContent:'Admin paste'});
    const btnJSON  = el('button',{className:'btn small warn',textContent:'Upload JSON'});
    btnPaste.addEventListener('click', async ()=>{
      const text = prompt('Paste quick text (names, goals/assists, rating, with commas or new lines):');
      if(!text) return;
      try{
        await jpost(`/api/cup/fixtures/${f.id}/ingest-text`, { text });
        toast('Parsed & saved'); loadScheduling(); loadPublic();
      }catch(e){ toast('Failed to parse: '+e.message, false); }
    });
    btnJSON.addEventListener('click', async ()=>{
      const hs = Number(prompt('Home score?')||0);
      const as = Number(prompt('Away score?')||0);
      const sample = {
        text: 'optional notes',
        details: {
          home: [{ "player":"Players1", "goals":1, "assists":0, "rating":9.1 }],
          away: [{ "player":"Player1", "goals":2, "assists":0, "rating":8.8 }]
        }
      };
      const blob = prompt('Paste JSON (we prepared a sample):', JSON.stringify(sample, null, 2));
      if(!blob) return;
      let data; try{ data = JSON.parse(blob); }catch{ return toast('Invalid JSON', false); }
      data.hs = hs; data.as = as;
      try{
        await jpost(`/api/cup/fixtures/${f.id}/report`, data);
        toast('Result + details saved'); loadScheduling(); loadPublic();
      }catch(e){ toast('Failed: '+e.message, false); }
    });
    row5.append(btnPaste, btnJSON);
    c.append(row5);
  }

  // unresolved
  if (Array.isArray(f.unresolved) && f.unresolved.length){
    const u = el('div',{className:'unresolved',style:'margin-top:8px'});
    u.innerHTML = `<b>Unresolved names:</b> ${f.unresolved.map(x=>`${escapeHtml(x.side)}: ${escapeHtml(x.name)}`).join(', ')}`;
    c.append(u);
  }
  return c;
}

$('#btnCreateFx').addEventListener('click', async ()=>{
  const home = $('#fxHome').value.trim();
  const away = $('#fxAway').value.trim();
  const round = $('#fxRound').value.trim();
  if(!home||!away) return toast('Home & Away required', false);
  try{ await jpost('/api/cup/fixtures', { home, away, round, cup: $('#cupSched').value }); toast('Fixture created'); loadScheduling(); }
  catch(e){ toast('Failed: '+e.message, false); }
});

/* =======================
   RANKINGS / WALLET
======================= */
async function loadRankings(){
  try{
    const r = await jget('/api/rankings');
    const tb = $('#rankTable tbody'); tb.innerHTML='';
    Object.entries(r.rankings||{}).forEach(([clubId, row])=>{
      const tr = el('tr');
      tr.innerHTML = `<td>${escapeHtml(clubId)}</td>
        <td>${escapeHtml(row.leaguePos||'')}</td>
        <td>${escapeHtml(row.cup||'none')}</td>
        <td>${escapeHtml(row.points||0)}</td>
        <td>${escapeHtml(row.tier||'mid')}</td>`;
      tb.append(tr);
    });
  }catch(e){ /* ignore */ }
}

$('#btnWalletLoad').addEventListener('click', loadWallet);
$('#btnWalletCollect').addEventListener('click', collectWallet);

async function loadWallet(){
  const id = $('#walletClubId').value.trim(); if(!id) return toast('Enter clubId', false);
  try{
    const r = await jget(`/api/wallets/${encodeURIComponent(id)}`);
    $('#walletInfo').style.display='';
    $('#walletBal').textContent = (r.wallet.balance||0).toLocaleString();
    $('#walletPer').textContent = (r.perDay||0).toLocaleString();
    $('#walletAccrued').textContent = (r.preview.amount||0).toLocaleString();
    $('#walletDays').textContent = r.preview.days||0;
  }catch(e){ toast('Failed to load wallet', false); }
}
async function collectWallet(){
  const id = $('#walletClubId').value.trim(); if(!id) return toast('Enter clubId', false);
  try{
    const r = await jpost(`/api/wallets/${encodeURIComponent(id)}/collect`,{});
    if(!r.ok){ toast(r.message||'Nothing to collect', false); return; }
    toast(`Collected ${r.preview.amount.toLocaleString()}`);
    loadWallet();
  }catch(e){ toast('Collect failed (need club manager session)', false); }
}

/* =======================
   INIT
======================= */
(async function init(){
  await refreshAuth();
  // Auto-open team via hash #team=<id>
  const m = location.hash.match(/team=([^&]+)/);
  if (m){
    const team = teams.find(t=>String(t.id)===decodeURIComponent(m[1]));
    if (team) openTeam(team);
  }
  // Eager load some tabs
  loadPublic(); loadRankings();
})();
</script>
</body>
</html>
